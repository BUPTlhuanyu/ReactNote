<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="alternate" type="application/rss+xml" href="/ReactNote/blog/rss.xml" title="React Note Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/ReactNote/blog/atom.xml" title="React Note Blog Atom Feed"><title data-react-helmet="true">Blog | React Note</title><meta data-react-helmet="true" property="og:title" content="Blog | React Note"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="description" content="Blog"><meta data-react-helmet="true" property="og:description" content="Blog"><meta data-react-helmet="true" property="og:url" content="https://BUPTlhuanyu.github.io/ReactNote/blog"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="blog_posts_list"><link data-react-helmet="true" rel="shortcut icon" href="/ReactNote/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://BUPTlhuanyu.github.io/ReactNote/blog"><link data-react-helmet="true" rel="alternate" href="https://BUPTlhuanyu.github.io/ReactNote/blog" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://BUPTlhuanyu.github.io/ReactNote/blog" hreflang="x-default"><link rel="stylesheet" href="/ReactNote/assets/css/styles.694d919f.css">
<link rel="preload" href="/ReactNote/assets/js/runtime~main.a78b756c.js" as="script">
<link rel="preload" href="/ReactNote/assets/js/main.48fd23c8.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script>
<script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?64a3c7fa9e8533c72827dc22e0d273ab";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/ReactNote/"><img src="/ReactNote/img/logo.png" alt="React Note Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/ReactNote/img/logo.png" alt="React Note Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">React Note</b></a><a class="navbar__item navbar__link" href="/ReactNote/docs/react/react/intro">React</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/ReactNote/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/BUPTlhuanyu" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ğŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ğŸŒ</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-list-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_2ahu thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_2hhb margin-bottom--md">Recent posts</div><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/ReactNote/blog/blog-post">koa code analyse</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/ReactNote/blog/blog-post">AOP design-pattern in javascript</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/ReactNote/blog/blog-post">koa code analyse</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2021-09-30T00:00:00.000Z" itemprop="datePublished">September 30, 2021</time> Â· 13 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://github.com/BUPTlhuanyu" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://github.com/BUPTlhuanyu.png" alt="liaohuanyu"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/BUPTlhuanyu" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">liaohuanyu</span></a></div><small class="avatar__subtitle" itemprop="description">Maintainer of ReactNote</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><blockquote><p><a href="https://koa.bootcss.com/" target="_blank" rel="noopener noreferrer">Koa2å®˜ç½‘</a> â€”â€”&gt; <a href="https://github.com/koajs/koa" target="_blank" rel="noopener noreferrer">githubåœ°å€</a></p></blockquote><blockquote><p><a href="https://chenshenhai.github.io/koa2-note/" target="_blank" rel="noopener noreferrer">Koa2è¿›é˜¶å­¦ä¹ ç¬”è®°</a> â€”â€”&gt; <a href="https://github.com/chenshenhai/koa2-note" target="_blank" rel="noopener noreferrer">githubåœ°å€</a></p></blockquote><blockquote><p><a href="https://chenshenhai.github.io/koajs-design-note/" target="_blank" rel="noopener noreferrer">Koa.js è®¾è®¡æ¨¡å¼-å­¦ä¹ ç¬”è®°</a> â€”â€”&gt; <a href="https://github.com/chenshenhai/koajs-design-note" target="_blank" rel="noopener noreferrer">githubåœ°å€</a></p></blockquote><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="koaç±»çš„ç»“æ„"></a>koaç±»çš„ç»“æ„<a class="hash-link" href="#koaç±»çš„ç»“æ„" title="Direct link to heading">#</a></h2><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">module.exports = class Application extends Emitterï½›</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    constructor() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    super();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.proxy = false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.middleware = [];</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.subdomainOffset = 2;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.context = Object.create(context);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.request = Object.create(request);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.response = Object.create(response);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  listen(...args) {...}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  toJSON() {...}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  inspect() {...}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  use(fn) {...}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  callback() {...}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  handleRequest(ctx, fnMiddleware) {...}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  createContext(req, res) {...}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  onerror(err) {...}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">ï½</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="ç®€å•ç¤ºä¾‹å‡ºå‘"></a>ç®€å•ç¤ºä¾‹å‡ºå‘<a class="hash-link" href="#ç®€å•ç¤ºä¾‹å‡ºå‘" title="Direct link to heading">#</a></h2><p>å¦‚ä¸‹ä¸ºå®˜æ–¹ç»™å‡ºçš„çº§è”å½¢å¼çš„<code>koa</code>ç¤ºä¾‹ï¼Œ</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">const Koa = require(&#x27;koa&#x27;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">const app = new Koa();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// logger</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">app.use(async (ctx, next) =&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  await next();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  const rt = ctx.response.get(&#x27;X-Response-Time&#x27;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  console.log(`${ctx.method} ${ctx.url} - ${rt}`);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">});</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// x-response-time</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">app.use(async (ctx, next) =&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  const start = Date.now();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  await next();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  const ms = Date.now() - start;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  ctx.set(&#x27;X-Response-Time&#x27;, `${ms}ms`);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">});</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// response</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">app.use(async ctx =&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  ctx.body = &#x27;Hello World&#x27;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">});</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">app.listen(3000);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>ä¸Šè¿°ç¤ºä¾‹çš„å·¥ä½œè¿‡ç¨‹å¯ä»¥åˆ†ä¸ºå‡†å¤‡é˜¶æ®µä¸å¤„ç†requesäº‹ä»¶è¿™ä¸¤ä¸ªé˜¶æ®µã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="å‡†å¤‡é˜¶æ®µ"></a>å‡†å¤‡é˜¶æ®µ<a class="hash-link" href="#å‡†å¤‡é˜¶æ®µ" title="Direct link to heading">#</a></h3><p>å‡†å¤‡é˜¶æ®µä¼šåˆ›å»ºkoaå®ä¾‹ï¼Œæ³¨å†Œä¸­é—´ä»¶ï¼Œç›‘å¬æŒ‡å®šç«¯å£ï¼Œä¸­é—´ä»¶çš„å¤„ç†æ–¹å¼ä¸ºæ´‹è‘±æ¨¡å‹è®¾è®¡æ¨¡å¼ï¼š</p><ol><li>åˆ›å»ºä¸€ä¸ª<code>koa</code>å®ä¾‹ä¸º<code>app</code>;</li><li>æ³¨å†Œ<code>logger</code>ä¸­é—´ä»¶ï¼Œä¹Ÿå°±æ˜¯å°†ä¸­é—´ä»¶å‡½æ•°æ·»åŠ åˆ°ä¸€ä¸ªåä¸º<code>middleware</code>çš„æ•°ç»„ä¸­ã€‚</li><li>æ³¨å†Œ<code>x-response-time</code>ä¸­é—´ä»¶ã€‚</li><li>æ³¨å†Œ<code>response</code>ä¸­é—´ä»¶ã€‚</li><li>ç›‘å¬3000ç«¯å£ã€‚</li></ol><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="1-åˆ›å»ºkoaå®ä¾‹è°ƒç”¨constructorå®šä¹‰å®ä¾‹å±æ€§middlewareç­‰ç­‰"></a>1. åˆ›å»ºkoaå®ä¾‹ï¼Œè°ƒç”¨constructorï¼Œå®šä¹‰å®ä¾‹å±æ€§middlewareç­‰ç­‰<a class="hash-link" href="#1-åˆ›å»ºkoaå®ä¾‹è°ƒç”¨constructorå®šä¹‰å®ä¾‹å±æ€§middlewareç­‰ç­‰" title="Direct link to heading">#</a></h4><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="2-koaå®ä¾‹çš„koaç±»çš„åŸå‹å¯¹è±¡æ–¹æ³•useæ·»åŠ ä¸­é—´ä»¶useæ–¹æ³•åªæ˜¯ç®€å•çš„å°†ä¸­é—´ä»¶æ·»åŠ åˆ°å®ä¾‹çš„å±æ€§middlewareæ•°ç»„ä¸­ç„¶åè¿”å›å®ä¾‹è‡ªèº«çš„this"></a>2. koaå®ä¾‹çš„koaç±»çš„åŸå‹å¯¹è±¡æ–¹æ³•useæ·»åŠ ä¸­é—´ä»¶ï¼Œuseæ–¹æ³•åªæ˜¯ç®€å•çš„å°†ä¸­é—´ä»¶æ·»åŠ åˆ°å®ä¾‹çš„å±æ€§middlewareæ•°ç»„ä¸­ï¼Œç„¶åè¿”å›å®ä¾‹è‡ªèº«çš„thisã€‚<a class="hash-link" href="#2-koaå®ä¾‹çš„koaç±»çš„åŸå‹å¯¹è±¡æ–¹æ³•useæ·»åŠ ä¸­é—´ä»¶useæ–¹æ³•åªæ˜¯ç®€å•çš„å°†ä¸­é—´ä»¶æ·»åŠ åˆ°å®ä¾‹çš„å±æ€§middlewareæ•°ç»„ä¸­ç„¶åè¿”å›å®ä¾‹è‡ªèº«çš„this" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">  use(fn) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (typeof fn !== &#x27;function&#x27;) throw new TypeError(&#x27;middleware must be a function!&#x27;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    debug(&#x27;use %s&#x27;, fn._name || fn.name || &#x27;-&#x27;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.middleware.push(fn);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return this;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="3-ç›‘å¬ç«¯å£3000è°ƒç”¨åŸå‹å¯¹è±¡æ–¹æ³•listenè¯¥æ–¹æ³•å†…éƒ¨ä¼šè°ƒç”¨nodeçš„httpæ¨¡å—è°ƒç”¨å®ä¾‹æ–¹æ³•thiscallbackç„¶åå°†è¿”å›ç»“æœä½œä¸ºhttpcreateserverçš„ä¼ å…¥å‚æ•°å³ä½œä¸ºç«¯å£è§¦å‘çš„requestäº‹ä»¶çš„å›è°ƒå‡½æ•°httpcreateserverè¿è¡Œåè¿”å›ä¸€ä¸ªhttpæœåŠ¡å™¨ç„¶åå°†è¯¥httpæœåŠ¡å™¨ç›‘å¬ç«¯å£3000åœ¨3000ç«¯å£æœ‰è¯·æ±‚çš„æ—¶å€™è§¦å‘nodeæœºåˆ¶çš„requestäº‹ä»¶å¹¶è°ƒç”¨thiscallbackè¿”å›çš„å‡½æ•°thiscallbackå‡½æ•°ä¼šå°†ä¸­é—´ä»¶å‡½æ•°ç»„ç»‡æˆæ´‹è‘±æ¨¡å‹å¹¶è¿”å›ä¸€ä¸ªæ‰§è¡Œå…¥å£å‡½æ•°ç”¨äºæŒ‰ç…§ç‰¹å®šé¡ºåºæ‰§è¡Œä¸­é—´ä»¶"></a>3. ç›‘å¬ç«¯å£3000ï¼Œè°ƒç”¨åŸå‹å¯¹è±¡æ–¹æ³•listenï¼Œè¯¥æ–¹æ³•å†…éƒ¨ä¼šè°ƒç”¨nodeçš„httpæ¨¡å—ï¼Œè°ƒç”¨å®ä¾‹æ–¹æ³•this.callbackï¼Œç„¶åå°†è¿”å›ç»“æœä½œä¸ºhttp.createServerçš„ä¼ å…¥å‚æ•°å³ä½œä¸ºç«¯å£è§¦å‘çš„requestäº‹ä»¶çš„å›è°ƒå‡½æ•°ã€‚http.createServerè¿è¡Œåè¿”å›ä¸€ä¸ªhttpæœåŠ¡å™¨ï¼Œç„¶åå°†è¯¥httpæœåŠ¡å™¨ç›‘å¬ç«¯å£3000ã€‚åœ¨3000ç«¯å£æœ‰è¯·æ±‚çš„æ—¶å€™ï¼Œè§¦å‘nodeæœºåˆ¶çš„requestäº‹ä»¶ï¼Œå¹¶è°ƒç”¨this.callback()è¿”å›çš„å‡½æ•°ã€‚this.callbackå‡½æ•°ä¼šå°†ä¸­é—´ä»¶å‡½æ•°ç»„ç»‡æˆæ´‹è‘±æ¨¡å‹ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ‰§è¡Œå…¥å£å‡½æ•°ï¼Œç”¨äºæŒ‰ç…§ç‰¹å®šé¡ºåºæ‰§è¡Œä¸­é—´ä»¶ã€‚<a class="hash-link" href="#3-ç›‘å¬ç«¯å£3000è°ƒç”¨åŸå‹å¯¹è±¡æ–¹æ³•listenè¯¥æ–¹æ³•å†…éƒ¨ä¼šè°ƒç”¨nodeçš„httpæ¨¡å—è°ƒç”¨å®ä¾‹æ–¹æ³•thiscallbackç„¶åå°†è¿”å›ç»“æœä½œä¸ºhttpcreateserverçš„ä¼ å…¥å‚æ•°å³ä½œä¸ºç«¯å£è§¦å‘çš„requestäº‹ä»¶çš„å›è°ƒå‡½æ•°httpcreateserverè¿è¡Œåè¿”å›ä¸€ä¸ªhttpæœåŠ¡å™¨ç„¶åå°†è¯¥httpæœåŠ¡å™¨ç›‘å¬ç«¯å£3000åœ¨3000ç«¯å£æœ‰è¯·æ±‚çš„æ—¶å€™è§¦å‘nodeæœºåˆ¶çš„requestäº‹ä»¶å¹¶è°ƒç”¨thiscallbackè¿”å›çš„å‡½æ•°thiscallbackå‡½æ•°ä¼šå°†ä¸­é—´ä»¶å‡½æ•°ç»„ç»‡æˆæ´‹è‘±æ¨¡å‹å¹¶è¿”å›ä¸€ä¸ªæ‰§è¡Œå…¥å£å‡½æ•°ç”¨äºæŒ‰ç…§ç‰¹å®šé¡ºåºæ‰§è¡Œä¸­é—´ä»¶" title="Direct link to heading">#</a></h4><p>åœ¨æ‰§è¡Œthis.callback()å‡½æ•°çš„è¿‡ç¨‹ä¸­ï¼Œé¦–å…ˆä¼šè°ƒç”¨composeå‡½æ•°å¤„ç†ä¸­é—´ä»¶ï¼Œç„¶åè¿”å›handleRequestå‡½æ•°ï¼Œè¯¥å‡½æ•°æ˜¯requestäº‹ä»¶çš„å›è°ƒå‡½æ•°ï¼Œç”¨äºæ‰§è¡Œä¸­é—´ä»¶å¯¹reqä¸resè¿›è¡Œå¤„ç†ã€‚</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">  listen(...args) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    debug(&#x27;listen&#x27;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    const server = http.createServer(this.callback());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return server.listen(...args);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  callback() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //composeå‡½æ•°å°†ä¸­é—´ä»¶æ•°ç»„è½¬æ¢æˆæ‰§è¡Œé“¾å‡½æ•°fn</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    const fn = compose(this.middleware);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!this.listenerCount(&#x27;error&#x27;)) this.on(&#x27;error&#x27;, this.onerror);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    const handleRequest = (req, res) =&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      const ctx = this.createContext(req, res);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      return this.handleRequest(ctx, fn);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    };</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return handleRequest;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  handleRequest(ctx, fnMiddleware) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    const res = ctx.res;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    res.statusCode = 404;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    const onerror = err =&gt; ctx.onerror(err);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    const handleResponse = () =&gt; respond(ctx);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    onFinished(res, onerror);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return fnMiddleware(ctx).then(handleResponse).catch(onerror);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="composeå¦‚ä½•ç»„ç»‡ä¸­é—´ä»¶æ•°ç»„middleware"></a>composeå¦‚ä½•ç»„ç»‡ä¸­é—´ä»¶æ•°ç»„middleware<a class="hash-link" href="#composeå¦‚ä½•ç»„ç»‡ä¸­é—´ä»¶æ•°ç»„middleware" title="Direct link to heading">#</a></h3><p>å¦‚ä½•å®ç°ä¸€ä¸ªcomposeï¼Œè¯¥å‡½æ•°çš„åŠŸèƒ½æ˜¯æŒ‰é¡ºåºæ‰§è¡Œmiddlewareä¸­çš„ä¸­é—´ä»¶ï¼š</p><ol><li>å‡è®¾ä¸­é—´ä»¶å‡½æ•°éƒ½æ˜¯ä¸€æ­¥åˆ°åº•å…¨éƒ¨æ‰§è¡Œå®Œåå†æ‰§è¡Œä¸‹ä¸€ä¸ªä¸­é—´ä»¶</li><li>ä¸­é—´ä»¶å‡½æ•°é¦–å…ˆæ‰§è¡Œä¸€éƒ¨åˆ†ç„¶åæ‰§è¡Œå…¶ä»–ä¸­é—´ä»¶ï¼Œç„¶åå†å›æ¥æ‰§è¡Œæ‰§è¡Œå‰©ä¸‹çš„éƒ¨åˆ†ã€‚</li><li>ä¸­é—´ä»¶å‡½æ•°æ˜¯å¼‚æ­¥çš„æƒ…å†µ</li><li>é™åˆ¶ä¸€ä¸ªä¸­é—´ä»¶åªèƒ½æ‰§è¡Œä¸€æ¬¡</li><li>å…è®¸ä¸­é—´ä»¶æˆªè·ä¿¡æ¯ä»¥åŠå¤„ç†é”™è¯¯</li></ol><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="ä¸­é—´ä»¶å‡½æ•°éƒ½æ˜¯ä¸€æ­¥åˆ°åº•å…¨éƒ¨æ‰§è¡Œå®Œåå†æ‰§è¡Œä¸‹ä¸€ä¸ªä¸­é—´ä»¶"></a>ä¸­é—´ä»¶å‡½æ•°éƒ½æ˜¯ä¸€æ­¥åˆ°åº•å…¨éƒ¨æ‰§è¡Œå®Œåå†æ‰§è¡Œä¸‹ä¸€ä¸ªä¸­é—´ä»¶ï¼š<a class="hash-link" href="#ä¸­é—´ä»¶å‡½æ•°éƒ½æ˜¯ä¸€æ­¥åˆ°åº•å…¨éƒ¨æ‰§è¡Œå®Œåå†æ‰§è¡Œä¸‹ä¸€ä¸ªä¸­é—´ä»¶" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">function myCompose(ctx = [],middleware){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return dispatch(0)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    function dispatch(i){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        let fn = middleware[i];</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if(!fn) return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return fn(ctx, dispatch.bind(null,i+1));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">let fn0 = function(ctx,next){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(0);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx.push(0)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    next()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">let fn1 = function(ctx,next){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(1);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx.push(1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    next();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">let fn2 = function(ctx,next){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(2);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx.push(2)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    next();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">let middleware = [fn0,fn1,fn2]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">let ctx = []</span></span><span class="token-line" style="color:#393A34"><span class="token plain">myCompose(ctx,middleware);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">console.log(ctx);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="ä¸­é—´ä»¶å‡½æ•°é¦–å…ˆæ‰§è¡Œä¸€éƒ¨åˆ†ç„¶åæ‰§è¡Œå…¶ä»–ä¸­é—´ä»¶ç„¶åå†å›æ¥æ‰§è¡Œæ‰§è¡Œå‰©ä¸‹çš„éƒ¨åˆ†"></a>ä¸­é—´ä»¶å‡½æ•°é¦–å…ˆæ‰§è¡Œä¸€éƒ¨åˆ†ç„¶åæ‰§è¡Œå…¶ä»–ä¸­é—´ä»¶ï¼Œç„¶åå†å›æ¥æ‰§è¡Œæ‰§è¡Œå‰©ä¸‹çš„éƒ¨åˆ†<a class="hash-link" href="#ä¸­é—´ä»¶å‡½æ•°é¦–å…ˆæ‰§è¡Œä¸€éƒ¨åˆ†ç„¶åæ‰§è¡Œå…¶ä»–ä¸­é—´ä»¶ç„¶åå†å›æ¥æ‰§è¡Œæ‰§è¡Œå‰©ä¸‹çš„éƒ¨åˆ†" title="Direct link to heading">#</a></h4><p>ä¸Šé¢çš„ä»£ç èƒ½å¦å®ç°è¿™æ ·çš„ä¸€ä¸ªåŠŸèƒ½å‘¢ï¼Ÿæµ‹è¯•å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">let fn0 = function(ctx,next){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(0);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx.push(0)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    next()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(&quot;fn0&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">let fn1 = function(ctx,next){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(1);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx.push(1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    next();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(&quot;fn1&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">let fn2 = function(ctx,next){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(2);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx.push(2)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    next();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(&quot;fn2&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">let middleware = [fn0,fn1,fn2]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">let ctx = []</span></span><span class="token-line" style="color:#393A34"><span class="token plain">myCompose(ctx,middleware);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">console.log(ctx);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>è¿”å›çš„ç»“æœï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">0</span></span><span class="token-line" style="color:#393A34"><span class="token plain">1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">2</span></span><span class="token-line" style="color:#393A34"><span class="token plain">fn2</span></span><span class="token-line" style="color:#393A34"><span class="token plain">fn1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">fn0</span></span><span class="token-line" style="color:#393A34"><span class="token plain">(3) [0, 1, 2]</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>æ˜¾ç„¶ä¸Šé¢çš„myComposeå‡½æ•°æ˜¯å¯ä»¥å®ç°è¿™æ ·çš„åŠŸèƒ½çš„ã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="ä¸­é—´ä»¶å‡½æ•°æ˜¯å¼‚æ­¥çš„æƒ…å†µ"></a>ä¸­é—´ä»¶å‡½æ•°æ˜¯å¼‚æ­¥çš„æƒ…å†µ<a class="hash-link" href="#ä¸­é—´ä»¶å‡½æ•°æ˜¯å¼‚æ­¥çš„æƒ…å†µ" title="Direct link to heading">#</a></h4><p>æµ‹è¯•å¼‚æ­¥çš„æƒ…å†µï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">let fn0 = async function(ctx,next){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(0);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx.push(0)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    await next()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(&quot;fn0&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">let fn1 = async function(ctx,next){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(1);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx.push(1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    await next();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(&quot;fn1&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">let fn2 = async function(ctx,next){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(2);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx.push(2)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    await next();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(&quot;fn2&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">let middleware = [fn0,fn1,fn2]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">let ctx = []</span></span><span class="token-line" style="color:#393A34"><span class="token plain">myCompose(ctx,middleware);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">console.log(ctx);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>è¿”å›çš„ç»“æœï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">0</span></span><span class="token-line" style="color:#393A34"><span class="token plain">1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">2</span></span><span class="token-line" style="color:#393A34"><span class="token plain">(3) [0, 1, 2]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">fn2</span></span><span class="token-line" style="color:#393A34"><span class="token plain">fn1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">fn0</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="é™åˆ¶ä¸€ä¸ªä¸­é—´ä»¶åªèƒ½æ‰§è¡Œä¸€æ¬¡"></a>é™åˆ¶ä¸€ä¸ªä¸­é—´ä»¶åªèƒ½æ‰§è¡Œä¸€æ¬¡<a class="hash-link" href="#é™åˆ¶ä¸€ä¸ªä¸­é—´ä»¶åªèƒ½æ‰§è¡Œä¸€æ¬¡" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">function myCompose(ctx = [],middleware){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return dispatch(0)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    function dispatch(i){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        let fn = middleware[i];</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if(!fn) return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return fn(ctx, dispatch.bind(null,i+1));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">let fn0 = async function(ctx,next){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(0);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx.push(0)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    await next()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    await next()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(&quot;fn0&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">let fn1 = async function(ctx,next){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(1);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx.push(1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    await next();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(&quot;fn1&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">let fn2 = async function(ctx,next){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(2);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx.push(2)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    await next();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(&quot;fn2&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">let middleware = [fn0,fn1,fn2]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">let ctx = []</span></span><span class="token-line" style="color:#393A34"><span class="token plain">myCompose(ctx,middleware);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">console.log(ctx);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>è¿”å›çš„ç»“æœï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">0</span></span><span class="token-line" style="color:#393A34"><span class="token plain">1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">2</span></span><span class="token-line" style="color:#393A34"><span class="token plain">(3) [0, 1, 2]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">fn2</span></span><span class="token-line" style="color:#393A34"><span class="token plain">fn1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">2</span></span><span class="token-line" style="color:#393A34"><span class="token plain">fn2</span></span><span class="token-line" style="color:#393A34"><span class="token plain">fn1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">fn0</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>åœ¨fn0å‡½æ•°ä¸­è°ƒç”¨äº†ä¸¤æ¬¡next()ï¼Œè¿™æ ·ä¼šå¯¼è‡´é‡æ–°æ‰§è¡Œäº†fn0åé¢çš„æ‰€æœ‰ä¸­é—´ä»¶å‡½æ•°ã€‚ä¸ºäº†é¿å…è¿™æ ·æƒ…å†µçš„å‘ç”Ÿï¼Œéœ€è¦é™åˆ¶ä¸€ä¸ªä¸­é—´ä»¶åªèƒ½æ‰§è¡Œä¸€æ¬¡ã€‚myComposeå‡½æ•°æ˜¯é€šè¿‡è°ƒç”¨dispatchå‡½æ•°æ¥æ‰§è¡Œä¸­é—´ä»¶å‡½æ•°çš„ï¼Œå› æ­¤å¯ä»¥é€šè¿‡é˜»æ­¢dispatchå‡½æ•°æ¥é˜»æ­¢ä¸­é—´ä»¶å‡½æ•°çš„æ‰§è¡Œã€‚ä»myComposeå‡½æ•°å¯çŸ¥ï¼Œåœ¨ä¸­é—´ä»¶å‡½æ•°ä¸­æ‰§è¡Œåˆ°ç¬¬äºŒæ¬¡nextçš„æ—¶å€™ï¼Œå¿…å®šå·²ç»è°ƒç”¨äº†middleware.lengthæ¬¡dispatchï¼Œå³æ‰§è¡Œè¿‡äº†æ‰€æœ‰ä¸­é—´ä»¶å‡½æ•°nextä¹‹å‰çš„é€»è¾‘ã€‚æ‰§è¡Œnext()å‡½æ•°å…¶å®å°±æ˜¯æ‰§è¡Œ<code>dispatch.bind(null, i + 1)</code> ï¼Œç”±æ­¤å¯ä»¥çœ‹å‡ºï¼Œæ¯ä¸ªä¸­é—´ä»¶å‡½æ•°æ‰§è¡Œç¬¬äºŒæ¬¡ next çš„å‡½æ•°çš„æ—¶å€™ï¼Œä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯ i+1 ï¼Œi+1 çš„èŒƒå›´æ˜¯[0,3]ã€‚å› æ­¤å¯ä»¥è®°å½•ä¸€ä¸‹å·²ç»æ‰§è¡Œäº†å¤šå°‘æ¬¡dispatchåˆ°indexä¸­ï¼Œç„¶åæ¯æ¬¡dispatchçš„æ—¶å€™æ¯”è¾ƒç¬¬ä¸€ä¸ªå‚æ•° i+1 ä¸ index çš„å€¼ï¼Œæ¥åˆ¤æ–­æ˜¯å¦å­˜åœ¨åŒä¸€ä¸ªä¸­é—´ä»¶å‡½æ•°è¢«æ‰§è¡Œäº†å¤šæ¬¡çš„æƒ…å†µã€‚å› æ­¤ä¿®æ”¹åmyComposeå¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">function myCompose(ctx = [],middleware){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    let index = -1;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return dispatch(0)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    function dispatch(i){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if(i &lt;= index) return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        index = i;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        let fn = middleware[i];</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if(!fn) return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return fn(ctx, dispatch.bind(null,i+1));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>è¿”å›çš„ç»“æœï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">0</span></span><span class="token-line" style="color:#393A34"><span class="token plain">1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">2</span></span><span class="token-line" style="color:#393A34"><span class="token plain">(3) [0, 1, 2]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">fn2</span></span><span class="token-line" style="color:#393A34"><span class="token plain">fn1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">fn0</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="å…è®¸ä¸­é—´ä»¶æˆªè·ä¿¡æ¯ä»¥åŠå¤„ç†é”™è¯¯"></a>å…è®¸ä¸­é—´ä»¶æˆªè·ä¿¡æ¯ä»¥åŠå¤„ç†é”™è¯¯<a class="hash-link" href="#å…è®¸ä¸­é—´ä»¶æˆªè·ä¿¡æ¯ä»¥åŠå¤„ç†é”™è¯¯" title="Direct link to heading">#</a></h4><p>å¯¹äºä¸€ä¸ªä¸­é—´ä»¶è€Œè¨€ï¼Œæ¯”å¦‚</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">let fn0 = async function(ctx,next){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(0);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx.push(0)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    await next()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(&quot;fn0&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>å¦‚æœä¸‹ä¸€ä¸ªä¸­é—´ä»¶å‡ºç°äº†é—®é¢˜ï¼Œæˆ–è€…fn0ä¸­é—´ä»¶å‡½æ•°éœ€è¦ä¸‹ä¸€ä¸ªä¸­é—´ä»¶å‡½æ•°è¿”å›ä¸€äº›æ•°æ®è¿›è¡Œå¤„ç†ï¼Œé‚£ä¹ˆå¦‚ä½•å®ç°å‘¢ï¼Ÿåˆ©ç”¨promise.resolveä»¥åŠrejectæ¥å¤„ç†æ•°æ®ä»¥åŠé”™è¯¯ä¿¡æ¯ã€‚ä¿®æ”¹åçš„ä»£ç ä¸ºï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">function myCompose(ctx = [],middleware){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    let index = -1;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return dispatch(0)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    function dispatch(i){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if(i &lt;= index) return Promise.reject(new Error(&#x27;next() called multiple times in a middleware&#x27;));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        index = i;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        let fn = middleware[i];</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if(!fn) return Promise.resolve();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Promise.resolve(fn(ctx, dispatch.bind(null,i+1)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>å¦‚æœreturn Promise.resolve(fn(context, dispatch.bind(null, i + 1)));å‡ºç°é”™è¯¯ï¼Œåˆ©ç”¨try-catchè¿›è¡Œæ•è·å¹¶ä¸”å°†é”™è¯¯ä¿¡æ¯rejectåˆ°ä¸Šå±‚ä¸­é—´ä»¶ã€‚ä¿®æ”¹åçš„ä»£ç ä¸ºï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">function myCompose(ctx = [],middleware){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    let index = -1;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return dispatch(0)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    function dispatch(i){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if(i &lt;= index) return Promise.reject(new Error(&#x27;next() called multiple times in a middleware&#x27;));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        index = i;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        let fn = middleware[i];</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if(!fn) return Promise.resolve();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return Promise.resolve(fn(ctx, dispatch.bind(null,i+1)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch(err){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return Promise.reject(err)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>å®˜æ–¹ç»™å‡ºçš„composeå®ç°å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">function compose (middleware) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!Array.isArray(middleware)) throw new TypeError(&#x27;Middleware stack must be an array!&#x27;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (const fn of middleware) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (typeof fn !== &#x27;function&#x27;) throw new TypeError(&#x27;Middleware must be composed of functions!&#x27;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param {Object} context</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return {Promise}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @api public</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return function (context, next) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // last called middleware #</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        let index = -1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return dispatch(0)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        function dispatch (i) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (i &lt;= index) return Promise.reject(new Error(&#x27;next() called multiple times&#x27;))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            index = i</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            let fn = middleware[i]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (i === middleware.length) fn = next</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!fn) return Promise.resolve()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return Promise.resolve(fn(context, dispatch.bind(null, i + 1)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (err) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return Promise.reject(err)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>ä¸ä¹‹å‰çš„myComposeç‰ˆæœ¬æ¯”è¾ƒå¤šäº†ä¸€ä¸ªif (i === middleware.length) fn = next;è¿™æ ·å¤„ç†æ˜¯ä¸ºäº†æ£€æµ‹å¦‚æœæ‰§è¡Œåˆ°middlewareæœ€åä¸€ä¸ªä¸­é—´ä»¶ï¼Œåˆ™å°†compose(this.middleware)(ctx,fnLast);ä¸­çš„fnLastæœ€ä¸ºæœ€åä¸€ä¸ªä¸­é—´ä»¶ã€‚koaæºç ä¸­è¿™ä¸ªnextä¸ºundefinedã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="å¤„ç†requesäº‹ä»¶"></a>å¤„ç†requesäº‹ä»¶<a class="hash-link" href="#å¤„ç†requesäº‹ä»¶" title="Direct link to heading">#</a></h3><p>å½“ç›‘å¬åˆ°3000ç«¯å£æœ‰è¯·æ±‚è¿‡æ¥çš„æ—¶å€™ï¼Œè§¦å‘requestäº‹ä»¶ï¼Œç„¶åå¼€å§‹æ‰§è¡Œå„ä¸ªä¸­é—´ä»¶ï¼Œå®é™…åœ¨ä¹‹å‰å®ç°myComposeå‡½æ•°çš„è¿‡ç¨‹ä¸­å¯ä»¥çœ‹å‡ºä¸­é—´ä»¶æ‰§è¡Œçš„é¡ºåºã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="æ€»ç»“"></a>æ€»ç»“<a class="hash-link" href="#æ€»ç»“" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">const Koa = require(&#x27;koa&#x27;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">const app = new Koa();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// logger</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">app.use(async (ctx, next) =&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  await next();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  const rt = ctx.response.get(&#x27;X-Response-Time&#x27;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  console.log(`${ctx.method} ${ctx.url} - ${rt}`);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">});</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// x-response-time</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">app.use(async (ctx, next) =&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  const start = Date.now();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  await next();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  const ms = Date.now() - start;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  ctx.set(&#x27;X-Response-Time&#x27;, `${ms}ms`);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">});</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// response</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">app.use(async ctx =&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  ctx.body = &#x27;Hello World&#x27;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">});</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">app.listen(3000);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>è¿™é‡Œä¸­é—´ä»¶çº§è”çš„æ–¹å¼å¯¹ctxè¿›è¡Œé€æ­¥å¤„ç†ï¼Œæ ¹æ®compose.jså¯çŸ¥ä¼ å…¥ä¸­é—´ä»¶çš„nextå…¶å®å°±æ˜¯ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">dispatch.bind(null, i + 1)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="å·¥ä½œåŸç†"></a>å·¥ä½œåŸç†<a class="hash-link" href="#å·¥ä½œåŸç†" title="Direct link to heading">#</a></h4><ol><li>åˆ›å»ºä¸€ä¸ªkoaå¯¹è±¡ï¼Œç„¶åè°ƒç”¨use(fn)å°†fn pushåˆ°è¯¥koaå¯¹è±¡çš„ä¸­é—´ä»¶æ•°ç»„ä¸­</li><li>æ¥ç€è°ƒç”¨listenåˆ›å»ºä¸€ä¸ªæœåŠ¡å™¨å®¹å™¨ï¼Œç„¶åè°ƒç”¨this.callback()ï¼Œç„¶åç›‘å¬æŒ‡å®šç«¯å£</li><li>this.callback()é¦–å…ˆä¼šè°ƒç”¨composeå¯¹ä¸­é—´ä»¶æ•°ç»„è¿›è¡Œå¤„ç†ï¼Œè¿”å›ä¸€ä¸ªæ´‹è‘±æ¨¡å‹çš„å…¥å£å‡½æ•°ã€‚ç„¶åè¿”å›ä¸€ä¸ªhandleRequest</li><li>handleRequestå‡½æ•°ä¼šåœ¨ç›‘å¬åˆ°ç«¯å£æœ‰è¯·æ±‚çš„æ—¶å€™è°ƒç”¨ï¼Œè¯¥å‡½æ•°æœ€ç»ˆä¼šè°ƒç”¨æ´‹è‘±æ¨¡å‹çš„å…¥å£å‡½æ•°ã€‚</li><li>handleRequestå‡½æ•°æ¥æ”¶ä¸¤ä¸ªå‚æ•°req, resï¼›è¯¥å‡½æ•°æ‰§è¡Œçš„æ—¶å€™é¦–å…ˆä¼šæ ¹æ®ä¼ å…¥çš„req, resåˆ›å»ºä¸€ä¸ªctxï¼›ç„¶åè°ƒç”¨koaå¯¹è±¡çš„handleRequestå‡½æ•°ï¼Œå°†ç»“æœè¿”å›ã€‚</li><li>koaå¯¹è±¡çš„handleRequestå‡½æ•°æ¥æ”¶ä¸¤ä¸ªå‚æ•°(ctx, fn)ï¼Œctxå°±æ˜¯æ ¹æ®req, resåˆ›å»ºçš„ctxï¼Œfnå°±æ˜¯è°ƒç”¨composeè¿”å›çš„æ´‹è‘±æ¨¡å‹å…¥å£å‡½æ•°ã€‚ koaå¯¹è±¡çš„handleRequestå‡½æ•°æœ€ç»ˆä¼šè°ƒç”¨fn(ctx)</li></ol><p>åœ¨ä¸­é—´ä»¶éœ€è¦çº§è”çš„æ—¶å€™ï¼Œéœ€è¦ç»™ä¸­é—´ä»¶ä¼ å…¥ç¬¬äºŒä¸ªå‚æ•°next</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="æŠ€å·§"></a>æŠ€å·§<a class="hash-link" href="#æŠ€å·§" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">let fn0 = async function(ctx,next){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(0);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx.push(0)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    await next()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    await next().catch(err=&gt;console.log(err))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(&quot;fn0&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>æ³¨æ„è¿™é‡Œï¼Œä¸­é—´ä»¶ç³»ç»Ÿå¸¦æ¥çš„é—®é¢˜ï¼Œä¸­é—´ä»¶å¯ä»¥éšæ„ç»™ctxå®šä¹‰å®ä¾‹æ–¹æ³•ä»¥åŠå±æ€§ï¼Œè¿™æ ·ä¼šå¯¼è‡´ä¸­é—´ä»¶ä¹‹é—´çš„è¦†ç›–çš„é—®é¢˜ï¼Œå¾ˆéš¾æ£€æŸ¥ä¸é”™è¯¯ã€‚é€šè¿‡åœ¨ä¸­é—´ä»¶å¯¹nextè¿›è¡Œcatchæ¥è¿›è¡Œé”™è¯¯æ£€æŸ¥ã€‚ </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">await next().catch(err=&gt;console.log(err))</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>ä¼šæ‰“å°é”™è¯¯ï¼Œä½†æ˜¯ç¨‹åºä¸ä¼šcrashæ‰ã€‚</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/ReactNote/blog/tags/node-koa">node koa</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/ReactNote/blog/blog-post">koa code analyse</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2021-09-30T00:00:00.000Z" itemprop="datePublished">September 30, 2021</time> Â· 13 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://github.com/BUPTlhuanyu" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://github.com/BUPTlhuanyu.png" alt="liaohuanyu"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/BUPTlhuanyu" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">liaohuanyu</span></a></div><small class="avatar__subtitle" itemprop="description">Maintainer of ReactNote</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><blockquote><p><a href="https://koa.bootcss.com/" target="_blank" rel="noopener noreferrer">Koa2å®˜ç½‘</a> â€”â€”&gt; <a href="https://github.com/koajs/koa" target="_blank" rel="noopener noreferrer">githubåœ°å€</a></p></blockquote><blockquote><p><a href="https://chenshenhai.github.io/koa2-note/" target="_blank" rel="noopener noreferrer">Koa2è¿›é˜¶å­¦ä¹ ç¬”è®°</a> â€”â€”&gt; <a href="https://github.com/chenshenhai/koa2-note" target="_blank" rel="noopener noreferrer">githubåœ°å€</a></p></blockquote><blockquote><p><a href="https://chenshenhai.github.io/koajs-design-note/" target="_blank" rel="noopener noreferrer">Koa.js è®¾è®¡æ¨¡å¼-å­¦ä¹ ç¬”è®°</a> â€”â€”&gt; <a href="https://github.com/chenshenhai/koajs-design-note" target="_blank" rel="noopener noreferrer">githubåœ°å€</a></p></blockquote><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="koaç±»çš„ç»“æ„"></a>koaç±»çš„ç»“æ„<a class="hash-link" href="#koaç±»çš„ç»“æ„" title="Direct link to heading">#</a></h2><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">module.exports = class Application extends Emitterï½›</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    constructor() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    super();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.proxy = false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.middleware = [];</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.subdomainOffset = 2;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.context = Object.create(context);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.request = Object.create(request);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.response = Object.create(response);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  listen(...args) {...}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  toJSON() {...}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  inspect() {...}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  use(fn) {...}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  callback() {...}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  handleRequest(ctx, fnMiddleware) {...}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  createContext(req, res) {...}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  onerror(err) {...}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">ï½</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="ç®€å•ç¤ºä¾‹å‡ºå‘"></a>ç®€å•ç¤ºä¾‹å‡ºå‘<a class="hash-link" href="#ç®€å•ç¤ºä¾‹å‡ºå‘" title="Direct link to heading">#</a></h2><p>å¦‚ä¸‹ä¸ºå®˜æ–¹ç»™å‡ºçš„çº§è”å½¢å¼çš„<code>koa</code>ç¤ºä¾‹ï¼Œ</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">const Koa = require(&#x27;koa&#x27;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">const app = new Koa();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// logger</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">app.use(async (ctx, next) =&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  await next();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  const rt = ctx.response.get(&#x27;X-Response-Time&#x27;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  console.log(`${ctx.method} ${ctx.url} - ${rt}`);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">});</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// x-response-time</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">app.use(async (ctx, next) =&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  const start = Date.now();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  await next();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  const ms = Date.now() - start;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  ctx.set(&#x27;X-Response-Time&#x27;, `${ms}ms`);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">});</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// response</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">app.use(async ctx =&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  ctx.body = &#x27;Hello World&#x27;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">});</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">app.listen(3000);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>ä¸Šè¿°ç¤ºä¾‹çš„å·¥ä½œè¿‡ç¨‹å¯ä»¥åˆ†ä¸ºå‡†å¤‡é˜¶æ®µä¸å¤„ç†requesäº‹ä»¶è¿™ä¸¤ä¸ªé˜¶æ®µã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="å‡†å¤‡é˜¶æ®µ"></a>å‡†å¤‡é˜¶æ®µ<a class="hash-link" href="#å‡†å¤‡é˜¶æ®µ" title="Direct link to heading">#</a></h3><p>å‡†å¤‡é˜¶æ®µä¼šåˆ›å»ºkoaå®ä¾‹ï¼Œæ³¨å†Œä¸­é—´ä»¶ï¼Œç›‘å¬æŒ‡å®šç«¯å£ï¼Œä¸­é—´ä»¶çš„å¤„ç†æ–¹å¼ä¸ºæ´‹è‘±æ¨¡å‹è®¾è®¡æ¨¡å¼ï¼š</p><ol><li>åˆ›å»ºä¸€ä¸ª<code>koa</code>å®ä¾‹ä¸º<code>app</code>;</li><li>æ³¨å†Œ<code>logger</code>ä¸­é—´ä»¶ï¼Œä¹Ÿå°±æ˜¯å°†ä¸­é—´ä»¶å‡½æ•°æ·»åŠ åˆ°ä¸€ä¸ªåä¸º<code>middleware</code>çš„æ•°ç»„ä¸­ã€‚</li><li>æ³¨å†Œ<code>x-response-time</code>ä¸­é—´ä»¶ã€‚</li><li>æ³¨å†Œ<code>response</code>ä¸­é—´ä»¶ã€‚</li><li>ç›‘å¬3000ç«¯å£ã€‚</li></ol><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="1-åˆ›å»ºkoaå®ä¾‹è°ƒç”¨constructorå®šä¹‰å®ä¾‹å±æ€§middlewareç­‰ç­‰"></a>1. åˆ›å»ºkoaå®ä¾‹ï¼Œè°ƒç”¨constructorï¼Œå®šä¹‰å®ä¾‹å±æ€§middlewareç­‰ç­‰<a class="hash-link" href="#1-åˆ›å»ºkoaå®ä¾‹è°ƒç”¨constructorå®šä¹‰å®ä¾‹å±æ€§middlewareç­‰ç­‰" title="Direct link to heading">#</a></h4><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="2-koaå®ä¾‹çš„koaç±»çš„åŸå‹å¯¹è±¡æ–¹æ³•useæ·»åŠ ä¸­é—´ä»¶useæ–¹æ³•åªæ˜¯ç®€å•çš„å°†ä¸­é—´ä»¶æ·»åŠ åˆ°å®ä¾‹çš„å±æ€§middlewareæ•°ç»„ä¸­ç„¶åè¿”å›å®ä¾‹è‡ªèº«çš„this"></a>2. koaå®ä¾‹çš„koaç±»çš„åŸå‹å¯¹è±¡æ–¹æ³•useæ·»åŠ ä¸­é—´ä»¶ï¼Œuseæ–¹æ³•åªæ˜¯ç®€å•çš„å°†ä¸­é—´ä»¶æ·»åŠ åˆ°å®ä¾‹çš„å±æ€§middlewareæ•°ç»„ä¸­ï¼Œç„¶åè¿”å›å®ä¾‹è‡ªèº«çš„thisã€‚<a class="hash-link" href="#2-koaå®ä¾‹çš„koaç±»çš„åŸå‹å¯¹è±¡æ–¹æ³•useæ·»åŠ ä¸­é—´ä»¶useæ–¹æ³•åªæ˜¯ç®€å•çš„å°†ä¸­é—´ä»¶æ·»åŠ åˆ°å®ä¾‹çš„å±æ€§middlewareæ•°ç»„ä¸­ç„¶åè¿”å›å®ä¾‹è‡ªèº«çš„this" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">  use(fn) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (typeof fn !== &#x27;function&#x27;) throw new TypeError(&#x27;middleware must be a function!&#x27;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    debug(&#x27;use %s&#x27;, fn._name || fn.name || &#x27;-&#x27;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.middleware.push(fn);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return this;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="3-ç›‘å¬ç«¯å£3000è°ƒç”¨åŸå‹å¯¹è±¡æ–¹æ³•listenè¯¥æ–¹æ³•å†…éƒ¨ä¼šè°ƒç”¨nodeçš„httpæ¨¡å—è°ƒç”¨å®ä¾‹æ–¹æ³•thiscallbackç„¶åå°†è¿”å›ç»“æœä½œä¸ºhttpcreateserverçš„ä¼ å…¥å‚æ•°å³ä½œä¸ºç«¯å£è§¦å‘çš„requestäº‹ä»¶çš„å›è°ƒå‡½æ•°httpcreateserverè¿è¡Œåè¿”å›ä¸€ä¸ªhttpæœåŠ¡å™¨ç„¶åå°†è¯¥httpæœåŠ¡å™¨ç›‘å¬ç«¯å£3000åœ¨3000ç«¯å£æœ‰è¯·æ±‚çš„æ—¶å€™è§¦å‘nodeæœºåˆ¶çš„requestäº‹ä»¶å¹¶è°ƒç”¨thiscallbackè¿”å›çš„å‡½æ•°thiscallbackå‡½æ•°ä¼šå°†ä¸­é—´ä»¶å‡½æ•°ç»„ç»‡æˆæ´‹è‘±æ¨¡å‹å¹¶è¿”å›ä¸€ä¸ªæ‰§è¡Œå…¥å£å‡½æ•°ç”¨äºæŒ‰ç…§ç‰¹å®šé¡ºåºæ‰§è¡Œä¸­é—´ä»¶"></a>3. ç›‘å¬ç«¯å£3000ï¼Œè°ƒç”¨åŸå‹å¯¹è±¡æ–¹æ³•listenï¼Œè¯¥æ–¹æ³•å†…éƒ¨ä¼šè°ƒç”¨nodeçš„httpæ¨¡å—ï¼Œè°ƒç”¨å®ä¾‹æ–¹æ³•this.callbackï¼Œç„¶åå°†è¿”å›ç»“æœä½œä¸ºhttp.createServerçš„ä¼ å…¥å‚æ•°å³ä½œä¸ºç«¯å£è§¦å‘çš„requestäº‹ä»¶çš„å›è°ƒå‡½æ•°ã€‚http.createServerè¿è¡Œåè¿”å›ä¸€ä¸ªhttpæœåŠ¡å™¨ï¼Œç„¶åå°†è¯¥httpæœåŠ¡å™¨ç›‘å¬ç«¯å£3000ã€‚åœ¨3000ç«¯å£æœ‰è¯·æ±‚çš„æ—¶å€™ï¼Œè§¦å‘nodeæœºåˆ¶çš„requestäº‹ä»¶ï¼Œå¹¶è°ƒç”¨this.callback()è¿”å›çš„å‡½æ•°ã€‚this.callbackå‡½æ•°ä¼šå°†ä¸­é—´ä»¶å‡½æ•°ç»„ç»‡æˆæ´‹è‘±æ¨¡å‹ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ‰§è¡Œå…¥å£å‡½æ•°ï¼Œç”¨äºæŒ‰ç…§ç‰¹å®šé¡ºåºæ‰§è¡Œä¸­é—´ä»¶ã€‚<a class="hash-link" href="#3-ç›‘å¬ç«¯å£3000è°ƒç”¨åŸå‹å¯¹è±¡æ–¹æ³•listenè¯¥æ–¹æ³•å†…éƒ¨ä¼šè°ƒç”¨nodeçš„httpæ¨¡å—è°ƒç”¨å®ä¾‹æ–¹æ³•thiscallbackç„¶åå°†è¿”å›ç»“æœä½œä¸ºhttpcreateserverçš„ä¼ å…¥å‚æ•°å³ä½œä¸ºç«¯å£è§¦å‘çš„requestäº‹ä»¶çš„å›è°ƒå‡½æ•°httpcreateserverè¿è¡Œåè¿”å›ä¸€ä¸ªhttpæœåŠ¡å™¨ç„¶åå°†è¯¥httpæœåŠ¡å™¨ç›‘å¬ç«¯å£3000åœ¨3000ç«¯å£æœ‰è¯·æ±‚çš„æ—¶å€™è§¦å‘nodeæœºåˆ¶çš„requestäº‹ä»¶å¹¶è°ƒç”¨thiscallbackè¿”å›çš„å‡½æ•°thiscallbackå‡½æ•°ä¼šå°†ä¸­é—´ä»¶å‡½æ•°ç»„ç»‡æˆæ´‹è‘±æ¨¡å‹å¹¶è¿”å›ä¸€ä¸ªæ‰§è¡Œå…¥å£å‡½æ•°ç”¨äºæŒ‰ç…§ç‰¹å®šé¡ºåºæ‰§è¡Œä¸­é—´ä»¶" title="Direct link to heading">#</a></h4><p>åœ¨æ‰§è¡Œthis.callback()å‡½æ•°çš„è¿‡ç¨‹ä¸­ï¼Œé¦–å…ˆä¼šè°ƒç”¨composeå‡½æ•°å¤„ç†ä¸­é—´ä»¶ï¼Œç„¶åè¿”å›handleRequestå‡½æ•°ï¼Œè¯¥å‡½æ•°æ˜¯requestäº‹ä»¶çš„å›è°ƒå‡½æ•°ï¼Œç”¨äºæ‰§è¡Œä¸­é—´ä»¶å¯¹reqä¸resè¿›è¡Œå¤„ç†ã€‚</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">  listen(...args) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    debug(&#x27;listen&#x27;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    const server = http.createServer(this.callback());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return server.listen(...args);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  callback() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //composeå‡½æ•°å°†ä¸­é—´ä»¶æ•°ç»„è½¬æ¢æˆæ‰§è¡Œé“¾å‡½æ•°fn</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    const fn = compose(this.middleware);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!this.listenerCount(&#x27;error&#x27;)) this.on(&#x27;error&#x27;, this.onerror);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    const handleRequest = (req, res) =&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      const ctx = this.createContext(req, res);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      return this.handleRequest(ctx, fn);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    };</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return handleRequest;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  handleRequest(ctx, fnMiddleware) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    const res = ctx.res;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    res.statusCode = 404;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    const onerror = err =&gt; ctx.onerror(err);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    const handleResponse = () =&gt; respond(ctx);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    onFinished(res, onerror);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return fnMiddleware(ctx).then(handleResponse).catch(onerror);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="composeå¦‚ä½•ç»„ç»‡ä¸­é—´ä»¶æ•°ç»„middleware"></a>composeå¦‚ä½•ç»„ç»‡ä¸­é—´ä»¶æ•°ç»„middleware<a class="hash-link" href="#composeå¦‚ä½•ç»„ç»‡ä¸­é—´ä»¶æ•°ç»„middleware" title="Direct link to heading">#</a></h3><p>å¦‚ä½•å®ç°ä¸€ä¸ªcomposeï¼Œè¯¥å‡½æ•°çš„åŠŸèƒ½æ˜¯æŒ‰é¡ºåºæ‰§è¡Œmiddlewareä¸­çš„ä¸­é—´ä»¶ï¼š</p><ol><li>å‡è®¾ä¸­é—´ä»¶å‡½æ•°éƒ½æ˜¯ä¸€æ­¥åˆ°åº•å…¨éƒ¨æ‰§è¡Œå®Œåå†æ‰§è¡Œä¸‹ä¸€ä¸ªä¸­é—´ä»¶</li><li>ä¸­é—´ä»¶å‡½æ•°é¦–å…ˆæ‰§è¡Œä¸€éƒ¨åˆ†ç„¶åæ‰§è¡Œå…¶ä»–ä¸­é—´ä»¶ï¼Œç„¶åå†å›æ¥æ‰§è¡Œæ‰§è¡Œå‰©ä¸‹çš„éƒ¨åˆ†ã€‚</li><li>ä¸­é—´ä»¶å‡½æ•°æ˜¯å¼‚æ­¥çš„æƒ…å†µ</li><li>é™åˆ¶ä¸€ä¸ªä¸­é—´ä»¶åªèƒ½æ‰§è¡Œä¸€æ¬¡</li><li>å…è®¸ä¸­é—´ä»¶æˆªè·ä¿¡æ¯ä»¥åŠå¤„ç†é”™è¯¯</li></ol><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="ä¸­é—´ä»¶å‡½æ•°éƒ½æ˜¯ä¸€æ­¥åˆ°åº•å…¨éƒ¨æ‰§è¡Œå®Œåå†æ‰§è¡Œä¸‹ä¸€ä¸ªä¸­é—´ä»¶"></a>ä¸­é—´ä»¶å‡½æ•°éƒ½æ˜¯ä¸€æ­¥åˆ°åº•å…¨éƒ¨æ‰§è¡Œå®Œåå†æ‰§è¡Œä¸‹ä¸€ä¸ªä¸­é—´ä»¶ï¼š<a class="hash-link" href="#ä¸­é—´ä»¶å‡½æ•°éƒ½æ˜¯ä¸€æ­¥åˆ°åº•å…¨éƒ¨æ‰§è¡Œå®Œåå†æ‰§è¡Œä¸‹ä¸€ä¸ªä¸­é—´ä»¶" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">function myCompose(ctx = [],middleware){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return dispatch(0)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    function dispatch(i){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        let fn = middleware[i];</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if(!fn) return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return fn(ctx, dispatch.bind(null,i+1));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">let fn0 = function(ctx,next){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(0);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx.push(0)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    next()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">let fn1 = function(ctx,next){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(1);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx.push(1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    next();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">let fn2 = function(ctx,next){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(2);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx.push(2)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    next();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">let middleware = [fn0,fn1,fn2]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">let ctx = []</span></span><span class="token-line" style="color:#393A34"><span class="token plain">myCompose(ctx,middleware);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">console.log(ctx);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="ä¸­é—´ä»¶å‡½æ•°é¦–å…ˆæ‰§è¡Œä¸€éƒ¨åˆ†ç„¶åæ‰§è¡Œå…¶ä»–ä¸­é—´ä»¶ç„¶åå†å›æ¥æ‰§è¡Œæ‰§è¡Œå‰©ä¸‹çš„éƒ¨åˆ†"></a>ä¸­é—´ä»¶å‡½æ•°é¦–å…ˆæ‰§è¡Œä¸€éƒ¨åˆ†ç„¶åæ‰§è¡Œå…¶ä»–ä¸­é—´ä»¶ï¼Œç„¶åå†å›æ¥æ‰§è¡Œæ‰§è¡Œå‰©ä¸‹çš„éƒ¨åˆ†<a class="hash-link" href="#ä¸­é—´ä»¶å‡½æ•°é¦–å…ˆæ‰§è¡Œä¸€éƒ¨åˆ†ç„¶åæ‰§è¡Œå…¶ä»–ä¸­é—´ä»¶ç„¶åå†å›æ¥æ‰§è¡Œæ‰§è¡Œå‰©ä¸‹çš„éƒ¨åˆ†" title="Direct link to heading">#</a></h4><p>ä¸Šé¢çš„ä»£ç èƒ½å¦å®ç°è¿™æ ·çš„ä¸€ä¸ªåŠŸèƒ½å‘¢ï¼Ÿæµ‹è¯•å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">let fn0 = function(ctx,next){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(0);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx.push(0)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    next()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(&quot;fn0&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">let fn1 = function(ctx,next){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(1);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx.push(1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    next();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(&quot;fn1&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">let fn2 = function(ctx,next){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(2);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx.push(2)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    next();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(&quot;fn2&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">let middleware = [fn0,fn1,fn2]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">let ctx = []</span></span><span class="token-line" style="color:#393A34"><span class="token plain">myCompose(ctx,middleware);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">console.log(ctx);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>è¿”å›çš„ç»“æœï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">0</span></span><span class="token-line" style="color:#393A34"><span class="token plain">1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">2</span></span><span class="token-line" style="color:#393A34"><span class="token plain">fn2</span></span><span class="token-line" style="color:#393A34"><span class="token plain">fn1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">fn0</span></span><span class="token-line" style="color:#393A34"><span class="token plain">(3) [0, 1, 2]</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>æ˜¾ç„¶ä¸Šé¢çš„myComposeå‡½æ•°æ˜¯å¯ä»¥å®ç°è¿™æ ·çš„åŠŸèƒ½çš„ã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="ä¸­é—´ä»¶å‡½æ•°æ˜¯å¼‚æ­¥çš„æƒ…å†µ"></a>ä¸­é—´ä»¶å‡½æ•°æ˜¯å¼‚æ­¥çš„æƒ…å†µ<a class="hash-link" href="#ä¸­é—´ä»¶å‡½æ•°æ˜¯å¼‚æ­¥çš„æƒ…å†µ" title="Direct link to heading">#</a></h4><p>æµ‹è¯•å¼‚æ­¥çš„æƒ…å†µï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">let fn0 = async function(ctx,next){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(0);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx.push(0)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    await next()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(&quot;fn0&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">let fn1 = async function(ctx,next){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(1);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx.push(1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    await next();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(&quot;fn1&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">let fn2 = async function(ctx,next){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(2);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx.push(2)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    await next();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(&quot;fn2&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">let middleware = [fn0,fn1,fn2]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">let ctx = []</span></span><span class="token-line" style="color:#393A34"><span class="token plain">myCompose(ctx,middleware);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">console.log(ctx);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>è¿”å›çš„ç»“æœï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">0</span></span><span class="token-line" style="color:#393A34"><span class="token plain">1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">2</span></span><span class="token-line" style="color:#393A34"><span class="token plain">(3) [0, 1, 2]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">fn2</span></span><span class="token-line" style="color:#393A34"><span class="token plain">fn1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">fn0</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="é™åˆ¶ä¸€ä¸ªä¸­é—´ä»¶åªèƒ½æ‰§è¡Œä¸€æ¬¡"></a>é™åˆ¶ä¸€ä¸ªä¸­é—´ä»¶åªèƒ½æ‰§è¡Œä¸€æ¬¡<a class="hash-link" href="#é™åˆ¶ä¸€ä¸ªä¸­é—´ä»¶åªèƒ½æ‰§è¡Œä¸€æ¬¡" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">function myCompose(ctx = [],middleware){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return dispatch(0)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    function dispatch(i){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        let fn = middleware[i];</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if(!fn) return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return fn(ctx, dispatch.bind(null,i+1));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">let fn0 = async function(ctx,next){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(0);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx.push(0)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    await next()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    await next()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(&quot;fn0&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">let fn1 = async function(ctx,next){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(1);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx.push(1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    await next();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(&quot;fn1&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">let fn2 = async function(ctx,next){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(2);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx.push(2)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    await next();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(&quot;fn2&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">let middleware = [fn0,fn1,fn2]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">let ctx = []</span></span><span class="token-line" style="color:#393A34"><span class="token plain">myCompose(ctx,middleware);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">console.log(ctx);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>è¿”å›çš„ç»“æœï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">0</span></span><span class="token-line" style="color:#393A34"><span class="token plain">1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">2</span></span><span class="token-line" style="color:#393A34"><span class="token plain">(3) [0, 1, 2]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">fn2</span></span><span class="token-line" style="color:#393A34"><span class="token plain">fn1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">2</span></span><span class="token-line" style="color:#393A34"><span class="token plain">fn2</span></span><span class="token-line" style="color:#393A34"><span class="token plain">fn1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">fn0</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>åœ¨fn0å‡½æ•°ä¸­è°ƒç”¨äº†ä¸¤æ¬¡next()ï¼Œè¿™æ ·ä¼šå¯¼è‡´é‡æ–°æ‰§è¡Œäº†fn0åé¢çš„æ‰€æœ‰ä¸­é—´ä»¶å‡½æ•°ã€‚ä¸ºäº†é¿å…è¿™æ ·æƒ…å†µçš„å‘ç”Ÿï¼Œéœ€è¦é™åˆ¶ä¸€ä¸ªä¸­é—´ä»¶åªèƒ½æ‰§è¡Œä¸€æ¬¡ã€‚myComposeå‡½æ•°æ˜¯é€šè¿‡è°ƒç”¨dispatchå‡½æ•°æ¥æ‰§è¡Œä¸­é—´ä»¶å‡½æ•°çš„ï¼Œå› æ­¤å¯ä»¥é€šè¿‡é˜»æ­¢dispatchå‡½æ•°æ¥é˜»æ­¢ä¸­é—´ä»¶å‡½æ•°çš„æ‰§è¡Œã€‚ä»myComposeå‡½æ•°å¯çŸ¥ï¼Œåœ¨ä¸­é—´ä»¶å‡½æ•°ä¸­æ‰§è¡Œåˆ°ç¬¬äºŒæ¬¡nextçš„æ—¶å€™ï¼Œå¿…å®šå·²ç»è°ƒç”¨äº†middleware.lengthæ¬¡dispatchï¼Œå³æ‰§è¡Œè¿‡äº†æ‰€æœ‰ä¸­é—´ä»¶å‡½æ•°nextä¹‹å‰çš„é€»è¾‘ã€‚æ‰§è¡Œnext()å‡½æ•°å…¶å®å°±æ˜¯æ‰§è¡Œ<code>dispatch.bind(null, i + 1)</code> ï¼Œç”±æ­¤å¯ä»¥çœ‹å‡ºï¼Œæ¯ä¸ªä¸­é—´ä»¶å‡½æ•°æ‰§è¡Œç¬¬äºŒæ¬¡ next çš„å‡½æ•°çš„æ—¶å€™ï¼Œä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯ i+1 ï¼Œi+1 çš„èŒƒå›´æ˜¯[0,3]ã€‚å› æ­¤å¯ä»¥è®°å½•ä¸€ä¸‹å·²ç»æ‰§è¡Œäº†å¤šå°‘æ¬¡dispatchåˆ°indexä¸­ï¼Œç„¶åæ¯æ¬¡dispatchçš„æ—¶å€™æ¯”è¾ƒç¬¬ä¸€ä¸ªå‚æ•° i+1 ä¸ index çš„å€¼ï¼Œæ¥åˆ¤æ–­æ˜¯å¦å­˜åœ¨åŒä¸€ä¸ªä¸­é—´ä»¶å‡½æ•°è¢«æ‰§è¡Œäº†å¤šæ¬¡çš„æƒ…å†µã€‚å› æ­¤ä¿®æ”¹åmyComposeå¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">function myCompose(ctx = [],middleware){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    let index = -1;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return dispatch(0)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    function dispatch(i){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if(i &lt;= index) return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        index = i;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        let fn = middleware[i];</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if(!fn) return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return fn(ctx, dispatch.bind(null,i+1));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>è¿”å›çš„ç»“æœï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">0</span></span><span class="token-line" style="color:#393A34"><span class="token plain">1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">2</span></span><span class="token-line" style="color:#393A34"><span class="token plain">(3) [0, 1, 2]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">fn2</span></span><span class="token-line" style="color:#393A34"><span class="token plain">fn1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">fn0</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="å…è®¸ä¸­é—´ä»¶æˆªè·ä¿¡æ¯ä»¥åŠå¤„ç†é”™è¯¯"></a>å…è®¸ä¸­é—´ä»¶æˆªè·ä¿¡æ¯ä»¥åŠå¤„ç†é”™è¯¯<a class="hash-link" href="#å…è®¸ä¸­é—´ä»¶æˆªè·ä¿¡æ¯ä»¥åŠå¤„ç†é”™è¯¯" title="Direct link to heading">#</a></h4><p>å¯¹äºä¸€ä¸ªä¸­é—´ä»¶è€Œè¨€ï¼Œæ¯”å¦‚</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">let fn0 = async function(ctx,next){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(0);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx.push(0)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    await next()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(&quot;fn0&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>å¦‚æœä¸‹ä¸€ä¸ªä¸­é—´ä»¶å‡ºç°äº†é—®é¢˜ï¼Œæˆ–è€…fn0ä¸­é—´ä»¶å‡½æ•°éœ€è¦ä¸‹ä¸€ä¸ªä¸­é—´ä»¶å‡½æ•°è¿”å›ä¸€äº›æ•°æ®è¿›è¡Œå¤„ç†ï¼Œé‚£ä¹ˆå¦‚ä½•å®ç°å‘¢ï¼Ÿåˆ©ç”¨promise.resolveä»¥åŠrejectæ¥å¤„ç†æ•°æ®ä»¥åŠé”™è¯¯ä¿¡æ¯ã€‚ä¿®æ”¹åçš„ä»£ç ä¸ºï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">function myCompose(ctx = [],middleware){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    let index = -1;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return dispatch(0)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    function dispatch(i){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if(i &lt;= index) return Promise.reject(new Error(&#x27;next() called multiple times in a middleware&#x27;));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        index = i;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        let fn = middleware[i];</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if(!fn) return Promise.resolve();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Promise.resolve(fn(ctx, dispatch.bind(null,i+1)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>å¦‚æœreturn Promise.resolve(fn(context, dispatch.bind(null, i + 1)));å‡ºç°é”™è¯¯ï¼Œåˆ©ç”¨try-catchè¿›è¡Œæ•è·å¹¶ä¸”å°†é”™è¯¯ä¿¡æ¯rejectåˆ°ä¸Šå±‚ä¸­é—´ä»¶ã€‚ä¿®æ”¹åçš„ä»£ç ä¸ºï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">function myCompose(ctx = [],middleware){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    let index = -1;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return dispatch(0)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    function dispatch(i){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if(i &lt;= index) return Promise.reject(new Error(&#x27;next() called multiple times in a middleware&#x27;));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        index = i;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        let fn = middleware[i];</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if(!fn) return Promise.resolve();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return Promise.resolve(fn(ctx, dispatch.bind(null,i+1)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch(err){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return Promise.reject(err)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>å®˜æ–¹ç»™å‡ºçš„composeå®ç°å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">function compose (middleware) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!Array.isArray(middleware)) throw new TypeError(&#x27;Middleware stack must be an array!&#x27;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (const fn of middleware) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (typeof fn !== &#x27;function&#x27;) throw new TypeError(&#x27;Middleware must be composed of functions!&#x27;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param {Object} context</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return {Promise}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @api public</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return function (context, next) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // last called middleware #</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        let index = -1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return dispatch(0)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        function dispatch (i) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (i &lt;= index) return Promise.reject(new Error(&#x27;next() called multiple times&#x27;))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            index = i</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            let fn = middleware[i]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (i === middleware.length) fn = next</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!fn) return Promise.resolve()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return Promise.resolve(fn(context, dispatch.bind(null, i + 1)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (err) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return Promise.reject(err)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>ä¸ä¹‹å‰çš„myComposeç‰ˆæœ¬æ¯”è¾ƒå¤šäº†ä¸€ä¸ªif (i === middleware.length) fn = next;è¿™æ ·å¤„ç†æ˜¯ä¸ºäº†æ£€æµ‹å¦‚æœæ‰§è¡Œåˆ°middlewareæœ€åä¸€ä¸ªä¸­é—´ä»¶ï¼Œåˆ™å°†compose(this.middleware)(ctx,fnLast);ä¸­çš„fnLastæœ€ä¸ºæœ€åä¸€ä¸ªä¸­é—´ä»¶ã€‚koaæºç ä¸­è¿™ä¸ªnextä¸ºundefinedã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="å¤„ç†requesäº‹ä»¶"></a>å¤„ç†requesäº‹ä»¶<a class="hash-link" href="#å¤„ç†requesäº‹ä»¶" title="Direct link to heading">#</a></h3><p>å½“ç›‘å¬åˆ°3000ç«¯å£æœ‰è¯·æ±‚è¿‡æ¥çš„æ—¶å€™ï¼Œè§¦å‘requestäº‹ä»¶ï¼Œç„¶åå¼€å§‹æ‰§è¡Œå„ä¸ªä¸­é—´ä»¶ï¼Œå®é™…åœ¨ä¹‹å‰å®ç°myComposeå‡½æ•°çš„è¿‡ç¨‹ä¸­å¯ä»¥çœ‹å‡ºä¸­é—´ä»¶æ‰§è¡Œçš„é¡ºåºã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="æ€»ç»“"></a>æ€»ç»“<a class="hash-link" href="#æ€»ç»“" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">const Koa = require(&#x27;koa&#x27;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">const app = new Koa();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// logger</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">app.use(async (ctx, next) =&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  await next();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  const rt = ctx.response.get(&#x27;X-Response-Time&#x27;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  console.log(`${ctx.method} ${ctx.url} - ${rt}`);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">});</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// x-response-time</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">app.use(async (ctx, next) =&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  const start = Date.now();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  await next();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  const ms = Date.now() - start;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  ctx.set(&#x27;X-Response-Time&#x27;, `${ms}ms`);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">});</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// response</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">app.use(async ctx =&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  ctx.body = &#x27;Hello World&#x27;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">});</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">app.listen(3000);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>è¿™é‡Œä¸­é—´ä»¶çº§è”çš„æ–¹å¼å¯¹ctxè¿›è¡Œé€æ­¥å¤„ç†ï¼Œæ ¹æ®compose.jså¯çŸ¥ä¼ å…¥ä¸­é—´ä»¶çš„nextå…¶å®å°±æ˜¯ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">dispatch.bind(null, i + 1)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="å·¥ä½œåŸç†"></a>å·¥ä½œåŸç†<a class="hash-link" href="#å·¥ä½œåŸç†" title="Direct link to heading">#</a></h4><ol><li>åˆ›å»ºä¸€ä¸ªkoaå¯¹è±¡ï¼Œç„¶åè°ƒç”¨use(fn)å°†fn pushåˆ°è¯¥koaå¯¹è±¡çš„ä¸­é—´ä»¶æ•°ç»„ä¸­</li><li>æ¥ç€è°ƒç”¨listenåˆ›å»ºä¸€ä¸ªæœåŠ¡å™¨å®¹å™¨ï¼Œç„¶åè°ƒç”¨this.callback()ï¼Œç„¶åç›‘å¬æŒ‡å®šç«¯å£</li><li>this.callback()é¦–å…ˆä¼šè°ƒç”¨composeå¯¹ä¸­é—´ä»¶æ•°ç»„è¿›è¡Œå¤„ç†ï¼Œè¿”å›ä¸€ä¸ªæ´‹è‘±æ¨¡å‹çš„å…¥å£å‡½æ•°ã€‚ç„¶åè¿”å›ä¸€ä¸ªhandleRequest</li><li>handleRequestå‡½æ•°ä¼šåœ¨ç›‘å¬åˆ°ç«¯å£æœ‰è¯·æ±‚çš„æ—¶å€™è°ƒç”¨ï¼Œè¯¥å‡½æ•°æœ€ç»ˆä¼šè°ƒç”¨æ´‹è‘±æ¨¡å‹çš„å…¥å£å‡½æ•°ã€‚</li><li>handleRequestå‡½æ•°æ¥æ”¶ä¸¤ä¸ªå‚æ•°req, resï¼›è¯¥å‡½æ•°æ‰§è¡Œçš„æ—¶å€™é¦–å…ˆä¼šæ ¹æ®ä¼ å…¥çš„req, resåˆ›å»ºä¸€ä¸ªctxï¼›ç„¶åè°ƒç”¨koaå¯¹è±¡çš„handleRequestå‡½æ•°ï¼Œå°†ç»“æœè¿”å›ã€‚</li><li>koaå¯¹è±¡çš„handleRequestå‡½æ•°æ¥æ”¶ä¸¤ä¸ªå‚æ•°(ctx, fn)ï¼Œctxå°±æ˜¯æ ¹æ®req, resåˆ›å»ºçš„ctxï¼Œfnå°±æ˜¯è°ƒç”¨composeè¿”å›çš„æ´‹è‘±æ¨¡å‹å…¥å£å‡½æ•°ã€‚ koaå¯¹è±¡çš„handleRequestå‡½æ•°æœ€ç»ˆä¼šè°ƒç”¨fn(ctx)</li></ol><p>åœ¨ä¸­é—´ä»¶éœ€è¦çº§è”çš„æ—¶å€™ï¼Œéœ€è¦ç»™ä¸­é—´ä»¶ä¼ å…¥ç¬¬äºŒä¸ªå‚æ•°next</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="æŠ€å·§"></a>æŠ€å·§<a class="hash-link" href="#æŠ€å·§" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">let fn0 = async function(ctx,next){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(0);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx.push(0)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    await next()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    await next().catch(err=&gt;console.log(err))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(&quot;fn0&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>æ³¨æ„è¿™é‡Œï¼Œä¸­é—´ä»¶ç³»ç»Ÿå¸¦æ¥çš„é—®é¢˜ï¼Œä¸­é—´ä»¶å¯ä»¥éšæ„ç»™ctxå®šä¹‰å®ä¾‹æ–¹æ³•ä»¥åŠå±æ€§ï¼Œè¿™æ ·ä¼šå¯¼è‡´ä¸­é—´ä»¶ä¹‹é—´çš„è¦†ç›–çš„é—®é¢˜ï¼Œå¾ˆéš¾æ£€æŸ¥ä¸é”™è¯¯ã€‚é€šè¿‡åœ¨ä¸­é—´ä»¶å¯¹nextè¿›è¡Œcatchæ¥è¿›è¡Œé”™è¯¯æ£€æŸ¥ã€‚ </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">await next().catch(err=&gt;console.log(err))</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>ä¼šæ‰“å°é”™è¯¯ï¼Œä½†æ˜¯ç¨‹åºä¸ä¼šcrashæ‰ã€‚</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/ReactNote/blog/tags/node-koa">node koa</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></main></div></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 BUPTlhuanyu, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/ReactNote/assets/js/runtime~main.a78b756c.js"></script>
<script src="/ReactNote/assets/js/main.48fd23c8.js"></script>
</body>
</html>