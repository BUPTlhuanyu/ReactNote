<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-react/react/reconciler/multi-setstate">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.18">
<link rel="alternate" type="application/rss+xml" href="/ReactNote/blog/rss.xml" title="React Note RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/ReactNote/blog/atom.xml" title="React Note Atom Feed"><title data-rh="true">React Note</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://BUPTlhuanyu.github.io/ReactNote/docs/react/react/reconciler/multi-setstate"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="description" content="æ¦‚è¿°ï¼ŒèƒŒæ™¯"><meta data-rh="true" property="og:description" content="æ¦‚è¿°ï¼ŒèƒŒæ™¯"><link data-rh="true" rel="icon" href="/ReactNote/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://BUPTlhuanyu.github.io/ReactNote/docs/react/react/reconciler/multi-setstate"><link data-rh="true" rel="alternate" href="https://BUPTlhuanyu.github.io/ReactNote/docs/react/react/reconciler/multi-setstate" hreflang="en"><link data-rh="true" rel="alternate" href="https://BUPTlhuanyu.github.io/ReactNote/docs/react/react/reconciler/multi-setstate" hreflang="x-default"><link rel="stylesheet" href="/ReactNote/assets/css/styles.5bb7972e.css">
<link rel="preload" href="/ReactNote/assets/js/runtime~main.208fed75.js" as="script">
<link rel="preload" href="/ReactNote/assets/js/main.d0834552.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script>
<script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?64a3c7fa9e8533c72827dc22e0d273ab";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/ReactNote/"><div class="navbar__logo"><img src="/ReactNote/img/logo.png" alt="React Note Logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/ReactNote/img/logo.png" alt="React Note Logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">React Note</b></a><a class="navbar__item navbar__link" href="/ReactNote/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/BUPTlhuanyu" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_S7eR colorModeToggle_vKtC"><button class="clean-btn toggleButton_rCf9 toggleButtonDisabled_Pu9x" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_RiAD"><nav class="menu thin-scrollbar menu_izAj"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/ReactNote/docs/react/react/intro">react</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/ReactNote/docs/react/react/intro">ä»‹ç»</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/ReactNote/docs/react/react/project-directory">ç›®å½•ç»“æ„</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/ReactNote/docs/react/react/shared">å…¬å…±æ–¹æ³•</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ReactNote/docs/react/react/ReactElement/reactelement-and-children">ReactElement</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ReactNote/docs/react/react/scheduler/why-need-scheduler">scheduler</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/ReactNote/docs/react/react/reconciler/container-root">reconciler</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ReactNote/docs/react/react/reconciler/container-root">åˆ›å»ºcontainerå¯¹åº”çš„root</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ReactNote/docs/react/react/reconciler/fiber-tree-root">åˆ›å»ºrootä¸‹çš„fiberæ ‘å¹¶å¼€å§‹åˆå§‹è°ƒåº¦</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ReactNote/docs/react/react/reconciler/schedulework">åˆ›å»ºrootä¸‹çš„fiberæ ‘å¹¶å¼€å§‹åˆå§‹è°ƒåº¦</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ReactNote/docs/react/react/reconciler/sync-async-work">åŒæ­¥ä¸å¼‚æ­¥è°ƒåº¦</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ReactNote/docs/react/react/reconciler/performwork">è°ƒåº¦çš„å…¥å£å‡½æ•°</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ReactNote/docs/react/react/reconciler/performwork-on-root">ä»æ ¹èŠ‚ç‚¹å¼€å§‹è°ƒåº¦</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ReactNote/docs/react/react/reconciler/expiration-time">åˆ°æœŸæ—¶é—´</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/ReactNote/docs/react/react/reconciler/multi-setstate">å¤šæ¬¡æ‰§è¡ŒsetStateçš„æ›´æ–°æœºåˆ¶</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ReactNote/docs/react/react/reconciler/react-fiber-lazy-component">ReactFiberLazyComponent</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ReactNote/docs/react/react/reconciler/todo-list">å¾…æ•´ç†æµç¨‹</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ReactNote/docs/react/react/event/event-bind">event</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/ReactNote/docs/react/react/error/error-handle">å¦‚ä½•å¤„ç†é”™è¯¯</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/ReactNote/docs/react/react-hook-form/react-hook-form-summary">react-hook-form</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/ReactNote/docs/react/react-router/react-router-summary">react-router</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/ReactNote/docs/react/react-transition/react-transition-group-transition">react-transition</a></div></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Xlws" aria-label="breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/ReactNote/">ğŸ </a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><span class="breadcrumbs__link" itemprop="item name">react</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><span class="breadcrumbs__link" itemprop="item name">reconciler</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="item name">å¤šæ¬¡æ‰§è¡ŒsetStateçš„æ›´æ–°æœºåˆ¶</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1></h1></header><h4 class="anchor anchorWithStickyNavbar_mojV" id="æ¦‚è¿°èƒŒæ™¯">æ¦‚è¿°ï¼ŒèƒŒæ™¯<a class="hash-link" href="#æ¦‚è¿°èƒŒæ™¯" title="Direct link to heading">â€‹</a></h4><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">stateåˆå§‹å€¼ä¸º{a:1}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">é—®é¢˜1ï¼šæœ€ç»ˆstateä¼šæ˜¯å¤šå°‘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clickHandler(){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.setState({</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        a : 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.setState({</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        a : 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.setState({</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        a : 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.setState({</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        a : 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">é—®é¢˜2ï¼šæœ€ç»ˆstateä¼šæ˜¯å¤šå°‘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clickHandler(){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.setState((prevState, nextProps) =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      return {a:prevState.a + 1};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.setState((prevState, nextProps) =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      return {a:prevState.a + 1};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.setState((prevState, nextProps) =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      return {a:prevState.a + 1};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.setState((prevState, nextProps) =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      return {a:prevState.a + 1};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>æ³¨æ„æœ¬æ–‡å°†ä¸ä¹‹å‰çš„æ–‡ç« <a href="http://note.youdao.com/noteshare?id=84df98e9c1e5cb9d1a66864b34268a7f&amp;sub=1E16F316E66348EB945206AE4746119A" target="_blank" rel="noopener noreferrer">2-6-2ã€å¯¹ç±»ç»„ä»¶æ‰§è¡ŒupdateClassComponent</a>ç´§å¯†ç›¸å…³ã€‚</p><p><strong>é˜…è¯»æœ¬æ–‡éœ€è¦ç‰¹åˆ«å…³æ³¨çš„æ˜¯</strong>ï¼š</p><ol><li>å¦‚ä¸‹å¤šä¸ªsetStateåŒæ­¥çš„æ‰§è¡Œçš„æ—¶å€™ï¼Œæ›´æ–°ä»»åŠ¡çš„åˆ°æœŸæ—¶é—´æ˜¯ç›¸åŒçš„</li></ol><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">åŸå› ï¼šåŒä¸€äº‹ä»¶ä¸­å¤šæ¬¡åŒæ­¥æ‰§è¡ŒsetStateçš„åˆ°æœŸæ—¶é—´éƒ½æ˜¯ç›¸åŒçš„</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">There&#x27;s already pending work. We might be in the middle of a browser</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">event. If we were to read the current time, it could cause multiple updates</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">within the same event to receive different expiration times, leading to</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tearing. Return the last read time. During the next idle callback, the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">time will be updated</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ol start="2"><li>å½“å‰fiberçš„åˆ°æœŸæ—¶é—´expirationTimeä¼šè¢«è®¾ç½®ä¸ºä¸ç±»ç»„ä»¶setStateäº§ç”Ÿçš„æ›´æ–°ä»»åŠ¡ç›¸åŒçš„åˆ°æœŸæ—¶é—´</li></ol><h4 class="anchor anchorWithStickyNavbar_mojV" id="å¿…è¦çš„å›é¡¾ä¸å‡†å¤‡">å¿…è¦çš„å›é¡¾ä¸å‡†å¤‡<a class="hash-link" href="#å¿…è¦çš„å›é¡¾ä¸å‡†å¤‡" title="Direct link to heading">â€‹</a></h4><p>å›é¡¾ç±»ç»„ä»¶çš„å®ä¾‹åŒ–ï¼Œç»™å‡ºä¸€äº›setStateç›¸å…³çš„å‡†å¤‡å·¥ä½œã€‚</p><blockquote><p>åœ¨æ‰§è¡ŒReactDOM.renderæ„å»ºfiberæ ‘çš„æ—¶å€™ï¼Œé‡åˆ°ç±»ç±»å‹çš„ç»„ä»¶ï¼Œä¼šè°ƒç”¨updateClassComponentï¼Œè¯¥å‡½æ•°ä¼šåœ¨ç»„ä»¶æŒ‚è½½ç”Ÿå‘½å‘¨æœŸä¸­è°ƒç”¨constructClassInstanceå®ä¾‹åŒ–ç±»ç±»å‹ç»„ä»¶ã€‚</p></blockquote><p>updateClassComponentæ‰€åœ¨è·¯å¾„ï¼šreact\packages\react-reconciler\src\ReactFiberBeginWork.js</p><blockquote><p>constructClassInstanceæ„å»ºç±»ç»„ä»¶çš„å®ä¾‹ç„¶åè°ƒç”¨adoptClassInstance(workInProgress, instance)ç»™ä¼ å…¥çš„instanceæ·»åŠ æ›´æ–°å™¨updaterå±æ€§å€¼ä¸ºclassComponentUpdaterï¼Œè¿™ä¸ªclassComponentUpdateråœ¨è¯¥æ–‡ä»¶ä¸­æ˜¯ä¸€ä¸ªåŒ…å«å¤šä¸ªå±æ€§çš„ å¯¹è±¡ï¼Œä¸»è¦ç”¨äºå­˜æ”¾æ›´æ–°ä»»åŠ¡ç›¸å…³é€»è¾‘</p></blockquote><p>constructClassInstanceå‡½æ•°æ‰€åœ¨è·¯å¾„ï¼šreact\packages\react-reconciler\src\ReactFiberClassComponent.js
ã€‚</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">const classComponentUpdater = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  isMounted,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  enqueueSetState(inst, payload, callback) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  enqueueReplaceState(inst, payload, callback) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  enqueueForceUpdate(inst, callback) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>setStateæ˜¯ä¾èµ–enqueueSetStateæ¥æ‰§è¡Œæ›´æ–°çš„,enqueueSetStateä»£ç åœ¨ä¸‹é¢çš„åˆ†æä¸­ä¼šç»™å‡ºã€‚</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="ä»setstateæ–¹æ³•åˆ‡å…¥">ä»setStateæ–¹æ³•åˆ‡å…¥<a class="hash-link" href="#ä»setstateæ–¹æ³•åˆ‡å…¥" title="Direct link to heading">â€‹</a></h4><p>setStateæ–¹æ³•ï¼š</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">Component.prototype.setState = function(partialState, callback) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  this.updater.enqueueSetState(this, partialState, callback, &#x27;setState&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>åœ¨ä¸Šè¿°æ–¹æ³•ä¸­ï¼Œå¿…é¡»è¦ä»‹ç»ä¸€ä¸‹å‚æ•°ä»£è¡¨çš„æ„ä¹‰ï¼š</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">partialStateï¼šä¼ å…¥setStateæ–¹æ³•çš„æ–°çš„stateå¯¹è±¡</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">callbackï¼šstateæ›´æ–°ä¹‹åçš„å›è°ƒå‡½æ•°</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>åœ¨ç±»ç»„ä»·ä¸­è°ƒç”¨setStateä¼šç›´æ¥è°ƒç”¨å®ä¾‹ä¸Šupdaterçš„enqueueSetStateæ–¹æ³•ï¼Œå…¶ä»£ç å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">enqueueSetState(inst, payload, callback) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  //è·å–å®ä¾‹å¯¹åº”çš„fiber</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  const fiber = ReactInstanceMap.get(inst);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  //è®¡ç®—å½“å‰æ—¶é—´:reactç¡®ä¿äº†åœ¨åŒä¸€ä¸ªæ—¶é—´ä¸­æ‰€æœ‰çš„æ›´æ–°éƒ½æ˜¯ç›¸åŒçš„åˆ°æœŸæ—¶é—´</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  const currentTime = requestCurrentTime();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  //æ ¹æ®å½“å‰æ—¶é—´ä¸fiberè®¡ç®—åˆ°æœŸæ—¶é—´</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  const expirationTime = computeExpirationForFiber(currentTime, fiber);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  //ä¼ å…¥ä¸€ä¸ªåˆ°æœŸæ—¶é—´ï¼Œè¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œè§packages\react-reconciler\src\ReactUpdateQueue.js</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  const update = createUpdate(expirationTime);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  //åˆ©ç”¨æ–°çš„stateä¿®æ”¹update.payload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  update.payload = payload;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  //åˆ©ç”¨callbackä¿®æ”¹update.callback</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if (callback !== undefined &amp;&amp; callback !== null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (__DEV__) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      warnOnInvalidCallback(callback, &#x27;setState&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    update.callback = callback;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  //ï¼Ÿï¼Ÿï¼Ÿå­˜ç–‘ï¼Œè°ƒç”¨scheduleråˆ é™¤å½“å‰æŸä¸ªä»»åŠ¡ï¼Œè¿™é‡Œå…ˆä¸è®¨è®º</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  flushPassiveEffects();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  //å¼€å§‹è°ƒåº¦setStateå¸¦æ¥çš„æ›´æ–°</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  enqueueUpdate(fiber, update);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  //å¼€å§‹è°ƒåº¦æ–°çš„å½“å‰fiberå­æ ‘ï¼Œè®¾ç½®ç›¸å…³çš„åˆ°æœŸæ—¶é—´ç­‰ç­‰,è¿™é‡Œå…³é”®æ˜¯ä¼šç»™å½“å‰fiberè®¾ç½®expirationTimeä¸ºsetStateçš„æ›´æ–°ä»»åŠ¡ç›¸åŒçš„å€¼</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  scheduleWork(fiber, expirationTime);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="enqueueupdate">enqueueUpdate<a class="hash-link" href="#enqueueupdate" title="Direct link to heading">â€‹</a></h4><blockquote><p>enqueueUpdateä¸ºfiberæ„å»ºupdateQueueé˜Ÿåˆ—ï¼Œå¤šä¸ªsetStateçš„æ•ˆæœæ˜¯å¤šä¸ªå…·å¤‡ç›¸åŒåˆ°æœŸæ—¶é—´çš„updateéƒ½è¢«æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­</p></blockquote><p>ä¾èµ–çš„å‡½æ•°ï¼š</p><ul><li>createUpdateQueueè¿”å›ä¸€ä¸ªUpdateQueueç±»å‹çš„å¯¹è±¡ï¼ˆè¯¥å¯¹è±¡æ˜¯ç”±updateç»„æˆçš„é˜Ÿåˆ—ï¼‰ï¼Œä¼ å…¥çš„stateå­˜æ”¾åˆ°baseStateå±æ€§ä¸Šã€‚</li><li>appendUpdateToQueueå°†ä¼ å…¥çš„updateæ·»åŠ åˆ°ä¼ å…¥çš„updateé˜Ÿåˆ—å³queueçš„æœ€åã€‚</li><li>cloneUpdateQueueè¿”å›ä¼ å…¥çš„updateé˜Ÿåˆ—çš„å…‹éš†ç‰ˆï¼Œè¿”å›çš„é˜Ÿåˆ—ä¸ä¼ å…¥çš„é˜Ÿåˆ—çš„firstUpdateæŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡ï¼ŒlastUpdateä¹ŸæŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡ã€‚</li></ul><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">export function createUpdateQueue&lt;State&gt;(baseState: State): UpdateQueue&lt;State&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  const queue: UpdateQueue&lt;State&gt; = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    baseState,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    firstUpdate: null,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lastUpdate: null,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    firstCapturedUpdate: null,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lastCapturedUpdate: null,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    firstEffect: null,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lastEffect: null,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    firstCapturedEffect: null,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lastCapturedEffect: null,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return queue;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">function appendUpdateToQueue&lt;State&gt;(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  queue: UpdateQueue&lt;State&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  update: Update&lt;State&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Append the update to the end of the list.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if (queue.lastUpdate === null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Queue is empty</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    queue.firstUpdate = queue.lastUpdate = update;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    queue.lastUpdate.next = update;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    queue.lastUpdate = update;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">function cloneUpdateQueue&lt;State&gt;(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  currentQueue: UpdateQueue&lt;State&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">): UpdateQueue&lt;State&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  const queue: UpdateQueue&lt;State&gt; = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    baseState: currentQueue.baseState,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    firstUpdate: currentQueue.firstUpdate,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lastUpdate: currentQueue.lastUpdate,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // TODO: With resuming, if we bail out and resuse the child tree, we should</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // keep these effects.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    firstCapturedUpdate: null,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lastCapturedUpdate: null,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    firstEffect: null,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lastEffect: null,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    firstCapturedEffect: null,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lastCapturedEffect: null,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return queue;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>enqueueUpdateçš„ä½œç”¨æ˜¯å°†ä¼ å…¥çš„æ›´æ–°ä»»åŠ¡ï¼ˆåŒ…å«æ–°stateä»¥åŠåˆ°æœŸæ—¶é—´çš„å¯¹è±¡ï¼‰æ·»åŠ åˆ°æ›´æ–°é˜Ÿåˆ—ã€‚</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">export function enqueueUpdate&lt;State&gt;(fiber: Fiber, update: Update&lt;State&gt;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Update queues are created lazily.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ä½¿ç”¨alternateå±æ€§åŒå‘è¿æ¥ä¸€ä¸ªå½“å‰fiberå’Œå…¶work-in-progressï¼Œå½“å‰fiberå®ä¾‹çš„alternateå±æ€§æŒ‡å‘å…¶work-in-progressï¼Œwork-in-progressçš„alternateå±æ€§æŒ‡å‘å½“å‰ç¨³å®šfiberã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  const alternate = fiber.alternate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  let queue1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  let queue2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if (alternate === null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // There&#x27;s only one fiber.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    queue1 = fiber.updateQueue;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    queue2 = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (queue1 === null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      //å¦‚æœå½“å‰ç»„ä»¶æ²¡æœ‰ç­‰å¾…setStateçš„é˜Ÿåˆ—åˆ™åˆ›å»ºä¸€ä¸ªï¼Œ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åˆ©ç”¨fiberå½“å‰å·²ç»è®°å½•å¹¶éœ€è¦æ•´åˆçš„stateå­˜å‚¨åˆ°queue1ä¸fiber.updateQueue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      queue1 = fiber.updateQueue = createUpdateQueue(fiber.memoizedState);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // There are two owners.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å¦‚æœfiberæ ‘ä»¥åŠworkinprogressæ ‘éƒ½å­˜åœ¨ï¼Œä¸‹é¢çš„é€»è¾‘åˆ™ä¼šåŒæ­¥ä¸¤ä¸ªæ ‘çš„updateé˜Ÿåˆ—</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    queue1 = fiber.updateQueue;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    queue2 = alternate.updateQueue;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å½“ä¸¤ä¸ªæ ‘çš„é˜Ÿåˆ—è‡³å°‘æœ‰ä¸€ä¸ªä¸å­˜åœ¨çš„æ—¶å€™æ‰§è¡Œé˜Ÿåˆ—åˆ›å»ºæˆ–è€…å¤åˆ¶æ“ä½œ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (queue1 === null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (queue2 === null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Neither fiber has an update queue. Create new ones.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //  ä¸¤ä¸ªé˜Ÿåˆ—éƒ½æ²¡æœ‰åˆ™æ ¹æ®å„è‡ªçš„memoizedStateåˆ›å»ºupdateé˜Ÿåˆ—</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        queue1 = fiber.updateQueue = createUpdateQueue(fiber.memoizedState);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        queue2 = alternate.updateQueue = createUpdateQueue(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          alternate.memoizedState,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¦‚æœæœ‰ä¸€ä¸ªæ²¡æœ‰åˆ™å¤åˆ¶å¦ä¸€ä¸ªé˜Ÿåˆ—ç»™å®ƒ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Only one fiber has an update queue. Clone to create a new one.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        queue1 = fiber.updateQueue = cloneUpdateQueue(queue2);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (queue2 === null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¦‚æœæœ‰ä¸€ä¸ªæ²¡æœ‰åˆ™å¤åˆ¶å¦ä¸€ä¸ªé˜Ÿåˆ—ç»™å®ƒ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Only one fiber has an update queue. Clone to create a new one.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        queue2 = alternate.updateQueue = cloneUpdateQueue(queue1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Both owners have an update queue.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if (queue2 === null || queue1 === queue2) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // There&#x27;s only a single queue.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å¦‚æœåªæœ‰ä¸€ä¸ªæ ‘ï¼Œæˆ–è€…ä¸¤æ£µæ ‘é˜Ÿåˆ—æ˜¯åŒä¸€ä¸ªï¼Œåˆ™å°†ä¼ å…¥çš„æ›´æ–°å¯¹è±¡æ·»åŠ åˆ°ç¬¬ä¸€ä¸ªé˜Ÿåˆ—ä¸­</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    appendUpdateToQueue(queue1, update);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // There are two queues. We need to append the update to both queues,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // while accounting for the persistent structure of the list â€” we don&#x27;t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // want the same update to be added multiple times.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //  å¦‚æœä¸¤ä¸ªé˜Ÿåˆ—å­˜åœ¨ï¼Œåˆ™å°†æ›´æ–°ä»»åŠ¡åŠ å…¥ä¸¤ä¸ªé˜Ÿåˆ—ä¸­ï¼Œå¹¶é¿å…è¢«æ·»åŠ å¤šæ¬¡</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (queue1.lastUpdate === null || queue2.lastUpdate === null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      // One of the queues is not empty. We must add the update to both queues.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      //  æœ‰ä¸€ä¸ªé˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œå°†updateæ·»åŠ åˆ°ä¸¤ä¸ªé˜Ÿåˆ—</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      appendUpdateToQueue(queue1, update);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      appendUpdateToQueue(queue2, update);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      // Both queues are non-empty. The last update is the same in both lists,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      // because of structural sharing. So, only append to one of the lists.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      appendUpdateToQueue(queue1, update);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      // But we still need to update the `lastUpdate` pointer of queue2.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      queue2.lastUpdate = update;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="processupdatequeue">processUpdateQueue<a class="hash-link" href="#processupdatequeue" title="Direct link to heading">â€‹</a></h4><p>é€šè¿‡å¤šä¸ªåŒæ­¥æ‰§è¡Œçš„setStateå‡½æ•°çš„ä½œç”¨ï¼Œä¸ºfiberç”Ÿæˆäº†å¯¹åº”çš„updateQueueï¼Œå¹¶ä¸”updateQueueä¸­çš„æ¯ä¸ªupdateçš„åˆ°æœŸæ—¶é—´æ˜¯ç›¸åŒçš„ã€‚æœ€ç»ˆåœ¨è°ƒåº¦æ›´æ–°æ ‘çš„æ—¶å€™ä¼šè°ƒç”¨performWorkï¼Œå…¶ä¸­ä¼šè°ƒç”¨updateClassInstanceï¼Œå…¶ä¸­ä¼šè°ƒç”¨processUpdateQueueå‡½æ•°æ¥å¤„ç†ä¹‹å‰æ„å»ºçš„updateQueueã€‚åªè€ƒè™‘updateQueueä¸­çš„updateï¼Œçœç•¥CapturedUpdateç›¸å…³é€»è¾‘ä¹‹åprocessUpdateQueueéƒ¨åˆ†ä»£ç å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">export function processUpdateQueue&lt;State&gt;(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  workInProgress: Fiber,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  queue: UpdateQueue&lt;State&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  props: any,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  instance: any,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  renderExpirationTime: ExpirationTime,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">): void {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  hasForceUpdate = false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  queue = ensureWorkInProgressQueueIsAClone(workInProgress, queue);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // These values may change as we process the queue.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  let newBaseState = queue.baseState;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  let newFirstUpdate = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  let newExpirationTime = NoWork;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Iterate through the list of updates to compute the result.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  let update = queue.firstUpdate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  let resultState = newBaseState;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  while (update !== null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    const updateExpirationTime = update.expirationTime;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (updateExpirationTime &lt; renderExpirationTime) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      // This update does not have sufficient priority. Skip it.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (newFirstUpdate === null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // This is the first skipped update. It will be the first update in</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // the new list.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        newFirstUpdate = update;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Since this is the first update that was skipped, the current result</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // is the new base state.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        newBaseState = resultState;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      // Since this update will remain in the list, update the remaining</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      // expiration time.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (newExpirationTime &lt; updateExpirationTime) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        newExpirationTime = updateExpirationTime;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      // This update does have sufficient priority. Process it and compute</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      // a new result.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      resultState = getStateFromUpdate(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        workInProgress,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        queue,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        update,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        resultState,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        props,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        instance,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      const callback = update.callback;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (callback !== null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        workInProgress.effectTag |= Callback;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Set this to null, in case it was mutated during an aborted render.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        update.nextEffect = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (queue.lastEffect === null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          queue.firstEffect = queue.lastEffect = update;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          queue.lastEffect.nextEffect = update;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          queue.lastEffect = update;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Continue to the next update.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    update = update.next;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if (newFirstUpdate === null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    queue.lastUpdate = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if (newFirstUpdate === null &amp;&amp; newFirstCapturedUpdate === null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // We processed every update, without skipping. That means the new base</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // state is the same as the result state.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    newBaseState = resultState;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  queue.baseState = newBaseState;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  queue.firstUpdate = newFirstUpdate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  workInProgress.expirationTime = newExpirationTime;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  workInProgress.memoizedState = resultState;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>åœ¨åŒæ­¥å¤šæ¬¡æ‰§è¡ŒsetStateçš„æƒ…å†µä¸‹ï¼Œå¾ªç¯ä¸­çš„ if åˆ¤æ–­æ¡ä»¶newExpirationTimeå§‹ç»ˆä¼šç­‰äºrenderExpirationTimeï¼Œå› æ­¤ä¼šå¾ªç¯éå†updateQueueé˜Ÿåˆ—ä¸­çš„updateï¼Œå¹¶è°ƒç”¨getStateFromUpdateä¸æ–­ä¿®æ”¹åˆå¹¶stateï¼Œå¾—åˆ°æœ€ç»ˆçš„stateå³resultStateã€‚processUpdateQueueçš„æœ€åä¼šå°†å¾—åˆ°çš„æ–°çš„stateå­˜å‚¨åˆ°queue.baseStateï¼Œå°†queue.firstUpdateç½®ä¸ºnullã€‚</p><p>æ¥ä¸‹æ¥é€šè¿‡getStateFromUpdateçœ‹å¦‚ä½•åˆå¹¶stateï¼š</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">function getStateFromUpdate&lt;State&gt;(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  workInProgress: Fiber,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  queue: UpdateQueue&lt;State&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  update: Update&lt;State&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  prevState: State,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nextProps: any,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  instance: any,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">): any {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  switch (update.tag) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Intentional fallthrough</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case UpdateState: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      const payload = update.payload;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      let partialState;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      //ä¸¤ç§ä¸åŒçš„setStateæ–¹å¼ï¼šç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå¯¹è±¡æˆ–è€…ä¸€ä¸ªå‡½æ•°</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (typeof payload === &#x27;function&#x27;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Updater function</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        partialState = payload.call(instance, prevState, nextProps);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Partial state object</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        partialState = payload;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (partialState === null || partialState === undefined) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Null and undefined are treated as no-ops.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¦‚æœåˆå¹¶åçš„stateä¸ºnullæˆ–è€…undefinedåˆ™è¿”å›ä¹‹å‰çš„state</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return prevState;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      // Merge the partial state and the previous state.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      // åˆå¹¶stateï¼Œå¹¶è¿”å›ï¼ŒObject.assignè¿™é‡Œæ˜¯ç¬¬ä¸€å±‚æ·±æ‹·è´ï¼Œå¦‚æœstateæ¯”è¾ƒå¤æ‚ï¼Œå°±ä¼šå­˜åœ¨æ·±å±‚å±æ€§æµ…æ‹·è´çš„ç°è±¡</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      return Object.assign({}, prevState, partialState);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return prevState;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>ç”±äºè¿™é‡Œåªçœ‹setStateï¼Œå› æ­¤çœç•¥äº†éƒ¨åˆ†ä»£ç ã€‚è¿™é‡Œå¯ä»¥å¾ˆæ¸…æ™°çš„çœ‹åˆ°stateçš„åˆå¹¶æœºåˆ¶ï¼ŒsetStateçš„ç¬¬ä¸€ä¸ªå‚æ•°æœ‰ä¸¤ç§æ–¹å¼ï¼š</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">1ã€å¯¹è±¡å½¢å¼</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2ã€å‡½æ•°å½¢å¼</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    (prevState, nextProps) =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      return {...};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ul><li>å¯¹è±¡å½¢å¼ï¼šä¼šç›´æ¥å°†å½“å‰çš„setStateä¸­çš„æ–°çš„stateä½œä¸ºpartialStateï¼Œç„¶ååˆ©ç”¨Object.assign({}, prevState, partialState)å°†ä¸Šä¸€æ¬¡setStateä¹‹åçš„stateä¸å½“å‰çš„æ–°çš„stateåˆå¹¶åˆ°ä¸€ä¸ªæ–°çš„å¯¹è±¡ä¸Šã€‚</li><li>å‡½æ•°å½¢å¼ï¼šåˆ©ç”¨è¯¥å‡½æ•°å¯¹ä¸Šä¸€æ¬¡setStateä¹‹åçš„stateä¸ä¸‹ä¸€æ¬¡çš„propsè¿›è¡Œè®¡ç®—åè¿”å›çš„å¯¹è±¡ä½œä¸ºå½“å‰æ–°çš„stateï¼Œå¹¶å­˜å‚¨åœ¨partialStateï¼Œæœ€åä¸prevStateåˆå¹¶åˆ°æ–°çš„å¯¹è±¡ä¸Šã€‚</li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="ä¸‹é¢ä»£ç stateæœ€ç»ˆä¼šæ˜¯5">ä¸‹é¢ä»£ç stateæœ€ç»ˆä¼šæ˜¯5ï¼š<a class="hash-link" href="#ä¸‹é¢ä»£ç stateæœ€ç»ˆä¼šæ˜¯5" title="Direct link to heading">â€‹</a></h4><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">stateåˆå§‹å€¼ä¸º{a:1}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clickHandler(){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.setState((prevState, nextProps) =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      return {a:prevState.a + 1};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.setState((prevState, nextProps) =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      return {a:prevState.a + 1};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.setState((prevState, nextProps) =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      return {a:prevState.a + 1};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.setState((prevState, nextProps) =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      return {a:prevState.a + 1};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/BUPTlhuanyu/ReactNote/tree/master/docs/react/react/reconciler/å¤šæ¬¡æ‰§è¡ŒsetStateçš„æ›´æ–°æœºåˆ¶.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/ReactNote/docs/react/react/reconciler/expiration-time"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">åˆ°æœŸæ—¶é—´</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/ReactNote/docs/react/react/reconciler/react-fiber-lazy-component"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">ReactFiberLazyComponent</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 BUPTlhuanyu, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/ReactNote/assets/js/runtime~main.208fed75.js"></script>
<script src="/ReactNote/assets/js/main.d0834552.js"></script>
</body>
</html>