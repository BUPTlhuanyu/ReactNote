<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="alternate" type="application/rss+xml" href="/ReactNote/blog/rss.xml" title="React Note Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/ReactNote/blog/atom.xml" title="React Note Blog Atom Feed"><title data-react-helmet="true">React Note</title><meta data-react-helmet="true" property="og:title" content="React Note"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://BUPTlhuanyu.github.io/ReactNote/docs/react/react/reconciler/multi-setstate"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" name="description" content="æ¦‚è¿°ï¼ŒèƒŒæ™¯"><meta data-react-helmet="true" property="og:description" content="æ¦‚è¿°ï¼ŒèƒŒæ™¯"><link data-react-helmet="true" rel="shortcut icon" href="/ReactNote/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://BUPTlhuanyu.github.io/ReactNote/docs/react/react/reconciler/multi-setstate"><link data-react-helmet="true" rel="alternate" href="https://BUPTlhuanyu.github.io/ReactNote/docs/react/react/reconciler/multi-setstate" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://BUPTlhuanyu.github.io/ReactNote/docs/react/react/reconciler/multi-setstate" hreflang="x-default"><link rel="stylesheet" href="/ReactNote/assets/css/styles.2a5b91fc.css">
<link rel="preload" href="/ReactNote/assets/js/runtime~main.ee2f40a8.js" as="script">
<link rel="preload" href="/ReactNote/assets/js/main.33abd88d.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/ReactNote/"><img src="/ReactNote/img/logo.png" alt="React Note Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/ReactNote/img/logo.png" alt="React Note Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">React Note</b></a><a class="navbar__item navbar__link navbar__link--active" href="/ReactNote/docs/react/react/intro">React</a><a class="navbar__item navbar__link" href="/ReactNote/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/BUPTlhuanyu" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ğŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ğŸŒ</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">react</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/ReactNote/docs/react/react/intro">ä»‹ç»</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/ReactNote/docs/react/react/react">ç›®å½•ç»“æ„</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/ReactNote/docs/react/react/shared">å…¬å…±æ–¹æ³•</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">ReactElement</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">scheduler</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">reconciler</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/ReactNote/docs/react/react/reconciler/container-root">åˆ›å»ºcontainerå¯¹åº”çš„root</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/ReactNote/docs/react/react/reconciler/fiber-tree-root">åˆ›å»ºrootä¸‹çš„fiberæ ‘å¹¶å¼€å§‹åˆå§‹è°ƒåº¦</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/ReactNote/docs/react/react/reconciler/schedulework">åˆ›å»ºrootä¸‹çš„fiberæ ‘å¹¶å¼€å§‹åˆå§‹è°ƒåº¦</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/ReactNote/docs/react/react/reconciler/sync-async-work">åŒæ­¥ä¸å¼‚æ­¥è°ƒåº¦</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/ReactNote/docs/react/react/reconciler/performwork">è°ƒåº¦çš„å…¥å£å‡½æ•°</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/ReactNote/docs/react/react/reconciler/performwork-on-root">ä»æ ¹èŠ‚ç‚¹å¼€å§‹è°ƒåº¦</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/ReactNote/docs/react/react/reconciler/expiration-time">åˆ°æœŸæ—¶é—´</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/ReactNote/docs/react/react/reconciler/multi-setstate">å¤šæ¬¡æ‰§è¡ŒsetStateçš„æ›´æ–°æœºåˆ¶</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/ReactNote/docs/react/react/reconciler/react-fiber-lazy-component">ReactFiberLazyComponent</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/ReactNote/docs/react/react/reconciler/todo-list">å¾…æ•´ç†æµç¨‹</a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">event</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/ReactNote/docs/react/react/error/error-handle">å¦‚ä½•å¤„ç†é”™è¯¯</a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">react-hook-form</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">react-router</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">react-transition</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="theme-doc-markdown markdown"><header><h1></h1></header><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="æ¦‚è¿°èƒŒæ™¯"></a>æ¦‚è¿°ï¼ŒèƒŒæ™¯<a class="hash-link" href="#æ¦‚è¿°èƒŒæ™¯" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">stateåˆå§‹å€¼ä¸º{a:1}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">é—®é¢˜1ï¼šæœ€ç»ˆstateä¼šæ˜¯å¤šå°‘</span></span><span class="token-line" style="color:#393A34"><span class="token plain">clickHandler(){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.setState({</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        a : 2</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.setState({</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        a : 3</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.setState({</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        a : 4</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.setState({</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        a : 5</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">é—®é¢˜2ï¼šæœ€ç»ˆstateä¼šæ˜¯å¤šå°‘</span></span><span class="token-line" style="color:#393A34"><span class="token plain">clickHandler(){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.setState((prevState, nextProps) =&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      return {a:prevState.a + 1};</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.setState((prevState, nextProps) =&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      return {a:prevState.a + 1};</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.setState((prevState, nextProps) =&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      return {a:prevState.a + 1};</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.setState((prevState, nextProps) =&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      return {a:prevState.a + 1};</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>æ³¨æ„æœ¬æ–‡å°†ä¸ä¹‹å‰çš„æ–‡ç« <a href="http://note.youdao.com/noteshare?id=84df98e9c1e5cb9d1a66864b34268a7f&amp;sub=1E16F316E66348EB945206AE4746119A" target="_blank" rel="noopener noreferrer">2-6-2ã€å¯¹ç±»ç»„ä»¶æ‰§è¡ŒupdateClassComponent</a>ç´§å¯†ç›¸å…³ã€‚</p><p><strong>é˜…è¯»æœ¬æ–‡éœ€è¦ç‰¹åˆ«å…³æ³¨çš„æ˜¯</strong>ï¼š</p><ol><li>å¦‚ä¸‹å¤šä¸ªsetStateåŒæ­¥çš„æ‰§è¡Œçš„æ—¶å€™ï¼Œæ›´æ–°ä»»åŠ¡çš„åˆ°æœŸæ—¶é—´æ˜¯ç›¸åŒçš„</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">åŸå› ï¼šåŒä¸€äº‹ä»¶ä¸­å¤šæ¬¡åŒæ­¥æ‰§è¡ŒsetStateçš„åˆ°æœŸæ—¶é—´éƒ½æ˜¯ç›¸åŒçš„</span></span><span class="token-line" style="color:#393A34"><span class="token plain">There&#x27;s already pending work. We might be in the middle of a browser</span></span><span class="token-line" style="color:#393A34"><span class="token plain">event. If we were to read the current time, it could cause multiple updates</span></span><span class="token-line" style="color:#393A34"><span class="token plain">within the same event to receive different expiration times, leading to</span></span><span class="token-line" style="color:#393A34"><span class="token plain">tearing. Return the last read time. During the next idle callback, the</span></span><span class="token-line" style="color:#393A34"><span class="token plain">time will be updated</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ol start="2"><li>å½“å‰fiberçš„åˆ°æœŸæ—¶é—´expirationTimeä¼šè¢«è®¾ç½®ä¸ºä¸ç±»ç»„ä»¶setStateäº§ç”Ÿçš„æ›´æ–°ä»»åŠ¡ç›¸åŒçš„åˆ°æœŸæ—¶é—´</li></ol><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="å¿…è¦çš„å›é¡¾ä¸å‡†å¤‡"></a>å¿…è¦çš„å›é¡¾ä¸å‡†å¤‡<a class="hash-link" href="#å¿…è¦çš„å›é¡¾ä¸å‡†å¤‡" title="Direct link to heading">#</a></h4><p>å›é¡¾ç±»ç»„ä»¶çš„å®ä¾‹åŒ–ï¼Œç»™å‡ºä¸€äº›setStateç›¸å…³çš„å‡†å¤‡å·¥ä½œã€‚</p><blockquote><p>åœ¨æ‰§è¡ŒReactDOM.renderæ„å»ºfiberæ ‘çš„æ—¶å€™ï¼Œé‡åˆ°ç±»ç±»å‹çš„ç»„ä»¶ï¼Œä¼šè°ƒç”¨updateClassComponentï¼Œè¯¥å‡½æ•°ä¼šåœ¨ç»„ä»¶æŒ‚è½½ç”Ÿå‘½å‘¨æœŸä¸­è°ƒç”¨constructClassInstanceå®ä¾‹åŒ–ç±»ç±»å‹ç»„ä»¶ã€‚</p></blockquote><p>updateClassComponentæ‰€åœ¨è·¯å¾„ï¼šreact\packages\react-reconciler\src\ReactFiberBeginWork.js</p><blockquote><p>constructClassInstanceæ„å»ºç±»ç»„ä»¶çš„å®ä¾‹ç„¶åè°ƒç”¨adoptClassInstance(workInProgress, instance)ç»™ä¼ å…¥çš„instanceæ·»åŠ æ›´æ–°å™¨updaterå±æ€§å€¼ä¸ºclassComponentUpdaterï¼Œè¿™ä¸ªclassComponentUpdateråœ¨è¯¥æ–‡ä»¶ä¸­æ˜¯ä¸€ä¸ªåŒ…å«å¤šä¸ªå±æ€§çš„ å¯¹è±¡ï¼Œä¸»è¦ç”¨äºå­˜æ”¾æ›´æ–°ä»»åŠ¡ç›¸å…³é€»è¾‘</p></blockquote><p>constructClassInstanceå‡½æ•°æ‰€åœ¨è·¯å¾„ï¼šreact\packages\react-reconciler\src\ReactFiberClassComponent.js
ã€‚</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">const classComponentUpdater = {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  isMounted,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  enqueueSetState(inst, payload, callback) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      ...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  },</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  enqueueReplaceState(inst, payload, callback) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      ...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  },</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  enqueueForceUpdate(inst, callback) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     ...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>setStateæ˜¯ä¾èµ–enqueueSetStateæ¥æ‰§è¡Œæ›´æ–°çš„,enqueueSetStateä»£ç åœ¨ä¸‹é¢çš„åˆ†æä¸­ä¼šç»™å‡ºã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="ä»setstateæ–¹æ³•åˆ‡å…¥"></a>ä»setStateæ–¹æ³•åˆ‡å…¥<a class="hash-link" href="#ä»setstateæ–¹æ³•åˆ‡å…¥" title="Direct link to heading">#</a></h4><p>setStateæ–¹æ³•ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">Component.prototype.setState = function(partialState, callback) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  this.updater.enqueueSetState(this, partialState, callback, &#x27;setState&#x27;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>åœ¨ä¸Šè¿°æ–¹æ³•ä¸­ï¼Œå¿…é¡»è¦ä»‹ç»ä¸€ä¸‹å‚æ•°ä»£è¡¨çš„æ„ä¹‰ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">partialStateï¼šä¼ å…¥setStateæ–¹æ³•çš„æ–°çš„stateå¯¹è±¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">callbackï¼šstateæ›´æ–°ä¹‹åçš„å›è°ƒå‡½æ•°</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>åœ¨ç±»ç»„ä»·ä¸­è°ƒç”¨setStateä¼šç›´æ¥è°ƒç”¨å®ä¾‹ä¸Šupdaterçš„enqueueSetStateæ–¹æ³•ï¼Œå…¶ä»£ç å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">enqueueSetState(inst, payload, callback) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  //è·å–å®ä¾‹å¯¹åº”çš„fiber</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  const fiber = ReactInstanceMap.get(inst);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  //è®¡ç®—å½“å‰æ—¶é—´:reactç¡®ä¿äº†åœ¨åŒä¸€ä¸ªæ—¶é—´ä¸­æ‰€æœ‰çš„æ›´æ–°éƒ½æ˜¯ç›¸åŒçš„åˆ°æœŸæ—¶é—´</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  const currentTime = requestCurrentTime();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  //æ ¹æ®å½“å‰æ—¶é—´ä¸fiberè®¡ç®—åˆ°æœŸæ—¶é—´</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  const expirationTime = computeExpirationForFiber(currentTime, fiber);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  //ä¼ å…¥ä¸€ä¸ªåˆ°æœŸæ—¶é—´ï¼Œè¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œè§packages\react-reconciler\src\ReactUpdateQueue.js</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  const update = createUpdate(expirationTime);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  //åˆ©ç”¨æ–°çš„stateä¿®æ”¹update.payload</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  update.payload = payload;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  //åˆ©ç”¨callbackä¿®æ”¹update.callback</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  if (callback !== undefined &amp;&amp; callback !== null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (__DEV__) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      warnOnInvalidCallback(callback, &#x27;setState&#x27;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    update.callback = callback;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  //ï¼Ÿï¼Ÿï¼Ÿå­˜ç–‘ï¼Œè°ƒç”¨scheduleråˆ é™¤å½“å‰æŸä¸ªä»»åŠ¡ï¼Œè¿™é‡Œå…ˆä¸è®¨è®º</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  flushPassiveEffects();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  //å¼€å§‹è°ƒåº¦setStateå¸¦æ¥çš„æ›´æ–°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  enqueueUpdate(fiber, update);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  //å¼€å§‹è°ƒåº¦æ–°çš„å½“å‰fiberå­æ ‘ï¼Œè®¾ç½®ç›¸å…³çš„åˆ°æœŸæ—¶é—´ç­‰ç­‰,è¿™é‡Œå…³é”®æ˜¯ä¼šç»™å½“å‰fiberè®¾ç½®expirationTimeä¸ºsetStateçš„æ›´æ–°ä»»åŠ¡ç›¸åŒçš„å€¼</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  scheduleWork(fiber, expirationTime);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="enqueueupdate"></a>enqueueUpdate<a class="hash-link" href="#enqueueupdate" title="Direct link to heading">#</a></h4><blockquote><p>enqueueUpdateä¸ºfiberæ„å»ºupdateQueueé˜Ÿåˆ—ï¼Œå¤šä¸ªsetStateçš„æ•ˆæœæ˜¯å¤šä¸ªå…·å¤‡ç›¸åŒåˆ°æœŸæ—¶é—´çš„updateéƒ½è¢«æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­</p></blockquote><p>ä¾èµ–çš„å‡½æ•°ï¼š</p><ul><li>createUpdateQueueè¿”å›ä¸€ä¸ªUpdateQueueç±»å‹çš„å¯¹è±¡ï¼ˆè¯¥å¯¹è±¡æ˜¯ç”±updateç»„æˆçš„é˜Ÿåˆ—ï¼‰ï¼Œä¼ å…¥çš„stateå­˜æ”¾åˆ°baseStateå±æ€§ä¸Šã€‚</li><li>appendUpdateToQueueå°†ä¼ å…¥çš„updateæ·»åŠ åˆ°ä¼ å…¥çš„updateé˜Ÿåˆ—å³queueçš„æœ€åã€‚</li><li>cloneUpdateQueueè¿”å›ä¼ å…¥çš„updateé˜Ÿåˆ—çš„å…‹éš†ç‰ˆï¼Œè¿”å›çš„é˜Ÿåˆ—ä¸ä¼ å…¥çš„é˜Ÿåˆ—çš„firstUpdateæŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡ï¼ŒlastUpdateä¹ŸæŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡ã€‚</li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">export function createUpdateQueue&lt;State&gt;(baseState: State): UpdateQueue&lt;State&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  const queue: UpdateQueue&lt;State&gt; = {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    baseState,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    firstUpdate: null,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    lastUpdate: null,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    firstCapturedUpdate: null,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    lastCapturedUpdate: null,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    firstEffect: null,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    lastEffect: null,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    firstCapturedEffect: null,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    lastCapturedEffect: null,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  };</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  return queue;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">function appendUpdateToQueue&lt;State&gt;(</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  queue: UpdateQueue&lt;State&gt;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  update: Update&lt;State&gt;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Append the update to the end of the list.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  if (queue.lastUpdate === null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Queue is empty</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    queue.firstUpdate = queue.lastUpdate = update;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    queue.lastUpdate.next = update;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    queue.lastUpdate = update;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">function cloneUpdateQueue&lt;State&gt;(</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  currentQueue: UpdateQueue&lt;State&gt;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">): UpdateQueue&lt;State&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  const queue: UpdateQueue&lt;State&gt; = {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    baseState: currentQueue.baseState,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    firstUpdate: currentQueue.firstUpdate,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    lastUpdate: currentQueue.lastUpdate,</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // TODO: With resuming, if we bail out and resuse the child tree, we should</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // keep these effects.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    firstCapturedUpdate: null,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    lastCapturedUpdate: null,</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    firstEffect: null,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    lastEffect: null,</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    firstCapturedEffect: null,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    lastCapturedEffect: null,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  };</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  return queue;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>enqueueUpdateçš„ä½œç”¨æ˜¯å°†ä¼ å…¥çš„æ›´æ–°ä»»åŠ¡ï¼ˆåŒ…å«æ–°stateä»¥åŠåˆ°æœŸæ—¶é—´çš„å¯¹è±¡ï¼‰æ·»åŠ åˆ°æ›´æ–°é˜Ÿåˆ—ã€‚</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">export function enqueueUpdate&lt;State&gt;(fiber: Fiber, update: Update&lt;State&gt;) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Update queues are created lazily.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ä½¿ç”¨alternateå±æ€§åŒå‘è¿æ¥ä¸€ä¸ªå½“å‰fiberå’Œå…¶work-in-progressï¼Œå½“å‰fiberå®ä¾‹çš„alternateå±æ€§æŒ‡å‘å…¶work-in-progressï¼Œwork-in-progressçš„alternateå±æ€§æŒ‡å‘å½“å‰ç¨³å®šfiberã€‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  const alternate = fiber.alternate;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  let queue1;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  let queue2;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  if (alternate === null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // There&#x27;s only one fiber.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    queue1 = fiber.updateQueue;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    queue2 = null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (queue1 === null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      //å¦‚æœå½“å‰ç»„ä»¶æ²¡æœ‰ç­‰å¾…setStateçš„é˜Ÿåˆ—åˆ™åˆ›å»ºä¸€ä¸ªï¼Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åˆ©ç”¨fiberå½“å‰å·²ç»è®°å½•å¹¶éœ€è¦æ•´åˆçš„stateå­˜å‚¨åˆ°queue1ä¸fiber.updateQueue</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      queue1 = fiber.updateQueue = createUpdateQueue(fiber.memoizedState);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // There are two owners.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å¦‚æœfiberæ ‘ä»¥åŠworkinprogressæ ‘éƒ½å­˜åœ¨ï¼Œä¸‹é¢çš„é€»è¾‘åˆ™ä¼šåŒæ­¥ä¸¤ä¸ªæ ‘çš„updateé˜Ÿåˆ—</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    queue1 = fiber.updateQueue;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    queue2 = alternate.updateQueue;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å½“ä¸¤ä¸ªæ ‘çš„é˜Ÿåˆ—è‡³å°‘æœ‰ä¸€ä¸ªä¸å­˜åœ¨çš„æ—¶å€™æ‰§è¡Œé˜Ÿåˆ—åˆ›å»ºæˆ–è€…å¤åˆ¶æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (queue1 === null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (queue2 === null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Neither fiber has an update queue. Create new ones.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //  ä¸¤ä¸ªé˜Ÿåˆ—éƒ½æ²¡æœ‰åˆ™æ ¹æ®å„è‡ªçš„memoizedStateåˆ›å»ºupdateé˜Ÿåˆ—</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        queue1 = fiber.updateQueue = createUpdateQueue(fiber.memoizedState);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        queue2 = alternate.updateQueue = createUpdateQueue(</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          alternate.memoizedState,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¦‚æœæœ‰ä¸€ä¸ªæ²¡æœ‰åˆ™å¤åˆ¶å¦ä¸€ä¸ªé˜Ÿåˆ—ç»™å®ƒ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Only one fiber has an update queue. Clone to create a new one.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        queue1 = fiber.updateQueue = cloneUpdateQueue(queue2);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (queue2 === null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¦‚æœæœ‰ä¸€ä¸ªæ²¡æœ‰åˆ™å¤åˆ¶å¦ä¸€ä¸ªé˜Ÿåˆ—ç»™å®ƒ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Only one fiber has an update queue. Clone to create a new one.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        queue2 = alternate.updateQueue = cloneUpdateQueue(queue1);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Both owners have an update queue.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  if (queue2 === null || queue1 === queue2) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // There&#x27;s only a single queue.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å¦‚æœåªæœ‰ä¸€ä¸ªæ ‘ï¼Œæˆ–è€…ä¸¤æ£µæ ‘é˜Ÿåˆ—æ˜¯åŒä¸€ä¸ªï¼Œåˆ™å°†ä¼ å…¥çš„æ›´æ–°å¯¹è±¡æ·»åŠ åˆ°ç¬¬ä¸€ä¸ªé˜Ÿåˆ—ä¸­</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    appendUpdateToQueue(queue1, update);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // There are two queues. We need to append the update to both queues,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // while accounting for the persistent structure of the list â€” we don&#x27;t</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // want the same update to be added multiple times.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //  å¦‚æœä¸¤ä¸ªé˜Ÿåˆ—å­˜åœ¨ï¼Œåˆ™å°†æ›´æ–°ä»»åŠ¡åŠ å…¥ä¸¤ä¸ªé˜Ÿåˆ—ä¸­ï¼Œå¹¶é¿å…è¢«æ·»åŠ å¤šæ¬¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (queue1.lastUpdate === null || queue2.lastUpdate === null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // One of the queues is not empty. We must add the update to both queues.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      //  æœ‰ä¸€ä¸ªé˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œå°†updateæ·»åŠ åˆ°ä¸¤ä¸ªé˜Ÿåˆ—</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      appendUpdateToQueue(queue1, update);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      appendUpdateToQueue(queue2, update);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // Both queues are non-empty. The last update is the same in both lists,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // because of structural sharing. So, only append to one of the lists.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      appendUpdateToQueue(queue1, update);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // But we still need to update the `lastUpdate` pointer of queue2.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      queue2.lastUpdate = update;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="processupdatequeue"></a>processUpdateQueue<a class="hash-link" href="#processupdatequeue" title="Direct link to heading">#</a></h4><p>é€šè¿‡å¤šä¸ªåŒæ­¥æ‰§è¡Œçš„setStateå‡½æ•°çš„ä½œç”¨ï¼Œä¸ºfiberç”Ÿæˆäº†å¯¹åº”çš„updateQueueï¼Œå¹¶ä¸”updateQueueä¸­çš„æ¯ä¸ªupdateçš„åˆ°æœŸæ—¶é—´æ˜¯ç›¸åŒçš„ã€‚æœ€ç»ˆåœ¨è°ƒåº¦æ›´æ–°æ ‘çš„æ—¶å€™ä¼šè°ƒç”¨performWorkï¼Œå…¶ä¸­ä¼šè°ƒç”¨updateClassInstanceï¼Œå…¶ä¸­ä¼šè°ƒç”¨processUpdateQueueå‡½æ•°æ¥å¤„ç†ä¹‹å‰æ„å»ºçš„updateQueueã€‚åªè€ƒè™‘updateQueueä¸­çš„updateï¼Œçœç•¥CapturedUpdateç›¸å…³é€»è¾‘ä¹‹åprocessUpdateQueueéƒ¨åˆ†ä»£ç å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">export function processUpdateQueue&lt;State&gt;(</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  workInProgress: Fiber,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  queue: UpdateQueue&lt;State&gt;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  props: any,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  instance: any,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  renderExpirationTime: ExpirationTime,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">): void {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  hasForceUpdate = false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  queue = ensureWorkInProgressQueueIsAClone(workInProgress, queue);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // These values may change as we process the queue.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  let newBaseState = queue.baseState;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  let newFirstUpdate = null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  let newExpirationTime = NoWork;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Iterate through the list of updates to compute the result.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  let update = queue.firstUpdate;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  let resultState = newBaseState;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  while (update !== null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    const updateExpirationTime = update.expirationTime;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (updateExpirationTime &lt; renderExpirationTime) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // This update does not have sufficient priority. Skip it.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (newFirstUpdate === null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // This is the first skipped update. It will be the first update in</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // the new list.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        newFirstUpdate = update;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Since this is the first update that was skipped, the current result</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // is the new base state.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        newBaseState = resultState;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // Since this update will remain in the list, update the remaining</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // expiration time.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (newExpirationTime &lt; updateExpirationTime) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        newExpirationTime = updateExpirationTime;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // This update does have sufficient priority. Process it and compute</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // a new result.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      resultState = getStateFromUpdate(</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        workInProgress,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        queue,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        update,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        resultState,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        props,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        instance,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      );</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      const callback = update.callback;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (callback !== null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        workInProgress.effectTag |= Callback;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Set this to null, in case it was mutated during an aborted render.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        update.nextEffect = null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (queue.lastEffect === null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          queue.firstEffect = queue.lastEffect = update;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          queue.lastEffect.nextEffect = update;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          queue.lastEffect = update;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Continue to the next update.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    update = update.next;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  if (newFirstUpdate === null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    queue.lastUpdate = null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  if (newFirstUpdate === null &amp;&amp; newFirstCapturedUpdate === null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // We processed every update, without skipping. That means the new base</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // state is the same as the result state.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    newBaseState = resultState;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  queue.baseState = newBaseState;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  queue.firstUpdate = newFirstUpdate;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  workInProgress.expirationTime = newExpirationTime;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  workInProgress.memoizedState = resultState;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>åœ¨åŒæ­¥å¤šæ¬¡æ‰§è¡ŒsetStateçš„æƒ…å†µä¸‹ï¼Œå¾ªç¯ä¸­çš„ if åˆ¤æ–­æ¡ä»¶newExpirationTimeå§‹ç»ˆä¼šç­‰äºrenderExpirationTimeï¼Œå› æ­¤ä¼šå¾ªç¯éå†updateQueueé˜Ÿåˆ—ä¸­çš„updateï¼Œå¹¶è°ƒç”¨getStateFromUpdateä¸æ–­ä¿®æ”¹åˆå¹¶stateï¼Œå¾—åˆ°æœ€ç»ˆçš„stateå³resultStateã€‚processUpdateQueueçš„æœ€åä¼šå°†å¾—åˆ°çš„æ–°çš„stateå­˜å‚¨åˆ°queue.baseStateï¼Œå°†queue.firstUpdateç½®ä¸ºnullã€‚</p><p>æ¥ä¸‹æ¥é€šè¿‡getStateFromUpdateçœ‹å¦‚ä½•åˆå¹¶stateï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">function getStateFromUpdate&lt;State&gt;(</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  workInProgress: Fiber,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  queue: UpdateQueue&lt;State&gt;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  update: Update&lt;State&gt;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  prevState: State,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  nextProps: any,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  instance: any,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">): any {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  switch (update.tag) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     ...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Intentional fallthrough</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    case UpdateState: {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      const payload = update.payload;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      let partialState;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      //ä¸¤ç§ä¸åŒçš„setStateæ–¹å¼ï¼šç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå¯¹è±¡æˆ–è€…ä¸€ä¸ªå‡½æ•°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (typeof payload === &#x27;function&#x27;) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Updater function</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        partialState = payload.call(instance, prevState, nextProps);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Partial state object</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        partialState = payload;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (partialState === null || partialState === undefined) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Null and undefined are treated as no-ops.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¦‚æœåˆå¹¶åçš„stateä¸ºnullæˆ–è€…undefinedåˆ™è¿”å›ä¹‹å‰çš„state</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return prevState;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // Merge the partial state and the previous state.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // åˆå¹¶stateï¼Œå¹¶è¿”å›ï¼ŒObject.assignè¿™é‡Œæ˜¯ç¬¬ä¸€å±‚æ·±æ‹·è´ï¼Œå¦‚æœstateæ¯”è¾ƒå¤æ‚ï¼Œå°±ä¼šå­˜åœ¨æ·±å±‚å±æ€§æµ…æ‹·è´çš„ç°è±¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      return Object.assign({}, prevState, partialState);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  return prevState;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>ç”±äºè¿™é‡Œåªçœ‹setStateï¼Œå› æ­¤çœç•¥äº†éƒ¨åˆ†ä»£ç ã€‚è¿™é‡Œå¯ä»¥å¾ˆæ¸…æ™°çš„çœ‹åˆ°stateçš„åˆå¹¶æœºåˆ¶ï¼ŒsetStateçš„ç¬¬ä¸€ä¸ªå‚æ•°æœ‰ä¸¤ç§æ–¹å¼ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">1ã€å¯¹è±¡å½¢å¼</span></span><span class="token-line" style="color:#393A34"><span class="token plain">2ã€å‡½æ•°å½¢å¼</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    (prevState, nextProps) =&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      return {...};</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ul><li>å¯¹è±¡å½¢å¼ï¼šä¼šç›´æ¥å°†å½“å‰çš„setStateä¸­çš„æ–°çš„stateä½œä¸ºpartialStateï¼Œç„¶ååˆ©ç”¨Object.assign({}, prevState, partialState)å°†ä¸Šä¸€æ¬¡setStateä¹‹åçš„stateä¸å½“å‰çš„æ–°çš„stateåˆå¹¶åˆ°ä¸€ä¸ªæ–°çš„å¯¹è±¡ä¸Šã€‚</li><li>å‡½æ•°å½¢å¼ï¼šåˆ©ç”¨è¯¥å‡½æ•°å¯¹ä¸Šä¸€æ¬¡setStateä¹‹åçš„stateä¸ä¸‹ä¸€æ¬¡çš„propsè¿›è¡Œè®¡ç®—åè¿”å›çš„å¯¹è±¡ä½œä¸ºå½“å‰æ–°çš„stateï¼Œå¹¶å­˜å‚¨åœ¨partialStateï¼Œæœ€åä¸prevStateåˆå¹¶åˆ°æ–°çš„å¯¹è±¡ä¸Šã€‚</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="ä¸‹é¢ä»£ç stateæœ€ç»ˆä¼šæ˜¯5"></a>ä¸‹é¢ä»£ç stateæœ€ç»ˆä¼šæ˜¯5ï¼š<a class="hash-link" href="#ä¸‹é¢ä»£ç stateæœ€ç»ˆä¼šæ˜¯5" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">stateåˆå§‹å€¼ä¸º{a:1}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">clickHandler(){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.setState((prevState, nextProps) =&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      return {a:prevState.a + 1};</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.setState((prevState, nextProps) =&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      return {a:prevState.a + 1};</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.setState((prevState, nextProps) =&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      return {a:prevState.a + 1};</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.setState((prevState, nextProps) =&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      return {a:prevState.a + 1};</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/BUPTlhuanyu/ReactNote/tree/master/docs/react/react/reconciler/å¤šæ¬¡æ‰§è¡ŒsetStateçš„æ›´æ–°æœºåˆ¶.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_13-_"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/ReactNote/docs/react/react/reconciler/expiration-time"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« åˆ°æœŸæ—¶é—´</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/ReactNote/docs/react/react/reconciler/react-fiber-lazy-component"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">ReactFiberLazyComponent Â»</div></a></div></nav></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 BUPTlhuanyu, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/ReactNote/assets/js/runtime~main.ee2f40a8.js"></script>
<script src="/ReactNote/assets/js/main.33abd88d.js"></script>
</body>
</html>