<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="alternate" type="application/rss+xml" href="/ReactNote/blog/rss.xml" title="React Note Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/ReactNote/blog/atom.xml" title="React Note Blog Atom Feed"><title data-react-helmet="true">React Note</title><meta data-react-helmet="true" property="og:title" content="React Note"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://BUPTlhuanyu.github.io/ReactNote/docs/react/react/scheduler/others/scheduler-code-details"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" name="description" content="1ã€ä¸ºå„ä¸ªäº‹ä»¶å›è°ƒå‡½æ•°è®¾ç½®ç›¸åº”çš„ä¼˜å…ˆçº§ï¼Œç„¶åæ ¹æ®è‡ªå®šä¹‰æˆ–è€…é»˜è®¤ä¼˜å…ˆçº§ç¡®å®šåˆ°æœŸæ—¶é—´ï¼Œä»¥æ­¤ä¸ºåŸºç¡€ï¼Œæ„å»ºä¸€ä¸ªåŒå‘å¾ªç¯åˆ—è¡¨å½“åšä»»åŠ¡é˜Ÿåˆ—ï¼Œæ¯ä¸ªèŠ‚ç‚¹å­˜å‚¨äº†ä»»åŠ¡çš„å›è°ƒå‡½æ•°ä»¥åŠåˆ°æœŸæ—¶é—´ï¼Œä¼˜å…ˆçº§ï¼Œå‰ä¸€ä¸ªèŠ‚ç‚¹åä¸€ä¸ªèŠ‚ç‚¹ã€‚"><meta data-react-helmet="true" property="og:description" content="1ã€ä¸ºå„ä¸ªäº‹ä»¶å›è°ƒå‡½æ•°è®¾ç½®ç›¸åº”çš„ä¼˜å…ˆçº§ï¼Œç„¶åæ ¹æ®è‡ªå®šä¹‰æˆ–è€…é»˜è®¤ä¼˜å…ˆçº§ç¡®å®šåˆ°æœŸæ—¶é—´ï¼Œä»¥æ­¤ä¸ºåŸºç¡€ï¼Œæ„å»ºä¸€ä¸ªåŒå‘å¾ªç¯åˆ—è¡¨å½“åšä»»åŠ¡é˜Ÿåˆ—ï¼Œæ¯ä¸ªèŠ‚ç‚¹å­˜å‚¨äº†ä»»åŠ¡çš„å›è°ƒå‡½æ•°ä»¥åŠåˆ°æœŸæ—¶é—´ï¼Œä¼˜å…ˆçº§ï¼Œå‰ä¸€ä¸ªèŠ‚ç‚¹åä¸€ä¸ªèŠ‚ç‚¹ã€‚"><link data-react-helmet="true" rel="shortcut icon" href="/ReactNote/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://BUPTlhuanyu.github.io/ReactNote/docs/react/react/scheduler/others/scheduler-code-details"><link data-react-helmet="true" rel="alternate" href="https://BUPTlhuanyu.github.io/ReactNote/docs/react/react/scheduler/others/scheduler-code-details" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://BUPTlhuanyu.github.io/ReactNote/docs/react/react/scheduler/others/scheduler-code-details" hreflang="x-default"><link rel="stylesheet" href="/ReactNote/assets/css/styles.694d919f.css">
<link rel="preload" href="/ReactNote/assets/js/runtime~main.a78b756c.js" as="script">
<link rel="preload" href="/ReactNote/assets/js/main.48fd23c8.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script>
<script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?64a3c7fa9e8533c72827dc22e0d273ab";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/ReactNote/"><img src="/ReactNote/img/logo.png" alt="React Note Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/ReactNote/img/logo.png" alt="React Note Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">React Note</b></a><a class="navbar__item navbar__link navbar__link--active" href="/ReactNote/docs/react/react/intro">React</a><a class="navbar__item navbar__link" href="/ReactNote/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/BUPTlhuanyu" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ğŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ğŸŒ</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">react</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/ReactNote/docs/react/react/intro">ä»‹ç»</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/ReactNote/docs/react/react/project-directory">ç›®å½•ç»“æ„</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/ReactNote/docs/react/react/shared">å…¬å…±æ–¹æ³•</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">ReactElement</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">scheduler</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/ReactNote/docs/react/react/scheduler/why-need-scheduler">ä¸ºä»€ä¹ˆéœ€è¦scheduler</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/ReactNote/docs/react/react/scheduler/new-scheduler">æ–°ç‰ˆscheduler</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/ReactNote/docs/react/react/scheduler/old-scheduler">å¯¹é½frameç‰ˆæœ¬çš„scheduler</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">å…¶ä»–</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/ReactNote/docs/react/react/scheduler/others/react-is">react-is</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/ReactNote/docs/react/react/scheduler/others/scheduler-code-details">scheduler-code-details</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/ReactNote/docs/react/react/scheduler/others/scheduler-tracing-subscriptions">scheduler-tracing-subscriptions</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/ReactNote/docs/react/react/scheduler/others/scheduler-tracing">scheduler-tracing</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">reconciler</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">event</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/ReactNote/docs/react/react/error/error-handle">å¦‚ä½•å¤„ç†é”™è¯¯</a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">react-hook-form</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">react-router</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">react-transition</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>è®¾è®¡æ€æƒ³</h1></header><p>1ã€ä¸ºå„ä¸ªäº‹ä»¶å›è°ƒå‡½æ•°è®¾ç½®ç›¸åº”çš„ä¼˜å…ˆçº§ï¼Œç„¶åæ ¹æ®è‡ªå®šä¹‰æˆ–è€…é»˜è®¤ä¼˜å…ˆçº§ç¡®å®šåˆ°æœŸæ—¶é—´ï¼Œä»¥æ­¤ä¸ºåŸºç¡€ï¼Œæ„å»ºä¸€ä¸ªåŒå‘å¾ªç¯åˆ—è¡¨å½“åšä»»åŠ¡é˜Ÿåˆ—ï¼Œæ¯ä¸ªèŠ‚ç‚¹å­˜å‚¨äº†ä»»åŠ¡çš„å›è°ƒå‡½æ•°ä»¥åŠåˆ°æœŸæ—¶é—´ï¼Œä¼˜å…ˆçº§ï¼Œå‰ä¸€ä¸ªèŠ‚ç‚¹åä¸€ä¸ªèŠ‚ç‚¹ã€‚</p><p>2ã€å½¢æˆçš„ä»»åŠ¡é“¾è¡¨çš„æ‰§è¡Œå‡†åˆ™æ˜¯ï¼šå½“å‰å¸§æœ‰ç©ºé—²æ—¶é—´ï¼Œåˆ™æ‰§è¡Œä»»åŠ¡ã€‚å³ä¾¿æ²¡æœ‰ç©ºé—²æ—¶é—´ä½†æ˜¯å½“å‰ä»»åŠ¡é“¾è¡¨æœ‰ä»»åŠ¡åˆ°æœŸäº†æˆ–è€…æœ‰ç«‹å³æ‰§è¡Œä»»åŠ¡ï¼Œé‚£ä¹ˆå¿…é¡»æ‰§è¡Œçš„æ—¶å€™å°±ä»¥ä¸¢å¤±å‡ å¸§çš„ä»£ä»·ï¼Œæ‰§è¡Œä»»åŠ¡é“¾è¡¨ä¸­åˆ°æœŸçš„ä»»åŠ¡ã€‚æ‰§è¡Œå®Œçš„ä»»åŠ¡éƒ½ä¼šè¢«ä»é“¾è¡¨ä¸­åˆ é™¤ã€‚æ¯æ¬¡åœ¨æ‰§è¡Œä»»åŠ¡é“¾è¡¨ä¸­åˆ°æœŸçš„ä»»åŠ¡çš„é‚£æ®µæ—¶é—´é‡Œï¼Œé¡ºä¾¿æŠŠä¼˜å…ˆçº§æœ€é«˜éœ€è¦ç«‹å³æ‰§è¡Œçš„ä»»åŠ¡éƒ½æ‰§è¡Œã€‚</p><p>æ€»è§ˆå›¾ï¼šflush*ä¸ºä»»åŠ¡æ‰§è¡Œæ¨¡å—ï¼Œä¸»è¦ç”¨äºæ‰§è¡Œä»»åŠ¡çš„å›è°ƒå‡½æ•°ï¼Œå¯¹ä»»åŠ¡é“¾è¡¨è¿›è¡Œæ“ä½œã€‚idleTickä¸animationTickä¸ºç›´æ¥è°ƒåº¦æ¨¡å—ï¼Œæ ¹æ®å½“å‰å¸§çš„ç©ºé—²æ—¶é—´ä¸ä»»åŠ¡é“¾è¡¨æœ€å°åˆ°æœŸæ—¶é—´æ¥æ§åˆ¶æ˜¯å¦åœ¨å½“å‰å¸§æ‰§è¡Œä»»åŠ¡é“¾è¡¨è¿˜æ˜¯åœ¨ä¸‹ä¸€å¸§ç»§ç»­å¤„ç†ã€‚ensureHostCallbackIsScheduledä¸requestHostCallbackç»„æˆä»»åŠ¡æ‰§è¡Œæ¨¡å—ä¸è°ƒåº¦æ¨¡å—çš„æ¢çº½ï¼Œåè°ƒä¸¤è€…çš„å·¥ä½œï¼Œå¹¶ä¸”ensureHostCallbackIsScheduledä¸ºå¤–éƒ¨APIæä¾›å…¥å£ã€‚</p><p><img src="/ReactNote/assets/images/scheduler-89f3ab83ca7250ef90c1572e772b9cf1.png"></p><header><h1>ä¾‹å­</h1></header><p>è€ƒè™‘ä¸€ç§æ¯”è¾ƒç®€å•çš„é€»è¾‘ï¼Œä»»åŠ¡é“¾è¡¨çš„æ‰§è¡Œä¸»è¦æ˜¯é€šè¿‡idleTickå‡½æ•°è°ƒç”¨flushWorkå®ç°çš„ï¼Œå› æ­¤åˆ†æidleTickå‡½æ•°å¤„ç†çš„ä¸‰ç§æƒ…å†µï¼š</p><p>æƒ…å†µ1ï¼šå½“å‰å¸§æˆªæ­¢æ—¶é—´å¤§äºå½“å‰æ—¶é—´ï¼Œè¯´æ˜å½“å‰å¸§è¿˜æœ‰æ—¶é—´æ‰§è¡Œä»»åŠ¡é“¾è¡¨èŠ‚ç‚¹ä¸­çš„å›è°ƒå‡½æ•°ï¼Œå› æ­¤æ‰§è¡ŒflushWorkã€‚</p><p>æƒ…å†µ2ï¼šå¦‚æœå½“å‰å¸§æˆªæ­¢æ—¶é—´å°äºæˆ–è€…ç­‰äºå½“å‰æ—¶é—´ï¼Œè¯´æ˜å½“å‰å¸§è¿‡æœŸäº†ï¼Œæ²¡æœ‰å‰©ä½™æ—¶é—´æ‰§è¡Œä»»åŠ¡å›è°ƒå‡½æ•°ï¼Œä½†æ˜¯å¦‚æœä»»åŠ¡é“¾è¡¨çš„æœ€å°åˆ°æœŸæ—¶é—´å·²ç»è¿‡æœŸäº†æˆ–è€…æœ‰ç«‹å³æ‰§è¡Œçš„ä»»åŠ¡ï¼Œé‚£ä¹ˆè¯´æ˜è¿™ä¸ªä»»åŠ¡é“¾è¡¨ä¸­çš„ä»»åŠ¡éå¾—æ‰§è¡Œä¸å¯ï¼Œé‚£å°±ç›´æ¥é˜»å¡æ¸²æŸ“ï¼Œå°†æ¥ä¸‹çš„å‡ ä¸ªæ¸²æŸ“å¸§çš„æ—¶é—´ç”¨æ¥æ‰§è¡Œå½“å‰è¿‡æœŸçš„ä»»åŠ¡é“¾è¡¨ã€‚</p><p>æƒ…å†µ3ï¼šå¦‚æœå½“å‰å¸§æˆªæ­¢æ—¶é—´å°äºæˆ–è€…ç­‰äºå½“å‰æ—¶é—´ï¼Œè¯´æ˜å½“å‰å¸§è¿‡æœŸäº†ï¼Œæ²¡æœ‰å‰©ä½™æ—¶é—´æ‰§è¡Œä»»åŠ¡å›è°ƒå‡½æ•°ï¼Œå¹¶ä¸”ä»»åŠ¡é“¾è¡¨çš„æœ€å°åˆ°æœŸæ—¶é—´è¿˜æ²¡åˆ°ï¼Œå› æ­¤è¿™ä¸ªä»»åŠ¡é“¾è¡¨è¿˜ä¸æ€¥ç€æ‰§è¡Œï¼Œå¯ä»¥æ”¾åˆ°ä¸‹ä¸€å¸§ï¼ˆanimation frame fireçš„æ—¶å€™è°ƒç”¨animationTickè§¦å‘Messageäº‹ä»¶è°ƒç”¨idleTickï¼‰å»å¤„ç†ï¼Œä¾ç„¶åˆ†ä¸‰ç§æƒ…å†µè¿›è¡Œå¤„ç†ã€‚</p><p>ç»™å‡ºä¸€å¼ å›¾å¦‚ä¸‹æˆ–è®¸ä½ ä¼šæœ‰ä¸€ä¸ªæ›´åŠ æ¸…æ™°çš„ç†è§£ï¼š</p><p><img src="/ReactNote/assets/images/scheduleråŸºæœ¬æµç¨‹-70d144bd9985feaa4bdf61c5a04d9284.png"></p><header><h1>ä¼˜å…ˆçº§ä»¥åŠå¯¹åº”çš„è¿‡æœŸæ—¶é—´</h1></header><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="äº”ä¸ªä¼˜å…ˆçº§"></a>äº”ä¸ªä¼˜å…ˆçº§<a class="hash-link" href="#äº”ä¸ªä¼˜å…ˆçº§" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">var ImmediatePriority = 1;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">var UserBlockingPriority = 2;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">var NormalPriority = 3;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">var LowPriority = 4;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">var IdlePriority = 5;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="äº”ä¸ªä¼˜å…ˆçº§å¯¹åº”çš„è¿‡æœŸæ—¶é—´"></a>äº”ä¸ªä¼˜å…ˆçº§å¯¹åº”çš„è¿‡æœŸæ—¶é—´<a class="hash-link" href="#äº”ä¸ªä¼˜å…ˆçº§å¯¹åº”çš„è¿‡æœŸæ—¶é—´" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">var maxSigned31BitInt = 1073741823;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">//  è¿‡æœŸæ—¶é—´</span></span><span class="token-line" style="color:#393A34"><span class="token plain">var IMMEDIATE_PRIORITY_TIMEOUT = -1;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">var USER_BLOCKING_PRIORITY = 250;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">var NORMAL_PRIORITY_TIMEOUT = 5000;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">var LOW_PRIORITY_TIMEOUT = 10000;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">var IDLE_PRIORITY = maxSigned31BitInt;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><header><h1>ä¸€äº›å˜é‡</h1></header><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">// å›è°ƒå‡½æ•°è¢«å­˜å‚¨åŒå‘å¾ªç¯é“¾è¡¨ä¸­</span></span><span class="token-line" style="color:#393A34"><span class="token plain">var firstCallbackNode = null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">//å½“å‰äº‹ä»¶å¼€å§‹æ—¶é—´</span></span><span class="token-line" style="color:#393A34"><span class="token plain">var currentEventStartTime = -1;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">//å½“å‰äº‹ä»¶åˆ°æœŸæ—¶é—´</span></span><span class="token-line" style="color:#393A34"><span class="token plain">var currentExpirationTime = -1;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><header><h1>é¢„å¤‡çŸ¥è¯†</h1></header><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="æµè§ˆå™¨æ¸²æŸ“å¸§ä¸æ˜¾ç¤ºå±çš„åˆ·æ–°é¢‘ç‡"></a>æµè§ˆå™¨æ¸²æŸ“å¸§ä¸æ˜¾ç¤ºå±çš„åˆ·æ–°é¢‘ç‡<a class="hash-link" href="#æµè§ˆå™¨æ¸²æŸ“å¸§ä¸æ˜¾ç¤ºå±çš„åˆ·æ–°é¢‘ç‡" title="Direct link to heading">#</a></h3><p>å¸§ï¼šé€šä¿—æ¥è¯´å°±æ˜¯ä¸€å¼ ä¸€å¼ å±•ç¤ºçš„ç”»é¢ï¼ˆå­¦è¿‡ç”µè§†åŸç†çš„åº”è¯¥ä¸ä¼šé™Œç”Ÿï¼Œæœ¬äººæœ¬ç§‘å­¦ç”µå­åšç¡¬ä»¶çš„ã€‚ï¼‰ï¼Œ
ç”±äºç°åœ¨å¹¿æ³›ä½¿ç”¨çš„å±å¹•éƒ½æœ‰å›ºå®šçš„åˆ·æ–°ç‡ï¼ˆæ¯”å¦‚æœ€æ–°çš„ä¸€èˆ¬åœ¨ 60Hzï¼‰ï¼Œ åœ¨ä¸¤æ¬¡ç¡¬ä»¶åˆ·æ–°ä¹‹é—´æµè§ˆå™¨è¿›è¡Œä¸¤æ¬¡é‡ç»˜æ˜¯æ²¡æœ‰æ„ä¹‰çš„åªä¼šæ¶ˆè€—æ€§èƒ½ã€‚å› æ­¤æµè§ˆå™¨çš„æ¸²æŸ“å‡ºä¸€å¸§ç”»é¢çš„é—´éš”åº”è¯¥å°±æ˜¯ç¡¬ä»¶çš„æ¯ä¸€å¸§å›¾åƒçš„æ—¶é—´é—´éš”ï¼Œå³åˆ·æ–°é¢‘ç‡çš„å€’æ•°ã€‚</p><p>é‚£ä¹ˆåœ¨æµè§ˆå™¨å‘ˆç°ä¸¤å¹…å›¾åƒçš„ç©ºé—²ï¼ˆidleï¼‰æ—¶é—´é‡Œï¼Œä¹Ÿå°±æ˜¯16.7msçš„æ—¶é—´é‡Œéœ€è¦æ‰§è¡Œå¦‚ä¸‹æ“ä½œï¼š</p><ul><li>è„šæœ¬æ‰§è¡Œï¼ˆJavaScriptï¼‰ï¼šè„šæœ¬é€ æˆäº†éœ€è¦é‡ç»˜çš„æ”¹åŠ¨ï¼Œæ¯”å¦‚å¢åˆ  DOMã€è¯·æ±‚åŠ¨ç”»ç­‰</li><li>æ ·å¼è®¡ç®—ï¼ˆCSS Object Modelï¼‰ï¼šçº§è”åœ°ç”Ÿæˆæ¯ä¸ªèŠ‚ç‚¹çš„ç”Ÿæ•ˆæ ·å¼ã€‚</li><li>å¸ƒå±€ï¼ˆLayoutï¼‰ï¼šè®¡ç®—å¸ƒå±€ï¼Œæ‰§è¡Œæ¸²æŸ“ç®—æ³•</li><li>é‡ç»˜ï¼ˆPaintï¼‰ï¼šå„å±‚åˆ†åˆ«è¿›è¡Œç»˜åˆ¶ï¼ˆæ¯”å¦‚ 3D åŠ¨ç”»ï¼‰</li><li>åˆæˆï¼ˆCompositeï¼‰ï¼šåˆæˆå„å±‚çš„æ¸²æŸ“ç»“æœ</li></ul><p>åœ¨è¿™16.7msä¸­ï¼ŒåŒ…æ‹¬äº†jsè„šæœ¬æ‰§è¡Œï¼Œéœ€è¦jsçº¿ç¨‹ï¼Œè€Œæ¸²æŸ“éœ€è¦çš„æ˜¯guiæ¸²æŸ“çº¿ç¨‹ï¼Œè€Œè¿™ä¸¤ä¸ªçº¿ç¨‹æ˜¯äº’æ–¥çš„ã€‚ç”±äºGUIæ¸²æŸ“çº¿ç¨‹ä¸JavaScriptæ‰§è¡Œçº¿ç¨‹æ˜¯äº’æ–¥çš„å…³ç³»ï¼Œå½“æµè§ˆå™¨åœ¨æ‰§è¡ŒJavaScriptç¨‹åºçš„æ—¶å€™ï¼ŒGUIæ¸²æŸ“çº¿ç¨‹ä¼šè¢«ä¿å­˜åœ¨ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œç›´åˆ°JSç¨‹åºæ‰§è¡Œå®Œæˆï¼Œæ‰ä¼šæ¥ç€æ‰§è¡Œã€‚å› æ­¤å¦‚æœJSæ‰§è¡Œçš„æ—¶é—´è¿‡é•¿ï¼Œè¿™æ ·å°±ä¼šé€ æˆé¡µé¢çš„æ¸²æŸ“ä¸è¿è´¯ï¼Œå¯¼è‡´é¡µé¢æ¸²æŸ“åŠ è½½é˜»å¡çš„æ„Ÿè§‰ã€‚</p><p>å¦‚ä¸‹å›¾æ‰€ç¤ºä¸ºæ¸²æŸ“å¸§ï¼Œä»£ç åœ¨githubä¸­reactNoteä»“åº“ä¸­ï¼Œè¿™é‡Œå±•ç¤ºä¸€ä¸‹ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">var start = null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">var element = document.getElementById(&quot;move&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">element.style.position = &#x27;absolute&#x27;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">function step(timestamp) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(&quot;timestamp&quot;,timestamp)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!start) start = timestamp;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    var progress = timestamp - start;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    element.style.left = Math.min(progress / 10, 200) + &#x27;px&#x27;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (progress &lt; 400) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        window.requestAnimationFrame(step);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        window.postMessage({},&quot;*&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">var idleTick = function(){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(&quot;idleTick&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">window.addEventListener(&#x27;message&#x27;, idleTick, false);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">window.requestAnimationFrame(step);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><img src="/ReactNote/assets/images/jsæ¸²æŸ“å¸§-d6f57fb5a30e4ee25e6a33ccd8d82ad8.png"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="æ³¨æ„"></a>æ³¨æ„ï¼š<a class="hash-link" href="#æ³¨æ„" title="Direct link to heading">#</a></h4><p>1ã€ä»å›¾ä¸­å¯ä»¥çœ‹åˆ°å¸ƒå±€é‡ç»˜åˆæˆä¹‹åå¹¶ä¸ä»£è¡¨æ˜¯å¸§çš„ç»“æŸã€‚æœ¬æ–‡çš„å½“å‰å¸§æˆªæ­¢æ—¶é—´frameDeadLineæ˜¯animation frame firedå¼€å§‹æ—¶é—´ + activeFrameTimeï¼ŒactiveFrameTimeè¿™ä¸ªå€¼å°±æ˜¯FPSï¼Œä¹Ÿå°±æ˜¯æµè§ˆå™¨å½“å‰çš„åˆ·æ–°é¢‘ç‡ï¼Œè¡¨ç¤ºæµç•…ç¨‹åº¦ï¼Œè¿™ä¸ªå€¼éšç€ç³»ç»Ÿçš„è¿è¡Œè€Œå˜åŒ–ã€‚</p><p>2ã€ä»å›¾ä¸­è¿˜å¯ä»¥çœ‹åˆ°postmessageåœ¨åˆæˆä¹‹åæ‰§è¡Œã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="windowrequestanimationframe"></a><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/requestAnimationFrame" target="_blank" rel="noopener noreferrer">window.requestAnimationFrame</a><a class="hash-link" href="#windowrequestanimationframe" title="Direct link to heading">#</a></h3><p>å½“ä½ å‡†å¤‡æ›´æ–°åŠ¨ç”»æ—¶ä½ åº”è¯¥è°ƒç”¨æ­¤æ–¹æ³•ã€‚è¿™å°†ä½¿æµè§ˆå™¨åœ¨ä¸‹ä¸€æ¬¡é‡ç»˜ä¹‹å‰è°ƒç”¨ä½ ä¼ å…¥ç»™è¯¥æ–¹æ³•çš„åŠ¨ç”»å‡½æ•°(å³ä½ çš„å›è°ƒå‡½æ•°)ã€‚å›è°ƒå‡½æ•°æ‰§è¡Œæ¬¡æ•°é€šå¸¸æ˜¯æ¯ç§’60æ¬¡ï¼Œä½†åœ¨å¤§å¤šæ•°éµå¾ªW3Cå»ºè®®çš„æµè§ˆå™¨ä¸­ï¼Œå›è°ƒå‡½æ•°æ‰§è¡Œæ¬¡æ•°é€šå¸¸ä¸æµè§ˆå™¨å±å¹•åˆ·æ–°æ¬¡æ•°ç›¸åŒ¹é…ã€‚ä¸ºäº†æé«˜æ€§èƒ½å’Œç”µæ± å¯¿å‘½ï¼Œå› æ­¤åœ¨å¤§å¤šæ•°æµè§ˆå™¨é‡Œï¼Œå½“<code>requestAnimationFrame()</code> è¿è¡Œåœ¨åå°æ ‡ç­¾é¡µæˆ–è€…éšè—çš„<code>&lt;iframe&gt;</code> é‡Œæ—¶ï¼Œ<code>requestAnimationFrame()</code> ä¼šè¢«æš‚åœè°ƒç”¨ä»¥æå‡æ€§èƒ½å’Œç”µæ± å¯¿å‘½ã€‚</p><p><strong>å‚æ•°ï¼š</strong></p><p>å¯¹äºä¼ å…¥çš„å›è°ƒå‡½æ•°ï¼šä¸‹ä¸€æ¬¡é‡ç»˜ä¹‹å‰æ›´æ–°åŠ¨ç”»å¸§æ‰€è°ƒç”¨çš„å‡½æ•°ã€‚è¯¥å›è°ƒå‡½æ•°ä¼šè¢«ä¼ å…¥<code>DOMHighResTimeStamp</code>å‚æ•°ï¼Œè¯¥å‚æ•°ä¸<code>performance.now()</code>çš„è¿”å›å€¼ç›¸åŒï¼Œå®ƒè¡¨ç¤º<code>requestAnimationFrame() </code>å¼€å§‹å»æ‰§è¡Œå›è°ƒå‡½æ•°çš„æ—¶åˆ»ã€‚</p><p><strong>è¿”å›å€¼ï¼š</strong></p><p>ä¸€ä¸ª long æ•´æ•°ï¼Œè¯·æ±‚ ID ï¼Œæ˜¯å›è°ƒåˆ—è¡¨ä¸­å”¯ä¸€çš„æ ‡è¯†ã€‚æ˜¯ä¸ªéé›¶å€¼ï¼Œæ²¡åˆ«çš„æ„ä¹‰ã€‚ä½ å¯ä»¥ä¼ è¿™ä¸ªå€¼ç»™ window.cancelAnimationFrame() ä»¥å–æ¶ˆå›è°ƒå‡½æ•°ã€‚</p><p>æ³¨æ„ï¼šè‹¥ä½ æƒ³åœ¨æµè§ˆå™¨ä¸‹æ¬¡é‡ç»˜ä¹‹å‰ç»§ç»­æ›´æ–°ä¸‹ä¸€å¸§åŠ¨ç”»ï¼Œé‚£ä¹ˆå›è°ƒå‡½æ•°è‡ªèº«å¿…é¡»å†æ¬¡è°ƒç”¨<code>window.requestAnimationFrame()</code></p><p>ä¾‹å¦‚ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">var start = null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">var element = document.getElementById(&#x27;SomeElementYouWantToAnimate&#x27;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">element.style.position = &#x27;absolute&#x27;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">function step(timestamp) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  if (!start) start = timestamp;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  var progress = timestamp - start;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  element.style.left = Math.min(progress / 10, 200) + &#x27;px&#x27;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  if (progress &lt; 2000) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    window.requestAnimationFrame(step);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">window.requestAnimationFrame(step);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>è¿™ä¸ªä¾‹å­ä¸­ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨çš„æ—¶å€™å½“å‰çš„æ¯«ç§’æ•°èµ‹å€¼ç»™timestampå¹¶ä¿å­˜åœ¨startä¸­ï¼Œç„¶åprogress=0ï¼Œå…ƒç´ ä¿æŒä¸åŠ¨ï¼Œå¹¶è°ƒç”¨<code>window.requestAnimationFrame(step)</code>åœ¨æµè§ˆå™¨ä¸‹æ¬¡é‡ç»˜ä¹‹å‰ç»§ç»­æ›´æ–°ä¸‹ä¸€å¸§åŠ¨ç”»ã€‚å‡è®¾åˆ·æ–°é¢‘ç‡ä¸ºæ¯ç§’60æ¬¡ï¼Œå› æ­¤å¤§çº¦16.6msä¹‹ååˆ·æ–°ä¸‹ä¸€æ¬¡ï¼Œæ‰§è¡Œä¸‹ä¸€å¸§åŠ¨ç”»ï¼Œæ­¤æ—¶ä¼ å…¥stepä¸­çš„timestamp = performance.now() = 16.6ï¼Œprogress = 16.6ï¼Œå…ƒç´ å‘å·¦ç§»åŠ¨16.6pxã€‚è¿™æ ·å¾ªç¯ä¸‹å»ï¼Œ<code>progress &gt; 2000</code>åœæ­¢æ‰§è¡Œè¯¥åŠ¨ç”»ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="windowcancelanimationframe"></a><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/cancelAnimationFrame" target="_blank" rel="noopener noreferrer">window.cancelAnimationFrame</a><a class="hash-link" href="#windowcancelanimationframe" title="Direct link to heading">#</a></h3><p>å–æ¶ˆä¸€ä¸ªå…ˆå‰é€šè¿‡è°ƒç”¨window.requestAnimationFrame()æ–¹æ³•æ·»åŠ åˆ°è®¡åˆ’ä¸­çš„åŠ¨ç”»å¸§è¯·æ±‚ã€‚</p><header><h1>ä¸€äº›å·¥å…·å‡½æ•°</h1></header><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="getcurrenttime"></a>getCurrentTime<a class="hash-link" href="#getcurrenttime" title="Direct link to heading">#</a></h3><p>æ³¨æ„<a href="https://developer.mozilla.org/en-US/docs/Web/API/DOMHighResTimeStamp#The_time_origin" target="_blank" rel="noopener noreferrer">window.performance.now()</a>è¿”å›çš„æ˜¯ä¸€ä¸ªä»¥æ¯«ç§’ä¸ºå•ä½çš„æ•°å€¼ï¼Œè¡¨ç¤ºä»æ‰“å¼€å½“å‰æ–‡æ¡£åˆ°è¯¥å‘½ä»¤æ‰§è¡Œçš„æ—¶å€™ç»å†çš„æ¯«ç§’æ•°ã€‚Date.now()æ–¹æ³•è¿”å›è‡ª1970å¹´1æœˆ1æ—¥ 00:00:00 UTCåˆ°å½“å‰æ—¶é—´çš„æ¯«ç§’æ•°ã€‚</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">var getCurrentTime; </span></span><span class="token-line" style="color:#393A34"><span class="token plain">var localDate = Date;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">if (hasNativePerformanceNow) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  var Performance = performance;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  getCurrentTime = function() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return Performance.now();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  };</span></span><span class="token-line" style="color:#393A34"><span class="token plain">} else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  getCurrentTime = function() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return localDate.now();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  };</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="requestanimationframewithtimeout"></a>requestAnimationFrameWithTimeout<a class="hash-link" href="#requestanimationframewithtimeout" title="Direct link to heading">#</a></h3><p>ä¸ºäº†æé«˜æ€§èƒ½å’Œç”µæ± å¯¿å‘½ï¼Œåœ¨å¤§å¤šæ•°æµè§ˆå™¨é‡Œï¼Œå½“<code>requestAnimationFrame()</code> è¿è¡Œåœ¨åå°æ ‡ç­¾é¡µæˆ–è€…éšè—çš„<code>&lt;iframe&gt;</code> é‡Œæ—¶ï¼Œ<code>requestAnimationFrame()</code> ä¼šè¢«æš‚åœè°ƒç”¨ä»¥æå‡æ€§èƒ½å’Œç”µæ± å¯¿å‘½ã€‚ä½†æ˜¯reactå¸Œæœ›åœ¨åå°è¿è¡Œçš„æ—¶å€™ä¹Ÿèƒ½ç»§ç»­å·¥ä½œï¼Œæ‰€ä»¥å°è£…äº†requestAnimationFrameWithTimeoutæ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><p>requestAnimationFrameWithTimeoutçš„åŸç†æ˜¯è¿è¡Œåœ¨åå°çš„æ—¶å€™ï¼Œè°ƒç”¨window.cancelAnimationFrameå–æ¶ˆrequestAnimationFrame()ï¼Œåˆ©ç”¨å®šæ—¶å™¨æ¥æ‰§è¡Œcallbackï¼›è€Œåœ¨è°ƒç”¨requestAnimationFrameçš„æ—¶å€™ï¼Œæ¸…é™¤å®šæ—¶å™¨ï¼Œæ‰§è¡Œcallback</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">var localRequestAnimationFrame =</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    typeof requestAnimationFrame === &#x27;function&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ? requestAnimationFrame</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    : undefined;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">var localCancelAnimationFrame =</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    typeof cancelAnimationFrame === &#x27;function&#x27; ? cancelAnimationFrame : undefined;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">var localSetTimeout = typeof setTimeout === &#x27;function&#x27; ? setTimeout :   undefined;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">var localClearTimeout =</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    typeof clearTimeout === &#x27;function&#x27; ? clearTimeout : undefined;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">var ANIMATION_FRAME_TIMEOUT = 100;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">var rAFID;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">var rAFTimeoutID;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">var requestAnimationFrameWithTimeout = function(callback) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  //åœ¨è°ƒç”¨requestAnimationFrameçš„æ—¶å€™ï¼Œæ¸…é™¤å®šæ—¶å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  rAFID = localRequestAnimationFrame(function(timestamp) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // cancel the setTimeout</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    localClearTimeout(rAFTimeoutID);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    callback(timestamp);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  //åœ¨è½¬åˆ°åå°çš„æ—¶å€™ï¼Œä½¿ç”¨å®šæ—¶å™¨æ‰§è¡Œå›è°ƒå‡½æ•°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  rAFTimeoutID = localSetTimeout(function() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // cancel the requestAnimationFrame</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    localCancelAnimationFrame(rAFID);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    callback(getCurrentTime());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }, ANIMATION_FRAME_TIMEOUT);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><header><h1>ä¸»é€»è¾‘ï¼šåˆ©ç”¨Messageäº‹ä»¶ä¸requestAnimationFrameè¿›è¡Œè°ƒåº¦</h1></header><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="å…³é”®å˜é‡"></a>å…³é”®å˜é‡<a class="hash-link" href="#å…³é”®å˜é‡" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">  // scheduledHostCallbackä¸ºä»»åŠ¡é˜Ÿåˆ—æ‰§è¡Œå™¨ï¼Œå­˜åœ¨è¡¨ç¤ºæœ‰ä»»åŠ¡éœ€è¦æ‰§è¡Œï¼Œä¸å­˜åœ¨è¡¨ç¤ºä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºï¼Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // åœ¨requestHostCallbackä¸­è®¾ç½®ä¸ºæŸä¸ªcallback</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  var scheduledHostCallback = null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  var isMessageEventScheduled = false; //æ˜¯å¦æ˜¯å¦å®‰æ’äº†Messageäº‹ä»¶çš„æ ‡è®°ï¼ŒanimationTickä¸­æ‰§è¡ŒpostMessageä¹‹å‰å°†å…¶ç½®ä¸ºtrueï¼Œåªæœ‰åœ¨æ‰§è¡Œäº†Messageå›è°ƒå‡½æ•°idleTickä¸­ä»¥åŠç”¨äºå–æ¶ˆä»»åŠ¡çš„cancelHostCallbackå‡½æ•°ä¸­ä¸­æ‰ä¼šå°†å…¶ç½®ä¸ºfalseã€‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  var timeoutTime = -1; //ä»£è¡¨æœ€é«˜ä¼˜å…ˆçº§ä»»åŠ¡firstCallbackNodeçš„è¿‡æœŸæ—¶é—´</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  var isAnimationFrameScheduled = false;//ç”¨äºæ ‡è®°æ˜¯å¦å·²ç»æ‰§è¡Œäº†requestAnimationFrameWithTimeout</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  var isFlushingHostCallback = false;//æ ‡è®°æ­£åœ¨æ‰§è¡Œä»»åŠ¡æ‰§è¡Œå™¨ï¼Œè¯¥æ ‡è®°ç›¸å½“äºä¸€ä¸ªé”ã€‚ä½œç”¨æ˜¯isFlushingHostCallbackå‚ä¸å†³å®šæ˜¯å¦å…è®¸postMessage</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  var frameDeadline = 0; //å½“å‰å¸§æˆªæ­¢æ—¶é—´</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  var previousFrameTime = 33; // ç”¨äºä¿å­˜ä¸Šä¸€å¸§çš„æ—¶é—´</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  var activeFrameTime = 33; // ä¸€å¸§çš„æ¸²æŸ“æ—¶é—´33msï¼Œè¿™é‡Œå‡è®¾ 1s 30å¸§</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  //å®‰å…¨æ£€æŸ¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  var messageKey =</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    &#x27;__reactIdleCallback$&#x27; +</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Math.random()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      .toString(36)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      .slice(2);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="ç›‘å¬messageäº‹ä»¶"></a>ç›‘å¬Messageäº‹ä»¶<a class="hash-link" href="#ç›‘å¬messageäº‹ä»¶" title="Direct link to heading">#</a></h3><p>ç›‘å¬Messageäº‹ä»¶ï¼Œä¼ å…¥å›è°ƒå‡½æ•°ï¼Œä¸å…è®¸æ•è·é˜¶æ®µè§¦å‘ã€‚idleTickæ˜¯ç”¨äºåœ¨ç›‘å¬åˆ°Messageäº‹ä»¶è§¦å‘çš„æ—¶å€™æ‰§è¡Œçš„å›è°ƒå‡½æ•°ã€‚</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">window.addEventListener(&#x27;message&#x27;, idleTick, false);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="ç›‘å¬messageäº‹ä»¶ä¼ å…¥çš„å›è°ƒå‡½æ•°idletick"></a>ç›‘å¬Messageäº‹ä»¶ä¼ å…¥çš„å›è°ƒå‡½æ•°idleTick<a class="hash-link" href="#ç›‘å¬messageäº‹ä»¶ä¼ å…¥çš„å›è°ƒå‡½æ•°idletick" title="Direct link to heading">#</a></h3><p>idleTickæµç¨‹å¦‚ä¸‹ï¼š</p><p>1ã€é€šè¿‡å°†å½“å‰å¸§æˆªæ­¢æ—¶é—´ä¸å½“å‰æ—¶é—´å¯¹æ¯”ï¼Œåˆ¤æ–­å½“å‰å¸§æ˜¯å¦æœ‰ç©ºä½™æ—¶é—´æ‰§è¡Œä»»åŠ¡ï¼Œå¦‚æœæœ‰åˆ™åˆ°æ­¥éª¤3ã€‚</p><p>2ã€åˆ¤æ–­ä»»åŠ¡é˜Ÿåˆ—æœ€å°çš„åˆ°æœŸæ—¶é—´å°äºå½“å‰æ—¶é—´ï¼Œå¦‚æœæ˜¯ï¼Œè¯´æ˜å·²ç»è¿‡æœŸï¼Œå°†didTimeoutæ ‡å¿—ç½®ä¸ºtrueï¼Œæ‰§è¡Œç¬¬3æ­¥ã€‚å¦‚æœè¿˜æ²¡æœ‰è¿‡æœŸï¼Œå¹¶ä¸”æ²¡æœ‰è°ƒç”¨requestAnimationFrameWithTimeoutæ¥è®¾ç½®åœ¨å‡ºç°ä¹‹åç«‹é©¬æ‰§è¡ŒanimationTickå‡½æ•°ï¼Œåˆ™è°ƒç”¨requestAnimationFrameWithTimeoutã€‚å¦‚æœå·²ç»è®¾ç½®è¿‡äº†ï¼Œå°±è¿˜åŸä»»åŠ¡é˜Ÿåˆ—ä¸åˆ°æœŸæ—¶é—´å¹¶è¿”å›ã€‚</p><p>3ã€å¦‚æœä»»åŠ¡æ‰§è¡Œå™¨å­˜åœ¨ï¼Œ<code>isFlushingHostCallback = true</code>æ ‡è®°æ­£åœ¨æ‰§è¡Œä»»åŠ¡æ‰§è¡Œå™¨ï¼Œç„¶åæ‰§è¡Œä»»åŠ¡æ‰§è¡Œå™¨ä¸­çš„é€»è¾‘prevScheduledCallback(didTimeout)ï¼Œæœ€å<code>isFlushingHostCallback = false</code>æ ‡è®°æ²¡æœ‰æ­£åœ¨æ‰§è¡Œä»»åŠ¡æ‰§è¡Œå™¨ã€‚å…¶ä¸­isFlushingHostCallbackä½œç”¨æ˜¯å‚ä¸å†³å®šæ˜¯å¦å…è®¸postMessageã€‚è¯¥æ ‡è®°åœ¨requestHostCallbackä¸­ä¼šè§åˆ°ï¼Œä¸è¯¥å‡½æ•°ä¼ å…¥çš„absoluteTimeoutä¸€èµ·å†³å®šæ˜¯å¦window.postMessage(messageKey, &#x27;*&#x27;);ï¼ˆæ­¤æ­¥éª¤å¦‚æœç¬¬1æ­¥æ¥çš„ï¼ŒdidTimeoutä¸ºfalseï¼Œç¬¬2æ­¥æ¥çš„ï¼Œåˆ™ä¸ºtrueï¼Œè¡¨ç¤ºä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡æœ€å°çš„åˆ°æœŸæ—¶é—´å¯¹åº”çš„ä»»åŠ¡å·²ç»è¿‡æœŸäº†ã€‚ï¼‰</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">  var idleTick = function(event) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (event.source !== window || event.data !== messageKey) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    isMessageEventScheduled = false;  //animationTickä¸­æ‰§è¡ŒpostMessageä¹‹å‰å°†å…¶ç½®ä¸ºtrueï¼Œåªæœ‰åœ¨æ‰§è¡Œäº†Messageå›è°ƒå‡½æ•°idleTickä¸­æ‰ä¼šå°†å…¶ç½®ä¸ºfalseã€‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    var prevScheduledCallback = scheduledHostCallback;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    var prevTimeoutTime = timeoutTime;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //ç½®ç©ºä»»åŠ¡é˜Ÿåˆ—æ‰§è¡Œå™¨ä»¥åŠé˜Ÿåˆ—ä¸­firstNodeä¸­çš„æœ€å°çš„åˆ°æœŸæ—¶é—´</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    scheduledHostCallback = null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    timeoutTime = -1;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //è·å–å½“å‰æ—¶é—´</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    var currentTime = getCurrentTime();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //æ ‡è®°ä»»åŠ¡é˜Ÿåˆ—æœ€å°çš„åˆ°æœŸæ—¶é—´çš„èŠ‚ç‚¹ä»¥åŠå½“å‰å¸§æˆªæ­¢æ—¶é—´æ˜¯å¦è¿‡æœŸ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    var didTimeout = false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (frameDeadline - currentTime &lt;= 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // frameDeadlineè¡¨ç¤ºå½“å‰å¸§æˆªæ­¢æ—¶é—´</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // currentTime è¡¨ç¤ºå½“å‰æ—¶åˆ»</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // å¦‚æœå½“å‰æ—¶åˆ»å¤§äºframeDeadlineï¼Œè¯´æ˜å‘ç”Ÿäº†é˜»å¡ï¼Œå·²ç»ä¸¢å¤±äº†ä¸€å¸§</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      //  å¦‚æœå°äºï¼Œè¯´æ˜å½“å‰å¸§æ²¡æœ‰ç©ºé—²æ—¶é—´ï¼Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // There&#x27;s no time left in this idle period. Check if the callback has</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // a timeout and whether it&#x27;s been exceeded.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (prevTimeoutTime !== -1 &amp;&amp; prevTimeoutTime &lt;= currentTime) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //ä»»åŠ¡é˜Ÿåˆ—æœ€å°çš„åˆ°æœŸæ—¶é—´å°äºå½“å‰æ—¶é—´ï¼Œè¯´æ˜å·²ç»è¿‡æœŸï¼Œå°†å…¶æ ‡å¿—ç½®ä¸ºtrue</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Exceeded the timeout. Invoke the callback even though there&#x27;s no</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // time left.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        didTimeout = true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //å¦‚æœæ²¡æœ‰è¿‡æœŸ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // No timeout.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!isAnimationFrameScheduled) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          //æ²¡æœ‰è®¾ç½®requestAnimationFrameWithTimeoutï¼Œå°†å…¶æ ‡å¿—isAnimationFrameScheduledç½®ä¸ºtrue</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          //å¹¶è°ƒç”¨requestAnimationFrameWithTimeout</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          // Schedule another animation callback so we retry later.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          isAnimationFrameScheduled = true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          requestAnimationFrameWithTimeout(animationTick);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Exit without invoking the callback.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //  æ¢å¤ä»»åŠ¡é˜Ÿåˆ—ä¸åˆ°æœŸæ—¶é—´å¹¶è¿”å›</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        scheduledHostCallback = prevScheduledCallback;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        timeoutTime = prevTimeoutTime;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //å¦‚æœå½“å‰å¸§è¿˜æœ‰ç©ºé—²æ—¶é—´ï¼Œå°±æ‰§è¡Œæ‰§è¡Œå™¨ï¼Œæ­¤æ—¶æ‰§è¡Œå™¨ä¸­çš„didTimeout=falseï¼Œè¡¨ç¤ºæ²¡æœ‰è¿‡æœŸï¼ˆæ­¤å¤„æœ‰ç–‘é—®ï¼Œéš¾é“èƒ½ç¡®ä¿æœ€å°åˆ°æœŸæ—¶é—´å°äºå½“å‰æ—¶é—´ï¼Ÿï¼‰</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //å¦‚æœå½“å‰é˜Ÿåˆ—ä¸­æœ€å°çš„åˆ°æœŸæ—¶é—´å·²ç»è¿‡æœŸäº†ï¼Œå°±è¯´æ˜åº”è¯¥ç«‹å³æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„è¯¥ä»»åŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (prevScheduledCallback !== null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      //æ ‡è®°æ­£åœ¨æ‰§è¡Œä»»åŠ¡æ‰§è¡Œå™¨ï¼Œè¯¥æ ‡è®°ç›¸å½“äºä¸€ä¸ªé”ã€‚ä½œç”¨æ˜¯isFlushingHostCallbackå‚ä¸å†³å®šæ˜¯å¦å…è®¸postMessage</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      isFlushingHostCallback = true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æ‰§è¡Œä»»åŠ¡æ‰§è¡Œå™¨ä¸­çš„é€»è¾‘</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        prevScheduledCallback(didTimeout);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      } finally {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æ‰§è¡Œå®Œä¹‹åç½®ä¸ºfalse</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        isFlushingHostCallback = false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  };</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="animation-frame-firedçš„å›è°ƒå‡½æ•°animationtick"></a>animation frame firedçš„å›è°ƒå‡½æ•°animationTick<a class="hash-link" href="#animation-frame-firedçš„å›è°ƒå‡½æ•°animationtick" title="Direct link to heading">#</a></h3><p>å›è°ƒå‡½æ•°idleTickä¸­åœ¨ä¸ç«‹å³æ‰§è¡Œä»»åŠ¡æ‰§è¡Œå™¨çš„æ—¶å€™ï¼Œå¹¶ä¸”æ²¡æœ‰è®¾ç½®animationTickå›è°ƒï¼Œåˆ™ä¼šæ‰§è¡ŒrequestAnimationFrameWithTimeout(animationTick)å¹¶é€€å‡ºï¼Œå…¶ä¸­animationTickçš„ä½œç”¨å¦‚ä¸‹ï¼š</p><p>1ã€å¦‚æœä»»åŠ¡æ‰§è¡Œå™¨ä¸ä¸ºç©ºï¼Œåˆ™åœ¨ä¸‹ä¸€å¸§ç»§ç»­æ‰§è¡ŒanimationTickå›è°ƒå‡½æ•°ï¼Œå¹¶åˆ°ç¬¬2æ­¥ã€‚å¦‚æœä»»åŠ¡æ‰§è¡Œå™¨ä¸ºç©ºï¼Œè¡¨æ˜æ²¡æœ‰ä»»åŠ¡éœ€è¦åœ¨ç©ºé—²æ—¶é—´é‡Œæ‰§è¡Œäº†ï¼Œå°†isAnimationFrameScheduledæ ‡å¿—ç½®ä¸ºfalseï¼Œè¡¨ç¤ºæ²¡æœ‰è®¾ç½®animationTickï¼Œç„¶åç›´æ¥è¿”å›ã€‚
2ã€åŠ¨æ€è°ƒæ•´æ¸²æŸ“ä¸€å¸§çš„æ—¶é—´ï¼Œå¹¶è®¡ç®—å‡ºå½“å‰å¸§æˆªæ­¢æ—¶é—´ä¸ºå½“å‰æ—¶é—´ + è°ƒæ•´åçš„æ—¶é—´é—´éš”
3ã€æ ¹æ®isMessageEventScheduledåˆ¤æ–­æ˜¯å¦æ‰§è¡ŒpostMessageï¼Œé¿å…æ‰“æ–­ä¹‹å‰å®‰æ’çš„Messageæ—¶é—´ã€‚</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">var animationTick = function(rafTime) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (scheduledHostCallback !== null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      //å¦‚æœä»»åŠ¡æ‰§è¡Œå™¨ä¸ä¸ºç©ºï¼Œåˆ™åœ¨ä¸‹ä¸€å¸§ç»§ç»­æ‰§è¡ŒanimationTickå›è°ƒå‡½æ•°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      requestAnimationFrameWithTimeout(animationTick);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // å¦‚æœæ²¡æœ‰ä»»åŠ¡éœ€è¦æ‰§è¡Œï¼Œç›´æ¥è¿”å›ï¼Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      isAnimationFrameScheduled = false; //ä»£è¡¨æ²¡æœ‰ä»»åŠ¡éœ€è¦AnimationFrameæ‰§è¡Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //ç»è¿‡å‡ æ¬¡å±å¹•åˆ·æ–°ä¹‹åï¼ŒåŠ¨æ€è®¡ç®—å‡ºæ­£ç¡®çš„åˆ·æ–°é¢‘ç‡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //  ä¸‹ä¸€å¸§çš„æ—¶é—´ = å½“å‰æ—¶é—´ - å½“å‰å¸§æˆªæ­¢æ—¶é—´ + æ—¶é—´é—´éš”</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //  å¦‚æœæµè§ˆå™¨åˆ·æ–°é¢‘ç‡åˆšå¥½æ˜¯30hzï¼Œåˆ™nextFrameTimeä¸º0</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //  å¦‚æœåˆ·æ–°é¢‘ç‡é«˜äº30hzï¼Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    var nextFrameTime = rafTime - frameDeadline + activeFrameTime;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      nextFrameTime &lt; activeFrameTime &amp;&amp;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      previousFrameTime &lt; activeFrameTime</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (nextFrameTime &lt; 8) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        nextFrameTime = 8;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      activeFrameTime =</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        nextFrameTime &lt; previousFrameTime ? previousFrameTime : nextFrameTime;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      previousFrameTime = nextFrameTime;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //å½“å‰å¸§æˆªæ­¢æ—¶é—´ = å½“å‰æ—¶é—´ + è°ƒæ•´åçš„æ—¶é—´é—´éš”</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    frameDeadline = rafTime + activeFrameTime;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!isMessageEventScheduled) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      isMessageEventScheduled = true;//æ ‡è®°å·²ç»æ‰§è¡Œäº†postMessage</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      window.postMessage(messageKey, &#x27;*&#x27;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  };</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="ä»»åŠ¡æ‰§è¡Œå™¨å¯¹postmessageä¸requestanimationframewithtimeoutè¡Œä¸ºè°ƒåº¦çš„å…³é”®å‡½æ•°"></a>ä»»åŠ¡æ‰§è¡Œå™¨å¯¹postMessageä¸requestAnimationFrameWithTimeoutè¡Œä¸ºè°ƒåº¦çš„å…³é”®å‡½æ•°<a class="hash-link" href="#ä»»åŠ¡æ‰§è¡Œå™¨å¯¹postmessageä¸requestanimationframewithtimeoutè¡Œä¸ºè°ƒåº¦çš„å…³é”®å‡½æ•°" title="Direct link to heading">#</a></h2><p>ä»»åŠ¡æ‰§è¡Œå™¨åœ¨æŸäº›æ¡ä»¶ä¸‹ä¼šè°ƒç”¨ä¸€ä¸‹ä¸‰ä¸ªå‡½æ•°æ¥å‘èµ·postMessageæˆ–è€…requestAnimationFrameWithTimeoutå¯¹ç©ºé—²æ—¶é—´å†…ä»»åŠ¡æ‰§è¡Œå™¨çš„æ‰§è¡Œè¿›è¡Œè°ƒåº¦ä¸æ§åˆ¶ã€‚å…¶ä¸­ä»»åŠ¡æ‰§è¡Œå™¨ä¼šé€šè¿‡è°ƒç”¨ensureHostCallbackIsScheduledå‡½æ•°æ¥å†³å®šæ˜¯è°ƒç”¨å¦è°ƒç”¨cancelHostCallbackæ¥æ¸…ç©ºæ‰§è¡Œå™¨ï¼Œåˆ°æœŸæ—¶é—´ä»¥åŠæ˜¯å¦æ˜¯å¦å®‰æ’äº†Messageäº‹ä»¶çš„æ ‡è®°ï¼›æœ€åä¼šè°ƒç”¨requestHostCallbackæ¥é‡æ–°è®¾ç½®ä»»åŠ¡æ‰§è¡Œå™¨ï¼Œå¹¶ç«‹å³æ‰§è¡Œä»»åŠ¡æˆ–è€…ç¨åæ‰§è¡Œä»»åŠ¡ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="è¢«ä»»åŠ¡æ‰§è¡Œå™¨è°ƒç”¨ä»¥è·å–å½“å‰å¸§æ˜¯å¦è¿‡æœŸçš„å‡½æ•°shouldyieldtohost"></a>è¢«ä»»åŠ¡æ‰§è¡Œå™¨è°ƒç”¨ä»¥è·å–å½“å‰å¸§æ˜¯å¦è¿‡æœŸçš„å‡½æ•°ï¼šshouldYieldToHost<a class="hash-link" href="#è¢«ä»»åŠ¡æ‰§è¡Œå™¨è°ƒç”¨ä»¥è·å–å½“å‰å¸§æ˜¯å¦è¿‡æœŸçš„å‡½æ•°shouldyieldtohost" title="Direct link to heading">#</a></h3><p>shouldYieldToHostè¿”å›å½“å‰å¸§æ˜¯å¦è¿‡æœŸï¼Œå¦‚æœå½“å‰å¸§æˆªæ­¢æ—¶é—´å°äºå½“å‰æ—¶é—´è¯´æ˜å½“å‰å¸§è¿‡æœŸäº†ï¼Œæ²¡æœ‰ç©ºé—²æ—¶é—´äº†ã€‚</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">    var frameDeadline = 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    shouldYieldToHost = function() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return frameDeadline &lt;= getCurrentTime();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    };</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="è¢«ä»»åŠ¡æ‰§è¡Œå™¨è°ƒç”¨ä»¥æ§åˆ¶postmessageè¡Œä¸ºçš„å‡½æ•°cancelhostcallback"></a>è¢«ä»»åŠ¡æ‰§è¡Œå™¨è°ƒç”¨ä»¥æ§åˆ¶postMessageè¡Œä¸ºçš„å‡½æ•°ï¼šcancelHostCallback<a class="hash-link" href="#è¢«ä»»åŠ¡æ‰§è¡Œå™¨è°ƒç”¨ä»¥æ§åˆ¶postmessageè¡Œä¸ºçš„å‡½æ•°cancelhostcallback" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">  //æ¸…é™¤æ‰§è¡Œå™¨ï¼Œåˆ°æœŸæ—¶é—´ä»¥åŠæ˜¯å¦æ˜¯å¦å®‰æ’äº†Messageäº‹ä»¶çš„æ ‡è®°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  cancelHostCallback = function() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    scheduledHostCallback = null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    isMessageEventScheduled = false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    timeoutTime = -1;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  };</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="è¢«ä»»åŠ¡æ‰§è¡Œå™¨è°ƒç”¨ä»¥é‡æ–°è®¾ç½®æ‰§è¡Œå™¨æ§åˆ¶postmessageä¸requestanimationframewithtimeoutè¡Œä¸ºçš„å‡½æ•°requesthostcallback"></a>è¢«ä»»åŠ¡æ‰§è¡Œå™¨è°ƒç”¨ä»¥é‡æ–°è®¾ç½®æ‰§è¡Œå™¨æ§åˆ¶postMessageä¸requestAnimationFrameWithTimeoutè¡Œä¸ºçš„å‡½æ•°ï¼šrequestHostCallback<a class="hash-link" href="#è¢«ä»»åŠ¡æ‰§è¡Œå™¨è°ƒç”¨ä»¥é‡æ–°è®¾ç½®æ‰§è¡Œå™¨æ§åˆ¶postmessageä¸requestanimationframewithtimeoutè¡Œä¸ºçš„å‡½æ•°requesthostcallback" title="Direct link to heading">#</a></h3><p>requestHostCallbackå‡½æ•°ç”¨äºè®¾ç½®ä»»åŠ¡æ‰§è¡Œå™¨ï¼Œä¸åˆ°æœŸæ—¶é—´ï¼Œè¯¥å‡½æ•°å¯ä»¥é‡æ–°è¿è¡Œä¸€ä¸ªæ–°çš„ä»»åŠ¡æ‰§è¡Œå™¨ã€‚å…¶é€»è¾‘æ˜¯ï¼šå¦‚æœé€šè¿‡è¯¥å‡½æ•°è®¾ç½®äº†ä»»åŠ¡æ‰§è¡Œå™¨ï¼Œå¹¶è®¾å®šäº†æ–°çš„åˆ°æœŸæ—¶é—´ï¼Œæ ¹æ®isFlushingHostCallbackè¡¨ç¤ºçš„æ˜¯å¦æœ‰ä»»åŠ¡æ‰§è¡Œå™¨æ­£åœ¨æ‰§è¡Œçš„æ ‡è®°ä»¥åŠåˆ°æœŸæ—¶é—´ï¼Œå¤„ç†ä»»åŠ¡æ‰§è¡Œå™¨æ˜¯ç«‹å³æ‰§è¡Œè¿˜æ˜¯åœ¨ä¸‹ä¸€å¸§è¿›è¡Œè°ƒåº¦ã€‚</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">  requestHostCallback = function(callback, absoluteTimeout) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //ç»™scheduledHostCallbackä»»åŠ¡æ‰§è¡Œå™¨è®¾ç½®ç›¸åº”çš„æ‰§è¡Œé€»è¾‘</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    scheduledHostCallback = callback;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //è®¾å®šåˆ°æœŸæ—¶é—´</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    timeoutTime = absoluteTimeout;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (isFlushingHostCallback || absoluteTimeout &lt; 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      //ç«‹å³æ‰§è¡Œï¼Œé€šè¿‡postMessageè§¦å‘Messageäº‹ä»¶ï¼Œåœ¨idleTickä¸­æ‰§è¡Œæ‰§è¡Œå™¨ä¸­çš„é€»è¾‘å³callback</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // Don&#x27;t wait for the next frame. Continue working ASAP, in a new event.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      window.postMessage(messageKey, &#x27;*&#x27;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else if (!isAnimationFrameScheduled) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      //å¦‚æœä¸æ˜¯ç«‹å³æ‰§è¡Œï¼Œå¹¶ä¸”è¿˜æ²¡æœ‰æ‰§è¡ŒrequestAnimationFrameWithTimeoutè®¾ç½®ä¸‹ä¸€å¸§åˆ·æ–°æ—¶çš„åŠ¨ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      //é‚£ä¹ˆè®¾ç½®isAnimationFrameScheduledæ ‡è®°ï¼Œå¹¶requestAnimationFrameWithTimeout</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // If rAF didn&#x27;t already schedule one, we need to schedule a frame.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // TODO: If this rAF doesn&#x27;t materialize because the browser throttles, we</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // might want to still have setTimeout trigger rIC as a backup to ensure</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // that we keep performing work.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      isAnimationFrameScheduled = true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      requestAnimationFrameWithTimeout(animationTick);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  };</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><header><h1>ä»»åŠ¡æ‰§è¡Œå™¨flushWork</h1></header><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="å·¥å…·å‡½æ•°ensurehostcallbackisscheduled"></a>å·¥å…·å‡½æ•°ensureHostCallbackIsScheduled<a class="hash-link" href="#å·¥å…·å‡½æ•°ensurehostcallbackisscheduled" title="Direct link to heading">#</a></h3><p>å¦‚æœå½“å‰æ­£åœ¨æ‰§è¡Œæœ€é«˜ä¼˜å…ˆçº§çš„å›è°ƒå‡½æ•°ï¼Œåˆ™è¿”å›ã€‚å¦åˆ™ï¼Œæ¸…ç©ºå½“å‰ç©ºé—²æ—¶é—´å®‰æ’çš„ä»»åŠ¡é˜Ÿåˆ—ï¼Œé‡æ–°è®¾ç½®ä»»åŠ¡æ‰§è¡Œå™¨ï¼Œå¹¶åœ¨requestHostCallbackå‡½æ•°ä¸­è°ƒç”¨postMessageè§¦å‘Messageäº‹ä»¶
ï¼Œåœ¨å›è°ƒå‡½æ•°idleTickä¸­ç«‹å³æ‰§è¡Œä»»åŠ¡æ‰§è¡Œå™¨æˆ–è€…æ‰§è¡ŒrequestAnimationFrameWithTimeoutå°†ä»»åŠ¡æ‰§è¡Œå™¨çš„æ‰§è¡Œä¸å¦æ”¾åˆ°ä¸‹ä¸€å¸§æ¥åˆ¤æ–­</p><p>æµç¨‹ï¼š</p><p>1ã€é€šè¿‡isExecutingCallbackæ ‡è®°åˆ¤æ–­æ˜¯å¦æ­£åœ¨æ‰§è¡Œæœ€é«˜ä¼˜å…ˆçº§çš„å›è°ƒå‡½æ•°ï¼Œå¦‚æœæ˜¯çš„ï¼Œç›´æ¥è¿”å›ã€‚å¦‚æœä¸æ˜¯ç»§ç»­æ‰§è¡Œç¬¬2æ­¥</p><p>2ã€è·å–æœ€å°çš„åˆ°æœŸæ—¶é—´ï¼Œå³åŒå‘é“¾è¡¨ç¬¬ä¸€ä¸ªèŠ‚ç‚¹çš„åˆ°æœŸæ—¶é—´ã€‚æ ¹æ®isHostCallbackScheduledæ ‡è®°æ¥åˆ¤æ–­å¸§ä¸å¸§ä¹‹é—´çš„æ—¶é—´é—´éš”å³ç©ºé—²æ—¶é—´æ˜¯å¦å®‰æ’äº†å›è°ƒå‡½æ•°ï¼ˆfasleè¡¨ç¤ºæ²¡æœ‰å®‰æ’å›è°ƒå‡½æ•°ï¼‰ï¼Œå¦‚æœå®‰æ’äº†å›è°ƒå‡½æ•°ï¼Œé‚£ä¹ˆéœ€è¦è°ƒç”¨cancelHostCallbackå‡½æ•°æ¥æ¸…é™¤ä»»åŠ¡æ‰§è¡Œå™¨ï¼Œåˆ°æœŸæ—¶é—´ä»¥åŠæ˜¯å¦æ˜¯å¦å®‰æ’äº†Messageäº‹ä»¶çš„æ ‡è®°ã€‚å¦åˆ™å°†isHostCallbackScheduledæ ‡è®°è®¾ç½®ä¸ºtrue</p><p>3ã€æ‰§è¡ŒrequestHostCallback(flushWork, expirationTime)ï¼Œä¼ å…¥ç¬¬ä¸€ä¸ªèŠ‚ç‚¹çš„åˆ°æœŸæ—¶é—´ï¼Œé‡æ–°è®¾ç½®ä»»åŠ¡æ‰§è¡Œå™¨ï¼Œå¹¶ç«‹å³æ‰§è¡Œä»»åŠ¡æˆ–è€…ç¨åæ‰§è¡Œä»»åŠ¡</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">function ensureHostCallbackIsScheduled() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  //æ˜¯å¦æ­£åœ¨æ‰§è¡Œæœ€é«˜ä¼˜å…ˆçº§çš„å›è°ƒå‡½æ•°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  if (isExecutingCallback) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Don&#x27;t schedule work yet; wait until the next time we yield.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Schedule the host callback using the earliest expiration in the list.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  //  è·å–æœ€å°çš„åˆ°æœŸæ—¶é—´</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  var expirationTime = firstCallbackNode.expirationTime;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  //å½“å‰ç©ºé—²æ—¶é—´è¿˜æ²¡æœ‰å®‰æ’å›è°ƒ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  if (!isHostCallbackScheduled) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //å°†æ ‡å¿—ç½®ä¸ºtrue</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    isHostCallbackScheduled = true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //å¦‚æœå·²ç»å®‰æ’å›è°ƒï¼Œåˆ™æ¸…é™¤ä»»åŠ¡æ‰§è¡Œå™¨ï¼Œåˆ°æœŸæ—¶é—´ä»¥åŠæ˜¯å¦æ˜¯å¦å®‰æ’äº†Messageäº‹ä»¶çš„æ ‡è®°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Cancel the existing host callback.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    cancelHostCallback();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  //ä¼ å…¥ç¬¬ä¸€ä¸ªèŠ‚ç‚¹çš„åˆ°æœŸæ—¶é—´ï¼Œé‡æ–°è®¾ç½®ä»»åŠ¡æ‰§è¡Œå™¨ï¼Œå¹¶åœ¨requestHostCallbackå‡½æ•°ä¸­è°ƒç”¨postMessageè§¦å‘Messageäº‹ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // åœ¨å›è°ƒå‡½æ•°idleTickä¸­ç«‹å³æ‰§è¡Œä»»åŠ¡æ‰§è¡Œå™¨æˆ–è€…æ‰§è¡ŒrequestAnimationFrameWithTimeoutå°†ä»»åŠ¡æ‰§è¡Œå™¨çš„æ‰§è¡Œä¸å¦æ”¾åˆ°ä¸‹ä¸€å¸§æ¥åˆ¤æ–­</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  requestHostCallback(flushWork, expirationTime);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="ä»»åŠ¡æ‰§è¡Œå™¨flushwork-1"></a>ä»»åŠ¡æ‰§è¡Œå™¨flushWork<a class="hash-link" href="#ä»»åŠ¡æ‰§è¡Œå™¨flushwork-1" title="Direct link to heading">#</a></h3><p>ä¼ å…¥çš„å‚æ•°didTimeoutä¸ºtrueï¼Œè¡¨ç¤ºä»»åŠ¡é˜Ÿåˆ—æœ€å°åˆ°æœŸæ—¶é—´å¯¹åº”çš„ä»»åŠ¡å·²ç»è¿‡æœŸäº†ï¼Œéœ€è¦ç«‹å³æ‰§è¡Œ
ä¸ºfalseï¼Œè¡¨ç¤ºå½“å‰å¸§æœ‰ç©ºä½™æ—¶é—´</p><p>æµç¨‹ï¼š</p><p>1ã€å°†æ­£åœ¨æ‰§è¡Œå›è°ƒçš„æ ‡è®°isExecutingCallbackç½®ä¸ºtrueï¼Œä¿å­˜å½“å‰çš„è¿‡æœŸæ ‡å¿—ï¼Œé‡æ–°è®¾ç½®å½“å‰çš„è¿‡æœŸæ ‡å¿—ï¼Œå¦‚æœè¿‡æœŸäº†ï¼Œæ‰§è¡Œç¬¬2æ­¥ï¼›å¦‚æœæ²¡æœ‰è¿‡æœŸï¼Œæ‰§è¡Œç¬¬3æ­¥ã€‚</p><p>2ã€ä¾æ¬¡æ‰§è¡ŒfirstCallbackNodeä»»åŠ¡é˜Ÿåˆ—ç¬¬ä¸€ä¸ªèŠ‚ç‚¹çš„å›è°ƒå‡½æ•°ï¼Œç„¶åä»firstCallbackNodeä»»åŠ¡é˜Ÿåˆ—ä¸­åˆ é™¤ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ã€‚ç›´åˆ°ç¬¬ä¸€ä¸ªèŠ‚ç‚¹è¿˜æ²¡æœ‰è¿‡æœŸæˆ–è€…ä»»åŠ¡é˜Ÿåˆ—éƒ½æ‰§è¡Œäº†å›è°ƒå‡½æ•°ã€‚åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦è¿‡æœŸï¼Œæ ¹æ®å½“å‰æ—¶é—´ä¸èŠ‚ç‚¹å­˜å‚¨çš„åˆ°æœŸæ—¶é—´æ¯”è¾ƒæ¥åˆ¤æ–­ã€‚</p><p>3ã€ä¾æ¬¡æ‰§è¡ŒfirstCallbackNodeä»»åŠ¡é˜Ÿåˆ—ç¬¬ä¸€ä¸ªèŠ‚ç‚¹çš„å›è°ƒå‡½æ•°ï¼Œç„¶åä»firstCallbackNodeä»»åŠ¡é˜Ÿåˆ—ä¸­åˆ é™¤ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ã€‚ç›´åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºæˆ–è€…å½“å‰æ—¶é—´å¤§äºå½“å‰å¸§æˆªæ­¢æ—¶é—´ã€‚</p><p>4ã€å°†å›è°ƒæ­£åœ¨æ‰§è¡Œçš„æ ‡è®°isExecutingCallbackç½®ä¸ºfalseï¼Œå¹¶æ¢å¤è¿‡æœŸæ ‡å¿—ã€‚æœ€ååˆ¤æ–­ï¼Œä»»åŠ¡é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºåˆ™æ ‡è®°<code>isHostCallbackScheduled = false</code>ï¼Œè¡¨ç¤ºç©ºé—²æ—¶é—´æ²¡æœ‰å®‰æ’ä»»åŠ¡é˜Ÿåˆ—ã€‚å¦‚æœä¸ä¸ºç©ºï¼Œåˆ™æ‰§è¡ŒensureHostCallbackIsScheduledï¼Œå°†å‰©ä¸‹çš„ä»»åŠ¡é˜Ÿåˆ—å®‰æ’åˆ°åœ¨ä¸‹ä¸€ç©ºé—²æ—¶é—´æ®µã€‚</p><p>5ã€æœ€åæ‰§è¡ŒflushImmediateWorkï¼Œæ‰§è¡Œä»»åŠ¡é˜Ÿåˆ—ä¸­æ‰€æœ‰ç«‹å³æ‰§è¡Œä»»åŠ¡(æœ€é«˜ä¼˜å…ˆçº§)çš„å›è°ƒå‡½æ•°ã€‚</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">function flushWork(didTimeout) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  isExecutingCallback = true;//è¡¨ç¤ºæ­£åœ¨æ‰§è¡Œå›è°ƒ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  const previousDidTimeout = currentDidTimeout;//ä¿å­˜å½“å‰çš„è¿‡æœŸæ ‡å¿—åˆ°previousDidTimeout</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  currentDidTimeout = didTimeout;//é‡æ–°è®¾ç½®å½“å‰çš„è¿‡æœŸæ ‡å¿—</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (didTimeout) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // Flush all the expired callbacks without yielding.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //å¦‚æœè¿‡æœŸäº†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      while (firstCallbackNode !== null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          // ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¸ä¸ºç©ºï¼Œå¹¶ä¸”ç¬¬ä¸€ä¸ªèŠ‚ç‚¹è¿‡æœŸäº†ï¼Œåˆ™ä¸€ç›´å¾ªç¯ï¼Œç›´åˆ°ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¸ºç©ºæˆ–è€…æ²¡æœ‰è¿‡æœŸã€‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Read the current time. Flush all the callbacks that expire at or</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // earlier than that time. Then read the current time again and repeat.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // This optimizes for as few performance.now calls as possible.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //  åˆ·æ–°å½“å‰æ—¶é—´</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        var currentTime = getCurrentTime();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (firstCallbackNode.expirationTime &lt;= currentTime) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          //å¦‚æœç¬¬ä¸€ä¸ªèŠ‚ç‚¹çš„åˆ°æœŸæ—¶é—´å°äºå½“å‰æ—¶é—´ï¼Œè¿‡æœŸäº†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          do {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //flushFirstCallback()ï¼šæ‰§è¡Œç¬¬ä¸€ä¸ªèŠ‚ç‚¹çš„å›è°ƒå‡½æ•°ï¼Œå¹¶ä»é“¾è¡¨ä¸­åˆ é™¤å½“å‰çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            flushFirstCallback();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          } while (</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //  ç›´åˆ°ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¸ºç©ºæˆ–è€…ç¬¬ä¸€ä¸ªèŠ‚ç‚¹æ²¡æœ‰è¿‡æœŸ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            firstCallbackNode !== null &amp;&amp;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            firstCallbackNode.expirationTime &lt;= currentTime</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          );</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          //ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¸ºç©ºæˆ–è€…ç¬¬ä¸€ä¸ªèŠ‚ç‚¹æ²¡æœ‰è¿‡æœŸ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          continue;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          //ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¸ºä¸ä¸ºç©ºä½†æ˜¯ç¬¬ä¸€ä¸ªèŠ‚ç‚¹æ²¡æœ‰è¿‡æœŸï¼Œåˆ™é€€å‡ºwhile(firstCallbackNode !== null)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // Keep flushing callbacks until we run out of time in the frame.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¸ä¸ºç©º</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (firstCallbackNode !== null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //ä¸€ç›´å¾ªç¯flushFirstCallback();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          // ç›´åˆ°å½“å‰å¸§æ²¡æœ‰ç©ºä½™æ—¶é—´å¯ç”¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          // æˆ–è€…ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¸ºç©ºï¼Œå³ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™åœæ­¢åˆ·æ–°ç¬¬ä¸€ä¸ªèŠ‚ç‚¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        do {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          flushFirstCallback();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } while (firstCallbackNode !== null &amp;&amp; !shouldYieldToHost());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  } finally {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //æœ€ç»ˆå°†å›è°ƒæ­£åœ¨æ‰§è¡Œçš„æ ‡è®°ç½®ä¸ºfalse</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    isExecutingCallback = false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //æ¢å¤ä¹‹å‰çš„è¿‡æœŸæ ‡å¿—</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    currentDidTimeout = previousDidTimeout;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (firstCallbackNode !== null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // å¦‚æœç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¸ä¸ºç©ºï¼Œè¡¨ç¤ºæ˜¯å› ä¸ºå½“å‰å¸§æ²¡æœ‰ç©ºä½™æ—¶é—´äº†ï¼Œè€Œåœæ­¢äº†å›è°ƒçš„æ‰§è¡Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      //  è¿™ä¸ªæ—¶å€™è¯·æ±‚ä¸‹ä¸€æ¬¡çš„å›è°ƒï¼Œç»§ç»­æ‰§è¡Œå‰©ä¸‹çš„ä»»åŠ¡é˜Ÿåˆ—</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // There&#x27;s still work remaining. Request another callback.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      ensureHostCallbackIsScheduled();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      //å¦‚æœéƒ½å·²ç»æ‰§è¡Œå®Œäº†ï¼Œä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºçš„æƒ…å†µï¼Œåˆ™è®¾ç½®æ ‡è®°isHostCallbackScheduledä¸ºfalseï¼Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // ç©ºé—²æ—¶é—´çš„ä½¿ç”¨æƒå¯ä»¥äº¤ç»™å…¶ä»–çš„ä»»åŠ¡é˜Ÿåˆ—</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      isHostCallbackScheduled = false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Before exiting, flush all the immediate work that was scheduled.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æœ€ååˆ·æ–°æ‰€æœ‰çš„ç«‹å³æ‰§è¡Œä»»åŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    flushImmediateWork();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="flushfirstcallback"></a>flushFirstCallback<a class="hash-link" href="#flushfirstcallback" title="Direct link to heading">#</a></h3><p>æµç¨‹ï¼š</p><p>1ã€æ‰§è¡Œç¬¬ä¸€ä¸ªèŠ‚ç‚¹çš„å›è°ƒå‡½æ•°ï¼Œå¹¶ä»é“¾è¡¨ä¸­åˆ é™¤å½“å‰çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¦‚æœå›è°ƒå‡½æ•°è¿”å›çš„æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œåˆ™åˆ©ç”¨è¿™ä¸ªå‡½æ•°åˆ›å»ºä¸€ä¸ªæ–°èŠ‚ç‚¹<code>continuationNode</code></p><p>2ã€å¦‚æœæ–°èŠ‚ç‚¹çš„ä¼˜å…ˆçº§æœ€é«˜ï¼Œåˆ™æ‰§è¡Œ<code>firstCallbackNode = continuationNode</code>ï¼Œå¹¶è°ƒç”¨<code>ensureHostCallbackIsScheduled</code>ã€‚å¦åˆ™ï¼Œåˆ°ç¬¬3æ­¥ã€‚</p><p>3ã€æœ€åï¼Œç”±äºæ–°èŠ‚ç‚¹çš„åˆ°æœŸæ—¶é—´ä¸åŸç¬¬ä¸€ä¸ªèŠ‚ç‚¹çš„åˆ°æœŸæ—¶é—´ä¸€æ ·ï¼Œæ‰€ä»¥æ–°èŠ‚ç‚¹å°†ä¼šæ›¿ä»£åŸç¬¬ä¸€ä¸ªèŠ‚ç‚¹çš„ä½ç½®ã€‚</p><p>åœ¨ä¸Šè¿°è¿‡ç¨‹ä¸­ï¼Œç”±äºç¬¬2æ­¥è®¾è®¡åˆ°å¼‚æ­¥äº‹ä»¶ï¼Œæ‰€ä»¥ç¬¬ä¸‰æ­¥ä¼šåœ¨ç¬¬äºŒæ­¥ä¹‹å‰æ”¹å˜ä»»åŠ¡é“¾è¡¨ã€‚</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">function flushFirstCallback() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  //å°†firstCallbackNodeèµ‹å€¼ç»™flushedNodeï¼Œä½œä¸ºå½“å‰éœ€è¦è¢«æ‰§è¡Œçš„ä»»åŠ¡èŠ‚ç‚¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  var flushedNode = firstCallbackNode;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Remove the node from the list before calling the callback. That way the</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // list is in a consistent state even if the callback throws.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  //  ä»é“¾è¡¨ä¸­åˆ é™¤ç¬¬ä¸€ä¸ªèŠ‚ç‚¹firstCallbackNodeï¼ŒåŸfirstCallbackNodeçš„åä¸€ä¸ªèŠ‚ç‚¹ä½œä¸ºç¬¬ä¸€ä¸ªèŠ‚ç‚¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  var next = firstCallbackNode.next;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  if (firstCallbackNode === next) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // This is the last callback in the list.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    firstCallbackNode = null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    next = null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    var lastCallbackNode = firstCallbackNode.previous;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    firstCallbackNode = lastCallbackNode.next = next;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    next.previous = lastCallbackNode;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  //å°†å½“å‰éœ€è¦è¢«æ‰§è¡Œçš„ä»»åŠ¡èŠ‚ç‚¹çš„nextä¸previousç½®nullï¼Œæ–­å¼€ä¸é“¾è¡¨çš„é“¾æ¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  flushedNode.next = flushedNode.previous = null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Now it&#x27;s safe to call the callback.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  var callback = flushedNode.callback;//è¯¥ä»»åŠ¡çš„å›è°ƒå‡½æ•°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  var expirationTime = flushedNode.expirationTime;//è¯¥ä»»åŠ¡çš„åˆ°æœŸæ—¶é—´</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  var priorityLevel = flushedNode.priorityLevel;//è¯¥ä»»åŠ¡çš„ä¼˜å…ˆçº§</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  var previousPriorityLevel = currentPriorityLevel;//ä¿å­˜å½“å‰ä¼˜å…ˆçº§</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  var previousExpirationTime = currentExpirationTime;//ä¿å­˜å½“å‰åˆ°æœŸæ—¶é—´</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  currentPriorityLevel = priorityLevel;//åˆ©ç”¨è¯¥ä»»åŠ¡çš„ä¼˜å…ˆçº§åˆ·æ–°å½“å‰ä¼˜å…ˆçº§</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  currentExpirationTime = expirationTime;//åˆ©ç”¨è¯¥ä»»åŠ¡çš„åˆ°æœŸæ—¶é—´åˆ·æ–°å½“å‰åˆ°æœŸæ—¶é—´</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  var continuationCallback;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    continuationCallback = callback();//æ‰§è¡Œè¯¥ä»»åŠ¡çš„å›è°ƒå‡½æ•°ï¼Œè¿”å›å€¼ä¿å­˜åœ¨continuationCallback</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  } finally {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //æ³¨æ„å¦‚æœcallbackæ˜¯å¼‚æ­¥çš„ï¼Œè¿™é‡Œfinallyçš„å­å¥ä¸ä¼šç­‰callbackæ‰§è¡Œå®Œåœ¨æ‰§è¡Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //  try...finallyæ˜¯åŒæ­¥çš„</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //  è°ƒç”¨äº†å›è°ƒå‡½æ•°ä¹‹åæ¢å¤åŸæœ‰çš„å½“å‰ä¼˜å…ˆçº§ä¸å½“å‰åˆ°æœŸæ—¶é—´</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    currentPriorityLevel = previousPriorityLevel;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    currentExpirationTime = previousExpirationTime;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // A callback may return a continuation. The continuation should be scheduled</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // with the same priority and expiration as the just-finished callback.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  //  å¦‚æœå›è°ƒå‡½æ•°è¿”å›çš„æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œåˆ™å†åˆ›å»ºä¸€ä¸ªä»»åŠ¡èŠ‚ç‚¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  if (typeof continuationCallback === &#x27;function&#x27;) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    var continuationNode: CallbackNode = {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      callback: continuationCallback,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      priorityLevel,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      expirationTime,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      next: null,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      previous: null,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    };</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Insert the new callback into the list, sorted by its expiration. This is</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // almost the same as the code in `scheduleCallback`, except the callback</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // is inserted into the list *before* callbacks of equal expiration instead</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // of after.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //  å°†æ–°ç”Ÿæˆçš„èŠ‚ç‚¹ä¾ç…§åˆ°æœŸæ—¶é—´æ’å…¥åˆ°é“¾è¡¨ä¸­ï¼Œä¸scheduleCallbackå‡½æ•°ä¸­çš„åŒºåˆ«æ˜¯ï¼Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //  å¦‚æœé‡åˆ°ç›¸åŒçš„åˆ°æœŸæ—¶é—´ï¼Œåˆ™æ’å…¥åˆ°å…¶å‰é¢è€Œä¸æ˜¯åé¢</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (firstCallbackNode === null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // This is the first callback in the list.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      //  å¦‚æœæ­¤æ—¶ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™è¯¥æ–°èŠ‚ç‚¹ä¸ºé“¾è¡¨å”¯ä¸€çš„èŠ‚ç‚¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      firstCallbackNode = continuationNode.next = continuationNode.previous = continuationNode;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      var nextAfterContinuation = null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      var node = firstCallbackNode;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      do {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (node.expirationTime &gt;= expirationTime) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          // This callback expires at or after the continuation. We will insert</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          // the continuation *before* this callback.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          nextAfterContinuation = node;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        node = node.next;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      } while (node !== firstCallbackNode);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (nextAfterContinuation === null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // No equal or lower priority callback was found, which means the new</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // callback is the lowest priority callback in the list.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        nextAfterContinuation = firstCallbackNode;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      } else if (nextAfterContinuation === firstCallbackNode) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // The new callback is the highest priority callback in the list.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //  å¦‚æœè¿”å›çš„å‡½æ•°æ„æˆçš„èŠ‚ç‚¹ä¼˜å…ˆçº§æ˜¯æœ€é«˜çš„ï¼Œé‚£ä¹ˆéœ€è¦å°†è¯¥èŠ‚ç‚¹å•ç‹¬è®¾ç½®ä¸ºä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          // è°ƒç”¨ensureHostCallbackIsScheduledé‡æ–°è®¾ç½®ä»»åŠ¡æ‰§è¡Œå™¨ï¼Œå¹¶ç«‹å³æ‰§è¡Œä»»åŠ¡æˆ–è€…ç¨åæ‰§è¡Œä»»åŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        firstCallbackNode = continuationNode;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ensureHostCallbackIsScheduled();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      var previous = nextAfterContinuation.previous;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      previous.next = nextAfterContinuation.previous = continuationNode;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      continuationNode.next = nextAfterContinuation;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      continuationNode.previous = previous;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="flushimmediatework"></a>flushImmediateWork<a class="hash-link" href="#flushimmediatework" title="Direct link to heading">#</a></h3><p>æ‰§è¡Œä»»åŠ¡é˜Ÿåˆ—ä¸­æ‰€æœ‰ç«‹å³æ‰§è¡Œä»»åŠ¡(æœ€é«˜ä¼˜å…ˆçº§)çš„å›è°ƒå‡½æ•°ï¼Œè¿™äº›å›è°ƒå‡½æ•°çš„æ˜¯ä¸èƒ½è¢«æ‰“æ–­çš„ï¼Œå› ä¸ºåœ¨é‡æ–°æ‰§è¡Œå…¶ä»–ä»»åŠ¡é˜Ÿåˆ—çš„æ—¶å€™ï¼Œä¼šå…ˆåˆ¤æ–­isExecutingCallbackè¿™ä¸ªæ ‡è®°ï¼Œå¦‚æœä¸ºtrueï¼Œè¯´æ˜åœ¨æ‰§è¡Œæœ€é«˜ä¼˜å…ˆçº§çš„å›è°ƒï¼Œç›´æ¥è¿”å›ã€‚</p><p>æµç¨‹ï¼š</p><p>1ã€å¦‚æœfirstCallbackNodeä»»åŠ¡å…·å¤‡æœ€é«˜ä¼˜å…ˆçº§ï¼Œå¹¶ä¸”currentEventStartTime === -1ï¼ˆï¼Ÿï¼‰ï¼Œåˆ™æ ‡è®°å¤„äºæ­£åœ¨æ‰§è¡Œæœ€é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡çš„èŠ‚ç‚¹ã€‚</p><p>2ã€æ‰§è¡Œç¬¬ä¸€ä¸ªèŠ‚ç‚¹çš„å›è°ƒå‡½æ•°ï¼Œç›´åˆ°ç¬¬ä¸€ä¸ªèŠ‚ç‚¹çš„ä¼˜å…ˆçº§ä¸æ˜¯æœ€é«˜ä¼˜å…ˆçº§ï¼ˆç«‹å³æ‰§è¡Œï¼‰ï¼Œç”±äºé“¾è¡¨æ˜¯æŒ‰ç…§åˆ°æœŸæ—¶é—´æ’åºï¼Œè€Œæœ€é«˜ä¼˜å…ˆçº§å¯¹åº”çš„åˆ°æœŸæ—¶é—´æœ€å°ï¼Œæ‰€ä»¥éƒ½ä¼šè¢«å®‰æ’åœ¨é“¾è¡¨å‰é¢ã€‚å› æ­¤è¿™é‡Œå°±æ˜¯æ‰§è¡Œé˜Ÿåˆ—ä¸­æ‰€æœ‰çš„ç«‹å³æ‰§è¡Œä»»åŠ¡çš„å›è°ƒå‡½æ•°</p><p>3ã€è°ƒç”¨å®Œæ‰€æœ‰çš„æœ€é«˜ä¼˜å…ˆçº§èŠ‚ç‚¹çš„å›è°ƒå‡½æ•°ä¹‹åï¼Œå°†isExecutingCallbackè®¾ç½®ä¸ºfalseï¼Œè¡¨ç¤ºç°åœ¨æ²¡æœ‰æ‰§è¡Œæœ€é«˜ä¼˜å…ˆçº§ä»»åŠ¡ã€‚å¦‚æœè¿˜æœ‰ä»»åŠ¡æ²¡æ‰§è¡Œå®Œï¼Œé‚£ä¹ˆé‡æ–°è®¾ç½®ä»»åŠ¡æ‰§è¡Œå™¨ï¼Œå¦åˆ™è®¾ç½®<code>isHostCallbackScheduled = false</code>è¡¨ç¤ºé˜Ÿåˆ—ä¸ºç©ºï¼Œç©ºé—²æ—¶é—´æ²¡æœ‰å®‰æ’ä»»åŠ¡ã€‚</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">function flushImmediateWork() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  if (</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Confirm we&#x27;ve exited the outer most event handler</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //  currentEventStartTimeè¡¨ç¤ºå½“å‰äº‹ä»¶è§¦å‘çš„å¼€å§‹æ—¶é—´</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //å¦‚æœfirstCallbackNodeä»»åŠ¡å…·å¤‡æœ€é«˜ä¼˜å…ˆçº§ï¼Œåˆ™æ‰§è¡Œå›è°ƒå‡½æ•°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    currentEventStartTime === -1 &amp;&amp;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    firstCallbackNode !== null &amp;&amp;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    firstCallbackNode.priorityLevel === ImmediatePriority</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  ) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //ä¸€ä¸ªé”ï¼Œç”¨äºæ ‡è®°æ˜¯å¦æ­£åœ¨æ‰§è¡Œæœ€é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    isExecutingCallback = true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æ‰§è¡Œç¬¬ä¸€ä¸ªèŠ‚ç‚¹çš„å›è°ƒå‡½æ•°ï¼Œç›´åˆ°ç¬¬ä¸€ä¸ªèŠ‚ç‚¹çš„ä¼˜å…ˆçº§ä¸æ˜¯æœ€é«˜ä¼˜å…ˆçº§ï¼ˆç«‹å³æ‰§è¡Œï¼‰</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      //  ç”±äºé“¾è¡¨æ˜¯æŒ‰ç…§åˆ°æœŸæ—¶é—´æ’åºï¼Œè€Œæœ€é«˜ä¼˜å…ˆçº§å¯¹åº”çš„åˆ°æœŸæ—¶é—´æœ€å°ï¼Œæ‰€ä»¥éƒ½ä¼šè¢«å®‰æ’åœ¨é“¾è¡¨å‰é¢</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      //  å› æ­¤è¿™é‡Œå°±æ˜¯æ‰§è¡Œé˜Ÿåˆ—ä¸­æ‰€æœ‰çš„ç«‹å³æ‰§è¡Œä»»åŠ¡çš„å›è°ƒå‡½æ•°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      do {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        flushFirstCallback();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      } while (</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Keep flushing until there are no more immediate callbacks</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        firstCallbackNode !== null &amp;&amp;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        firstCallbackNode.priorityLevel === ImmediatePriority</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      );</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } finally {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      //è°ƒç”¨å®Œæ‰€æœ‰çš„æœ€é«˜ä¼˜å…ˆçº§èŠ‚ç‚¹çš„å›è°ƒå‡½æ•°ä¹‹åï¼Œå°†isExecutingCallbackè®¾ç½®ä¸ºfalseï¼Œè¡¨ç¤ºç°åœ¨æ²¡æœ‰æ‰§è¡Œæœ€é«˜ä¼˜å…ˆçº§ä»»åŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      isExecutingCallback = false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (firstCallbackNode !== null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // There&#x27;s still work remaining. Request another callback.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // é‡æ–°è®¾ç½®ä»»åŠ¡æ‰§è¡Œå™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ensureHostCallbackIsScheduled();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //é˜Ÿåˆ—ä¸ºç©ºï¼Œç©ºé—²æ—¶é—´æ²¡æœ‰å®‰æ’ä»»åŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        isHostCallbackScheduled = false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><header><h1>API</h1></header><p>è¿™åªè´´unstable_scheduleCallbackä»£ç ä»¥åŠæ³¨é‡Šï¼Œå…·ä½“çš„æ³¨é‡Šä¸è§£æè¯·å…³æ³¨<a href="https://github.com/BUPTlhuanyu/ReactNote/blob/master/react/packages/scheduler/src/Scheduler.js" target="_blank" rel="noopener noreferrer">reactNote</a>ï¼Œscheduleræµ‹è¯•ä»£ç å…·ä½“å¯ä»¥å…³æ³¨<a href="https://github.com/BUPTlhuanyu/ReactNote/blob/master/react/runlogic/scheduler.html" target="_blank" rel="noopener noreferrer">reactNote</a></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">unstable_runWithPriority</span></span><span class="token-line" style="color:#393A34"><span class="token plain">unstable_wrapCallback</span></span><span class="token-line" style="color:#393A34"><span class="token plain">unstable_scheduleCallback</span></span><span class="token-line" style="color:#393A34"><span class="token plain">unstable_cancelCallback</span></span><span class="token-line" style="color:#393A34"><span class="token plain">unstable_getCurrentPriorityLevel</span></span><span class="token-line" style="color:#393A34"><span class="token plain">unstable_shouldYield</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="unstable_schedulecallback"></a>unstable_scheduleCallback<a class="hash-link" href="#unstable_schedulecallback" title="Direct link to heading">#</a></h3><p>ä¼ å…¥å‚æ•°ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">callbackï¼Œ//ä»»åŠ¡çš„å›è°ƒå‡½æ•°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">deprecated_options //åŒ…å«è‡ªå®šä¹‰çš„åˆ°æœŸæ—¶é•¿timeoutï¼Œå¯ä»¥ç”¨æ¥æŒ‡å®šcallbackæ‰§è¡Œçš„åˆ°æ—¶é—´ï¼Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                     ä¹Ÿå°±æ˜¯å¯ä»¥å½±å“æ’å…¥åˆ°å·²æœ‰çš„ä»»åŠ¡é“¾è¡¨çš„ä½ç½®ï¼Œå¯ä»¥ä½¿ä¼ å…¥çš„callbackå›è°ƒå‡½æ•°åœ¨å½“å‰å¸§paintä¹‹å‰æ‰§è¡Œï¼Œå³ç«‹å³æ‰§è¡Œã€‚</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>åŠŸèƒ½ï¼š
è®¡ç®—å¼€å§‹æ—¶é—´ï¼Œç„¶åæ ¹æ®ä¼ å…¥çš„å‚æ•°deprecated_options.timeoutè®¡ç®—åˆ°æœŸæ—¶é—´ = å¼€å§‹æ—¶é—´ + ä¼ å…¥çš„å‚æ•°optionsä¸­çš„timeoutï¼Œå¦‚æœdeprecated_options.timeoutä¸å­˜åœ¨ï¼Œæ ¹æ®é»˜è®¤ä¼˜å…ˆçº§è®¡ç®—åˆ°æœŸæ—¶é—´ã€‚å°è£…æˆä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¦‚ä¸‹ï¼›</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">  //æ–°èŠ‚ç‚¹ï¼šä¿å­˜äº†ä¼ å…¥çš„å›è°ƒå‡½æ•°ï¼Œä¼˜å…ˆçº§ï¼Œåˆ°æœŸæ—¶é—´</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  var newNode = {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    callback,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    priorityLevel: currentPriorityLevel,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    expirationTime,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    next: null,//é“¾è¡¨åä¸€ä¸ªèŠ‚ç‚¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    previous: null,//é“¾è¡¨å‰ä¸€ä¸ªèŠ‚ç‚¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  };</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>æœ€åæŒ‰ç…§åˆ°æœŸæ—¶é—´çš„å¤§å°ï¼Œä»firstNodeå¼€å§‹ä»¥å°åˆ°å¤§çš„é¡ºåºæ’å…¥åˆ°åŒå‘å¾ªç¯é“¾è¡¨ä¸­firstCallbackNodeä¸­ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„é“¾è¡¨ã€‚ </p><p>æºç ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">function unstable_scheduleCallback(callback, deprecated_options) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //åªæœ‰unstable_wrapCallbackå’Œunstable_runWithPriorityä¼šæ”¹å˜currentEventStartTime</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å› æ­¤åœ¨åˆå§‹çŠ¶æ€ï¼ŒcurrentEventStartTime=-1ï¼Œæ‰€ä»¥startTime = getCurrentTime()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    var startTime =</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        currentEventStartTime !== -1 ? currentEventStartTime : getCurrentTime();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //è®¡ç®—åˆ°æœŸæ—¶é—´ = å¼€å§‹æ—¶é—´ + ä¼ å…¥çš„å‚æ•°optionsä¸­çš„timeout</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //deprecated_options.timeoutè¡¨ç¤ºå¤šå°‘æ¯«ç§’ä¹‹åè¿‡æœŸ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    var expirationTime;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        typeof deprecated_options === &#x27;object&#x27; &amp;&amp;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        deprecated_options !== null &amp;&amp;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        typeof deprecated_options.timeout === &#x27;number&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // FIXME: Remove this branch once we lift expiration times out of React.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        expirationTime = startTime + deprecated_options.timeout;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æ ¹æ®å½“å‰ä¼˜å…ˆçº§ç¡®å®šè¿‡æœŸæ—¶é—´</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //   åˆå§‹çŠ¶æ€ä¸‹ä¸ºcurrentPriorityLevelä¸ºNormalPriority,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        switch (currentPriorityLevel) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            case ImmediatePriority:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                expirationTime = startTime + IMMEDIATE_PRIORITY_TIMEOUT;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            case UserBlockingPriority:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                expirationTime = startTime + USER_BLOCKING_PRIORITY;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            case IdlePriority:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                expirationTime = startTime + IDLE_PRIORITY;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            case LowPriority:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                expirationTime = startTime + LOW_PRIORITY_TIMEOUT;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            case NormalPriority:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            default:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                expirationTime = startTime + NORMAL_PRIORITY_TIMEOUT;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //æ–°èŠ‚ç‚¹ï¼šä¿å­˜äº†ä¼ å…¥çš„å›è°ƒå‡½æ•°ï¼Œä¼˜å…ˆçº§ï¼Œåˆ°æœŸæ—¶é—´</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    var newNode = {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        callback,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        priorityLevel: currentPriorityLevel,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        expirationTime,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        next: null,//é“¾è¡¨åä¸€ä¸ªèŠ‚ç‚¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        previous: null,//é“¾è¡¨å‰ä¸€ä¸ªèŠ‚ç‚¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    };</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Insert the new callback into the list, ordered first by expiration, then</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // by insertion. So the new callback is inserted any other callback with</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // equal expiration.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å°†å½“å‰åŒ…å«å›è°ƒå‡½æ•°çš„èŠ‚ç‚¹æŒ‰ç…§åˆ°æœŸæ—¶é—´ä»firstNodeå¼€å§‹ä»¥å°åˆ°å¤§çš„é¡ºåºæ’å…¥åˆ°åŒå‘å¾ªç¯é“¾è¡¨ä¸­ï¼Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (firstCallbackNode === null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //å¦‚æœä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™å°†æ–°èŠ‚ç‚¹ç»„æˆä¸€ä¸ªåŒå‘å¾ªç¯é“¾è¡¨ï¼Œå¹¶æ‰§è¡ŒensureHostCallbackIsScheduledï¼Œå¼€å§‹è°ƒåº¦</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // This is the first callback in the list.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        firstCallbackNode = newNode.next = newNode.previous = newNode;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ensureHostCallbackIsScheduled();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //å¦‚æœä»»åŠ¡é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œå°†æ–°èŠ‚ç‚¹æ’å…¥å¾ªç¯é“¾è¡¨ï¼Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        var next = null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        var node = firstCallbackNode;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        do {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (node.expirationTime &gt; expirationTime) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // The new callback expires before this one.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                next = node;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            node = node.next;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } while (node !== firstCallbackNode);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (next === null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //å¦‚æœæ–°èŠ‚ç‚¹çš„åˆ°æœŸæ—¶é—´æ˜¯æœ€å¤§çš„ï¼Œåˆ™åº”è¯¥å¤„äºé“¾è¡¨çš„æœ«ç«¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //å¯¹äºåŒå‘å¾ªç¯é“¾è¡¨è€Œè¨€ï¼Œæ–°èŠ‚ç‚¹çš„nextä¸ºé“¾è¡¨çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ã€‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // No callback with a later expiration was found, which means the new</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // callback has the latest expiration in the list.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            next = firstCallbackNode;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else if (next === firstCallbackNode) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // The new callback has the earliest expiration in the entire list.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //  å¦‚æœæ–°èŠ‚ç‚¹çš„åˆ°æœŸæ—¶é—´æœ€å°ï¼Œåˆ™æ–°èŠ‚ç‚¹å°±åº”è¯¥æ˜¯é“¾è¡¨çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //  åœ¨æ’å…¥ä¹‹å‰ï¼Œå…ˆæ‰§è¡ŒensureHostCallbackIsScheduled()è¿›è¡Œè°ƒåº¦</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //  ç”±äºensureHostCallbackIsScheduledçš„å‡½æ•°ä½œç”¨åŸŸé“¾ä¸­æœ€ç»ˆæ˜¯é€šè¿‡å›è°ƒå‡½æ•°æ¥è°ƒç”¨flushWorkå‡½æ•°æ¥æ‰§è¡Œä»»åŠ¡é“¾è¡¨ä¸­çš„å›è°ƒå‡½æ•°çš„ï¼Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //  å±äºå¼‚æ­¥äº‹ä»¶ï¼Œå› æ­¤ifå¤–éƒ¨çš„ä»£ç å…ˆäºensureHostCallbackIsScheduled()æ‰§è¡Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            firstCallbackNode = newNode;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ensureHostCallbackIsScheduled();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        var previous = next.previous;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        previous.next = next.previous = newNode;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        newNode.next = next;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        newNode.previous = previous;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return newNode;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/BUPTlhuanyu/ReactNote/tree/master/docs/react/react/scheduler/others/schedulerç»†èŠ‚.mdx" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_13-_"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/ReactNote/docs/react/react/scheduler/others/react-is"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« react-is</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/ReactNote/docs/react/react/scheduler/others/scheduler-tracing-subscriptions"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">scheduler-tracing-subscriptions Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#äº”ä¸ªä¼˜å…ˆçº§" class="table-of-contents__link">äº”ä¸ªä¼˜å…ˆçº§</a></li><li><a href="#äº”ä¸ªä¼˜å…ˆçº§å¯¹åº”çš„è¿‡æœŸæ—¶é—´" class="table-of-contents__link">äº”ä¸ªä¼˜å…ˆçº§å¯¹åº”çš„è¿‡æœŸæ—¶é—´</a></li><li><a href="#æµè§ˆå™¨æ¸²æŸ“å¸§ä¸æ˜¾ç¤ºå±çš„åˆ·æ–°é¢‘ç‡" class="table-of-contents__link">æµè§ˆå™¨æ¸²æŸ“å¸§ä¸æ˜¾ç¤ºå±çš„åˆ·æ–°é¢‘ç‡</a></li><li><a href="#windowrequestanimationframe" class="table-of-contents__link">window.requestAnimationFrame</a></li><li><a href="#windowcancelanimationframe" class="table-of-contents__link">window.cancelAnimationFrame</a></li><li><a href="#getcurrenttime" class="table-of-contents__link">getCurrentTime</a></li><li><a href="#requestanimationframewithtimeout" class="table-of-contents__link">requestAnimationFrameWithTimeout</a></li><li><a href="#å…³é”®å˜é‡" class="table-of-contents__link">å…³é”®å˜é‡</a></li><li><a href="#ç›‘å¬messageäº‹ä»¶" class="table-of-contents__link">ç›‘å¬Messageäº‹ä»¶</a></li><li><a href="#ç›‘å¬messageäº‹ä»¶ä¼ å…¥çš„å›è°ƒå‡½æ•°idletick" class="table-of-contents__link">ç›‘å¬Messageäº‹ä»¶ä¼ å…¥çš„å›è°ƒå‡½æ•°idleTick</a></li><li><a href="#animation-frame-firedçš„å›è°ƒå‡½æ•°animationtick" class="table-of-contents__link">animation frame firedçš„å›è°ƒå‡½æ•°animationTick</a></li><li><a href="#ä»»åŠ¡æ‰§è¡Œå™¨å¯¹postmessageä¸requestanimationframewithtimeoutè¡Œä¸ºè°ƒåº¦çš„å…³é”®å‡½æ•°" class="table-of-contents__link">ä»»åŠ¡æ‰§è¡Œå™¨å¯¹postMessageä¸requestAnimationFrameWithTimeoutè¡Œä¸ºè°ƒåº¦çš„å…³é”®å‡½æ•°</a><ul><li><a href="#è¢«ä»»åŠ¡æ‰§è¡Œå™¨è°ƒç”¨ä»¥è·å–å½“å‰å¸§æ˜¯å¦è¿‡æœŸçš„å‡½æ•°shouldyieldtohost" class="table-of-contents__link">è¢«ä»»åŠ¡æ‰§è¡Œå™¨è°ƒç”¨ä»¥è·å–å½“å‰å¸§æ˜¯å¦è¿‡æœŸçš„å‡½æ•°ï¼šshouldYieldToHost</a></li><li><a href="#è¢«ä»»åŠ¡æ‰§è¡Œå™¨è°ƒç”¨ä»¥æ§åˆ¶postmessageè¡Œä¸ºçš„å‡½æ•°cancelhostcallback" class="table-of-contents__link">è¢«ä»»åŠ¡æ‰§è¡Œå™¨è°ƒç”¨ä»¥æ§åˆ¶postMessageè¡Œä¸ºçš„å‡½æ•°ï¼šcancelHostCallback</a></li><li><a href="#è¢«ä»»åŠ¡æ‰§è¡Œå™¨è°ƒç”¨ä»¥é‡æ–°è®¾ç½®æ‰§è¡Œå™¨æ§åˆ¶postmessageä¸requestanimationframewithtimeoutè¡Œä¸ºçš„å‡½æ•°requesthostcallback" class="table-of-contents__link">è¢«ä»»åŠ¡æ‰§è¡Œå™¨è°ƒç”¨ä»¥é‡æ–°è®¾ç½®æ‰§è¡Œå™¨æ§åˆ¶postMessageä¸requestAnimationFrameWithTimeoutè¡Œä¸ºçš„å‡½æ•°ï¼šrequestHostCallback</a></li><li><a href="#å·¥å…·å‡½æ•°ensurehostcallbackisscheduled" class="table-of-contents__link">å·¥å…·å‡½æ•°ensureHostCallbackIsScheduled</a></li><li><a href="#ä»»åŠ¡æ‰§è¡Œå™¨flushwork-1" class="table-of-contents__link">ä»»åŠ¡æ‰§è¡Œå™¨flushWork</a></li><li><a href="#flushfirstcallback" class="table-of-contents__link">flushFirstCallback</a></li><li><a href="#flushimmediatework" class="table-of-contents__link">flushImmediateWork</a></li><li><a href="#unstable_schedulecallback" class="table-of-contents__link">unstable_scheduleCallback</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 BUPTlhuanyu, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/ReactNote/assets/js/runtime~main.a78b756c.js"></script>
<script src="/ReactNote/assets/js/main.48fd23c8.js"></script>
</body>
</html>