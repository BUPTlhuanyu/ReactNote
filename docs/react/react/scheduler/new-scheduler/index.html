<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="alternate" type="application/rss+xml" href="/ReactNote/blog/rss.xml" title="React Note Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/ReactNote/blog/atom.xml" title="React Note Blog Atom Feed"><title data-react-helmet="true">React Note</title><meta data-react-helmet="true" property="og:title" content="React Note"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://BUPTlhuanyu.github.io/ReactNote/docs/react/react/scheduler/new-scheduler"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" name="description" content="æ–°ç‰ˆscheduler"><meta data-react-helmet="true" property="og:description" content="æ–°ç‰ˆscheduler"><link data-react-helmet="true" rel="shortcut icon" href="/ReactNote/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://BUPTlhuanyu.github.io/ReactNote/docs/react/react/scheduler/new-scheduler"><link data-react-helmet="true" rel="alternate" href="https://BUPTlhuanyu.github.io/ReactNote/docs/react/react/scheduler/new-scheduler" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://BUPTlhuanyu.github.io/ReactNote/docs/react/react/scheduler/new-scheduler" hreflang="x-default"><link rel="stylesheet" href="/ReactNote/assets/css/styles.694d919f.css">
<link rel="preload" href="/ReactNote/assets/js/runtime~main.43bcc622.js" as="script">
<link rel="preload" href="/ReactNote/assets/js/main.4658e3c8.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/ReactNote/"><img src="/ReactNote/img/logo.png" alt="React Note Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/ReactNote/img/logo.png" alt="React Note Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">React Note</b></a><a class="navbar__item navbar__link navbar__link--active" href="/ReactNote/docs/react/react/intro">React</a><a class="navbar__item navbar__link" href="/ReactNote/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/BUPTlhuanyu" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ğŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ğŸŒ</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">react</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/ReactNote/docs/react/react/intro">ä»‹ç»</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/ReactNote/docs/react/react/project-directory">ç›®å½•ç»“æ„</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/ReactNote/docs/react/react/shared">å…¬å…±æ–¹æ³•</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">ReactElement</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">scheduler</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/ReactNote/docs/react/react/scheduler/why-need-scheduler">ä¸ºä»€ä¹ˆéœ€è¦scheduler</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/ReactNote/docs/react/react/scheduler/new-scheduler">æ–°ç‰ˆscheduler</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/ReactNote/docs/react/react/scheduler/old-scheduler">å¯¹é½frameç‰ˆæœ¬çš„scheduler</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">å…¶ä»–</a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">reconciler</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">event</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/ReactNote/docs/react/react/error/error-handle">å¦‚ä½•å¤„ç†é”™è¯¯</a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">react-hook-form</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">react-router</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">react-transition</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1></h1></header><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="æ–°ç‰ˆscheduler"></a>æ–°ç‰ˆscheduler<a class="hash-link" href="#æ–°ç‰ˆscheduler" title="Direct link to heading">#</a></h2><p>ä¸ŠèŠ‚è¯´åˆ°äº†åœ¨<code>react16.8</code>ç‰ˆæœ¬çš„<code>scheduler</code>ç”±<code>requestAnimation</code>ä»¥åŠ<code>postmessage</code>å®ç°ï¼Œå³å¯¹é½<code>frame</code>çš„æ–¹æ¡ˆã€‚æ ¹æ®<code>react</code>å®˜æ–¹ç›¸å…³<a href="/ReactNote/docs/react/react/scheduler/[facebook/react#16271%5D(https://github.com/facebook/react/pull/16271)">issue</a>çš„æè¿°ï¼Œ<code>scheduler</code> ä¸­ <code>requestAnimation</code> æ„æˆçš„å¾ªç¯å¯¹<code>CPU</code>çš„åˆ©ç”¨ç‡ä½äºæ–°ç‰ˆæœ¬<code>scheduler</code>ä¸­ <code>message</code> æ„æˆçš„å¾ªç¯ã€‚æ­¤å¤–é€šè¿‡ä¸€äº›<a href="https://github.com/facebook/react/pull/16271" target="_blank" rel="noopener noreferrer">issue</a>ä¹Ÿèƒ½çœ‹åˆ°<code>react</code>å¯¹ä»£ç è´¨é‡çš„è¯¸å¤šè€ƒé‡ã€‚</p><p>â€‹	ç°åœ¨å¼€å§‹æ–°ç‰ˆschedulerçš„å®ç°ï¼Œå¤§è‡´ç”»äº†ä¸€å¼ è¿è¡Œæµç¨‹å›¾ï¼Œæœ‰ä¸‹é¢å‡ ç‚¹éœ€è¦æ³¨æ„ï¼š</p><ol><li>taskQueueä¸timerQueueæ˜¯ä¸¤ä¸ªæœ€å°å †ï¼Œåè€…çš„ä»»åŠ¡åœ¨ä¸€å®šæ—¶é—´(delay)ä¹‹åè¢«æ”¾åˆ°taskQueueä¸­ï¼ŒtaskQueueä¸­çš„ä»»åŠ¡åœ¨åˆ°æœŸä¹‹åæ‰ä¼šæ‰§è¡Œã€‚</li><li>timerQueueæŒ‰ç…§current+delayæ—¶é—´æ’åºï¼ŒtaskQueueæŒ‰ç…§current+delay+priorityTimeæ’åº</li><li>ä»»åŠ¡æ— æ³•åšåˆ°ä¸€å®šæ˜¯åœ¨delayæ—¶é—´ä¹‹åä»timerQueueè½¬ç§»åˆ°taskQueue</li><li><code>wookloop</code>æ¯æ¬¡æ‰¹é‡æ‰§è¡Œä»»åŠ¡çš„æ—¶é—´æ§åˆ¶åœ¨<code>5m</code>så†…ï¼Œæ¯æ¬¡æ‰§è¡Œä¸€ä¸ª<code>task</code>ä¹‹å‰ä¼šæ£€æŸ¥å½“å‰<code>wookloop</code>æ‰§è¡Œæ˜¯å¦å·²ç»è¶…è¿‡äº†<code>5ms</code></li><li><code>task</code>çš„åˆ°æœŸæ—¶é—´ç›¸åŒçš„æ—¶å€™å…ˆåŠ å…¥çš„å…ˆæ‰§è¡Œ</li></ol><p><img alt="æ–°ç‰ˆscheduler" src="/ReactNote/assets/images/æ–°ç‰ˆscheduler-6e5b3a763d30e3c48e231e4d39271e9f.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="å·¥å…·"></a>å·¥å…·<a class="hash-link" href="#å·¥å…·" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="è·å–å½“å‰æ—¶é—´"></a>è·å–å½“å‰æ—¶é—´<a class="hash-link" href="#è·å–å½“å‰æ—¶é—´" title="Direct link to heading">#</a></h4><blockquote><p>ä»£ç è´¨é‡ä½“ç°åœ¨ç»†èŠ‚ä¸Šï¼šè¿™é‡Œæ˜¯ç›´æ¥æ›¿æ¢æ‰getCurrentTimeï¼Œè€Œä¸æ˜¯æ¯æ¬¡åœ¨å‡½æ•°ä¸­åˆ¤æ–­æ˜¯å¦å­˜åœ¨performance.now</p></blockquote><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> hasNativePerformanceNow </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">typeof</span><span class="token plain"> </span><span class="token dom variable" style="color:#36acaa">performance</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;object&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">typeof</span><span class="token plain"> </span><span class="token dom variable" style="color:#36acaa">performance</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">now</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;function&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> localDate </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token known-class-name class-name">Date</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> getCurrentTime</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hasNativePerformanceNow</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> </span><span class="token maybe-class-name">Performance</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token dom variable" style="color:#36acaa">performance</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">getCurrentTime</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token maybe-class-name">Performance</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">getCurrentTime</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> localDate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="å®šä¹‰ä¼˜å…ˆçº§å¯¹åº”çš„æ—¶é—´"></a>å®šä¹‰ä¼˜å…ˆçº§å¯¹åº”çš„æ—¶é—´<a class="hash-link" href="#å®šä¹‰ä¼˜å…ˆçº§å¯¹åº”çš„æ—¶é—´" title="Direct link to heading">#</a></h4><blockquote><p>é¢„æœŸçš„ç”¨æˆ·äº¤äº’çš„æ—¶é—´ï¼šUSER_BLOCKING_PRIORITY_TIMEOUT</p></blockquote><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token maybe-class-name">ImmediatePriority</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token maybe-class-name">UserBlockingPriority</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token maybe-class-name">NormalPriority</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token maybe-class-name">LowPriority</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token maybe-class-name">IdlePriority</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">IMMEDIATE_PRIORITY_TIMEOUT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">USER_BLOCKING_PRIORITY_TIMEOUT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">250</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NORMAL_PRIORITY_TIMEOUT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5000</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">LOW_PRIORITY_TIMEOUT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10000</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">IDLE_PRIORITY_TIMEOUT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1073741823</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> priorityMap </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token maybe-class-name">ImmediatePriority</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">IMMEDIATE_PRIORITY_TIMEOUT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token maybe-class-name">UserBlockingPriority</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">USER_BLOCKING_PRIORITY_TIMEOUT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token maybe-class-name">NormalPriority</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NORMAL_PRIORITY_TIMEOUT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token maybe-class-name">LowPriority</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">LOW_PRIORITY_TIMEOUT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token maybe-class-name">IdlePriority</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">IDLE_PRIORITY_TIMEOUT</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="ä¸€ä¸ªç®€å•çš„å®šæ—¶å™¨"></a>ä¸€ä¸ªç®€å•çš„å®šæ—¶å™¨<a class="hash-link" href="#ä¸€ä¸ªç®€å•çš„å®šæ—¶å™¨" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">function requestHostTimeout(callback, ms) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  taskTimeoutID = setTimeout(() =&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    callback(getCurrentTime());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }, ms);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="æœ€å°å †"></a><a href="https://www.cxyxiaowu.com/1943.html" target="_blank" rel="noopener noreferrer">æœ€å°å †</a><a class="hash-link" href="#æœ€å°å †" title="Direct link to heading">#</a></h4><blockquote><p>æœ€å°å †å¿…å®šæ˜¯ä¸€ä¸ªå®Œå…¨äºŒå‰æ ‘ï¼Œè€Œå®Œå…¨äºŒå‰æ ‘çš„çˆ¶å­èŠ‚ç‚¹ä¹‹é—´çš„ä½ç½®å…³ç³»æ˜¯ç¡®å®šçš„ï¼Œå› æ­¤å¯ä»¥é€šè¿‡æ•°ç»„æ¥å®ç°ä¸€ä¸ªæœ€å°å †</p></blockquote><p>ä»£ç ç¨å¾®é•¿ï¼Œè¿™é‡Œä¸åšå±•ç¤ºï¼Œå› æ­¤åˆ—ä¸¾ä¸‹é¢è¦ç‚¹ï¼š</p><ol><li><p>æœ€å°å †ç‰¹ç‚¹ï¼šåœ¨æœ€å°å †ä¸­èŠ‚ç‚¹çš„å€¼æ˜¯å…¶å­æ ‘çš„æœ€å°å€¼ã€‚</p></li><li><p>æœ€å°å †å®šç†ï¼šæ•°ç»„ä¸­å·²çŸ¥å½“å‰èŠ‚ç‚¹ä¸‹æ ‡ä¸º<code>index</code>ï¼Œé‚£ä¹ˆå·¦å­èŠ‚ç‚¹ä¸º<code>2*index+1</code>ï¼Œå³å­èŠ‚ç‚¹ä¸º<code>2*index+2</code>ï¼Œçˆ¶èŠ‚ç‚¹ä¸º<code>Math.floor((index - 1)/2)</code></p></li><li><p>æœ€å°å †æ’å…¥å…ƒç´ ï¼šå°†æ–°æ’å…¥çš„å…ƒç´ <code>push</code>åˆ°æ•°ç»„ï¼Œæ–°æ’å…¥çš„å…ƒç´ ä¸å…¶çˆ¶èŠ‚ç‚¹æ¯”è¾ƒï¼Œå¦‚æœæ¯”çˆ¶èŠ‚ç‚¹å°ï¼Œåˆ™äº¤æ¢çˆ¶å­èŠ‚ç‚¹ä½ç½®ã€‚æ–°æ’å…¥çš„èŠ‚ç‚¹ä¾æ¬¡ä¸æ–­å‘ä¸Šå¯»æ‰¾ï¼Œç›´åˆ°æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„èŠ‚ç‚¹ä¸ºæ­¢ã€‚</p></li><li><p>æœ€å°å †åˆ é™¤æœ€å°å€¼å…ƒç´ ï¼šå°†æœ€åä¸€ä¸ªèŠ‚ç‚¹æ›¿æ¢åˆ°ç¬¬ä¸€ä¸ªèŠ‚ç‚¹çš„ä½ç½®ï¼Œç„¶åå°†ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¸‹æ²‰(æ»¡è¶³èŠ‚ç‚¹æ˜¯å…¶å­æ ‘çš„æœ€å°å€¼å³å¯)ã€‚</p></li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="æ·»åŠ ä»»åŠ¡"></a>æ·»åŠ ä»»åŠ¡<a class="hash-link" href="#æ·»åŠ ä»»åŠ¡" title="Direct link to heading">#</a></h3><p>ä¼ªä»£ç å¦‚ä¸‹ï¼Œæ¥æ”¶çš„å‚æ•°æè¿°å¦‚ä¸‹</p><ol><li>priorityLevelï¼šä¼˜å…ˆçº§</li><li>delayï¼šå»¶è¿Ÿè°ƒåº¦çš„å»¶æ—¶æ—¶é—´</li><li>callbackï¼šä»»åŠ¡</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> taskIdCounter </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">scheduleCallback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">priorityLevel</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> callback</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> delay </span><span class="token parameter operator" style="color:#393A34">=</span><span class="token parameter"> </span><span class="token parameter number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> currentTime </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getCurrentTime</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> startTime </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> currentTime </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> delay</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> expirationTime </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> startTime </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> priorityMap</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">priorityLevel</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> newTask </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> taskIdCounter</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          callback</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          priorityLevel</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          startTime</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          expirationTime</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          sortIndex</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">startTime </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> currentTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          newTask</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">sortIndex</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> startTime</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token function" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">timerQueue</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> newTask</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">peek</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">taskQueue</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> newTask </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">peek</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">timerQueue</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token comment" style="color:#999988;font-style:italic">// åœ¨æ­¤ä¹‹å‰è¿˜éœ€å–æ¶ˆæ‰ä¹‹å‰çš„timeoutï¼Œå› æ­¤ç°åœ¨æ‰æ˜¯æœ€å°çš„å®šæ—¶å™¨æ—¶é—´</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">requestHostTimeout</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">handleTimeout</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> startTime </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> currentTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          newTask</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">sortIndex</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> expirationTime</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token function" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">taskQueue</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> newTask</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">isHostCallbackScheduled </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">isPerformingWork</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            isHostCallbackScheduled </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// è¾¹ç•Œå¤„ç†ï¼Œç¡®ä¿ä¸€ä¸ªäº‹ä»¶å¾ªç¯é‡Œé¢åªæ‰§è¡Œä¸€ä¸ªflushWork</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">requestHostCallback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">flushWork</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">     </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> newTask</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>scheduleCallbacké¦–å…ˆä¼šæ„å»ºä¸€ä¸ªå †èŠ‚ç‚¹ï¼Œå…¶åˆ°æœŸæ—¶é—´<code>expirationTime=currentTime+delay+priorityTime</code>ã€‚</p><blockquote><p>taskQueueæ ¹æ®currentTime+delayæ¥è¿›è¡Œæ’åºï¼ŒtimerQueueæ ¹æ®currentTime+delay+priorityTimeæ¥è¿›è¡Œæ’åº</p></blockquote><ol><li><p>å½“æ¥æ”¶çš„å‚æ•°<code>delay&gt;0</code>çš„æ—¶å€™ï¼Œä¼šå°†æ–°çš„å †èŠ‚ç‚¹æ·»åŠ åˆ°æœ€å°å †<code>timerQueue</code>ä¸­ï¼Œå¹¶ä¸”å¦‚æœ<code>taskQueue</code>ä¸ºç©ºï¼Œå¹¶ä¸”æ–°çš„å †èŠ‚ç‚¹æ˜¯æœ€å°å€¼ï¼Œé‚£ä¹ˆä¼šåœ¨<code>delay</code>æ—¶é—´ä¹‹åå¼€å§‹è°ƒåº¦<code>timerQueue</code>ä¸<code>taskQueue</code>ä¸­çš„å„ä¸ªä»»åŠ¡ã€‚</p></li><li><p>å½“æ¥æ”¶åˆ°çš„å‚æ•°<code>delay&lt;=0</code>çš„æ—¶å€™ï¼Œä¼šå°†æ–°çš„å †èŠ‚ç‚¹æ·»åŠ åˆ°æœ€å°å †<code>taskQueue</code>ä¸­ï¼Œå¦‚æœæ²¡æœ‰åœ¨è°ƒåº¦çš„å¾ªç¯é‡Œï¼Œåˆ™å¼€å¯è°ƒåº¦ã€‚</p></li></ol><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°åœ¨ç¬¬ä¸€ç§æƒ…å†µ<code>delay&gt;0</code>çš„æ—¶å€™ï¼Œåœ¨<code>taskQueue</code>ä¸­æ²¡æœ‰ä»»åŠ¡å¹¶ä¸”æ–°èŠ‚ç‚¹åˆ°æœŸæ—¶é—´ä¸æ˜¯<code>timerQueue</code>æœ€å°å€¼çš„æƒ…å†µä¸‹ï¼Œ<code>scheduler</code>ä¸€ç›´å¤„äºå®šæ—¶å™¨çš„è¯»ç§’é˜¶æ®µï¼Œä¸€æ—¦è¯»ç§’ç»“æŸï¼Œåˆ™ç»§ç»­å¼€å§‹åˆ·æ–°ä¸¤ä¸ªæœ€å°å †ä¸­çš„ä»»åŠ¡ã€‚æ³¨æ„æ–°æ–¹æ¡ˆä¸­å¹¶ä¸ä¼šä¸€ç›´å»è½®è¯¢ï¼Œä¸<strong>å¯¹é½frameçš„æ–¹æ¡ˆ</strong>ä¸åŒï¼Œä¸ä¼šæ¯ä¸€å¸§éƒ½å»åˆ¤æ–­æ˜¯å¦æœ‰åˆ°æœŸçš„ä»»åŠ¡éœ€è¦æ‰§è¡Œã€‚</p><blockquote><p>æ³¨æ„ï¼šåˆ©ç”¨requestAnimationè½®è¯¢å¯¹ä¸€èˆ¬çš„åº”ç”¨æ¥è¯´ï¼Œä¸ä¼šæœ‰å¤ªå¤šçš„æ€§èƒ½æŸè€—ï¼Œæ‰€ä»¥ä¸å¿…è¿‡å¤šçº ç»“è¿™é‡Œçš„æ”¹è¿›çš„ä»·å€¼åœ¨å“ªé‡Œï¼Œå½“ä½ é—®åˆ°è¿™ä¸ªé—®é¢˜çš„æ—¶å€™ï¼Œè¯´æ˜ä½ çš„åº”ç”¨æˆ–è®¸æ¯”è¾ƒç®€å•ï¼Œæ ¹æœ¬ç”¨ä¸ç€å…³å¿ƒè¿™ä¸€ç‚¹ã€‚</p></blockquote><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œæ·»åŠ ä¸€ä¸ªæ–°çš„ä»»åŠ¡ä¸ä¸€å®šä¼šå¼€å¯æ–°ä¸€è½®çš„è°ƒåº¦ï¼Œå› ä¸ºæœ‰å¯èƒ½æ­£åœ¨è°ƒåº¦ä¸­ï¼Œæˆ–è€…æ­£åœ¨è¯»ç§’ï¼Œè¯»ç§’ä¹‹åå°±å¼€å§‹è°ƒåº¦ã€‚ä¸ºäº†ç¡®ä¿è°ƒåº¦æœºåˆ¶çš„å®Œæ•´ï¼Œéœ€è¦åœ¨è°ƒåº¦å‡½æ•°<code>workLoop</code>å‡½æ•°ç»“æŸä¹‹å‰åˆ¤æ–­æœ€å°å †çš„çŠ¶æ€æ¥å¼€å¯æ–°ä¸€è½®çš„è°ƒåº¦ã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="delayæ—¶é—´ä¹‹åå†å†³å®šæ˜¯å¦å¼€å¯è°ƒåº¦"></a>delayæ—¶é—´ä¹‹åå†å†³å®šæ˜¯å¦å¼€å¯è°ƒåº¦<a class="hash-link" href="#delayæ—¶é—´ä¹‹åå†å†³å®šæ˜¯å¦å¼€å¯è°ƒåº¦" title="Direct link to heading">#</a></h4><p><code>advanceTimers</code>ç”¨äºå°†<code>timerQueue</code>ä¸­<code>timeout</code>çš„ä»»åŠ¡æ·»åŠ åˆ°<code>taskQueue</code>ä¸­ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„ä¸‹é¢ä¸€ç‚¹</p><blockquote><p>scheduleræä¾›äº†ä¸€ç§èƒ½åŠ›ï¼Œå³ä½¿æ˜¯ååŠ å…¥çš„ä»»åŠ¡ï¼Œåªè¦ä¼˜å…ˆçº§è¶³å¤Ÿé«˜ï¼Œé‚£ä¹ˆå°±æœ‰å¯èƒ½åœ¨å‰é¢æ·»åŠ çš„ä»»åŠ¡ä¹‹å‰æ‰§è¡Œ</p></blockquote><p><code>handleTimeout</code>ä¼šè°ƒç”¨<code>advanceTimers</code>æ¥æ›´æ–°ä¸€ä¸‹ä¸¤ä¸ªæœ€å°å †ï¼Œç„¶åæ ¹æ®ä¸‹é¢çš„æƒ…å†µæ¥æ¥å†³å®šæ˜¯è¯»ç§’è¿˜æ˜¯åœ¨ä¸‹ä¸ªäº‹ä»¶å¾ªç¯ä¸­å¼€å§‹è°ƒåº¦ã€‚</p><ol><li>å¦‚æœ<code>taskQueue</code>ä¸ä¸ºç©ºï¼Œè¯´æ˜è¦å°½å¿«å¼€å§‹è°ƒåº¦ï¼Œåˆ™åˆ©ç”¨<code>requestHostCallback</code>åœ¨ä¸‹ä¸ªäº‹ä»¶å¾ªç¯ä¸­å¼€å§‹è°ƒåº¦</li><li>å¦‚æœ<code>taskQueue</code>ä¸ºç©ºå¹¶ä¸”<code>timerQueue</code>ä¸ä¸ºç©ºï¼Œåˆ™éœ€è¦è¯»ç§’ï¼Œæ—¶é—´åˆ°äº†ä¹‹åå†è°ƒç”¨<code>handleTimeout</code>æ¥åˆ¤æ–­æ˜¯è¯»ç§’è¿˜æ˜¯å°½å¿«è°ƒåº¦ã€‚</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">advanceTimers</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">currentTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Check for tasks that are no longer delayed and add them to the queue.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> timer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">peek</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">timerQueue</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">timer </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">timer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">callback</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// Timer was cancelled.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">pop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">timerQueue</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">timer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">startTime</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> currentTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// Timer fired. Transfer to the task queue.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">pop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">timerQueue</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      timer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">sortIndex</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> timer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">expirationTime</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">taskQueue</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> timer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// Remaining timers are pending.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    timer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">peek</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">timerQueue</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">handleTimeout</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">currentTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  isHostTimeoutScheduled </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">advanceTimers</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">currentTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">isHostCallbackScheduled</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">peek</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">taskQueue</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      isHostCallbackScheduled </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">requestHostCallback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">flushWork</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> firstTimer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">peek</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">timerQueue</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">firstTimer </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">requestHostTimeout</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">handleTimeout</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> firstTimer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">startTime</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> currentTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="å°½å¿«å¼€å§‹è°ƒåº¦"></a>å°½å¿«å¼€å§‹è°ƒåº¦<a class="hash-link" href="#å°½å¿«å¼€å§‹è°ƒåº¦" title="Direct link to heading">#</a></h4><p><code>scheduledHostCallback</code>æ˜¯å¼€å§‹åˆ·æ–°ä»»åŠ¡çš„ä¸€ä¸ªå…¥å£å‡½æ•°ï¼Œè¿™é‡Œå…ˆä¸äºˆç†ä¼šã€‚è¿™é‡Œä»‹ç»çš„æ˜¯ä»€ä¹ˆæ¡ä»¶æ‰ä¼šå»æ‰§è¡Œè¿™ä¸ªå…¥å£å‡½æ•°ï¼Ÿ</p><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦çŸ¥é“ä»€ä¹ˆæ˜¯<code>MessageChannel</code>ï¼Œå¦‚æœæ­å»ºè¿‡websocketæœåŠ¡æˆ–è€…å¼€è¿‡chromeæ’ä»¶çš„åŒå­¦åº”è¯¥ä¼šå¾ˆç†Ÿæ‚‰è¿™ä¸ªï¼Œè¿™é‡Œæä¾›ä¸€ä¸ªç›¸å…³çš„å®è·µï¼Œ<a href="https://github.com/baidu/san-devtools" target="_blank" rel="noopener noreferrer">san-devtools</a>ã€‚ç®€è€Œè¨€ä¹‹å°±æ˜¯ä¸€ä¸ªé€šä¿¡ç®¡é“ã€‚é‚£ä¹ˆä¸ºä»€å¼ƒç”¨<code>window.postmessage</code>è€Œä½¿ç”¨<code>MessageChannel</code>å‘¢ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨<code>window.postmessage</code>çš„æ—¶å€™ä¼šè§¦å‘æ‰€æœ‰é€šè¿‡<code>addEventlistener</code>ç»‘å®šçš„<code>message</code>äº‹ä»¶å¤„ç†å‡½æ•°ï¼Œå› æ­¤<code>react</code>ä¸ºäº†å‡å°‘ä¸²æ‰°ï¼Œç”¨<code>MessageChannel</code>æ„å»ºäº†ä¸€ä¸ªä¸“å±ç®¡é“ï¼Œå‡å°‘äº†å¤–ç•Œçš„ä¸²æ‰°ï¼ˆå½“å¤–ç•Œé€šä¿¡é¢‘ç¹æ•°æ®é‡è¿‡å¤§ï¼Œå¼•èµ·ç¼“å†²é˜Ÿåˆ—æº¢å‡ºè€Œå¯¼è‡´ç®¡é“é˜»å¡ä¾¿ä¼šå½±å“åˆ°<code>react</code>çš„è°ƒåº¦æ€§èƒ½ï¼‰ä»¥åŠå¯¹å¤–ç•Œçš„å¹²æ‰°ã€‚<code>window.postmessage</code>æ„å‘³ç€æ˜¯ä¸€ä¸ªå…¨å±€çš„ç®¡é“ï¼Œå› æ­¤<code>MessageChannel</code>çš„ç¼ºç‚¹åˆ™æ˜¯åªèƒ½åœ¨ä¸€å®šçš„ä½œç”¨åŸŸä¸‹æ‰ç”Ÿæ•ˆã€‚</p><p>å…¶æ¬¡<code>postmessage/setImmediate</code>è§¦å‘çš„æ˜¯ä¸€ä¸ªå®ä»»åŠ¡ï¼Œå› æ­¤ä¸¤ä¸ªäº‹ä»¶å¾ªç¯ä¹‹é—´ä¼šæœ‰ä¸€æ®µç©ºé—²æ—¶é—´å¤„ç†é¡µé¢çš„äº¤äº’äº‹ä»¶ï¼Œ<code>message</code>äº‹ä»¶å¤„ç†å‡½æ•°/å®šæ—¶å™¨å›è°ƒå‡½æ•°<code>performWorkUntilDeadline</code>ä¸­ä¼šè°ƒç”¨<code>scheduledHostCallback</code>å¼€å§‹è°ƒåº¦ã€‚å¹¶ä¸”åœ¨æ­¤ä¹‹å‰è®¾ç½®äº†åˆ°æœŸæ—¶é—´<code>deadline</code>ï¼Œè¡¨ç¤ºä»å½“å‰æ—¶é—´å¼€å§‹ï¼Œ<code>scheduledHostCallback</code>åªèƒ½å¤Ÿæ‰§è¡Œ<code>yieldInterval=5ms</code>ï¼Œåœ¨æ‰§è¡Œæœ€å°å †ä¸­çš„ä¸‹ä¸€ä¸ªä»»åŠ¡ä¹‹å‰å¦‚æœå‘ç°è¶…æ—¶äº†ï¼Œé‚£ä¹ˆä¼šåœæ­¢æ‰§è¡Œæœ€å°å †ä¸­çš„ä»»åŠ¡ï¼Œå¹¶ä¸”å¦‚æœæœ‰ä»»åŠ¡å­˜ç•™åˆ™åœ¨ä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªç¯ä¸­è¯•å›¾å¼€å¯æ–°çš„è°ƒåº¦ã€‚åœæ­¢æ‰§è¡Œæœ€å°å †ä¸­çš„ä»»åŠ¡ä¹Ÿæ˜¯ä¸ºäº†å“åº”ç”¨æˆ·çš„äº¤äº’ã€‚ä¸è¿‡å¦‚æœè¿™é‡Œç”¨æˆ·çš„äº¤äº’å¤„ç†é€»è¾‘è¿‡é•¿ï¼Œä¼šå¯¼è‡´æœ€å°å †ä¸­çš„ä»»åŠ¡è¿‡å¤šï¼Œå› æ­¤äº¤äº’å¤„ç†é€»è¾‘è€—æ—¶è¿‡å¤šåˆ™è¡¨æ˜åº”ç”¨å¼€å‘è€…çš„ä»£ç ä½åŠ£ã€‚</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> schedulePerformWorkUntilDeadline</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">typeof</span><span class="token plain"> setImmediate </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;function&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">schedulePerformWorkUntilDeadline</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">setImmediate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">performWorkUntilDeadline</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> channel </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">MessageChannel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> port </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">port2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">port1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">onmessage</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> performWorkUntilDeadline</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">schedulePerformWorkUntilDeadline</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    port</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">postMessage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">requestHostCallback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">callback</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  scheduledHostCallback </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> callback</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">isMessageLoopRunning</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    isMessageLoopRunning </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">schedulePerformWorkUntilDeadline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> yieldInterval </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">performWorkUntilDeadline</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">scheduledHostCallback </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> currentTime </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getCurrentTime</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    deadline </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> currentTime </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> yieldInterval</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> hasTimeRemaining </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> hasMoreWork </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      hasMoreWork </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">scheduledHostCallback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hasTimeRemaining</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> currentTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">finally</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hasMoreWork</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">schedulePerformWorkUntilDeadline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        isMessageLoopRunning </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        scheduledHostCallback </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    isMessageLoopRunning </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="è°ƒåº¦"></a>è°ƒåº¦<a class="hash-link" href="#è°ƒåº¦" title="Direct link to heading">#</a></h3><p>åœ¨<code>flushWork</code>ä¸­éœ€è¦ç¡®ä¿ä¸€æ®µæ—¶é—´åªæœ‰ä¸€ä¸ª<code>flushWork</code>ï¼Œå› æ­¤éœ€è¦å–æ¶ˆ<code>requestHostCallback</code>è¯»ç§’ï¼Œä»¥åŠåˆ©ç”¨<code>isPerformingWork</code>åŠ é”ã€‚</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">flushWork</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">hasTimeRemaining</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> initialTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  isHostCallbackScheduled </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">isHostTimeoutScheduled</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    isHostTimeoutScheduled </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">cancelHostTimeout</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  isPerformingWork </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">workLoop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hasTimeRemaining</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> initialTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">finally</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    isPerformingWork </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>æ­£å¼è°ƒåº¦åœ¨<code>workLoop</code>ä¸­ï¼Œä»£ç å¤ªé•¿å¯ä»¥ç»“åˆæ–‡ç« å¼€å¤´çš„å›¾æ¥ç†è§£ã€‚</p><ol><li>æ¯æ¬¡å¼€å§‹æ‰§è¡Œ<code>task</code>ä¹‹å‰ï¼Œå…ˆæŠŠ<code>timerQueue</code>ä¸­è¶…æ—¶çš„ä»»åŠ¡å‹å…¥<code>taskQueue</code>ï¼Œç„¶ååˆ¤æ–­å½“å‰æ•´ä¸ªè°ƒåº¦æ˜¯å¦è¶…æ—¶äº†(<code>5ms</code>)ï¼Œæ²¡æœ‰è¶…æ—¶é‚£ä¹ˆåˆ·æ–°<code>taskQueue</code>ä¸­åˆ°æœŸçš„ä»»åŠ¡ã€‚åœ¨æ­¤è¿‡ç¨‹ä¸­ï¼Œå¦‚æœä»»åŠ¡è¿”å›äº†ä¸€ä¸ªå‡½æ•°ï¼Œé‚£ä¹ˆè¿™ä¸ªå‡½æ•°ä¼šç»§æ‰¿è¿™ä¸ªä»»åŠ¡çš„åˆ°æœŸæ—¶é—´ï¼Œä¹Ÿå°±æ˜¯ç›¸å½“äºæ¨¡æ‹Ÿäº†ä¸€ä¸ªå¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œç”¨æˆ·å¯ä»¥åœ¨æ·»åŠ çš„å‡½æ•°ä¸­è¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¼šç«‹å³æ‰§è¡Œï¼ˆä¹Ÿå°±åœ¨å½“å‰äº‹ä»¶å¾ªç¯ä¸­ï¼Œå¹¶ä¸”æ¯”å½“å‰äº‹ä»¶å¾ªç¯ä¸­å…¶ä»–çš„å¾®ä»»åŠ¡æ›´æ—©æ‰§è¡Œï¼‰ã€‚</li><li>å½“è°ƒåº¦è¶…æ—¶æˆ–è€…æ²¡æœ‰è¿‡æœŸçš„ä»»åŠ¡çš„æ—¶å€™ï¼Œåœæ­¢å¯¹<code>taskQueue</code>ä¸­çš„ä»»åŠ¡è¿›è¡Œæ‰«æï¼ˆæ‰§è¡Œï¼‰ï¼Œç„¶åå¦‚æœ<code>taskQueue</code>ä¸ä¸ºç©ºï¼Œé‚£ä¹ˆè¿”å›<code>true</code>ï¼Œé‚£ä¹ˆåœ¨ä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªç¯ä¸­ä¼šç»§ç»­è°ƒåº¦(<code>flushWork</code>)ã€‚å¦‚æœ<code>taskQueue</code>ä¸ºç©ºï¼Œ<code>timerQueue</code>ä¸ä¸ºç©ºï¼Œåˆ™å¼€å§‹ä»¥æœ€å°å †çš„æœ€å°å€¼è¯»ç§’ï¼Œè¯»ç§’å®Œæˆä¹‹åå†é€šè¿‡<code>handleTimeout</code>åˆ¤æ–­æ˜¯å¦ç»§ç»­è¯»ç§’è¿˜æ˜¯å°½å¿«å¼€å¯æ–°çš„è°ƒåº¦ã€‚</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">workLoop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">hasTimeRemaining</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> initialTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> currentTime </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> initialTime</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">advanceTimers</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">currentTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  currentTask </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">peek</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">taskQueue</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">currentTask </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      currentTask</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">expirationTime</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> currentTime </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">hasTimeRemaining </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">shouldYieldToHost</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> callback </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> currentTask</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">callback</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">typeof</span><span class="token plain"> callback </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;function&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      currentTask</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">callback</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      currentPriorityLevel </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> currentTask</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">priorityLevel</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> didUserCallbackTimeout </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> currentTask</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">expirationTime</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> currentTime</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> continuationCallback </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">callback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">didUserCallbackTimeout</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      currentTime </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getCurrentTime</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">typeof</span><span class="token plain"> continuationCallback </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;function&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        currentTask</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">callback</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> continuationCallback</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">currentTask </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">peek</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">taskQueue</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token function" style="color:#d73a49">pop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">taskQueue</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">advanceTimers</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">currentTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">pop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">taskQueue</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    currentTask </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">peek</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">taskQueue</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Return whether there&#x27;s additional work</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">currentTask </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> firstTimer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">peek</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">timerQueue</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">firstTimer </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">requestHostTimeout</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">handleTimeout</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> firstTimer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">startTime</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> currentTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="æ€»ç»“"></a>æ€»ç»“<a class="hash-link" href="#æ€»ç»“" title="Direct link to heading">#</a></h2><p>â€‹	è¿™ä¸€å°èŠ‚ï¼Œä»‹ç»äº†æ–°ç‰ˆ<code>scheduler</code>çš„å®ç°åŸç†ï¼Œç›¸å¯¹äºè€ç‰ˆè€Œè¨€ï¼Œåœ¨æœ‰è¶³å¤Ÿä»»åŠ¡çš„æ—¶å€™ï¼Œæ–°ç‰ˆå°†æ—¶é—´åˆ‡å¾—æ›´ç»†ï¼Œ<code>5ms</code>ä¸€ç‰‡ï¼Œè¿™æ ·æœ‰æ›´å¤šçš„æ—¶é—´æ¥å“åº”ç”¨æˆ·çš„æ“ä½œã€‚å½“æ²¡æœ‰ä»»åŠ¡çš„æ—¶å€™ï¼Œä¸ä¼šå› ä¸ºå¤–éƒ¨<code>postmessage</code>æ‰§è¡Œ<code>react</code>ä¸­çš„<code>message</code>äº‹ä»¶å¤„ç†å‡½æ•°ï¼Œè¿è¡Œæ—¶ä»£ç æ›´åŠ å¹²å‡€ã€‚ä¸‹ä¸€èŠ‚ä¼šä»‹ç»<code>å¸§å¯¹é½æ–¹æ¡ˆ</code>ä¸­çš„å¯å‘å¼ç®—æ³•çš„åŸç†ï¼Œä»¥åŠæ¸¸æˆä¸­çš„<code>vsync</code>æ¦‚å¿µã€‚</p><p>â€‹	æœ‰ä»»ä½•ä¸æ­£ç¡®çš„åœ°æ–¹è¯·ç›´æ¥è¯„è®ºæˆ–è€…è”ç³»æˆ‘ã€‚</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/BUPTlhuanyu/ReactNote/tree/master/docs/react/react/scheduler/æ–°ç‰ˆscheduler.mdx" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_13-_"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/ReactNote/docs/react/react/scheduler/why-need-scheduler"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« ä¸ºä»€ä¹ˆéœ€è¦scheduler</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/ReactNote/docs/react/react/scheduler/old-scheduler"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">å¯¹é½frameç‰ˆæœ¬çš„scheduler Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#æ–°ç‰ˆscheduler" class="table-of-contents__link">æ–°ç‰ˆscheduler</a><ul><li><a href="#å·¥å…·" class="table-of-contents__link">å·¥å…·</a></li><li><a href="#æ·»åŠ ä»»åŠ¡" class="table-of-contents__link">æ·»åŠ ä»»åŠ¡</a></li><li><a href="#è°ƒåº¦" class="table-of-contents__link">è°ƒåº¦</a></li></ul></li><li><a href="#æ€»ç»“" class="table-of-contents__link">æ€»ç»“</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 BUPTlhuanyu, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/ReactNote/assets/js/runtime~main.43bcc622.js"></script>
<script src="/ReactNote/assets/js/main.4658e3c8.js"></script>
</body>
</html>