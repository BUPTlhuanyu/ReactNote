"use strict";(self.webpackChunkreact_note_docusaurus=self.webpackChunkreact_note_docusaurus||[]).push([[1334],{3905:function(e,t,n){n.d(t,{Zo:function(){return p},kt:function(){return f}});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=r.createContext({}),u=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=u(e.components);return r.createElement(l.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},s=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,l=e.parentName,p=c(e,["components","mdxType","originalType","parentName"]),s=u(n),f=a,b=s["".concat(l,".").concat(f)]||s[f]||d[f]||o;return n?r.createElement(b,i(i({ref:t},p),{},{components:n})):r.createElement(b,i({ref:t},p))}));function f(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,i=new Array(o);i[0]=s;var c={};for(var l in t)hasOwnProperty.call(t,l)&&(c[l]=t[l]);c.originalType=e,c.mdxType="string"==typeof e?e:a,i[1]=c;for(var u=2;u<o;u++)i[u]=n[u];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}s.displayName="MDXCreateElement"},9303:function(e,t,n){n.r(t),n.d(t,{assets:function(){return p},contentTitle:function(){return l},default:function(){return f},frontMatter:function(){return c},metadata:function(){return u},toc:function(){return d}});var r=n(3117),a=n(102),o=(n(7294),n(3905)),i=["components"],c={id:"fiber-tree-root",sidebar_label:"\u521b\u5efaroot\u4e0b\u7684fiber\u6811\u5e76\u5f00\u59cb\u521d\u59cb\u8c03\u5ea6",slug:"/react/react/reconciler/fiber-tree-root",sidebar_position:2,title:""},l=void 0,u={unversionedId:"react/react/reconciler/fiber-tree-root",id:"react/react/reconciler/fiber-tree-root",title:"",description:"\u6982\u8ff0\uff0c\u80cc\u666f",source:"@site/docs/react/react/reconciler/2-2\u3001\u521b\u5efaroot\u4e0b\u7684fiber\u6811\u5e76\u5f00\u59cb\u521d\u59cb\u8c03\u5ea6.md",sourceDirName:"react/react/reconciler",slug:"/react/react/reconciler/fiber-tree-root",permalink:"/ReactNote/docs/react/react/reconciler/fiber-tree-root",editUrl:"https://github.com/BUPTlhuanyu/ReactNote/tree/master/docs/react/react/reconciler/2-2\u3001\u521b\u5efaroot\u4e0b\u7684fiber\u6811\u5e76\u5f00\u59cb\u521d\u59cb\u8c03\u5ea6.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{id:"fiber-tree-root",sidebar_label:"\u521b\u5efaroot\u4e0b\u7684fiber\u6811\u5e76\u5f00\u59cb\u521d\u59cb\u8c03\u5ea6",slug:"/react/react/reconciler/fiber-tree-root",sidebar_position:2,title:""},sidebar:"react",previous:{title:"\u521b\u5efacontainer\u5bf9\u5e94\u7684root",permalink:"/ReactNote/docs/react/react/reconciler/container-root"},next:{title:"\u521b\u5efaroot\u4e0b\u7684fiber\u6811\u5e76\u5f00\u59cb\u521d\u59cb\u8c03\u5ea6",permalink:"/ReactNote/docs/react/react/reconciler/schedulework"}},p={},d=[{value:"\u6982\u8ff0\uff0c\u80cc\u666f",id:"\u6982\u8ff0\u80cc\u666f",level:2},{value:"\u6784\u5efa\u5b50\u7ec4\u4ef6\u7684fiber\u6811",id:"\u6784\u5efa\u5b50\u7ec4\u4ef6\u7684fiber\u6811",level:2},{value:"\u8c03\u5ea6\u51fd\u6570scheduleRootUpdate",id:"\u8c03\u5ea6\u51fd\u6570schedulerootupdate",level:2},{value:"step1\uff1acreateUpdate\uff1a\u521b\u5efa\u66f4\u65b0\u5668",id:"step1createupdate\u521b\u5efa\u66f4\u65b0\u5668",level:4},{value:"step2\uff1a\u5c06\u9700\u8981\u6302\u8f7d\u5230container\u4e0a\u7684element\u4f20\u5165update\u5bf9\u8c61\u7684payload\u5c5e\u6027\u4e0a\uff1a",id:"step2\u5c06\u9700\u8981\u6302\u8f7d\u5230container\u4e0a\u7684element\u4f20\u5165update\u5bf9\u8c61\u7684payload\u5c5e\u6027\u4e0a",level:4},{value:"step3\uff1aflushPassiveEffects",id:"step3flushpassiveeffects",level:4},{value:"step4\uff1aenqueueUpdate",id:"step4enqueueupdate",level:4},{value:"step5\uff1ascheduleWork",id:"step5schedulework",level:4}],s={toc:d};function f(e){var t=e.components,n=(0,a.Z)(e,i);return(0,o.kt)("wrapper",(0,r.Z)({},s,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h2",{id:"\u6982\u8ff0\u80cc\u666f"},"\u6982\u8ff0\uff0c\u80cc\u666f"),(0,o.kt)("p",null,"2-1\u3001\u521b\u5efacontainer\u5bf9\u5e94\u7684root\u5206\u6790\u4e86legacyRenderSubtreeIntoContainer\u7684\u7b2c\u4e00\u6b65\uff1a\u521b\u5efacontainer\u5bf9\u5e94\u7684root\u3002\u672c\u6587\u4ecb\u7ecd\u7b2c\u4e8c\u6b65\uff1a\u521b\u5efaroot\u4e0b\u7684fiber\u6811\u5e76\u5f00\u59cb\u521d\u59cb\u8c03\u5ea6\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"legacyRenderSubtreeIntoContainer\u5728\u521b\u5efa\u5b8ccontainer\u5bf9\u5e94\u7684root(root.current\u4e3a\u8be5container\u5bf9\u5e94\u7684fiber)\u4e4b\u540e,\u4f1a\u6267\u884c\u5982\u4e0b\u4ee3\u7801:\nDOMRenderer.unbatchedUpdates(() => {\n  if (parentComponent != null) {\n    root.legacy_renderSubtreeIntoContainer(\n      parentComponent,\n      children,\n      callback,\n    );\n  } else {\n    root.render(children, callback);\n  }\n});\n")),(0,o.kt)("p",null,"\u6b64\u5904DOMRenderer.unbatchedUpdates\u5176\u5b9e\u5c31\u662f\u76f4\u63a5\u6267\u884c\u4f20\u5165\u7684\u51fd\u6570\uff0c\u4f20\u5165\u7684\u51fd\u6570\u4f1a\u8c03\u7528root.render(children, callback)\uff0cunbatchedUpdates\u4ee3\u7801\u5982\u4e0b\uff1a"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"//isBatchingUpdates: \u6b63\u5728\u6279\u5904\u7406\u66f4\u65b0\u4efb\u52a1\n//isUnbatchingUpdates: \u6b63\u5728\u89e3\u9664\u6279\u5904\u7406\u66f4\u65b0\u4efb\u52a1\nfunction unbatchedUpdates<A, R>(fn: (a: A) => R, a: A): R {\n  if (isBatchingUpdates && !isUnbatchingUpdates) {\n    isUnbatchingUpdates = true;\n    try {\n      return fn(a);\n    } finally {\n      isUnbatchingUpdates = false;\n    }\n  }\n  return fn(a);\n}\n")),(0,o.kt)("p",null,"\u8fd9\u91cc\u7684root.render\u5176\u5b9e\u5c31\u662fReactRoot.prototype.render\uff0c \u56e0\u4e3a"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"root = legacyCreateRootFromDOMContainer(\n  container,\n  forceHydrate,\n);\n")),(0,o.kt)("p",null,"legacyCreateRootFromDOMContainer\u8fd4\u56deReactRoot\u5b9e\u4f8b\u8d4b\u503c\u7ed9root\n\u56e0\u6b64root.render\u5373ReactRoot\u539f\u578b\u5bf9\u8c61\u4e0a\u7684render\u65b9\u6cd5\u3002"),(0,o.kt)("p",null,"ReactRoot.prototype.render\u4ee3\u7801\u5982\u4e0b\uff1a"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"ReactRoot.prototype.render = function(\n  children: ReactNodeList,\n  callback: ?() => mixed,\n): Work {\n  const root = this._internalRoot;\n  const work = new ReactWork();\n  callback = callback === undefined ? null : callback;\n  if (__DEV__) {\n    warnOnInvalidCallback(callback, 'render');\n  }\n  if (callback !== null) {\n    work.then(callback);\n  }\n  //\u5f00\u59cb\u6784\u5efafiber\u6811\n  DOMRenderer.updateContainer(children, root, null, work._onCommit);\n  //\u6700\u7ec8\u8fd4\u56de\u5b9e\u4f8bwork\n  return work;\n};\n")),(0,o.kt)("p",null,"\u53ef\u89c1\u6267\u884ccontainer\u5bf9\u5e94\u7684root\u4e0arender\u51fd\u6570\u4f1a\u521b\u5efa\u4e00\u4e2aReactWork\u5b9e\u4f8b\uff0c\u5e76\u8c03\u7528DOMRenderer.updateContainer\u66f4\u65b0container\u5e76\u6784\u5efafiber\u6811\uff0c\u6700\u540e\u8fd4\u56de\u4e00\u4e2awork\u5b9e\u4f8b\u7528\u4e8e\u5176\u4ed6\u8c03\u5ea6\u3002"),(0,o.kt)("p",null,"\u5148\u7ed9\u51faReactWork\u4ee3\u7801\uff1a"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"//\u7ed9\u5b9e\u4f8b\u6dfb\u52a0\u5c5e\u6027\nfunction ReactWork() {\n  this._callbacks = null;\n  this._didCommit = false;\n  // TODO: Avoid need to bind by replacing callbacks in the update queue with\n  // list of Work objects.\n  this._onCommit = this._onCommit.bind(this);\n}\n")),(0,o.kt)("p",null,"\u63a5\u4e0b\u6765\u5206\u6790\uff0cDOMRenderer.updateContainer\u5982\u4f55\u6784\u5efa\u5b50\u7ec4\u4ef6\u7684fiber\u6811\u3002"),(0,o.kt)("h2",{id:"\u6784\u5efa\u5b50\u7ec4\u4ef6\u7684fiber\u6811"},"\u6784\u5efa\u5b50\u7ec4\u4ef6\u7684fiber\u6811"),(0,o.kt)("p",null,"\u901a\u8fc7container\u5bf9\u5e94root\u5143\u7d20\u7684render\u65b9\u6cd5\uff0c\u8c03\u7528updateContainer\u5f00\u59cb\u6784\u5efafiber\u6811\u3002\nDOMRenderer.updateContainer(children, root, null, work._onCommit);"),(0,o.kt)("p",null,"\u7ed9\u51faupdateContainer\u4ee3\u7801\uff1a"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"export function updateContainer(\n  element: ReactNodeList,\n  container: OpaqueRoot,\n  parentComponent: ?React$Component<any, any>,\n  callback: ?Function,\n): ExpirationTime {\n  //  container.current\u4e3acontainer\u5bf9\u5e94\u7684fiber\u5bf9\u8c61\n  const current = container.current;\n  //\u901a\u8fc7\u5f53\u524d\u65f6\u95f4\u8ba1\u7b97\u51fa\u4e00\u4e2a\u5230\u671f\u65f6\u95f4\u8fd4\u56de\u5e76\u5b58\u5165currentTime\n  const currentTime = requestCurrentTime();\n  //\u4e3afiber\u8ba1\u7b97\u5230\u671f\u65f6\u95f4\n  const expirationTime = computeExpirationForFiber(currentTime, current);\n  return updateContainerAtExpirationTime(\n    element,\n    container,\n    parentComponent,\n    expirationTime,\n    callback,\n  );\n}\n")),(0,o.kt)("p",null,"\u4e0a\u8ff0\u4ee3\u7801\u4e2d\uff0c\u4f1a\u8c03\u7528computeExpirationForFiber\u8ba1\u7b97container\u5bf9\u5e94\u7684fiber\u7684\u5230\u671f\u65f6\u95f4\uff0c\u7136\u540e\u8c03\u7528updateContainerAtExpirationTime\uff0c\u5728updateContainerAtExpirationTime\u51fd\u6570\u4e2d\u4f1a\u5bf9debugTool\u3001context\u8fdb\u884c\u5904\u7406\u4ee5\u53ca\u8c03\u7528scheduleRootUpdate\u5f00\u59cb\u66f4\u65b0container\uff0c\u6784\u5efafiber\u6811\u3002updateContainerAtExpirationTime\u4ee3\u7801\u5982\u4e0b\uff1a"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"export function updateContainerAtExpirationTime(\n  element: ReactNodeList,\n  container: OpaqueRoot,\n  parentComponent: ?React$Component<any, any>,\n  expirationTime: ExpirationTime,\n  callback: ?Function,\n) {\n  // TODO: If this is a nested container, this won't be the root.\n  const current = container.current;\n\n  if (__DEV__) {\n    //\u5f00\u53d1\u73af\u5883\u4e0b\u5982\u679c\u5b58\u5728debugTool,\u6839\u636e\u6761\u4ef6\u6267\u884conMountContainer\uff0conUnmountContainer\uff0conUpdateContainer\n    if (ReactFiberInstrumentation.debugTool) {\n      if (current.alternate === null) {\n        ReactFiberInstrumentation.debugTool.onMountContainer(container);\n      } else if (element === null) {\n        ReactFiberInstrumentation.debugTool.onUnmountContainer(container);\n      } else {\n        ReactFiberInstrumentation.debugTool.onUpdateContainer(container);\n      }\n    }\n  }\n\n  const context = getContextForSubtree(parentComponent);\n  //\u521d\u59cb\u72b6\u6001\u4e0b\uff0ccontainer.context = {}\n  if (container.context === null) {\n    container.context = context;\n  } else {\n    container.pendingContext = context;\n  }\n  //\u5f00\u59cb\u8c03\u5ea6root\u7684\u66f4\u65b0\n  return scheduleRootUpdate(current, element, expirationTime, callback);\n}\n")),(0,o.kt)("p",null,"\u771f\u6b63\u7684\u5f00\u59cb\u8c03\u5ea6root\u7684\u66f4\u65b0\u7684\u51fd\u6570\u4e3ascheduleRootUpdate\uff0c\u4e0b\u9762\u63a5\u7740\u5206\u6790\u3002"),(0,o.kt)("h2",{id:"\u8c03\u5ea6\u51fd\u6570schedulerootupdate"},"\u8c03\u5ea6\u51fd\u6570scheduleRootUpdate"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"scheduleRootUpdate\uff1a\n    const update = createUpdate(expirationTime);\n    update.payload = {element};\n    flushPassiveEffects()\n    enqueueUpdate(current, update)\n    scheduleWork(current, expirationTime)\n    return expirationTime\n")),(0,o.kt)("h4",{id:"step1createupdate\u521b\u5efa\u66f4\u65b0\u5668"},"step1\uff1acreateUpdate\uff1a\u521b\u5efa\u66f4\u65b0\u5668"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"//\u4f20\u5165\u4e00\u4e2a\u5230\u671f\u65f6\u95f4\uff0c\u8fd4\u56de\u4e00\u4e2a\u5bf9\u8c61\nexport function createUpdate(expirationTime: ExpirationTime): Update<*> {\n  return {\n    expirationTime: expirationTime,//\u5230\u671f\u65f6\u95f4\n\n    tag: UpdateState,//\u5bf9\u4e8estate\u7684\u5904\u7406\u7c7b\u578b\u4e3a\u66f4\u65b0state\n    payload: null,//\u8f7d\u8377\uff0c\u25d4 \u2038\u25d4?\n    callback: null,\n\n    next: null,\n    nextEffect: null,\n  };\n}\n")),(0,o.kt)("h4",{id:"step2\u5c06\u9700\u8981\u6302\u8f7d\u5230container\u4e0a\u7684element\u4f20\u5165update\u5bf9\u8c61\u7684payload\u5c5e\u6027\u4e0a"},"step2\uff1a\u5c06\u9700\u8981\u6302\u8f7d\u5230container\u4e0a\u7684element\u4f20\u5165update\u5bf9\u8c61\u7684payload\u5c5e\u6027\u4e0a\uff1a"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"update.payload = {element};\n")),(0,o.kt)("h4",{id:"step3flushpassiveeffects"},"step3\uff1aflushPassiveEffects"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"// \u25d4 \u2038\u25d4?\nfunction flushPassiveEffects() {\n  if (passiveEffectCallback !== null) {\n    Schedule_cancelCallback(passiveEffectCallbackHandle);\n    // We call the scheduled callback instead of commitPassiveEffects directly\n    // to ensure tracing works correctly.\n    passiveEffectCallback();\n  }\n}\n")),(0,o.kt)("h4",{id:"step4enqueueupdate"},"step4\uff1aenqueueUpdate"),(0,o.kt)("p",null,"\u7531\u4e8e\u521d\u59cb\u5316\u8fc7\u7a0b\u4e2d\uff0c\u53ea\u6709\u4e00\u4e2acontainer\u7684fiber\u5bf9\u8c61\u5e76\u4e14\u6ca1\u6709\u66f4\u65b0\u961f\u5217\uff0c\u6240\u4ee5\u9996\u5148\u9700\u8981\u8c03\u7528createUpdateQueue\u521b\u5efa\u66f4\u65b0\u961f\u5217\u3002\u7136\u540e\u8c03\u7528appendUpdateToQueue\u5c06update\u5bf9\u8c61\u6dfb\u52a0\u5230\u521a\u521b\u5efa\u7684container\u7684\u66f4\u65b0\u961f\u5217\uff08\u4e00\u4e2a\u53cc\u5411\u5faa\u73af\u94fe\u8868\uff09\u7684\u672b\u5c3e\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"export function enqueueUpdate<State>(fiber: Fiber, update: Update<State>) {\n  // Update queues are created lazily.\n  const alternate = fiber.alternate;\n  let queue1;\n  queue1 = fiber.updateQueue = createUpdateQueue(fiber.memoizedState);\n  appendUpdateToQueue(queue1, update);\n}\n\ncreateUpdateQueue\u4e3a\uff1a\nexport function createUpdateQueue<State>(baseState: State): UpdateQueue<State> {\n  const queue: UpdateQueue<State> = {\n    baseState,\n    firstUpdate: null,\n    lastUpdate: null,\n    firstCapturedUpdate: null,\n    lastCapturedUpdate: null,\n    firstEffect: null,\n    lastEffect: null,\n    firstCapturedEffect: null,\n    lastCapturedEffect: null,\n  };\n  return queue;\n}\n\nappendUpdateToQueue\u4e3a\uff1a\nfunction appendUpdateToQueue<State>(\n  queue: UpdateQueue<State>,\n  update: Update<State>,\n) {\n  // Append the update to the end of the list.\n  if (queue.lastUpdate === null) {\n    // Queue is empty\n    queue.firstUpdate = queue.lastUpdate = update;\n  } else {\n    queue.lastUpdate.next = update;\n    queue.lastUpdate = update;\n  }\n}\n")),(0,o.kt)("h4",{id:"step5schedulework"},"step5\uff1ascheduleWork"),(0,o.kt)("p",null,"\u521d\u59cb\u72b6\u6001\u4e0b\uff0c\u5bf9hostroot\u800c\u8a00\uff0c\u53ea\u4f1a\u66f4\u65b0fiber\u7684\u5230\u671f\u65f6\u95f4\uff0c\u5e76\u8fd4\u56deroot = fiber.stateNode\uff0c\u8fd9\u91cc\u662f\u5f00\u59cb\u4e86\u6b63\u5f0f\u7684\u8c03\u5ea6\u9636\u6bb5\uff0cscheduleWork\u662f\u4e00\u4e2a\u516c\u7528\u7684\u8c03\u5ea6\u5165\u53e3\uff0c\u4e0d\u7ba1\u662f\u66f4\u65b0\u8fd8\u662f\u521d\u59cb\u5316\u90fd\u9700\u8981\u8be5\u65b9\u6cd5\u8fdb\u884c\u6b63\u5f0f\u7684\u8c03\u5ea6\u3002\u63a5\u4e0b\u6765\u7684\u7b2c\u4e09\u7ae0\u5c06\u4f1a\u5206\u6790\u8be5\u8c03\u5ea6\u5de5\u5177\u3002"))}f.isMDXComponent=!0}}]);