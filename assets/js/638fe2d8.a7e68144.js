"use strict";(self.webpackChunkreact_note_docusaurus=self.webpackChunkreact_note_docusaurus||[]).push([[6846],{3905:function(e,n,t){t.d(n,{Zo:function(){return p},kt:function(){return u}});var r=t(7294);function l(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function a(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?a(Object(t),!0).forEach((function(n){l(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):a(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function c(e,n){if(null==e)return{};var t,r,l=function(e,n){if(null==e)return{};var t,r,l={},a=Object.keys(e);for(r=0;r<a.length;r++)t=a[r],n.indexOf(t)>=0||(l[t]=e[t]);return l}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)t=a[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(l[t]=e[t])}return l}var i=r.createContext({}),d=function(e){var n=r.useContext(i),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},p=function(e){var n=d(e.components);return r.createElement(i.Provider,{value:n},e.children)},s={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},h=r.forwardRef((function(e,n){var t=e.components,l=e.mdxType,a=e.originalType,i=e.parentName,p=c(e,["components","mdxType","originalType","parentName"]),h=d(t),u=l,m=h["".concat(i,".").concat(u)]||h[u]||s[u]||a;return t?r.createElement(m,o(o({ref:n},p),{},{components:t})):r.createElement(m,o({ref:n},p))}));function u(e,n){var t=arguments,l=n&&n.mdxType;if("string"==typeof e||l){var a=t.length,o=new Array(a);o[0]=h;var c={};for(var i in n)hasOwnProperty.call(n,i)&&(c[i]=n[i]);c.originalType=e,c.mdxType="string"==typeof e?e:l,o[1]=c;for(var d=2;d<a;d++)o[d]=t[d];return r.createElement.apply(null,o)}return r.createElement.apply(null,t)}h.displayName="MDXCreateElement"},1292:function(e,n,t){t.r(n),t.d(n,{frontMatter:function(){return c},contentTitle:function(){return i},metadata:function(){return d},toc:function(){return p},default:function(){return h}});var r=t(7462),l=t(3366),a=(t(7294),t(3905)),o=["components"],c={id:"react-children",sidebar_label:"ReactChildren",slug:"/react/react/ReactElement/others/react-children",sidebar_position:3,title:""},i=void 0,d={unversionedId:"react/react/ReactElement/others/react-children",id:"react/react/ReactElement/others/react-children",isDocsHomePage:!1,title:"",description:"react.children\u5b98\u65b9API",source:"@site/docs/react/react/ReactElement/others/ReactChildren.md",sourceDirName:"react/react/ReactElement/others",slug:"/react/react/ReactElement/others/react-children",permalink:"/ReactNote/docs/react/react/ReactElement/others/react-children",editUrl:"https://github.com/BUPTlhuanyu/ReactNote/tree/master/docs/react/react/ReactElement/others/ReactChildren.md",tags:[],version:"current",sidebarPosition:3,frontMatter:{id:"react-children",sidebar_label:"ReactChildren",slug:"/react/react/ReactElement/others/react-children",sidebar_position:3,title:""},sidebar:"react",previous:{title:"ReactBaseClasses",permalink:"/ReactNote/docs/react/react/ReactElement/others/react-base-class"},next:{title:"ReactDebugCurrentFrame",permalink:"/ReactNote/docs/react/react/ReactElement/others/react-debug-current-frame"}},p=[{value:"\u5bf9\u5916\u63a5\u53e3",id:"\u5bf9\u5916\u63a5\u53e3",children:[{value:"\ud83c\udf40React.Children.map",id:"reactchildrenmap",children:[]},{value:"\ud83c\udf40toArray",id:"toarray",children:[]},{value:"\ud83c\udf40onlyChild",id:"onlychild",children:[]},{value:"\ud83c\udf40countChildren",id:"countchildren",children:[]}]},{value:"\u5185\u90e8\u5de5\u5177\u51fd\u6570",id:"\u5185\u90e8\u5de5\u5177\u51fd\u6570",children:[{value:"escape",id:"escape",children:[]},{value:"escapeUserProvidedKey",id:"escapeuserprovidedkey",children:[]},{value:"getComponentKey",id:"getcomponentkey",children:[]},{value:"0\ufe0f\u20e3mapIntoWithKeyPrefixInternal",id:"0\ufe0f\u20e3mapintowithkeyprefixinternal",children:[]},{value:"1\ufe0f\u20e3traverseContextPool\u6570\u636e\u7ed3\u6784\uff1agetPooledTraverseContext\u4e0ereleaseTraverseContext",id:"1\ufe0f\u20e3traversecontextpool\u6570\u636e\u7ed3\u6784getpooledtraversecontext\u4e0ereleasetraversecontext",children:[]},{value:"2\ufe0f\u20e3traverseAllChildren",id:"2\ufe0f\u20e3traverseallchildren",children:[]},{value:"2\ufe0f\u20e3-1\ufe0f\u20e3traverseAllChildrenImpl",id:"2\ufe0f\u20e3-1\ufe0f\u20e3traverseallchildrenimpl",children:[]},{value:"2\ufe0f\u20e3-1\ufe0f\u20e3-1\ufe0f\u20e3 mapSingleChildIntoContext",id:"2\ufe0f\u20e3-1\ufe0f\u20e3-1\ufe0f\u20e3-mapsinglechildintocontext",children:[]},{value:"forEachSingleChild",id:"foreachsinglechild",children:[]},{value:"forEachChildren",id:"foreachchildren",children:[]}]}],s={toc:p};function h(e){var n=e.components,t=(0,l.Z)(e,o);return(0,a.kt)("wrapper",(0,r.Z)({},s,t,{components:n,mdxType:"MDXLayout"}),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"http://react.html.cn/docs/react-api.html#react.children"},"react.children\u5b98\u65b9API"),"\n,\u9605\u8bfb\u5168\u6587\uff0c\u53ef\u4ee5\u4e86\u89e3react.children\u57fa\u672c\u539f\u7406\uff0c\u638c\u63e1react.children\u5404\u4e2aAPI\u7684\u7528\u6cd5\uff0c\u8fd8\u80fd\u4e86\u89e3\u5230\u5b98\u65b9API\u4ee5\u5916\u7684\u8865\u5145\u7528\u6cd5\u3002"),(0,a.kt)("p",null,"\u9884\u5907\u77e5\u8bc6\uff1a\nreact\u5143\u7d20\u7684$$typeof:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$$typeof: REACT_FORWARD_REF_TYPE\n$$typeof: REACT_MEMO_TYPE\n$$typeof: REACT_CONTEXT_TYPE\n$$typeof: REACT_PROVIDER_TYPE\n$$typeof: REACT_ELEMENT_TYPE\n$$typeof: REACT_LAZY_TYPE\n$$typeof: REACT_PORTAL_TYPE\n")),(0,a.kt)("h2",{id:"\u5bf9\u5916\u63a5\u53e3"},"\u5bf9\u5916\u63a5\u53e3"),(0,a.kt)("h3",{id:"reactchildrenmap"},"\ud83c\udf40React.Children.map"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"React.Children.map(children, func, context)\n")),(0,a.kt)("p",null,"\u53c2\u6570\u63cf\u8ff0\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"children\uff1a\n    \u53ef\u4ee5\u662f\u4e00\u4e2a\u5bf9\u8c61\uff0c\u4f46\u662f\u5fc5\u987b\u5177\u5907\u5c5e\u6027$$typeof\u4e3aSymbol.for('react.portal')\u6216\u8005Symbol.for('react.element')\uff0c\u53ef\u4ee5\u79f0\u5176\u4e3a\u7c7breactChild\u5bf9\u8c61\uff0c\u5426\u5219\u62a5\u9519\u3002\n    children\u4e3anull\u6216\u8005undefined\u5c31\u8fd4\u56denull\u6216\u8005undefined\uff0cchildren\u4e2d\u7684Fragment\u4e3a\u4e00\u4e2a\u5b50\u7ec4\u4ef6\u3002\nfunc\uff1a\n    \u5bf9\u7b26\u5408\u89c4\u5b9a\u7684children\u6267\u884c\u7684\u51fd\u6570\uff0cfunc\u4f1a\u88ab\u4f20\u5165\u4e24\u4e2a\u53c2\u6570\uff0c\u7b26\u5408\u89c4\u5b9a\u7684children\u4ee5\u53ca\u5230\u5f53\u524dchildren\u7684\u6570\u91cf\u3002\u6240\u6709\u6267\u884cfunc\u8fd4\u56de\u7684children\u90fd\u4f1a\u6dfb\u52a0\u5230\u4e00\u4e2a\u6570\u7ec4\u4e2d\uff0c\u6ca1\u6709\u5d4c\u5957\u3002\ncontext:\n    \u4e00\u822c\u90fd\u4e3anull\uff0c\u5982\u679c\u4f20\u5165context\u5219func\u8fd0\u884c\u4e2d\u7684this\u4e3acontext\uff0c\u770b\u4f8b2\n")),(0,a.kt)("p",null,"\u8fd4\u56de\u503c\uff1a\n\u8fd4\u56de\u4e00\u4e2a\u5e73\u9762\u6570\u7ec4\uff0c\u770b\u4f8b1"),(0,a.kt)("p",null,"\u4f8b\u5b50\u76f8\u5173\u4ee3\u7801\uff0c\u89c1runLogic\u6587\u4ef6\u5939\u7684index.js\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"//\n<App>\n    {/*\u6d4b\u8bd5*/}\n    <Header/>\n    <Content/>\n    string 1\n    <React.Fragment>\n        Some text.\n        <h2>A heading</h2>\n    </React.Fragment>\n    <Footer>\u8986\u76d6</Footer>\n    string 2\n</App>\n\n//\nclass App extends React.Component{\n    render(){\n        \u4f8b1\u4ee3\u7801\n        \u4f8b2\u4ee3\u7801\n        return (\n            <div>\n                ...\n            </div>\n        )\n    }\n}                                                               \n")),(0,a.kt)("p",null,"\u4f8b1\uff1a\u6d4b\u8bd5children\u662f\u4e00\u4e2a\u5d4c\u5957\u7ed3\u6784\uff0c\u8fd4\u56de\u7684\u6570\u7ec4\u662f\u5426\u662f\u4e00\u4e2a\u5e73\u9762\u6570\u7ec4\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"let reactChildLike = {$$typeof:Symbol.for('react.element')}\nlet complexChildren = [reactChildLike,[reactChildLike,this.props.children]]\nconsole.log(React.Children.map(complexChildren,(children)=>[children,children,children]))\n")),(0,a.kt)("p",null,"\u7ed3\u679c\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'this.props.children\u4e3a\uff1a\n(6)\xa0[{\u2026}, {\u2026}, "string 1", {\u2026}, {\u2026}, "string 2"]\n\ncomplexChildren\u4e2d\u7b26\u5408\u89c4\u5b9a\u7684child\u4e3a1+1+6=8\uff0c\u6240\u4ee5\u8f93\u51fa\u7684result\u4e3a3*8=24\u4e2a\u5143\u7d20\u7684\u5e73\u9762\u6570\u7ec4\n\n(24)\xa0[{\u2026}, {\u2026}, {\u2026}, {\u2026}, {\u2026}, {\u2026}, {\u2026}, {\u2026}, {\u2026}, {\u2026}, {\u2026}, {\u2026}, "string 1", "string 1", "string 1", {\u2026}, {\u2026}, {\u2026}, {\u2026}, {\u2026}, {\u2026}, "string 2", "string 2", "string 2"]\n')),(0,a.kt)("p",null,"\u4f8b2\uff1a\u6d4b\u8bd5context\u7684\u4f5c\u7528"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'    let reactChildLike = {$$typeof:Symbol.for(\'react.element\')}\n    let func = function (child) {\n        console.log(this)\n        this.a=1000;\n        return child\n    }\n    let contextTest = {a:1}\n    console.log("React.Children.map test",React.Children.map(reactChildLike,func,contextTest))\n    console.log("contextTest.a",contextTest.a)\n')),(0,a.kt)("p",null,"\u7ed3\u679c\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'    React.Children.map test \n        [{\u2026}]\n        0: {$$typeof: Symbol(react.element), type: undefined, key: ".0", ref: undefined, props: undefined,\xa0\u2026}length: 1__proto__: Array(0)\n    contextTest.a 1000\n')),(0,a.kt)("p",null,"func\u7ed9this.a\u8d4b\u503c\u4e3a1000\uff0c\u5728\u4f20\u5165context\u7684\u65f6\u5019\uff0c\u5916\u90e8\u7684context.a\u53d8\u6210\u4e861000\u3002"),(0,a.kt)("h4",{id:"\u6e90\u7801\u5165\u53e3"},"\u6e90\u7801\u5165\u53e3\uff1a"),(0,a.kt)("p",null,"\u5bf9\u5916\u63a5\u53e3\u5728\u6e90\u7801\u4e2d\u5bf9\u5e94\u4e3amapChildren\uff0cforEachChildren\uff0ccountChildren\uff0conlyChild\uff0ctoArray"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"export {\n  forEachChildren as forEach,\n  mapChildren as map,\n  countChildren as count,\n  onlyChild as only,\n  toArray,\n};\n\nfunction mapChildren(children, func, context) {\n//children\u4e3anull\u6216\u8005undefined\u5c31\u8fd4\u56denull\u6216\u8005undefined\n  if (children == null) {\n    return children;\n  }\n  const result = [];\n  mapIntoWithKeyPrefixInternal(children, result, null, func, context);\n  return result;\n}\n")),(0,a.kt)("h4",{id:"\u8fd0\u884c\u903b\u8f91\u7c7b\u6bd4\u6811\u7684\u6df1\u5ea6\u4f18\u5148\u904d\u5386\u7b97\u6cd5"},"\u8fd0\u884c\u903b\u8f91\uff1a\u7c7b\u6bd4\u6811\u7684\u6df1\u5ea6\u4f18\u5148\u904d\u5386\u7b97\u6cd5"),(0,a.kt)("hr",null),(0,a.kt)("h4",{id:"1-\u521d\u59cb\u8c03\u7528"},"1. \u521d\u59cb\u8c03\u7528"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"mapChildren\u51fd\u6570\u4e2d"),"\uff1amapChildren\u4f20\u5165\uff08children\uff0cfunc\uff0ccontext\uff09\uff0c\u8c03\u7528mapIntoWithKeyPrefixInternal(children, result, null, func, context)(\u6ce8\u610f\u8fd9\u91ccresult\u662f\u4e00\u4e2a\u5f15\u7528\u7c7b\u578b\uff0c\u6240\u4ee5\u540e\u7eed\u5bf9result\u7684\u64cd\u4f5c\u90fd\u4f1a\u5f71\u54cd\u5b83)\uff0c\u5c06\u5bf9\u5e94\u7684child\u52a0\u5165\u5230\u6570\u7ec4result\u4e2d\uff0c\u6700\u540emapChildren\u51fd\u6570\u4f1a\u8fd4\u56de\u8fd9\u4e2a\u6570\u7ec4",(0,a.kt)("inlineCode",{parentName:"p"},"result"),"\u3002"),(0,a.kt)("hr",null),(0,a.kt)("h4",{id:"2-mapintowithkeyprefixinternal\u7684\u4f5c\u7528"},"2. mapIntoWithKeyPrefixInternal\u7684\u4f5c\u7528"),(0,a.kt)("p",null,"\u8be5\u51fd\u6570\u4f1a\u4f9d\u6b64\u8c03\u7528\u4e0b\u9762\u4e09\u4e2a\u51fd\u6570\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"  const traverseContext = getPooledTraverseContext(array,escapedPrefix,func,context);\n  traverseAllChildren(children, mapSingleChildIntoContext, traverseContext);\n  releaseTraverseContext(traverseContext);\n")),(0,a.kt)("p",null,"\u4e0a\u9762\u7684\u4f5c\u7528\u662f\u4f9d\u6b21\u8c03\u7528getPooledTraverseContext\u51fd\u6570\u4ecetraverseContext\u6c60\u4e2d\u83b7\u53d6traverseContext\u5bf9\u8c61(mapIntoWithKeyPrefixInternal\u51fd\u6570\u7684\u4e00\u6b21\u8c03\u7528\u8fc7\u7a0b\u4e2d\u7684\u7ed3\u679c\u4fdd\u5b58\u5728\u8fd9\u4e2atraverseContext\u5bf9\u8c61\u7684result\u5c5e\u6027\u4e2d\uff0c\u4f46\u662f\u8fd9\u4e2aresult\u5c5e\u6027\u662fmapChildren\u51fd\u6570\u7684result\u8fd9\u4e2a\u6570\u7ec4\uff0c\u56e0\u4e3a\u5f15\u7528\u7c7b\u578b\u7684\u503c\u4f1a\u88ab\u51fd\u6570\u5185\u90e8\u6539\u5199)\uff0c\u7136\u540e\u8c03\u7528traverseAllChildren\u5e76\u8fdb\u4e00\u6b65\u8c03\u7528traverseAllChildrenImpl\u5bf9children\u6811\u8fdb\u884c\u9012\u5f52\u904d\u5386\uff0c1\ufe0f\u20e3.\u5982\u679cchildren\u662fstring\uff0cnumber\uff0c\u6216\u8005\u8282\u70b9\u7684\u5373$$typeof\u4e3aREACT_ELEMENT_TYPE\uff0cREACT_PORTAL_TYPE\uff0c\u5219\u8c03\u7528mapSingleChildIntoContext\u5c06children\u4f20\u5165React.Children.map\u4f20\u5165\u7684",(0,a.kt)("inlineCode",{parentName:"p"},"func"),"\uff0c\u5982\u679c\u8fd9\u4e2a",(0,a.kt)("inlineCode",{parentName:"p"},"func"),"\u8fd4\u56de\u7684\u662f\u4e00\u4e2a\u5408\u6cd5\u7684react\u5143\u7d20\uff0c\u90a3\u4e48\u5c06\u8fd9\u4e2a\u8fd4\u56de\u7ed3\u679c\u5b58\u5165\u5f53\u524dtraverseContext\u7684result\u4e2d\uff1b\u5982\u679cfunc\u8fd4\u56de\u7684\u8fd8\u662f\u4e00\u4e2a\u6570\u7ec4\uff0c\u90a3\u4e48\u8fd8\u9700\u8981\u5bf9\u8fd9\u4e2a\u6570\u7ec4\u9012\u5f52\u8c03\u7528mapIntoWithKeyPrefixInternal(\u8fd9\u4e2a\u65b9\u6cd5\u53c8\u4f1a\u4ecetraverseContextPool\u4e2d\u83b7\u53d6\u6808\u9876\u7684traverseContext)\u30022\ufe0f\u20e3.\u5982\u679cchidren\u662f\u6570\u7ec4\uff0c\u5bf9\u6bcf\u4e2a\u5143\u7d20\u9012\u5f52\u8c03\u7528traverseAllChildrenImpl\u3002"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"\u6ce8\u610f\u8fd9\u91cc\u5b58\u5728\u4e24\u4e2a\u9012\u5f52\u5faa\u73af\u3002\u5982\u679c\u4f20\u5165\u7684children\u5faa\u73af\u5d4c\u5957\u4e86\u81ea\u8eab\uff0c\u90a3\u4e48\u4f1a\u65e0\u9650\u9012\u5f52\u4e0b\u53bb\uff0c\u5bfc\u81f4\u8c03\u7528\u6808\u6ea2\u51fa\u3002")),(0,a.kt)("p",null,"\u6700\u540e\uff0c\u8c03\u7528",(0,a.kt)("inlineCode",{parentName:"p"},"releaseTraverseContext"),"\u5c06\u5f53\u524dmapIntoWithKeyPrefixInternal\u4f5c\u7528\u57df\u4e0b\u7684traverseContext\u624b\u52a8\u6e05\u7a7a\uff0c\u5e76\u6839\u636etraverseContext\u6c60\u7684\u5269\u4f59\u7a7a\u95f4\u6709\u9009\u62e9\u7684\u5c06traverseContext\u653e\u5230\u6c60\u4e2d\u3002"),(0,a.kt)("p",null,"\u603b\u7ed3\uff1a\u8fd9\u91ccchildren\u662f\u4e00\u4e2a\u5d4c\u5957\u7684\u6570\u7ec4\u3002\u9075\u5faa\u6df1\u5ea6\u4f18\u5148\u904d\u5386\uff0c\u7528traverseAllChildrenImpl\u7684\u9012\u5f52\u8c03\u7528\u5c06\u5176\u5c55\u5f00\u6210\u4e3a\u4e00\u4e2a\u6811\uff0c\u9012\u5f52\u8c03\u7528\u7684\u4f9d\u636e\u662f\u6570\u7ec4\u7684\u5143\u7d20\u662f\u5426\u662f\u4e00\u4e2a\u6570\u7ec4\u3002\u5982\u679c\u662f\u6570\u7ec4\u5c31\u9012\u5f52\uff0c\u5426\u5219\u76f4\u63a5\u5c06\u5143\u7d20\u4f20\u5165\u67d0\u4e2a\u51fd\u6570func\uff0c\u5982\u679c\u8be5\u51fd\u6570\u8fd4\u56de\u7684\u7ed3\u679c\u8fd8\u662f\u4e00\u4e2a\u6570\u7ec4\uff0c\u90a3\u4e48\u8fd9\u4e2a\u6570\u7ec4\u4f1a\u88ab\u518d\u6b21\u6df1\u5ea6\u4f18\u5148\u904d\u5386\u5e76\u5c55\u5f00\u6210\u4e00\u4e2a\u6811\uff0c\u5e76\u7528func\u5904\u7406\u3002"),(0,a.kt)("h3",{id:"toarray"},"\ud83c\udf40toArray"),(0,a.kt)("p",null,"\u5229\u7528mapChildren\u4e5f\u80fd\u5b9e\u73b0toArray\u7684\u529f\u80fd\uff0c\u53ea\u9700\u8981func\u4e3achild => child\u5373\u53ef"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"function toArray(children) {\n  const result = [];\n  mapIntoWithKeyPrefixInternal(children, result, null, child => child);\n  return result;\n}\n")),(0,a.kt)("h3",{id:"onlychild"},"\ud83c\udf40onlyChild"),(0,a.kt)("p",null,"\u5224\u65adchildren\u662f\u5426\u662f\u5355\u4e2aReact element child"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"function onlyChild(children) {\n  invariant(\n    isValidElement(children),\n    'React.Children.only expected to receive a single React element child.',\n  );\n  return children;\n}\n")),(0,a.kt)("h3",{id:"countchildren"},"\ud83c\udf40countChildren"),(0,a.kt)("p",null,"\u8ba1\u7b97children\u4e2a\u6570"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"function countChildren(children) {\n  return traverseAllChildren(children, () => null, null);\n}\n")),(0,a.kt)("h2",{id:"\u5185\u90e8\u5de5\u5177\u51fd\u6570"},"\u5185\u90e8\u5de5\u5177\u51fd\u6570"),(0,a.kt)("h3",{id:"escape"},"escape"),(0,a.kt)("p",null,"\u5c06\u4f20\u5165\u7684key\u4e2d\u6240\u6709\u7684'='\u66ff\u6362\u6210'=0',':'\u66ff\u6362\u6210 '=2',\u5e76\u5728key\u4e4b\u524d\u52a0\u4e0a'$'"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"function escape(key) {\n  const escapeRegex = /[=:]/g;\n  const escaperLookup = {\n    '=': '=0',\n    ':': '=2',\n  };\n  const escapedString = ('' + key).replace(escapeRegex, function(match) {\n    return escaperLookup[match];\n  });\n\n  return '$' + escapedString;\n}\n")),(0,a.kt)("h3",{id:"escapeuserprovidedkey"},"escapeUserProvidedKey"),(0,a.kt)("p",null,"\u5339\u914d\u4e00\u4e2a\u6216\u8005\u591a\u4e2a \"/\",\u5e76\u7528'$&/'\u66ff\u6362"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"const userProvidedKeyEscapeRegex = /\\/+/g;\nfunction escapeUserProvidedKey(text) {\n  return ('' + text).replace(userProvidedKeyEscapeRegex, '$&/');\n}\n")),(0,a.kt)("h3",{id:"getcomponentkey"},"getComponentKey"),(0,a.kt)("p",null,"\u5982\u679ccomponent\u5b58\u5728\u4e0d\u4e3anull\u7684key\uff0c\u5219\u8fd4\u56deescape(component.key)\uff0c\u5426\u5219\u8fd4\u56deindex.toString(36)"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"function getComponentKey(component, index) {\n  // Do some typechecking here since we call this blindly. We want to ensure\n  // that we don't blog potential future ES APIs.\n  if (\n    typeof component === 'object' &&\n    component !== null &&\n    component.key != null\n  ) {\n    // Explicit key\n    return escape(component.key);\n  }\n  // Implicit key determined by the index in the set\n  // \u8f6c\u6362\u621036\u8fdb\u5236\n  return index.toString(36);\n}\n")),(0,a.kt)("h3",{id:"0\ufe0f\u20e3mapintowithkeyprefixinternal"},"0\ufe0f\u20e3mapIntoWithKeyPrefixInternal"),(0,a.kt)("p",null,"\u8c03\u7528escapeUserProvidedKey\u5bf9\u4f20\u5165\u7684prefix\u8fdb\u884c\u5904\u7406\u5f97\u5230escapedPrefix\uff0c\u8f7d\n\u901a\u8fc7\u8c03\u7528getPooledTraverseContext\u5c06\u4f20\u5165\u7684\u53c2\u6570array\u3001escapedPrefix\u3001func\u4ee5\u53cacontext\u8d4b\u503c\u7ed9traverseContext\u7684result\u3001keyPrefix\u3001func\u4e0econtext\u5c5e\u6027\u3002\n\u8c03\u7528traverseAllChildren\u3002\u6700\u540e\u6e05\u9664traverseContext\u4e0a\u7684\u5c5e\u6027\uff0c\u5e76\u5165\u6808\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"function mapIntoWithKeyPrefixInternal(children, array, prefix, func, context) {\n  let escapedPrefix = '';\n  if (prefix != null) {\n    escapedPrefix = escapeUserProvidedKey(prefix) + '/';\n  }\n  const traverseContext = getPooledTraverseContext(\n    array,\n    escapedPrefix,\n    func,\n    context,\n  );\n  traverseAllChildren(children, mapSingleChildIntoContext, traverseContext);\n  releaseTraverseContext(traverseContext);\n}\n")),(0,a.kt)("h3",{id:"1\ufe0f\u20e3traversecontextpool\u6570\u636e\u7ed3\u6784getpooledtraversecontext\u4e0ereleasetraversecontext"},"1\ufe0f\u20e3traverseContextPool\u6570\u636e\u7ed3\u6784\uff1agetPooledTraverseContext\u4e0ereleaseTraverseContext"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"//\u6570\u636e\u7ed3\u6784\uff1acontext\u6c60\uff0c\u5927\u5c0f\u4e3a10\u3002\u5f53\u505a\u4e00\u4e2a\u6808\u4f7f\u7528\nconst POOL_SIZE = 10;\nconst traverseContextPool = [];\n//\u83b7\u53d6\u4e00\u4e2acontext\n//\u7ed9\u6808\u9876\u7684context\u8bbe\u7f6e\u76f8\u5e94\u5c5e\u6027\u503c\uff0c\u5e76\u5f39\u51fa\u8fd4\u56de\u3002\n//\u5982\u679c\u6808\u4e2d\u6ca1\u6709\u5143\u7d20\uff0c\u76f4\u63a5\u8fd4\u56de\u4e00\u4e2a\u5bf9\u8c61\uff0c\u76f8\u5e94\u7684\u8bbe\u7f6e\u4e86\u5c5e\u6027\u503c\nfunction getPooledTraverseContext(\n  mapResult,\n  keyPrefix,\n  mapFunction,\n  mapContext,\n) {\n  if (traverseContextPool.length) {\n    const traverseContext = traverseContextPool.pop();\n    traverseContext.result = mapResult;\n    traverseContext.keyPrefix = keyPrefix;\n    traverseContext.func = mapFunction;\n    traverseContext.context = mapContext;\n    traverseContext.count = 0;\n    return traverseContext;\n  } else {\n    return {\n      result: mapResult,\n      keyPrefix: keyPrefix,\n      func: mapFunction,\n      context: mapContext,\n      count: 0,\n    };\n  }\n}\n\n//\u5982\u679c\u6808\u672a\u6ee1\uff0cpush\u4e00\u4e2a\u7a7acontext\u5bf9\u8c61\nfunction releaseTraverseContext(traverseContext) {\n  traverseContext.result = null;\n  traverseContext.keyPrefix = null;\n  traverseContext.func = null;\n  traverseContext.context = null;\n  traverseContext.count = 0;\n  if (traverseContextPool.length < POOL_SIZE) {\n    traverseContextPool.push(traverseContext);\n  }\n}\n")),(0,a.kt)("h3",{id:"2\ufe0f\u20e3traverseallchildren"},"2\ufe0f\u20e3traverseAllChildren"),(0,a.kt)("p",null,"traverseAllChildrenImpl\u8c03\u7528\u5c01\u88c5\uff0c\u4e0e\u5176\u529f\u80fd\u4e00\u6837\u3002"),(0,a.kt)("h3",{id:"2\ufe0f\u20e3-1\ufe0f\u20e3traverseallchildrenimpl"},"2\ufe0f\u20e3-1\ufe0f\u20e3traverseAllChildrenImpl"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Children\u4e0d\u80fd\u662f\u4e00\u4e2a\u5bf9\u8c61"),"\n\u4ee3\u7801\u6709\u70b9\u957f\uff0c\u7b80\u8ff0\u5176\u4f5c\u7528\uff1a\u8f93\u5165children\u6811\uff0c\u8fd4\u56de\u6811\u4e2d\u8282\u70b9\u7c7b\u578b\u662fstring\uff0cnumber\uff0c\u6216\u8005\u8282\u70b9\u7684\u5373$$typeof\u4e3aREACT_ELEMENT_TYPE\uff0cREACT_PORTAL_TYPE\u7684\u8282\u70b9\u6570\u91cf\u3002\u56e0\u6b64React.Fragment\u7684$$typeof\u4e5f\u4e3aREACT_ELEMENT_TYPE,\u6240\u4ee5React.Fragment\u4e3a\u4e00\u4e2a\u8282\u70b9\u3002\u5982\u679cchildren\u662fArray\u6216\u8005\u5176\u4ed6\u7c7b\u578b\u7684\u5b50\u8282\u70b9\uff0c\u5219\u9012\u5f52\u8c03\u7528traverseAllChildrenImpl\uff0c\u76f4\u5230children\u7684typeof\u662fstring\uff0cnumber\uff0c\u6216\u8005$$typeof\u4e3aREACT_ELEMENT_TYPE\uff0cREACT_PORTAL_TYPE\u65f6\uff0c\u5bf9\u8be5children\u6267\u884ccallback\u51fd\u6570\uff0c\u5e76\u8fd4\u56de1\u3002\u6ce8\u610f\uff1a\u4e0d\u662f\u5bf9\u6240\u6709\u7684\u8282\u70b9\u904d\u5386\u3002"),(0,a.kt)("p",null,"callback\u4f20\u5165\u7684\u53c2\u6570\u4e3atraverseContext\uff0cchildren\uff0cnameSoFar\n\u5176\u4e2dnameSoFar === '' ? '.' + getComponentKey(children, 0) : nameSoFar\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"callback(\n  traverseContext,\n  children,\n  // If it's the only child, treat the name as if it was wrapped in an array\n  // so that it's consistent if the number of children grows.\n  nameSoFar === '' ? SEPARATOR + getComponentKey(children, 0) : nameSoFar,\n);\n")),(0,a.kt)("p",null,"\u53ef\u4ee5\u53c2\u770bblog/D3\u6587\u4ef6\u4e0b\u7684reactchildren.vsdx\u6587\u4ef6\u4e2d\u7684\u6d41\u7a0b\u56fe\u4ee5\u53careact\u6587\u4ef6\u5939\u4e0b\u5bf9\u5e94\u7684\u6e90\u7801\u6ce8\u91ca\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"function traverseAllChildrenImpl(\n  children,\n  nameSoFar,\n  callback,\n  traverseContext,\n){...}\n")),(0,a.kt)("h3",{id:"2\ufe0f\u20e3-1\ufe0f\u20e3-1\ufe0f\u20e3-mapsinglechildintocontext"},"2\ufe0f\u20e3-1\ufe0f\u20e3-1\ufe0f\u20e3 mapSingleChildIntoContext"),(0,a.kt)("p",null,"\u5bf9children\u6267\u884cfunc\uff08func\u4e3a\u4f20\u5165\u7684React.Children.map\u4e2d\u7684func\uff09,\n\u5982\u679c\u8fd4\u56de\u4e86\u4e00\u4e2a\u6570\u7ec4\uff0c\u5219\u5bf9\u8fd9\u4e2a\u6570\u7ec4\u8c03\u7528mapIntoWithKeyPrefixInternal\u76ee\u7684\u662f\u6dfb\u52a0\u7279\u5b9a\u7684key\n\u514b\u9686\u4ee5child\u8282\u70b9\u4e3a\u6839\u8282\u70b9\u7684\u6811\u4e2d\u7684\u6240\u6709child\uff0c\u66ff\u6362\u6389\u6bcf\u4e2a\u65b0child\u5143\u7d20\u7684key\uff0cpush\u5230bookKeeping\u4e2d\u7684result"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"function mapSingleChildIntoContext(bookKeeping, child, childKey) {\n  const {result, keyPrefix, func, context} = bookKeeping;\n\n  let mappedChild = func.call(context, child, bookKeeping.count++);\n  if (Array.isArray(mappedChild)) {\n      //\u5982\u679cchild\u4e2d\u5305\u542b\u591a\u4e2achild\uff0c\u5219\u8fd4\u56de\u7684mappedChild\u662f\u4e00\u4e2a\u6570\u7ec4\uff0c\u5219\u9012\u5f52\u8c03\u7528mapIntoWithKeyPrefixInternal\n    mapIntoWithKeyPrefixInternal(mappedChild, result, childKey, c => c);\n  } else if (mappedChild != null) {\n      //\u5982\u679cchild\u4e2d\u53ea\u6709\u4e00\u4e2achild\uff0c\u5e76\u4e14\u662f\u5408\u6cd5\u7684react\u5143\u7d20\uff0c\n      // \u5219\u5c06mappedChild\u7684key\u5c5e\u6027\u503c\u66ff\u6362\u6389\n    //  \u6700\u540e\u5c06\u65b0\u7684react\u5143\u7d20push\u5230bookKeeping.result\n    if (isValidElement(mappedChild)) {\n      mappedChild = cloneAndReplaceKey(\n        mappedChild,\n        // Keep both the (mapped) and old keys if they differ, just as\n        // traverseAllChildren used to do for objects as children\n        keyPrefix +\n          (mappedChild.key && (!child || child.key !== mappedChild.key)\n            ? escapeUserProvidedKey(mappedChild.key) + '/'\n            : '') +\n          childKey,\n      );\n    }\n    result.push(mappedChild);\n  }\n}\n")),(0,a.kt)("h3",{id:"foreachsinglechild"},"forEachSingleChild"),(0,a.kt)("p",null,"\u6267\u884cbookKeeping.func\uff0c\u5e76\u5c06bookKeeping.count\u7684\u503c\u52a01\u3002func\u4f20\u5165\u7684\u53c2\u6570\u4e3abookKeeping.context,child\u4ee5\u53cabookKeeping.count\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"function forEachSingleChild(bookKeeping, child, name) {\n  const {func, context} = bookKeeping;\n  //\u6267\u884cbookKeeping.func\uff0cbookKeeping.count\u8ba1\u6570\u589e\u52a0\u4e00\n  func.call(context, child, bookKeeping.count++);\n}\n")),(0,a.kt)("h3",{id:"foreachchildren"},"forEachChildren"),(0,a.kt)("p",null,"\u901a\u8fc7\u8c03\u7528getPooledTraverseContext\u5c06\u4f20\u5165\u7684\u53c2\u6570forEachFunc\u4ee5\u53caforEachContext\u8d4b\u503c\u7ed9traverseContext\u7684func\u4e0econtext\u5c5e\u6027\u3002\n\u8c03\u7528traverseAllChildren"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"function forEachChildren(children, forEachFunc, forEachContext) {\n  if (children == null) {\n    return children;\n  }\n  const traverseContext = getPooledTraverseContext(\n    null,\n    null,\n    forEachFunc,\n    forEachContext,\n  );\n  traverseAllChildren(children, forEachSingleChild, traverseContext);\n  releaseTraverseContext(traverseContext);\n}\n")))}h.isMDXComponent=!0}}]);