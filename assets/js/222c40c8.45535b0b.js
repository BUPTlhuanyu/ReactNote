"use strict";(self.webpackChunkreact_note_docusaurus=self.webpackChunkreact_note_docusaurus||[]).push([[6197],{3905:function(e,n,t){t.d(n,{Zo:function(){return u},kt:function(){return k}});var a=t(7294);function i(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function l(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function r(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?l(Object(t),!0).forEach((function(n){i(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):l(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function o(e,n){if(null==e)return{};var t,a,i=function(e,n){if(null==e)return{};var t,a,i={},l=Object.keys(e);for(a=0;a<l.length;a++)t=l[a],n.indexOf(t)>=0||(i[t]=e[t]);return i}(e,n);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)t=l[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(i[t]=e[t])}return i}var s=a.createContext({}),c=function(e){var n=a.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):r(r({},n),e)),t},u=function(e){var n=c(e.components);return a.createElement(s.Provider,{value:n},e.children)},d={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},m=a.forwardRef((function(e,n){var t=e.components,i=e.mdxType,l=e.originalType,s=e.parentName,u=o(e,["components","mdxType","originalType","parentName"]),m=c(t),k=i,p=m["".concat(s,".").concat(k)]||m[k]||d[k]||l;return t?a.createElement(p,r(r({ref:n},u),{},{components:t})):a.createElement(p,r({ref:n},u))}));function k(e,n){var t=arguments,i=n&&n.mdxType;if("string"==typeof e||i){var l=t.length,r=new Array(l);r[0]=m;var o={};for(var s in n)hasOwnProperty.call(n,s)&&(o[s]=n[s]);o.originalType=e,o.mdxType="string"==typeof e?e:i,r[1]=o;for(var c=2;c<l;c++)r[c]=t[c];return a.createElement.apply(null,r)}return a.createElement.apply(null,t)}m.displayName="MDXCreateElement"},5578:function(e,n,t){t.r(n),t.d(n,{frontMatter:function(){return o},contentTitle:function(){return s},metadata:function(){return c},toc:function(){return u},default:function(){return m}});var a=t(7462),i=t(3366),l=(t(7294),t(3905)),r=["components"],o={id:"scheduler-code-details",sidebar_label:"scheduler-code-details",slug:"/react/react/scheduler/others/scheduler-code-details",sidebar_position:1,title:""},s="\u8bbe\u8ba1\u601d\u60f3",c={unversionedId:"react/react/scheduler/others/scheduler-code-details",id:"react/react/scheduler/others/scheduler-code-details",isDocsHomePage:!1,title:"",description:"1\u3001\u4e3a\u5404\u4e2a\u4e8b\u4ef6\u56de\u8c03\u51fd\u6570\u8bbe\u7f6e\u76f8\u5e94\u7684\u4f18\u5148\u7ea7\uff0c\u7136\u540e\u6839\u636e\u81ea\u5b9a\u4e49\u6216\u8005\u9ed8\u8ba4\u4f18\u5148\u7ea7\u786e\u5b9a\u5230\u671f\u65f6\u95f4\uff0c\u4ee5\u6b64\u4e3a\u57fa\u7840\uff0c\u6784\u5efa\u4e00\u4e2a\u53cc\u5411\u5faa\u73af\u5217\u8868\u5f53\u505a\u4efb\u52a1\u961f\u5217\uff0c\u6bcf\u4e2a\u8282\u70b9\u5b58\u50a8\u4e86\u4efb\u52a1\u7684\u56de\u8c03\u51fd\u6570\u4ee5\u53ca\u5230\u671f\u65f6\u95f4\uff0c\u4f18\u5148\u7ea7\uff0c\u524d\u4e00\u4e2a\u8282\u70b9\u540e\u4e00\u4e2a\u8282\u70b9\u3002",source:"@site/docs/react/react/scheduler/others/scheduler\u7ec6\u8282.mdx",sourceDirName:"react/react/scheduler/others",slug:"/react/react/scheduler/others/scheduler-code-details",permalink:"/docs/react/react/scheduler/others/scheduler-code-details",editUrl:"https://github.com/BUPTlhuanyu/ReactNote/tree/master/docs/react/react/scheduler/others/scheduler\u7ec6\u8282.mdx",tags:[],version:"current",sidebarPosition:1,frontMatter:{id:"scheduler-code-details",sidebar_label:"scheduler-code-details",slug:"/react/react/scheduler/others/scheduler-code-details",sidebar_position:1,title:""},sidebar:"react",previous:{title:"react-is",permalink:"/docs/react/react/scheduler/others/react-is"},next:{title:"scheduler-tracing-subscriptions",permalink:"/docs/react/react/scheduler/others/scheduler-tracing-subscriptions"}},u=[{value:"\u4e94\u4e2a\u4f18\u5148\u7ea7",id:"\u4e94\u4e2a\u4f18\u5148\u7ea7",children:[]},{value:"\u4e94\u4e2a\u4f18\u5148\u7ea7\u5bf9\u5e94\u7684\u8fc7\u671f\u65f6\u95f4",id:"\u4e94\u4e2a\u4f18\u5148\u7ea7\u5bf9\u5e94\u7684\u8fc7\u671f\u65f6\u95f4",children:[]},{value:"\u6d4f\u89c8\u5668\u6e32\u67d3\u5e27\u4e0e\u663e\u793a\u5c4f\u7684\u5237\u65b0\u9891\u7387",id:"\u6d4f\u89c8\u5668\u6e32\u67d3\u5e27\u4e0e\u663e\u793a\u5c4f\u7684\u5237\u65b0\u9891\u7387",children:[]},{value:"window.requestAnimationFrame",id:"windowrequestanimationframe",children:[]},{value:"window.cancelAnimationFrame",id:"windowcancelanimationframe",children:[]},{value:"getCurrentTime",id:"getcurrenttime",children:[]},{value:"requestAnimationFrameWithTimeout",id:"requestanimationframewithtimeout",children:[]},{value:"\u5173\u952e\u53d8\u91cf",id:"\u5173\u952e\u53d8\u91cf",children:[]},{value:"\u76d1\u542cMessage\u4e8b\u4ef6",id:"\u76d1\u542cmessage\u4e8b\u4ef6",children:[]},{value:"\u76d1\u542cMessage\u4e8b\u4ef6\u4f20\u5165\u7684\u56de\u8c03\u51fd\u6570idleTick",id:"\u76d1\u542cmessage\u4e8b\u4ef6\u4f20\u5165\u7684\u56de\u8c03\u51fd\u6570idletick",children:[]},{value:"animation frame fired\u7684\u56de\u8c03\u51fd\u6570animationTick",id:"animation-frame-fired\u7684\u56de\u8c03\u51fd\u6570animationtick",children:[]},{value:"\u4efb\u52a1\u6267\u884c\u5668\u5bf9postMessage\u4e0erequestAnimationFrameWithTimeout\u884c\u4e3a\u8c03\u5ea6\u7684\u5173\u952e\u51fd\u6570",id:"\u4efb\u52a1\u6267\u884c\u5668\u5bf9postmessage\u4e0erequestanimationframewithtimeout\u884c\u4e3a\u8c03\u5ea6\u7684\u5173\u952e\u51fd\u6570",children:[{value:"\u88ab\u4efb\u52a1\u6267\u884c\u5668\u8c03\u7528\u4ee5\u83b7\u53d6\u5f53\u524d\u5e27\u662f\u5426\u8fc7\u671f\u7684\u51fd\u6570\uff1ashouldYieldToHost",id:"\u88ab\u4efb\u52a1\u6267\u884c\u5668\u8c03\u7528\u4ee5\u83b7\u53d6\u5f53\u524d\u5e27\u662f\u5426\u8fc7\u671f\u7684\u51fd\u6570shouldyieldtohost",children:[]},{value:"\u88ab\u4efb\u52a1\u6267\u884c\u5668\u8c03\u7528\u4ee5\u63a7\u5236postMessage\u884c\u4e3a\u7684\u51fd\u6570\uff1acancelHostCallback",id:"\u88ab\u4efb\u52a1\u6267\u884c\u5668\u8c03\u7528\u4ee5\u63a7\u5236postmessage\u884c\u4e3a\u7684\u51fd\u6570cancelhostcallback",children:[]},{value:"\u88ab\u4efb\u52a1\u6267\u884c\u5668\u8c03\u7528\u4ee5\u91cd\u65b0\u8bbe\u7f6e\u6267\u884c\u5668\u63a7\u5236postMessage\u4e0erequestAnimationFrameWithTimeout\u884c\u4e3a\u7684\u51fd\u6570\uff1arequestHostCallback",id:"\u88ab\u4efb\u52a1\u6267\u884c\u5668\u8c03\u7528\u4ee5\u91cd\u65b0\u8bbe\u7f6e\u6267\u884c\u5668\u63a7\u5236postmessage\u4e0erequestanimationframewithtimeout\u884c\u4e3a\u7684\u51fd\u6570requesthostcallback",children:[]},{value:"\u5de5\u5177\u51fd\u6570ensureHostCallbackIsScheduled",id:"\u5de5\u5177\u51fd\u6570ensurehostcallbackisscheduled",children:[]},{value:"\u4efb\u52a1\u6267\u884c\u5668flushWork",id:"\u4efb\u52a1\u6267\u884c\u5668flushwork-1",children:[]},{value:"flushFirstCallback",id:"flushfirstcallback",children:[]},{value:"flushImmediateWork",id:"flushimmediatework",children:[]},{value:"unstable_scheduleCallback",id:"unstable_schedulecallback",children:[]}]}],d={toc:u};function m(e){var n=e.components,o=(0,i.Z)(e,r);return(0,l.kt)("wrapper",(0,a.Z)({},d,o,{components:n,mdxType:"MDXLayout"}),(0,l.kt)("h1",{id:"\u8bbe\u8ba1\u601d\u60f3"},"\u8bbe\u8ba1\u601d\u60f3"),(0,l.kt)("p",null,"1\u3001\u4e3a\u5404\u4e2a\u4e8b\u4ef6\u56de\u8c03\u51fd\u6570\u8bbe\u7f6e\u76f8\u5e94\u7684\u4f18\u5148\u7ea7\uff0c\u7136\u540e\u6839\u636e\u81ea\u5b9a\u4e49\u6216\u8005\u9ed8\u8ba4\u4f18\u5148\u7ea7\u786e\u5b9a\u5230\u671f\u65f6\u95f4\uff0c\u4ee5\u6b64\u4e3a\u57fa\u7840\uff0c\u6784\u5efa\u4e00\u4e2a\u53cc\u5411\u5faa\u73af\u5217\u8868\u5f53\u505a\u4efb\u52a1\u961f\u5217\uff0c\u6bcf\u4e2a\u8282\u70b9\u5b58\u50a8\u4e86\u4efb\u52a1\u7684\u56de\u8c03\u51fd\u6570\u4ee5\u53ca\u5230\u671f\u65f6\u95f4\uff0c\u4f18\u5148\u7ea7\uff0c\u524d\u4e00\u4e2a\u8282\u70b9\u540e\u4e00\u4e2a\u8282\u70b9\u3002"),(0,l.kt)("p",null,"2\u3001\u5f62\u6210\u7684\u4efb\u52a1\u94fe\u8868\u7684\u6267\u884c\u51c6\u5219\u662f\uff1a\u5f53\u524d\u5e27\u6709\u7a7a\u95f2\u65f6\u95f4\uff0c\u5219\u6267\u884c\u4efb\u52a1\u3002\u5373\u4fbf\u6ca1\u6709\u7a7a\u95f2\u65f6\u95f4\u4f46\u662f\u5f53\u524d\u4efb\u52a1\u94fe\u8868\u6709\u4efb\u52a1\u5230\u671f\u4e86\u6216\u8005\u6709\u7acb\u5373\u6267\u884c\u4efb\u52a1\uff0c\u90a3\u4e48\u5fc5\u987b\u6267\u884c\u7684\u65f6\u5019\u5c31\u4ee5\u4e22\u5931\u51e0\u5e27\u7684\u4ee3\u4ef7\uff0c\u6267\u884c\u4efb\u52a1\u94fe\u8868\u4e2d\u5230\u671f\u7684\u4efb\u52a1\u3002\u6267\u884c\u5b8c\u7684\u4efb\u52a1\u90fd\u4f1a\u88ab\u4ece\u94fe\u8868\u4e2d\u5220\u9664\u3002\u6bcf\u6b21\u5728\u6267\u884c\u4efb\u52a1\u94fe\u8868\u4e2d\u5230\u671f\u7684\u4efb\u52a1\u7684\u90a3\u6bb5\u65f6\u95f4\u91cc\uff0c\u987a\u4fbf\u628a\u4f18\u5148\u7ea7\u6700\u9ad8\u9700\u8981\u7acb\u5373\u6267\u884c\u7684\u4efb\u52a1\u90fd\u6267\u884c\u3002"),(0,l.kt)("p",null,"\u603b\u89c8\u56fe\uff1aflush*\u4e3a\u4efb\u52a1\u6267\u884c\u6a21\u5757\uff0c\u4e3b\u8981\u7528\u4e8e\u6267\u884c\u4efb\u52a1\u7684\u56de\u8c03\u51fd\u6570\uff0c\u5bf9\u4efb\u52a1\u94fe\u8868\u8fdb\u884c\u64cd\u4f5c\u3002idleTick\u4e0eanimationTick\u4e3a\u76f4\u63a5\u8c03\u5ea6\u6a21\u5757\uff0c\u6839\u636e\u5f53\u524d\u5e27\u7684\u7a7a\u95f2\u65f6\u95f4\u4e0e\u4efb\u52a1\u94fe\u8868\u6700\u5c0f\u5230\u671f\u65f6\u95f4\u6765\u63a7\u5236\u662f\u5426\u5728\u5f53\u524d\u5e27\u6267\u884c\u4efb\u52a1\u94fe\u8868\u8fd8\u662f\u5728\u4e0b\u4e00\u5e27\u7ee7\u7eed\u5904\u7406\u3002ensureHostCallbackIsScheduled\u4e0erequestHostCallback\u7ec4\u6210\u4efb\u52a1\u6267\u884c\u6a21\u5757\u4e0e\u8c03\u5ea6\u6a21\u5757\u7684\u67a2\u7ebd\uff0c\u534f\u8c03\u4e24\u8005\u7684\u5de5\u4f5c\uff0c\u5e76\u4e14ensureHostCallbackIsScheduled\u4e3a\u5916\u90e8API\u63d0\u4f9b\u5165\u53e3\u3002"),(0,l.kt)("p",null,(0,l.kt)("img",{src:t(9070).Z})),(0,l.kt)("h1",{id:"\u4f8b\u5b50"},"\u4f8b\u5b50"),(0,l.kt)("p",null,"\u8003\u8651\u4e00\u79cd\u6bd4\u8f83\u7b80\u5355\u7684\u903b\u8f91\uff0c\u4efb\u52a1\u94fe\u8868\u7684\u6267\u884c\u4e3b\u8981\u662f\u901a\u8fc7idleTick\u51fd\u6570\u8c03\u7528flushWork\u5b9e\u73b0\u7684\uff0c\u56e0\u6b64\u5206\u6790idleTick\u51fd\u6570\u5904\u7406\u7684\u4e09\u79cd\u60c5\u51b5\uff1a"),(0,l.kt)("p",null,"\u60c5\u51b51\uff1a\u5f53\u524d\u5e27\u622a\u6b62\u65f6\u95f4\u5927\u4e8e\u5f53\u524d\u65f6\u95f4\uff0c\u8bf4\u660e\u5f53\u524d\u5e27\u8fd8\u6709\u65f6\u95f4\u6267\u884c\u4efb\u52a1\u94fe\u8868\u8282\u70b9\u4e2d\u7684\u56de\u8c03\u51fd\u6570\uff0c\u56e0\u6b64\u6267\u884cflushWork\u3002"),(0,l.kt)("p",null,"\u60c5\u51b52\uff1a\u5982\u679c\u5f53\u524d\u5e27\u622a\u6b62\u65f6\u95f4\u5c0f\u4e8e\u6216\u8005\u7b49\u4e8e\u5f53\u524d\u65f6\u95f4\uff0c\u8bf4\u660e\u5f53\u524d\u5e27\u8fc7\u671f\u4e86\uff0c\u6ca1\u6709\u5269\u4f59\u65f6\u95f4\u6267\u884c\u4efb\u52a1\u56de\u8c03\u51fd\u6570\uff0c\u4f46\u662f\u5982\u679c\u4efb\u52a1\u94fe\u8868\u7684\u6700\u5c0f\u5230\u671f\u65f6\u95f4\u5df2\u7ecf\u8fc7\u671f\u4e86\u6216\u8005\u6709\u7acb\u5373\u6267\u884c\u7684\u4efb\u52a1\uff0c\u90a3\u4e48\u8bf4\u660e\u8fd9\u4e2a\u4efb\u52a1\u94fe\u8868\u4e2d\u7684\u4efb\u52a1\u975e\u5f97\u6267\u884c\u4e0d\u53ef\uff0c\u90a3\u5c31\u76f4\u63a5\u963b\u585e\u6e32\u67d3\uff0c\u5c06\u63a5\u4e0b\u7684\u51e0\u4e2a\u6e32\u67d3\u5e27\u7684\u65f6\u95f4\u7528\u6765\u6267\u884c\u5f53\u524d\u8fc7\u671f\u7684\u4efb\u52a1\u94fe\u8868\u3002"),(0,l.kt)("p",null,"\u60c5\u51b53\uff1a\u5982\u679c\u5f53\u524d\u5e27\u622a\u6b62\u65f6\u95f4\u5c0f\u4e8e\u6216\u8005\u7b49\u4e8e\u5f53\u524d\u65f6\u95f4\uff0c\u8bf4\u660e\u5f53\u524d\u5e27\u8fc7\u671f\u4e86\uff0c\u6ca1\u6709\u5269\u4f59\u65f6\u95f4\u6267\u884c\u4efb\u52a1\u56de\u8c03\u51fd\u6570\uff0c\u5e76\u4e14\u4efb\u52a1\u94fe\u8868\u7684\u6700\u5c0f\u5230\u671f\u65f6\u95f4\u8fd8\u6ca1\u5230\uff0c\u56e0\u6b64\u8fd9\u4e2a\u4efb\u52a1\u94fe\u8868\u8fd8\u4e0d\u6025\u7740\u6267\u884c\uff0c\u53ef\u4ee5\u653e\u5230\u4e0b\u4e00\u5e27\uff08animation frame fire\u7684\u65f6\u5019\u8c03\u7528animationTick\u89e6\u53d1Message\u4e8b\u4ef6\u8c03\u7528idleTick\uff09\u53bb\u5904\u7406\uff0c\u4f9d\u7136\u5206\u4e09\u79cd\u60c5\u51b5\u8fdb\u884c\u5904\u7406\u3002"),(0,l.kt)("p",null,"\u7ed9\u51fa\u4e00\u5f20\u56fe\u5982\u4e0b\u6216\u8bb8\u4f60\u4f1a\u6709\u4e00\u4e2a\u66f4\u52a0\u6e05\u6670\u7684\u7406\u89e3\uff1a"),(0,l.kt)("p",null,(0,l.kt)("img",{src:t(6415).Z})),(0,l.kt)("h1",{id:"\u4f18\u5148\u7ea7\u4ee5\u53ca\u5bf9\u5e94\u7684\u8fc7\u671f\u65f6\u95f4"},"\u4f18\u5148\u7ea7\u4ee5\u53ca\u5bf9\u5e94\u7684\u8fc7\u671f\u65f6\u95f4"),(0,l.kt)("h3",{id:"\u4e94\u4e2a\u4f18\u5148\u7ea7"},"\u4e94\u4e2a\u4f18\u5148\u7ea7"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"var ImmediatePriority = 1;\nvar UserBlockingPriority = 2;\nvar NormalPriority = 3;\nvar LowPriority = 4;\nvar IdlePriority = 5;\n")),(0,l.kt)("h3",{id:"\u4e94\u4e2a\u4f18\u5148\u7ea7\u5bf9\u5e94\u7684\u8fc7\u671f\u65f6\u95f4"},"\u4e94\u4e2a\u4f18\u5148\u7ea7\u5bf9\u5e94\u7684\u8fc7\u671f\u65f6\u95f4"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"var maxSigned31BitInt = 1073741823;\n//  \u8fc7\u671f\u65f6\u95f4\nvar IMMEDIATE_PRIORITY_TIMEOUT = -1;\nvar USER_BLOCKING_PRIORITY = 250;\nvar NORMAL_PRIORITY_TIMEOUT = 5000;\nvar LOW_PRIORITY_TIMEOUT = 10000;\nvar IDLE_PRIORITY = maxSigned31BitInt;\n")),(0,l.kt)("h1",{id:"\u4e00\u4e9b\u53d8\u91cf"},"\u4e00\u4e9b\u53d8\u91cf"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"// \u56de\u8c03\u51fd\u6570\u88ab\u5b58\u50a8\u53cc\u5411\u5faa\u73af\u94fe\u8868\u4e2d\nvar firstCallbackNode = null;\n//\u5f53\u524d\u4e8b\u4ef6\u5f00\u59cb\u65f6\u95f4\nvar currentEventStartTime = -1;\n//\u5f53\u524d\u4e8b\u4ef6\u5230\u671f\u65f6\u95f4\nvar currentExpirationTime = -1;\n")),(0,l.kt)("h1",{id:"\u9884\u5907\u77e5\u8bc6"},"\u9884\u5907\u77e5\u8bc6"),(0,l.kt)("h3",{id:"\u6d4f\u89c8\u5668\u6e32\u67d3\u5e27\u4e0e\u663e\u793a\u5c4f\u7684\u5237\u65b0\u9891\u7387"},"\u6d4f\u89c8\u5668\u6e32\u67d3\u5e27\u4e0e\u663e\u793a\u5c4f\u7684\u5237\u65b0\u9891\u7387"),(0,l.kt)("p",null,"\u5e27\uff1a\u901a\u4fd7\u6765\u8bf4\u5c31\u662f\u4e00\u5f20\u4e00\u5f20\u5c55\u793a\u7684\u753b\u9762\uff08\u5b66\u8fc7\u7535\u89c6\u539f\u7406\u7684\u5e94\u8be5\u4e0d\u4f1a\u964c\u751f\uff0c\u672c\u4eba\u672c\u79d1\u5b66\u7535\u5b50\u505a\u786c\u4ef6\u7684\u3002\uff09\uff0c\n\u7531\u4e8e\u73b0\u5728\u5e7f\u6cdb\u4f7f\u7528\u7684\u5c4f\u5e55\u90fd\u6709\u56fa\u5b9a\u7684\u5237\u65b0\u7387\uff08\u6bd4\u5982\u6700\u65b0\u7684\u4e00\u822c\u5728 60Hz\uff09\uff0c \u5728\u4e24\u6b21\u786c\u4ef6\u5237\u65b0\u4e4b\u95f4\u6d4f\u89c8\u5668\u8fdb\u884c\u4e24\u6b21\u91cd\u7ed8\u662f\u6ca1\u6709\u610f\u4e49\u7684\u53ea\u4f1a\u6d88\u8017\u6027\u80fd\u3002\u56e0\u6b64\u6d4f\u89c8\u5668\u7684\u6e32\u67d3\u51fa\u4e00\u5e27\u753b\u9762\u7684\u95f4\u9694\u5e94\u8be5\u5c31\u662f\u786c\u4ef6\u7684\u6bcf\u4e00\u5e27\u56fe\u50cf\u7684\u65f6\u95f4\u95f4\u9694\uff0c\u5373\u5237\u65b0\u9891\u7387\u7684\u5012\u6570\u3002"),(0,l.kt)("p",null,"\u90a3\u4e48\u5728\u6d4f\u89c8\u5668\u5448\u73b0\u4e24\u5e45\u56fe\u50cf\u7684\u7a7a\u95f2\uff08idle\uff09\u65f6\u95f4\u91cc\uff0c\u4e5f\u5c31\u662f16.7ms\u7684\u65f6\u95f4\u91cc\u9700\u8981\u6267\u884c\u5982\u4e0b\u64cd\u4f5c\uff1a"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u811a\u672c\u6267\u884c\uff08JavaScript\uff09\uff1a\u811a\u672c\u9020\u6210\u4e86\u9700\u8981\u91cd\u7ed8\u7684\u6539\u52a8\uff0c\u6bd4\u5982\u589e\u5220 DOM\u3001\u8bf7\u6c42\u52a8\u753b\u7b49"),(0,l.kt)("li",{parentName:"ul"},"\u6837\u5f0f\u8ba1\u7b97\uff08CSS Object Model\uff09\uff1a\u7ea7\u8054\u5730\u751f\u6210\u6bcf\u4e2a\u8282\u70b9\u7684\u751f\u6548\u6837\u5f0f\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u5e03\u5c40\uff08Layout\uff09\uff1a\u8ba1\u7b97\u5e03\u5c40\uff0c\u6267\u884c\u6e32\u67d3\u7b97\u6cd5"),(0,l.kt)("li",{parentName:"ul"},"\u91cd\u7ed8\uff08Paint\uff09\uff1a\u5404\u5c42\u5206\u522b\u8fdb\u884c\u7ed8\u5236\uff08\u6bd4\u5982 3D \u52a8\u753b\uff09"),(0,l.kt)("li",{parentName:"ul"},"\u5408\u6210\uff08Composite\uff09\uff1a\u5408\u6210\u5404\u5c42\u7684\u6e32\u67d3\u7ed3\u679c")),(0,l.kt)("p",null,"\u5728\u8fd916.7ms\u4e2d\uff0c\u5305\u62ec\u4e86js\u811a\u672c\u6267\u884c\uff0c\u9700\u8981js\u7ebf\u7a0b\uff0c\u800c\u6e32\u67d3\u9700\u8981\u7684\u662fgui\u6e32\u67d3\u7ebf\u7a0b\uff0c\u800c\u8fd9\u4e24\u4e2a\u7ebf\u7a0b\u662f\u4e92\u65a5\u7684\u3002\u7531\u4e8eGUI\u6e32\u67d3\u7ebf\u7a0b\u4e0eJavaScript\u6267\u884c\u7ebf\u7a0b\u662f\u4e92\u65a5\u7684\u5173\u7cfb\uff0c\u5f53\u6d4f\u89c8\u5668\u5728\u6267\u884cJavaScript\u7a0b\u5e8f\u7684\u65f6\u5019\uff0cGUI\u6e32\u67d3\u7ebf\u7a0b\u4f1a\u88ab\u4fdd\u5b58\u5728\u4e00\u4e2a\u961f\u5217\u4e2d\uff0c\u76f4\u5230JS\u7a0b\u5e8f\u6267\u884c\u5b8c\u6210\uff0c\u624d\u4f1a\u63a5\u7740\u6267\u884c\u3002\u56e0\u6b64\u5982\u679cJS\u6267\u884c\u7684\u65f6\u95f4\u8fc7\u957f\uff0c\u8fd9\u6837\u5c31\u4f1a\u9020\u6210\u9875\u9762\u7684\u6e32\u67d3\u4e0d\u8fde\u8d2f\uff0c\u5bfc\u81f4\u9875\u9762\u6e32\u67d3\u52a0\u8f7d\u963b\u585e\u7684\u611f\u89c9\u3002"),(0,l.kt)("p",null,"\u5982\u4e0b\u56fe\u6240\u793a\u4e3a\u6e32\u67d3\u5e27\uff0c\u4ee3\u7801\u5728github\u4e2dreactNote\u4ed3\u5e93\u4e2d\uff0c\u8fd9\u91cc\u5c55\u793a\u4e00\u4e0b\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},'var start = null;\nvar element = document.getElementById("move")\nelement.style.position = \'absolute\';\n\nfunction step(timestamp) {\n    console.log("timestamp",timestamp)\n    if (!start) start = timestamp;\n    var progress = timestamp - start;\n    element.style.left = Math.min(progress / 10, 200) + \'px\';\n    if (progress < 400) {\n\n        window.requestAnimationFrame(step);\n        window.postMessage({},"*");\n    }\n}\n\nvar idleTick = function(){\n    console.log("idleTick")\n}\n\nwindow.addEventListener(\'message\', idleTick, false);\n\nwindow.requestAnimationFrame(step);\n')),(0,l.kt)("p",null,(0,l.kt)("img",{src:t(3696).Z})),(0,l.kt)("h4",{id:"\u6ce8\u610f"},"\u6ce8\u610f\uff1a"),(0,l.kt)("p",null,"1\u3001\u4ece\u56fe\u4e2d\u53ef\u4ee5\u770b\u5230\u5e03\u5c40\u91cd\u7ed8\u5408\u6210\u4e4b\u540e\u5e76\u4e0d\u4ee3\u8868\u662f\u5e27\u7684\u7ed3\u675f\u3002\u672c\u6587\u7684\u5f53\u524d\u5e27\u622a\u6b62\u65f6\u95f4frameDeadLine\u662fanimation frame fired\u5f00\u59cb\u65f6\u95f4 + activeFrameTime\uff0cactiveFrameTime\u8fd9\u4e2a\u503c\u5c31\u662fFPS\uff0c\u4e5f\u5c31\u662f\u6d4f\u89c8\u5668\u5f53\u524d\u7684\u5237\u65b0\u9891\u7387\uff0c\u8868\u793a\u6d41\u7545\u7a0b\u5ea6\uff0c\u8fd9\u4e2a\u503c\u968f\u7740\u7cfb\u7edf\u7684\u8fd0\u884c\u800c\u53d8\u5316\u3002"),(0,l.kt)("p",null,"2\u3001\u4ece\u56fe\u4e2d\u8fd8\u53ef\u4ee5\u770b\u5230postmessage\u5728\u5408\u6210\u4e4b\u540e\u6267\u884c\u3002"),(0,l.kt)("h3",{id:"windowrequestanimationframe"},(0,l.kt)("a",{parentName:"h3",href:"https://developer.mozilla.org/zh-CN/docs/Web/API/Window/requestAnimationFrame"},"window.requestAnimationFrame")),(0,l.kt)("p",null,"\u5f53\u4f60\u51c6\u5907\u66f4\u65b0\u52a8\u753b\u65f6\u4f60\u5e94\u8be5\u8c03\u7528\u6b64\u65b9\u6cd5\u3002\u8fd9\u5c06\u4f7f\u6d4f\u89c8\u5668\u5728\u4e0b\u4e00\u6b21\u91cd\u7ed8\u4e4b\u524d\u8c03\u7528\u4f60\u4f20\u5165\u7ed9\u8be5\u65b9\u6cd5\u7684\u52a8\u753b\u51fd\u6570(\u5373\u4f60\u7684\u56de\u8c03\u51fd\u6570)\u3002\u56de\u8c03\u51fd\u6570\u6267\u884c\u6b21\u6570\u901a\u5e38\u662f\u6bcf\u79d260\u6b21\uff0c\u4f46\u5728\u5927\u591a\u6570\u9075\u5faaW3C\u5efa\u8bae\u7684\u6d4f\u89c8\u5668\u4e2d\uff0c\u56de\u8c03\u51fd\u6570\u6267\u884c\u6b21\u6570\u901a\u5e38\u4e0e\u6d4f\u89c8\u5668\u5c4f\u5e55\u5237\u65b0\u6b21\u6570\u76f8\u5339\u914d\u3002\u4e3a\u4e86\u63d0\u9ad8\u6027\u80fd\u548c\u7535\u6c60\u5bff\u547d\uff0c\u56e0\u6b64\u5728\u5927\u591a\u6570\u6d4f\u89c8\u5668\u91cc\uff0c\u5f53",(0,l.kt)("inlineCode",{parentName:"p"},"requestAnimationFrame()")," \u8fd0\u884c\u5728\u540e\u53f0\u6807\u7b7e\u9875\u6216\u8005\u9690\u85cf\u7684",(0,l.kt)("inlineCode",{parentName:"p"},"<iframe>")," \u91cc\u65f6\uff0c",(0,l.kt)("inlineCode",{parentName:"p"},"requestAnimationFrame()")," \u4f1a\u88ab\u6682\u505c\u8c03\u7528\u4ee5\u63d0\u5347\u6027\u80fd\u548c\u7535\u6c60\u5bff\u547d\u3002"),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"\u53c2\u6570\uff1a")),(0,l.kt)("p",null,"\u5bf9\u4e8e\u4f20\u5165\u7684\u56de\u8c03\u51fd\u6570\uff1a\u4e0b\u4e00\u6b21\u91cd\u7ed8\u4e4b\u524d\u66f4\u65b0\u52a8\u753b\u5e27\u6240\u8c03\u7528\u7684\u51fd\u6570\u3002\u8be5\u56de\u8c03\u51fd\u6570\u4f1a\u88ab\u4f20\u5165",(0,l.kt)("inlineCode",{parentName:"p"},"DOMHighResTimeStamp"),"\u53c2\u6570\uff0c\u8be5\u53c2\u6570\u4e0e",(0,l.kt)("inlineCode",{parentName:"p"},"performance.now()"),"\u7684\u8fd4\u56de\u503c\u76f8\u540c\uff0c\u5b83\u8868\u793a",(0,l.kt)("inlineCode",{parentName:"p"},"requestAnimationFrame() "),"\u5f00\u59cb\u53bb\u6267\u884c\u56de\u8c03\u51fd\u6570\u7684\u65f6\u523b\u3002"),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"\u8fd4\u56de\u503c\uff1a")),(0,l.kt)("p",null,"\u4e00\u4e2a long \u6574\u6570\uff0c\u8bf7\u6c42 ID \uff0c\u662f\u56de\u8c03\u5217\u8868\u4e2d\u552f\u4e00\u7684\u6807\u8bc6\u3002\u662f\u4e2a\u975e\u96f6\u503c\uff0c\u6ca1\u522b\u7684\u610f\u4e49\u3002\u4f60\u53ef\u4ee5\u4f20\u8fd9\u4e2a\u503c\u7ed9 window.cancelAnimationFrame() \u4ee5\u53d6\u6d88\u56de\u8c03\u51fd\u6570\u3002"),(0,l.kt)("p",null,"\u6ce8\u610f\uff1a\u82e5\u4f60\u60f3\u5728\u6d4f\u89c8\u5668\u4e0b\u6b21\u91cd\u7ed8\u4e4b\u524d\u7ee7\u7eed\u66f4\u65b0\u4e0b\u4e00\u5e27\u52a8\u753b\uff0c\u90a3\u4e48\u56de\u8c03\u51fd\u6570\u81ea\u8eab\u5fc5\u987b\u518d\u6b21\u8c03\u7528",(0,l.kt)("inlineCode",{parentName:"p"},"window.requestAnimationFrame()")),(0,l.kt)("p",null,"\u4f8b\u5982\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"var start = null;\nvar element = document.getElementById('SomeElementYouWantToAnimate');\nelement.style.position = 'absolute';\n\nfunction step(timestamp) {\n  if (!start) start = timestamp;\n  var progress = timestamp - start;\n  element.style.left = Math.min(progress / 10, 200) + 'px';\n  if (progress < 2000) {\n    window.requestAnimationFrame(step);\n  }\n}\n\nwindow.requestAnimationFrame(step);\n")),(0,l.kt)("p",null,"\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0c\u7b2c\u4e00\u6b21\u8c03\u7528\u7684\u65f6\u5019\u5f53\u524d\u7684\u6beb\u79d2\u6570\u8d4b\u503c\u7ed9timestamp\u5e76\u4fdd\u5b58\u5728start\u4e2d\uff0c\u7136\u540eprogress=0\uff0c\u5143\u7d20\u4fdd\u6301\u4e0d\u52a8\uff0c\u5e76\u8c03\u7528",(0,l.kt)("inlineCode",{parentName:"p"},"window.requestAnimationFrame(step)"),"\u5728\u6d4f\u89c8\u5668\u4e0b\u6b21\u91cd\u7ed8\u4e4b\u524d\u7ee7\u7eed\u66f4\u65b0\u4e0b\u4e00\u5e27\u52a8\u753b\u3002\u5047\u8bbe\u5237\u65b0\u9891\u7387\u4e3a\u6bcf\u79d260\u6b21\uff0c\u56e0\u6b64\u5927\u7ea616.6ms\u4e4b\u540e\u5237\u65b0\u4e0b\u4e00\u6b21\uff0c\u6267\u884c\u4e0b\u4e00\u5e27\u52a8\u753b\uff0c\u6b64\u65f6\u4f20\u5165step\u4e2d\u7684timestamp = performance.now() = 16.6\uff0cprogress = 16.6\uff0c\u5143\u7d20\u5411\u5de6\u79fb\u52a816.6px\u3002\u8fd9\u6837\u5faa\u73af\u4e0b\u53bb\uff0c",(0,l.kt)("inlineCode",{parentName:"p"},"progress > 2000"),"\u505c\u6b62\u6267\u884c\u8be5\u52a8\u753b\u3002"),(0,l.kt)("h3",{id:"windowcancelanimationframe"},(0,l.kt)("a",{parentName:"h3",href:"https://developer.mozilla.org/zh-CN/docs/Web/API/Window/cancelAnimationFrame"},"window.cancelAnimationFrame")),(0,l.kt)("p",null,"\u53d6\u6d88\u4e00\u4e2a\u5148\u524d\u901a\u8fc7\u8c03\u7528window.requestAnimationFrame()\u65b9\u6cd5\u6dfb\u52a0\u5230\u8ba1\u5212\u4e2d\u7684\u52a8\u753b\u5e27\u8bf7\u6c42\u3002"),(0,l.kt)("h1",{id:"\u4e00\u4e9b\u5de5\u5177\u51fd\u6570"},"\u4e00\u4e9b\u5de5\u5177\u51fd\u6570"),(0,l.kt)("h3",{id:"getcurrenttime"},"getCurrentTime"),(0,l.kt)("p",null,"\u6ce8\u610f",(0,l.kt)("a",{parentName:"p",href:"https://developer.mozilla.org/en-US/docs/Web/API/DOMHighResTimeStamp#The_time_origin"},"window.performance.now()"),"\u8fd4\u56de\u7684\u662f\u4e00\u4e2a\u4ee5\u6beb\u79d2\u4e3a\u5355\u4f4d\u7684\u6570\u503c\uff0c\u8868\u793a\u4ece\u6253\u5f00\u5f53\u524d\u6587\u6863\u5230\u8be5\u547d\u4ee4\u6267\u884c\u7684\u65f6\u5019\u7ecf\u5386\u7684\u6beb\u79d2\u6570\u3002Date.now()\u65b9\u6cd5\u8fd4\u56de\u81ea1970\u5e741\u67081\u65e5 00:00:00 UTC\u5230\u5f53\u524d\u65f6\u95f4\u7684\u6beb\u79d2\u6570\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"var getCurrentTime; \nvar localDate = Date;\n\nif (hasNativePerformanceNow) {\n  var Performance = performance;\n  getCurrentTime = function() {\n    return Performance.now();\n  };\n} else {\n  getCurrentTime = function() {\n    return localDate.now();\n  };\n}\n")),(0,l.kt)("h3",{id:"requestanimationframewithtimeout"},"requestAnimationFrameWithTimeout"),(0,l.kt)("p",null,"\u4e3a\u4e86\u63d0\u9ad8\u6027\u80fd\u548c\u7535\u6c60\u5bff\u547d\uff0c\u5728\u5927\u591a\u6570\u6d4f\u89c8\u5668\u91cc\uff0c\u5f53",(0,l.kt)("inlineCode",{parentName:"p"},"requestAnimationFrame()")," \u8fd0\u884c\u5728\u540e\u53f0\u6807\u7b7e\u9875\u6216\u8005\u9690\u85cf\u7684",(0,l.kt)("inlineCode",{parentName:"p"},"<iframe>")," \u91cc\u65f6\uff0c",(0,l.kt)("inlineCode",{parentName:"p"},"requestAnimationFrame()")," \u4f1a\u88ab\u6682\u505c\u8c03\u7528\u4ee5\u63d0\u5347\u6027\u80fd\u548c\u7535\u6c60\u5bff\u547d\u3002\u4f46\u662freact\u5e0c\u671b\u5728\u540e\u53f0\u8fd0\u884c\u7684\u65f6\u5019\u4e5f\u80fd\u7ee7\u7eed\u5de5\u4f5c\uff0c\u6240\u4ee5\u5c01\u88c5\u4e86requestAnimationFrameWithTimeout\u6765\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u3002"),(0,l.kt)("p",null,"requestAnimationFrameWithTimeout\u7684\u539f\u7406\u662f\u8fd0\u884c\u5728\u540e\u53f0\u7684\u65f6\u5019\uff0c\u8c03\u7528window.cancelAnimationFrame\u53d6\u6d88requestAnimationFrame()\uff0c\u5229\u7528\u5b9a\u65f6\u5668\u6765\u6267\u884ccallback\uff1b\u800c\u5728\u8c03\u7528requestAnimationFrame\u7684\u65f6\u5019\uff0c\u6e05\u9664\u5b9a\u65f6\u5668\uff0c\u6267\u884ccallback"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"var localRequestAnimationFrame =\n    typeof requestAnimationFrame === 'function'\n    ? requestAnimationFrame\n    : undefined;\nvar localCancelAnimationFrame =\n    typeof cancelAnimationFrame === 'function' ? cancelAnimationFrame : undefined;\nvar localSetTimeout = typeof setTimeout === 'function' ? setTimeout :   undefined;\nvar localClearTimeout =\n    typeof clearTimeout === 'function' ? clearTimeout : undefined;\n\n\nvar ANIMATION_FRAME_TIMEOUT = 100;\nvar rAFID;\nvar rAFTimeoutID;\nvar requestAnimationFrameWithTimeout = function(callback) {\n  //\u5728\u8c03\u7528requestAnimationFrame\u7684\u65f6\u5019\uff0c\u6e05\u9664\u5b9a\u65f6\u5668\n  rAFID = localRequestAnimationFrame(function(timestamp) {\n    // cancel the setTimeout\n    localClearTimeout(rAFTimeoutID);\n    callback(timestamp);\n  });\n  //\u5728\u8f6c\u5230\u540e\u53f0\u7684\u65f6\u5019\uff0c\u4f7f\u7528\u5b9a\u65f6\u5668\u6267\u884c\u56de\u8c03\u51fd\u6570\n  rAFTimeoutID = localSetTimeout(function() {\n    // cancel the requestAnimationFrame\n    localCancelAnimationFrame(rAFID);\n    callback(getCurrentTime());\n  }, ANIMATION_FRAME_TIMEOUT);\n};\n")),(0,l.kt)("h1",{id:"\u4e3b\u903b\u8f91\u5229\u7528message\u4e8b\u4ef6\u4e0erequestanimationframe\u8fdb\u884c\u8c03\u5ea6"},"\u4e3b\u903b\u8f91\uff1a\u5229\u7528Message\u4e8b\u4ef6\u4e0erequestAnimationFrame\u8fdb\u884c\u8c03\u5ea6"),(0,l.kt)("h3",{id:"\u5173\u952e\u53d8\u91cf"},"\u5173\u952e\u53d8\u91cf"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"  // scheduledHostCallback\u4e3a\u4efb\u52a1\u961f\u5217\u6267\u884c\u5668\uff0c\u5b58\u5728\u8868\u793a\u6709\u4efb\u52a1\u9700\u8981\u6267\u884c\uff0c\u4e0d\u5b58\u5728\u8868\u793a\u4efb\u52a1\u961f\u5217\u4e3a\u7a7a\uff0c\n  // \u5728requestHostCallback\u4e2d\u8bbe\u7f6e\u4e3a\u67d0\u4e2acallback\n  var scheduledHostCallback = null;\n\n  var isMessageEventScheduled = false; //\u662f\u5426\u662f\u5426\u5b89\u6392\u4e86Message\u4e8b\u4ef6\u7684\u6807\u8bb0\uff0canimationTick\u4e2d\u6267\u884cpostMessage\u4e4b\u524d\u5c06\u5176\u7f6e\u4e3atrue\uff0c\u53ea\u6709\u5728\u6267\u884c\u4e86Message\u56de\u8c03\u51fd\u6570idleTick\u4e2d\u4ee5\u53ca\u7528\u4e8e\u53d6\u6d88\u4efb\u52a1\u7684cancelHostCallback\u51fd\u6570\u4e2d\u4e2d\u624d\u4f1a\u5c06\u5176\u7f6e\u4e3afalse\u3002\n  var timeoutTime = -1; //\u4ee3\u8868\u6700\u9ad8\u4f18\u5148\u7ea7\u4efb\u52a1firstCallbackNode\u7684\u8fc7\u671f\u65f6\u95f4\n\n  var isAnimationFrameScheduled = false;//\u7528\u4e8e\u6807\u8bb0\u662f\u5426\u5df2\u7ecf\u6267\u884c\u4e86requestAnimationFrameWithTimeout\n\n  var isFlushingHostCallback = false;//\u6807\u8bb0\u6b63\u5728\u6267\u884c\u4efb\u52a1\u6267\u884c\u5668\uff0c\u8be5\u6807\u8bb0\u76f8\u5f53\u4e8e\u4e00\u4e2a\u9501\u3002\u4f5c\u7528\u662fisFlushingHostCallback\u53c2\u4e0e\u51b3\u5b9a\u662f\u5426\u5141\u8bb8postMessage\n\n  var frameDeadline = 0; //\u5f53\u524d\u5e27\u622a\u6b62\u65f6\u95f4\n\n  var previousFrameTime = 33; // \u7528\u4e8e\u4fdd\u5b58\u4e0a\u4e00\u5e27\u7684\u65f6\u95f4\n  var activeFrameTime = 33; // \u4e00\u5e27\u7684\u6e32\u67d3\u65f6\u95f433ms\uff0c\u8fd9\u91cc\u5047\u8bbe 1s 30\u5e27\n  \n  //\u5b89\u5168\u68c0\u67e5\n  var messageKey =\n    '__reactIdleCallback$' +\n    Math.random()\n      .toString(36)\n      .slice(2);\n")),(0,l.kt)("h3",{id:"\u76d1\u542cmessage\u4e8b\u4ef6"},"\u76d1\u542cMessage\u4e8b\u4ef6"),(0,l.kt)("p",null,"\u76d1\u542cMessage\u4e8b\u4ef6\uff0c\u4f20\u5165\u56de\u8c03\u51fd\u6570\uff0c\u4e0d\u5141\u8bb8\u6355\u83b7\u9636\u6bb5\u89e6\u53d1\u3002idleTick\u662f\u7528\u4e8e\u5728\u76d1\u542c\u5230Message\u4e8b\u4ef6\u89e6\u53d1\u7684\u65f6\u5019\u6267\u884c\u7684\u56de\u8c03\u51fd\u6570\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"window.addEventListener('message', idleTick, false);\n")),(0,l.kt)("h3",{id:"\u76d1\u542cmessage\u4e8b\u4ef6\u4f20\u5165\u7684\u56de\u8c03\u51fd\u6570idletick"},"\u76d1\u542cMessage\u4e8b\u4ef6\u4f20\u5165\u7684\u56de\u8c03\u51fd\u6570idleTick"),(0,l.kt)("p",null,"idleTick\u6d41\u7a0b\u5982\u4e0b\uff1a"),(0,l.kt)("p",null,"1\u3001\u901a\u8fc7\u5c06\u5f53\u524d\u5e27\u622a\u6b62\u65f6\u95f4\u4e0e\u5f53\u524d\u65f6\u95f4\u5bf9\u6bd4\uff0c\u5224\u65ad\u5f53\u524d\u5e27\u662f\u5426\u6709\u7a7a\u4f59\u65f6\u95f4\u6267\u884c\u4efb\u52a1\uff0c\u5982\u679c\u6709\u5219\u5230\u6b65\u9aa43\u3002"),(0,l.kt)("p",null,"2\u3001\u5224\u65ad\u4efb\u52a1\u961f\u5217\u6700\u5c0f\u7684\u5230\u671f\u65f6\u95f4\u5c0f\u4e8e\u5f53\u524d\u65f6\u95f4\uff0c\u5982\u679c\u662f\uff0c\u8bf4\u660e\u5df2\u7ecf\u8fc7\u671f\uff0c\u5c06didTimeout\u6807\u5fd7\u7f6e\u4e3atrue\uff0c\u6267\u884c\u7b2c3\u6b65\u3002\u5982\u679c\u8fd8\u6ca1\u6709\u8fc7\u671f\uff0c\u5e76\u4e14\u6ca1\u6709\u8c03\u7528requestAnimationFrameWithTimeout\u6765\u8bbe\u7f6e\u5728\u51fa\u73b0\u4e4b\u540e\u7acb\u9a6c\u6267\u884canimationTick\u51fd\u6570\uff0c\u5219\u8c03\u7528requestAnimationFrameWithTimeout\u3002\u5982\u679c\u5df2\u7ecf\u8bbe\u7f6e\u8fc7\u4e86\uff0c\u5c31\u8fd8\u539f\u4efb\u52a1\u961f\u5217\u4e0e\u5230\u671f\u65f6\u95f4\u5e76\u8fd4\u56de\u3002"),(0,l.kt)("p",null,"3\u3001\u5982\u679c\u4efb\u52a1\u6267\u884c\u5668\u5b58\u5728\uff0c",(0,l.kt)("inlineCode",{parentName:"p"},"isFlushingHostCallback = true"),"\u6807\u8bb0\u6b63\u5728\u6267\u884c\u4efb\u52a1\u6267\u884c\u5668\uff0c\u7136\u540e\u6267\u884c\u4efb\u52a1\u6267\u884c\u5668\u4e2d\u7684\u903b\u8f91prevScheduledCallback(didTimeout)\uff0c\u6700\u540e",(0,l.kt)("inlineCode",{parentName:"p"},"isFlushingHostCallback = false"),"\u6807\u8bb0\u6ca1\u6709\u6b63\u5728\u6267\u884c\u4efb\u52a1\u6267\u884c\u5668\u3002\u5176\u4e2disFlushingHostCallback\u4f5c\u7528\u662f\u53c2\u4e0e\u51b3\u5b9a\u662f\u5426\u5141\u8bb8postMessage\u3002\u8be5\u6807\u8bb0\u5728requestHostCallback\u4e2d\u4f1a\u89c1\u5230\uff0c\u4e0e\u8be5\u51fd\u6570\u4f20\u5165\u7684absoluteTimeout\u4e00\u8d77\u51b3\u5b9a\u662f\u5426window.postMessage(messageKey, '*');\uff08\u6b64\u6b65\u9aa4\u5982\u679c\u7b2c1\u6b65\u6765\u7684\uff0cdidTimeout\u4e3afalse\uff0c\u7b2c2\u6b65\u6765\u7684\uff0c\u5219\u4e3atrue\uff0c\u8868\u793a\u4efb\u52a1\u961f\u5217\u7684\u4efb\u52a1\u6700\u5c0f\u7684\u5230\u671f\u65f6\u95f4\u5bf9\u5e94\u7684\u4efb\u52a1\u5df2\u7ecf\u8fc7\u671f\u4e86\u3002\uff09"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"  var idleTick = function(event) {\n    if (event.source !== window || event.data !== messageKey) {\n      return;\n    }\n\n    isMessageEventScheduled = false;  //animationTick\u4e2d\u6267\u884cpostMessage\u4e4b\u524d\u5c06\u5176\u7f6e\u4e3atrue\uff0c\u53ea\u6709\u5728\u6267\u884c\u4e86Message\u56de\u8c03\u51fd\u6570idleTick\u4e2d\u624d\u4f1a\u5c06\u5176\u7f6e\u4e3afalse\u3002\n\n    var prevScheduledCallback = scheduledHostCallback;\n    var prevTimeoutTime = timeoutTime;\n    //\u7f6e\u7a7a\u4efb\u52a1\u961f\u5217\u6267\u884c\u5668\u4ee5\u53ca\u961f\u5217\u4e2dfirstNode\u4e2d\u7684\u6700\u5c0f\u7684\u5230\u671f\u65f6\u95f4\n    scheduledHostCallback = null;\n    timeoutTime = -1;\n\n    //\u83b7\u53d6\u5f53\u524d\u65f6\u95f4\n    var currentTime = getCurrentTime();\n\n    //\u6807\u8bb0\u4efb\u52a1\u961f\u5217\u6700\u5c0f\u7684\u5230\u671f\u65f6\u95f4\u7684\u8282\u70b9\u4ee5\u53ca\u5f53\u524d\u5e27\u622a\u6b62\u65f6\u95f4\u662f\u5426\u8fc7\u671f\n    var didTimeout = false;\n    if (frameDeadline - currentTime <= 0) {\n      // frameDeadline\u8868\u793a\u5f53\u524d\u5e27\u622a\u6b62\u65f6\u95f4\n      // currentTime \u8868\u793a\u5f53\u524d\u65f6\u523b\n      // \u5982\u679c\u5f53\u524d\u65f6\u523b\u5927\u4e8eframeDeadline\uff0c\u8bf4\u660e\u53d1\u751f\u4e86\u963b\u585e\uff0c\u5df2\u7ecf\u4e22\u5931\u4e86\u4e00\u5e27\n      //  \u5982\u679c\u5c0f\u4e8e\uff0c\u8bf4\u660e\u5f53\u524d\u5e27\u6ca1\u6709\u7a7a\u95f2\u65f6\u95f4\uff0c\n      // There's no time left in this idle period. Check if the callback has\n      // a timeout and whether it's been exceeded.\n      if (prevTimeoutTime !== -1 && prevTimeoutTime <= currentTime) {\n        //\u4efb\u52a1\u961f\u5217\u6700\u5c0f\u7684\u5230\u671f\u65f6\u95f4\u5c0f\u4e8e\u5f53\u524d\u65f6\u95f4\uff0c\u8bf4\u660e\u5df2\u7ecf\u8fc7\u671f\uff0c\u5c06\u5176\u6807\u5fd7\u7f6e\u4e3atrue\n        // Exceeded the timeout. Invoke the callback even though there's no\n        // time left.\n        didTimeout = true;\n      } else {\n        //\u5982\u679c\u6ca1\u6709\u8fc7\u671f\n        // No timeout.\n        if (!isAnimationFrameScheduled) {\n          //\u6ca1\u6709\u8bbe\u7f6erequestAnimationFrameWithTimeout\uff0c\u5c06\u5176\u6807\u5fd7isAnimationFrameScheduled\u7f6e\u4e3atrue\n          //\u5e76\u8c03\u7528requestAnimationFrameWithTimeout\n          // Schedule another animation callback so we retry later.\n          isAnimationFrameScheduled = true;\n          requestAnimationFrameWithTimeout(animationTick);\n        }\n        // Exit without invoking the callback.\n        //  \u6062\u590d\u4efb\u52a1\u961f\u5217\u4e0e\u5230\u671f\u65f6\u95f4\u5e76\u8fd4\u56de\n        scheduledHostCallback = prevScheduledCallback;\n        timeoutTime = prevTimeoutTime;\n        return;\n      }\n    }\n\n    //\u5982\u679c\u5f53\u524d\u5e27\u8fd8\u6709\u7a7a\u95f2\u65f6\u95f4\uff0c\u5c31\u6267\u884c\u6267\u884c\u5668\uff0c\u6b64\u65f6\u6267\u884c\u5668\u4e2d\u7684didTimeout=false\uff0c\u8868\u793a\u6ca1\u6709\u8fc7\u671f\uff08\u6b64\u5904\u6709\u7591\u95ee\uff0c\u96be\u9053\u80fd\u786e\u4fdd\u6700\u5c0f\u5230\u671f\u65f6\u95f4\u5c0f\u4e8e\u5f53\u524d\u65f6\u95f4\uff1f\uff09\n    //\u5982\u679c\u5f53\u524d\u961f\u5217\u4e2d\u6700\u5c0f\u7684\u5230\u671f\u65f6\u95f4\u5df2\u7ecf\u8fc7\u671f\u4e86\uff0c\u5c31\u8bf4\u660e\u5e94\u8be5\u7acb\u5373\u6267\u884c\u961f\u5217\u4e2d\u7684\u8be5\u4efb\u52a1\n    if (prevScheduledCallback !== null) {\n      //\u6807\u8bb0\u6b63\u5728\u6267\u884c\u4efb\u52a1\u6267\u884c\u5668\uff0c\u8be5\u6807\u8bb0\u76f8\u5f53\u4e8e\u4e00\u4e2a\u9501\u3002\u4f5c\u7528\u662fisFlushingHostCallback\u53c2\u4e0e\u51b3\u5b9a\u662f\u5426\u5141\u8bb8postMessage\n      isFlushingHostCallback = true;\n      try {\n        //\u6267\u884c\u4efb\u52a1\u6267\u884c\u5668\u4e2d\u7684\u903b\u8f91\n        prevScheduledCallback(didTimeout);\n      } finally {\n        //\u6267\u884c\u5b8c\u4e4b\u540e\u7f6e\u4e3afalse\n        isFlushingHostCallback = false;\n      }\n    }\n  };\n")),(0,l.kt)("h3",{id:"animation-frame-fired\u7684\u56de\u8c03\u51fd\u6570animationtick"},"animation frame fired\u7684\u56de\u8c03\u51fd\u6570animationTick"),(0,l.kt)("p",null,"\u56de\u8c03\u51fd\u6570idleTick\u4e2d\u5728\u4e0d\u7acb\u5373\u6267\u884c\u4efb\u52a1\u6267\u884c\u5668\u7684\u65f6\u5019\uff0c\u5e76\u4e14\u6ca1\u6709\u8bbe\u7f6eanimationTick\u56de\u8c03\uff0c\u5219\u4f1a\u6267\u884crequestAnimationFrameWithTimeout(animationTick)\u5e76\u9000\u51fa\uff0c\u5176\u4e2danimationTick\u7684\u4f5c\u7528\u5982\u4e0b\uff1a"),(0,l.kt)("p",null,"1\u3001\u5982\u679c\u4efb\u52a1\u6267\u884c\u5668\u4e0d\u4e3a\u7a7a\uff0c\u5219\u5728\u4e0b\u4e00\u5e27\u7ee7\u7eed\u6267\u884canimationTick\u56de\u8c03\u51fd\u6570\uff0c\u5e76\u5230\u7b2c2\u6b65\u3002\u5982\u679c\u4efb\u52a1\u6267\u884c\u5668\u4e3a\u7a7a\uff0c\u8868\u660e\u6ca1\u6709\u4efb\u52a1\u9700\u8981\u5728\u7a7a\u95f2\u65f6\u95f4\u91cc\u6267\u884c\u4e86\uff0c\u5c06isAnimationFrameScheduled\u6807\u5fd7\u7f6e\u4e3afalse\uff0c\u8868\u793a\u6ca1\u6709\u8bbe\u7f6eanimationTick\uff0c\u7136\u540e\u76f4\u63a5\u8fd4\u56de\u3002\n2\u3001\u52a8\u6001\u8c03\u6574\u6e32\u67d3\u4e00\u5e27\u7684\u65f6\u95f4\uff0c\u5e76\u8ba1\u7b97\u51fa\u5f53\u524d\u5e27\u622a\u6b62\u65f6\u95f4\u4e3a\u5f53\u524d\u65f6\u95f4 + \u8c03\u6574\u540e\u7684\u65f6\u95f4\u95f4\u9694\n3\u3001\u6839\u636eisMessageEventScheduled\u5224\u65ad\u662f\u5426\u6267\u884cpostMessage\uff0c\u907f\u514d\u6253\u65ad\u4e4b\u524d\u5b89\u6392\u7684Message\u65f6\u95f4\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"var animationTick = function(rafTime) {\n    if (scheduledHostCallback !== null) {\n      //\u5982\u679c\u4efb\u52a1\u6267\u884c\u5668\u4e0d\u4e3a\u7a7a\uff0c\u5219\u5728\u4e0b\u4e00\u5e27\u7ee7\u7eed\u6267\u884canimationTick\u56de\u8c03\u51fd\u6570\n      requestAnimationFrameWithTimeout(animationTick);\n    } else {\n      // \u5982\u679c\u6ca1\u6709\u4efb\u52a1\u9700\u8981\u6267\u884c\uff0c\u76f4\u63a5\u8fd4\u56de\uff0c\n      isAnimationFrameScheduled = false; //\u4ee3\u8868\u6ca1\u6709\u4efb\u52a1\u9700\u8981AnimationFrame\u6267\u884c\n      return;\n    }\n\n    //\u7ecf\u8fc7\u51e0\u6b21\u5c4f\u5e55\u5237\u65b0\u4e4b\u540e\uff0c\u52a8\u6001\u8ba1\u7b97\u51fa\u6b63\u786e\u7684\u5237\u65b0\u9891\u7387\n    //  \u4e0b\u4e00\u5e27\u7684\u65f6\u95f4 = \u5f53\u524d\u65f6\u95f4 - \u5f53\u524d\u5e27\u622a\u6b62\u65f6\u95f4 + \u65f6\u95f4\u95f4\u9694\n    //  \u5982\u679c\u6d4f\u89c8\u5668\u5237\u65b0\u9891\u7387\u521a\u597d\u662f30hz\uff0c\u5219nextFrameTime\u4e3a0\n    //  \u5982\u679c\u5237\u65b0\u9891\u7387\u9ad8\u4e8e30hz\uff0c\n    var nextFrameTime = rafTime - frameDeadline + activeFrameTime;\n    if (\n      nextFrameTime < activeFrameTime &&\n      previousFrameTime < activeFrameTime\n    ) {\n      if (nextFrameTime < 8) {\n        nextFrameTime = 8;\n      }\n      activeFrameTime =\n        nextFrameTime < previousFrameTime ? previousFrameTime : nextFrameTime;\n    } else {\n      previousFrameTime = nextFrameTime;\n    }\n    //\u5f53\u524d\u5e27\u622a\u6b62\u65f6\u95f4 = \u5f53\u524d\u65f6\u95f4 + \u8c03\u6574\u540e\u7684\u65f6\u95f4\u95f4\u9694\n    frameDeadline = rafTime + activeFrameTime;\n        if (!isMessageEventScheduled) {\n      isMessageEventScheduled = true;//\u6807\u8bb0\u5df2\u7ecf\u6267\u884c\u4e86postMessage\n      window.postMessage(messageKey, '*');\n    }\n  };\n")),(0,l.kt)("h2",{id:"\u4efb\u52a1\u6267\u884c\u5668\u5bf9postmessage\u4e0erequestanimationframewithtimeout\u884c\u4e3a\u8c03\u5ea6\u7684\u5173\u952e\u51fd\u6570"},"\u4efb\u52a1\u6267\u884c\u5668\u5bf9postMessage\u4e0erequestAnimationFrameWithTimeout\u884c\u4e3a\u8c03\u5ea6\u7684\u5173\u952e\u51fd\u6570"),(0,l.kt)("p",null,"\u4efb\u52a1\u6267\u884c\u5668\u5728\u67d0\u4e9b\u6761\u4ef6\u4e0b\u4f1a\u8c03\u7528\u4e00\u4e0b\u4e09\u4e2a\u51fd\u6570\u6765\u53d1\u8d77postMessage\u6216\u8005requestAnimationFrameWithTimeout\u5bf9\u7a7a\u95f2\u65f6\u95f4\u5185\u4efb\u52a1\u6267\u884c\u5668\u7684\u6267\u884c\u8fdb\u884c\u8c03\u5ea6\u4e0e\u63a7\u5236\u3002\u5176\u4e2d\u4efb\u52a1\u6267\u884c\u5668\u4f1a\u901a\u8fc7\u8c03\u7528ensureHostCallbackIsScheduled\u51fd\u6570\u6765\u51b3\u5b9a\u662f\u8c03\u7528\u5426\u8c03\u7528cancelHostCallback\u6765\u6e05\u7a7a\u6267\u884c\u5668\uff0c\u5230\u671f\u65f6\u95f4\u4ee5\u53ca\u662f\u5426\u662f\u5426\u5b89\u6392\u4e86Message\u4e8b\u4ef6\u7684\u6807\u8bb0\uff1b\u6700\u540e\u4f1a\u8c03\u7528requestHostCallback\u6765\u91cd\u65b0\u8bbe\u7f6e\u4efb\u52a1\u6267\u884c\u5668\uff0c\u5e76\u7acb\u5373\u6267\u884c\u4efb\u52a1\u6216\u8005\u7a0d\u540e\u6267\u884c\u4efb\u52a1\u3002"),(0,l.kt)("h3",{id:"\u88ab\u4efb\u52a1\u6267\u884c\u5668\u8c03\u7528\u4ee5\u83b7\u53d6\u5f53\u524d\u5e27\u662f\u5426\u8fc7\u671f\u7684\u51fd\u6570shouldyieldtohost"},"\u88ab\u4efb\u52a1\u6267\u884c\u5668\u8c03\u7528\u4ee5\u83b7\u53d6\u5f53\u524d\u5e27\u662f\u5426\u8fc7\u671f\u7684\u51fd\u6570\uff1ashouldYieldToHost"),(0,l.kt)("p",null,"shouldYieldToHost\u8fd4\u56de\u5f53\u524d\u5e27\u662f\u5426\u8fc7\u671f\uff0c\u5982\u679c\u5f53\u524d\u5e27\u622a\u6b62\u65f6\u95f4\u5c0f\u4e8e\u5f53\u524d\u65f6\u95f4\u8bf4\u660e\u5f53\u524d\u5e27\u8fc7\u671f\u4e86\uff0c\u6ca1\u6709\u7a7a\u95f2\u65f6\u95f4\u4e86\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"    var frameDeadline = 0;\n    shouldYieldToHost = function() {\n        return frameDeadline <= getCurrentTime();\n    };\n")),(0,l.kt)("h3",{id:"\u88ab\u4efb\u52a1\u6267\u884c\u5668\u8c03\u7528\u4ee5\u63a7\u5236postmessage\u884c\u4e3a\u7684\u51fd\u6570cancelhostcallback"},"\u88ab\u4efb\u52a1\u6267\u884c\u5668\u8c03\u7528\u4ee5\u63a7\u5236postMessage\u884c\u4e3a\u7684\u51fd\u6570\uff1acancelHostCallback"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"  //\u6e05\u9664\u6267\u884c\u5668\uff0c\u5230\u671f\u65f6\u95f4\u4ee5\u53ca\u662f\u5426\u662f\u5426\u5b89\u6392\u4e86Message\u4e8b\u4ef6\u7684\u6807\u8bb0\n  cancelHostCallback = function() {\n    scheduledHostCallback = null;\n    isMessageEventScheduled = false;\n    timeoutTime = -1;\n  };\n")),(0,l.kt)("h3",{id:"\u88ab\u4efb\u52a1\u6267\u884c\u5668\u8c03\u7528\u4ee5\u91cd\u65b0\u8bbe\u7f6e\u6267\u884c\u5668\u63a7\u5236postmessage\u4e0erequestanimationframewithtimeout\u884c\u4e3a\u7684\u51fd\u6570requesthostcallback"},"\u88ab\u4efb\u52a1\u6267\u884c\u5668\u8c03\u7528\u4ee5\u91cd\u65b0\u8bbe\u7f6e\u6267\u884c\u5668\u63a7\u5236postMessage\u4e0erequestAnimationFrameWithTimeout\u884c\u4e3a\u7684\u51fd\u6570\uff1arequestHostCallback"),(0,l.kt)("p",null,"requestHostCallback\u51fd\u6570\u7528\u4e8e\u8bbe\u7f6e\u4efb\u52a1\u6267\u884c\u5668\uff0c\u4e0e\u5230\u671f\u65f6\u95f4\uff0c\u8be5\u51fd\u6570\u53ef\u4ee5\u91cd\u65b0\u8fd0\u884c\u4e00\u4e2a\u65b0\u7684\u4efb\u52a1\u6267\u884c\u5668\u3002\u5176\u903b\u8f91\u662f\uff1a\u5982\u679c\u901a\u8fc7\u8be5\u51fd\u6570\u8bbe\u7f6e\u4e86\u4efb\u52a1\u6267\u884c\u5668\uff0c\u5e76\u8bbe\u5b9a\u4e86\u65b0\u7684\u5230\u671f\u65f6\u95f4\uff0c\u6839\u636eisFlushingHostCallback\u8868\u793a\u7684\u662f\u5426\u6709\u4efb\u52a1\u6267\u884c\u5668\u6b63\u5728\u6267\u884c\u7684\u6807\u8bb0\u4ee5\u53ca\u5230\u671f\u65f6\u95f4\uff0c\u5904\u7406\u4efb\u52a1\u6267\u884c\u5668\u662f\u7acb\u5373\u6267\u884c\u8fd8\u662f\u5728\u4e0b\u4e00\u5e27\u8fdb\u884c\u8c03\u5ea6\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"  requestHostCallback = function(callback, absoluteTimeout) {\n    //\u7ed9scheduledHostCallback\u4efb\u52a1\u6267\u884c\u5668\u8bbe\u7f6e\u76f8\u5e94\u7684\u6267\u884c\u903b\u8f91\n    scheduledHostCallback = callback;\n    //\u8bbe\u5b9a\u5230\u671f\u65f6\u95f4\n    timeoutTime = absoluteTimeout;\n    if (isFlushingHostCallback || absoluteTimeout < 0) {\n      //\u7acb\u5373\u6267\u884c\uff0c\u901a\u8fc7postMessage\u89e6\u53d1Message\u4e8b\u4ef6\uff0c\u5728idleTick\u4e2d\u6267\u884c\u6267\u884c\u5668\u4e2d\u7684\u903b\u8f91\u5373callback\n      // Don't wait for the next frame. Continue working ASAP, in a new event.\n      window.postMessage(messageKey, '*');\n    } else if (!isAnimationFrameScheduled) {\n      //\u5982\u679c\u4e0d\u662f\u7acb\u5373\u6267\u884c\uff0c\u5e76\u4e14\u8fd8\u6ca1\u6709\u6267\u884crequestAnimationFrameWithTimeout\u8bbe\u7f6e\u4e0b\u4e00\u5e27\u5237\u65b0\u65f6\u7684\u52a8\u4f5c\n      //\u90a3\u4e48\u8bbe\u7f6eisAnimationFrameScheduled\u6807\u8bb0\uff0c\u5e76requestAnimationFrameWithTimeout\n      // If rAF didn't already schedule one, we need to schedule a frame.\n      // TODO: If this rAF doesn't materialize because the browser throttles, we\n      // might want to still have setTimeout trigger rIC as a backup to ensure\n      // that we keep performing work.\n      isAnimationFrameScheduled = true;\n      requestAnimationFrameWithTimeout(animationTick);\n    }\n  };\n")),(0,l.kt)("h1",{id:"\u4efb\u52a1\u6267\u884c\u5668flushwork"},"\u4efb\u52a1\u6267\u884c\u5668flushWork"),(0,l.kt)("h3",{id:"\u5de5\u5177\u51fd\u6570ensurehostcallbackisscheduled"},"\u5de5\u5177\u51fd\u6570ensureHostCallbackIsScheduled"),(0,l.kt)("p",null,"\u5982\u679c\u5f53\u524d\u6b63\u5728\u6267\u884c\u6700\u9ad8\u4f18\u5148\u7ea7\u7684\u56de\u8c03\u51fd\u6570\uff0c\u5219\u8fd4\u56de\u3002\u5426\u5219\uff0c\u6e05\u7a7a\u5f53\u524d\u7a7a\u95f2\u65f6\u95f4\u5b89\u6392\u7684\u4efb\u52a1\u961f\u5217\uff0c\u91cd\u65b0\u8bbe\u7f6e\u4efb\u52a1\u6267\u884c\u5668\uff0c\u5e76\u5728requestHostCallback\u51fd\u6570\u4e2d\u8c03\u7528postMessage\u89e6\u53d1Message\u4e8b\u4ef6\n\uff0c\u5728\u56de\u8c03\u51fd\u6570idleTick\u4e2d\u7acb\u5373\u6267\u884c\u4efb\u52a1\u6267\u884c\u5668\u6216\u8005\u6267\u884crequestAnimationFrameWithTimeout\u5c06\u4efb\u52a1\u6267\u884c\u5668\u7684\u6267\u884c\u4e0e\u5426\u653e\u5230\u4e0b\u4e00\u5e27\u6765\u5224\u65ad"),(0,l.kt)("p",null,"\u6d41\u7a0b\uff1a"),(0,l.kt)("p",null,"1\u3001\u901a\u8fc7isExecutingCallback\u6807\u8bb0\u5224\u65ad\u662f\u5426\u6b63\u5728\u6267\u884c\u6700\u9ad8\u4f18\u5148\u7ea7\u7684\u56de\u8c03\u51fd\u6570\uff0c\u5982\u679c\u662f\u7684\uff0c\u76f4\u63a5\u8fd4\u56de\u3002\u5982\u679c\u4e0d\u662f\u7ee7\u7eed\u6267\u884c\u7b2c2\u6b65"),(0,l.kt)("p",null,"2\u3001\u83b7\u53d6\u6700\u5c0f\u7684\u5230\u671f\u65f6\u95f4\uff0c\u5373\u53cc\u5411\u94fe\u8868\u7b2c\u4e00\u4e2a\u8282\u70b9\u7684\u5230\u671f\u65f6\u95f4\u3002\u6839\u636eisHostCallbackScheduled\u6807\u8bb0\u6765\u5224\u65ad\u5e27\u4e0e\u5e27\u4e4b\u95f4\u7684\u65f6\u95f4\u95f4\u9694\u5373\u7a7a\u95f2\u65f6\u95f4\u662f\u5426\u5b89\u6392\u4e86\u56de\u8c03\u51fd\u6570\uff08fasle\u8868\u793a\u6ca1\u6709\u5b89\u6392\u56de\u8c03\u51fd\u6570\uff09\uff0c\u5982\u679c\u5b89\u6392\u4e86\u56de\u8c03\u51fd\u6570\uff0c\u90a3\u4e48\u9700\u8981\u8c03\u7528cancelHostCallback\u51fd\u6570\u6765\u6e05\u9664\u4efb\u52a1\u6267\u884c\u5668\uff0c\u5230\u671f\u65f6\u95f4\u4ee5\u53ca\u662f\u5426\u662f\u5426\u5b89\u6392\u4e86Message\u4e8b\u4ef6\u7684\u6807\u8bb0\u3002\u5426\u5219\u5c06isHostCallbackScheduled\u6807\u8bb0\u8bbe\u7f6e\u4e3atrue"),(0,l.kt)("p",null,"3\u3001\u6267\u884crequestHostCallback(flushWork, expirationTime)\uff0c\u4f20\u5165\u7b2c\u4e00\u4e2a\u8282\u70b9\u7684\u5230\u671f\u65f6\u95f4\uff0c\u91cd\u65b0\u8bbe\u7f6e\u4efb\u52a1\u6267\u884c\u5668\uff0c\u5e76\u7acb\u5373\u6267\u884c\u4efb\u52a1\u6216\u8005\u7a0d\u540e\u6267\u884c\u4efb\u52a1"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"function ensureHostCallbackIsScheduled() {\n  //\u662f\u5426\u6b63\u5728\u6267\u884c\u6700\u9ad8\u4f18\u5148\u7ea7\u7684\u56de\u8c03\u51fd\u6570\n  if (isExecutingCallback) {\n    // Don't schedule work yet; wait until the next time we yield.\n    return;\n  }\n  // Schedule the host callback using the earliest expiration in the list.\n  //  \u83b7\u53d6\u6700\u5c0f\u7684\u5230\u671f\u65f6\u95f4\n  var expirationTime = firstCallbackNode.expirationTime;\n  //\u5f53\u524d\u7a7a\u95f2\u65f6\u95f4\u8fd8\u6ca1\u6709\u5b89\u6392\u56de\u8c03\n  if (!isHostCallbackScheduled) {\n    //\u5c06\u6807\u5fd7\u7f6e\u4e3atrue\n    isHostCallbackScheduled = true;\n  } else {\n    //\u5982\u679c\u5df2\u7ecf\u5b89\u6392\u56de\u8c03\uff0c\u5219\u6e05\u9664\u4efb\u52a1\u6267\u884c\u5668\uff0c\u5230\u671f\u65f6\u95f4\u4ee5\u53ca\u662f\u5426\u662f\u5426\u5b89\u6392\u4e86Message\u4e8b\u4ef6\u7684\u6807\u8bb0\n    // Cancel the existing host callback.\n    cancelHostCallback();\n  }\n  //\u4f20\u5165\u7b2c\u4e00\u4e2a\u8282\u70b9\u7684\u5230\u671f\u65f6\u95f4\uff0c\u91cd\u65b0\u8bbe\u7f6e\u4efb\u52a1\u6267\u884c\u5668\uff0c\u5e76\u5728requestHostCallback\u51fd\u6570\u4e2d\u8c03\u7528postMessage\u89e6\u53d1Message\u4e8b\u4ef6\n  // \u5728\u56de\u8c03\u51fd\u6570idleTick\u4e2d\u7acb\u5373\u6267\u884c\u4efb\u52a1\u6267\u884c\u5668\u6216\u8005\u6267\u884crequestAnimationFrameWithTimeout\u5c06\u4efb\u52a1\u6267\u884c\u5668\u7684\u6267\u884c\u4e0e\u5426\u653e\u5230\u4e0b\u4e00\u5e27\u6765\u5224\u65ad\n  requestHostCallback(flushWork, expirationTime);\n}\n")),(0,l.kt)("h3",{id:"\u4efb\u52a1\u6267\u884c\u5668flushwork-1"},"\u4efb\u52a1\u6267\u884c\u5668flushWork"),(0,l.kt)("p",null,"\u4f20\u5165\u7684\u53c2\u6570didTimeout\u4e3atrue\uff0c\u8868\u793a\u4efb\u52a1\u961f\u5217\u6700\u5c0f\u5230\u671f\u65f6\u95f4\u5bf9\u5e94\u7684\u4efb\u52a1\u5df2\u7ecf\u8fc7\u671f\u4e86\uff0c\u9700\u8981\u7acb\u5373\u6267\u884c\n\u4e3afalse\uff0c\u8868\u793a\u5f53\u524d\u5e27\u6709\u7a7a\u4f59\u65f6\u95f4"),(0,l.kt)("p",null,"\u6d41\u7a0b\uff1a"),(0,l.kt)("p",null,"1\u3001\u5c06\u6b63\u5728\u6267\u884c\u56de\u8c03\u7684\u6807\u8bb0isExecutingCallback\u7f6e\u4e3atrue\uff0c\u4fdd\u5b58\u5f53\u524d\u7684\u8fc7\u671f\u6807\u5fd7\uff0c\u91cd\u65b0\u8bbe\u7f6e\u5f53\u524d\u7684\u8fc7\u671f\u6807\u5fd7\uff0c\u5982\u679c\u8fc7\u671f\u4e86\uff0c\u6267\u884c\u7b2c2\u6b65\uff1b\u5982\u679c\u6ca1\u6709\u8fc7\u671f\uff0c\u6267\u884c\u7b2c3\u6b65\u3002"),(0,l.kt)("p",null,"2\u3001\u4f9d\u6b21\u6267\u884cfirstCallbackNode\u4efb\u52a1\u961f\u5217\u7b2c\u4e00\u4e2a\u8282\u70b9\u7684\u56de\u8c03\u51fd\u6570\uff0c\u7136\u540e\u4ecefirstCallbackNode\u4efb\u52a1\u961f\u5217\u4e2d\u5220\u9664\u7b2c\u4e00\u4e2a\u8282\u70b9\u3002\u76f4\u5230\u7b2c\u4e00\u4e2a\u8282\u70b9\u8fd8\u6ca1\u6709\u8fc7\u671f\u6216\u8005\u4efb\u52a1\u961f\u5217\u90fd\u6267\u884c\u4e86\u56de\u8c03\u51fd\u6570\u3002\u5224\u65ad\u8282\u70b9\u662f\u5426\u8fc7\u671f\uff0c\u6839\u636e\u5f53\u524d\u65f6\u95f4\u4e0e\u8282\u70b9\u5b58\u50a8\u7684\u5230\u671f\u65f6\u95f4\u6bd4\u8f83\u6765\u5224\u65ad\u3002"),(0,l.kt)("p",null,"3\u3001\u4f9d\u6b21\u6267\u884cfirstCallbackNode\u4efb\u52a1\u961f\u5217\u7b2c\u4e00\u4e2a\u8282\u70b9\u7684\u56de\u8c03\u51fd\u6570\uff0c\u7136\u540e\u4ecefirstCallbackNode\u4efb\u52a1\u961f\u5217\u4e2d\u5220\u9664\u7b2c\u4e00\u4e2a\u8282\u70b9\u3002\u76f4\u5230\u4efb\u52a1\u961f\u5217\u4e3a\u7a7a\u6216\u8005\u5f53\u524d\u65f6\u95f4\u5927\u4e8e\u5f53\u524d\u5e27\u622a\u6b62\u65f6\u95f4\u3002"),(0,l.kt)("p",null,"4\u3001\u5c06\u56de\u8c03\u6b63\u5728\u6267\u884c\u7684\u6807\u8bb0isExecutingCallback\u7f6e\u4e3afalse\uff0c\u5e76\u6062\u590d\u8fc7\u671f\u6807\u5fd7\u3002\u6700\u540e\u5224\u65ad\uff0c\u4efb\u52a1\u961f\u5217\u662f\u5426\u4e3a\u7a7a\uff0c\u5982\u679c\u4e3a\u7a7a\u5219\u6807\u8bb0",(0,l.kt)("inlineCode",{parentName:"p"},"isHostCallbackScheduled = false"),"\uff0c\u8868\u793a\u7a7a\u95f2\u65f6\u95f4\u6ca1\u6709\u5b89\u6392\u4efb\u52a1\u961f\u5217\u3002\u5982\u679c\u4e0d\u4e3a\u7a7a\uff0c\u5219\u6267\u884censureHostCallbackIsScheduled\uff0c\u5c06\u5269\u4e0b\u7684\u4efb\u52a1\u961f\u5217\u5b89\u6392\u5230\u5728\u4e0b\u4e00\u7a7a\u95f2\u65f6\u95f4\u6bb5\u3002"),(0,l.kt)("p",null,"5\u3001\u6700\u540e\u6267\u884cflushImmediateWork\uff0c\u6267\u884c\u4efb\u52a1\u961f\u5217\u4e2d\u6240\u6709\u7acb\u5373\u6267\u884c\u4efb\u52a1(\u6700\u9ad8\u4f18\u5148\u7ea7)\u7684\u56de\u8c03\u51fd\u6570\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"function flushWork(didTimeout) {\n  isExecutingCallback = true;//\u8868\u793a\u6b63\u5728\u6267\u884c\u56de\u8c03\n  const previousDidTimeout = currentDidTimeout;//\u4fdd\u5b58\u5f53\u524d\u7684\u8fc7\u671f\u6807\u5fd7\u5230previousDidTimeout\n  currentDidTimeout = didTimeout;//\u91cd\u65b0\u8bbe\u7f6e\u5f53\u524d\u7684\u8fc7\u671f\u6807\u5fd7\n  try {\n    if (didTimeout) {\n      // Flush all the expired callbacks without yielding.\n        //\u5982\u679c\u8fc7\u671f\u4e86\n      while (firstCallbackNode !== null) {\n          // \u7b2c\u4e00\u4e2a\u8282\u70b9\u4e0d\u4e3a\u7a7a\uff0c\u5e76\u4e14\u7b2c\u4e00\u4e2a\u8282\u70b9\u8fc7\u671f\u4e86\uff0c\u5219\u4e00\u76f4\u5faa\u73af\uff0c\u76f4\u5230\u7b2c\u4e00\u4e2a\u8282\u70b9\u4e3a\u7a7a\u6216\u8005\u6ca1\u6709\u8fc7\u671f\u3002\n        // Read the current time. Flush all the callbacks that expire at or\n        // earlier than that time. Then read the current time again and repeat.\n        // This optimizes for as few performance.now calls as possible.\n        //  \u5237\u65b0\u5f53\u524d\u65f6\u95f4\n        var currentTime = getCurrentTime();\n        if (firstCallbackNode.expirationTime <= currentTime) {\n          //\u5982\u679c\u7b2c\u4e00\u4e2a\u8282\u70b9\u7684\u5230\u671f\u65f6\u95f4\u5c0f\u4e8e\u5f53\u524d\u65f6\u95f4\uff0c\u8fc7\u671f\u4e86\n          do {\n            //flushFirstCallback()\uff1a\u6267\u884c\u7b2c\u4e00\u4e2a\u8282\u70b9\u7684\u56de\u8c03\u51fd\u6570\uff0c\u5e76\u4ece\u94fe\u8868\u4e2d\u5220\u9664\u5f53\u524d\u7684\u7b2c\u4e00\u4e2a\u8282\u70b9\n            flushFirstCallback();\n          } while (\n            //  \u76f4\u5230\u7b2c\u4e00\u4e2a\u8282\u70b9\u4e3a\u7a7a\u6216\u8005\u7b2c\u4e00\u4e2a\u8282\u70b9\u6ca1\u6709\u8fc7\u671f\n            firstCallbackNode !== null &&\n            firstCallbackNode.expirationTime <= currentTime\n          );\n          //\u7b2c\u4e00\u4e2a\u8282\u70b9\u4e3a\u7a7a\u6216\u8005\u7b2c\u4e00\u4e2a\u8282\u70b9\u6ca1\u6709\u8fc7\u671f\n          continue;\n        }\n          //\u7b2c\u4e00\u4e2a\u8282\u70b9\u4e3a\u4e0d\u4e3a\u7a7a\u4f46\u662f\u7b2c\u4e00\u4e2a\u8282\u70b9\u6ca1\u6709\u8fc7\u671f\uff0c\u5219\u9000\u51fawhile(firstCallbackNode !== null)\n        break;\n      }\n    } else {\n      // Keep flushing callbacks until we run out of time in the frame.\n        // \u7b2c\u4e00\u4e2a\u8282\u70b9\u4e0d\u4e3a\u7a7a\n      if (firstCallbackNode !== null) {\n        //\u4e00\u76f4\u5faa\u73afflushFirstCallback();\n          // \u76f4\u5230\u5f53\u524d\u5e27\u6ca1\u6709\u7a7a\u4f59\u65f6\u95f4\u53ef\u7528\n          // \u6216\u8005\u7b2c\u4e00\u4e2a\u8282\u70b9\u4e3a\u7a7a\uff0c\u5373\u4efb\u52a1\u961f\u5217\u4e3a\u7a7a\uff0c\u5219\u505c\u6b62\u5237\u65b0\u7b2c\u4e00\u4e2a\u8282\u70b9\n        do {\n          flushFirstCallback();\n        } while (firstCallbackNode !== null && !shouldYieldToHost());\n      }\n    }\n  } finally {\n    //\u6700\u7ec8\u5c06\u56de\u8c03\u6b63\u5728\u6267\u884c\u7684\u6807\u8bb0\u7f6e\u4e3afalse\n    isExecutingCallback = false;\n    //\u6062\u590d\u4e4b\u524d\u7684\u8fc7\u671f\u6807\u5fd7\n    currentDidTimeout = previousDidTimeout;\n    if (firstCallbackNode !== null) {\n      // \u5982\u679c\u7b2c\u4e00\u4e2a\u8282\u70b9\u4e0d\u4e3a\u7a7a\uff0c\u8868\u793a\u662f\u56e0\u4e3a\u5f53\u524d\u5e27\u6ca1\u6709\u7a7a\u4f59\u65f6\u95f4\u4e86\uff0c\u800c\u505c\u6b62\u4e86\u56de\u8c03\u7684\u6267\u884c\n      //  \u8fd9\u4e2a\u65f6\u5019\u8bf7\u6c42\u4e0b\u4e00\u6b21\u7684\u56de\u8c03\uff0c\u7ee7\u7eed\u6267\u884c\u5269\u4e0b\u7684\u4efb\u52a1\u961f\u5217\n      // There's still work remaining. Request another callback.\n      ensureHostCallbackIsScheduled();\n    } else {\n      //\u5982\u679c\u90fd\u5df2\u7ecf\u6267\u884c\u5b8c\u4e86\uff0c\u4efb\u52a1\u961f\u5217\u4e3a\u7a7a\u7684\u60c5\u51b5\uff0c\u5219\u8bbe\u7f6e\u6807\u8bb0isHostCallbackScheduled\u4e3afalse\uff0c\n      // \u7a7a\u95f2\u65f6\u95f4\u7684\u4f7f\u7528\u6743\u53ef\u4ee5\u4ea4\u7ed9\u5176\u4ed6\u7684\u4efb\u52a1\u961f\u5217\n      isHostCallbackScheduled = false;\n    }\n    // Before exiting, flush all the immediate work that was scheduled.\n    // \u6700\u540e\u5237\u65b0\u6240\u6709\u7684\u7acb\u5373\u6267\u884c\u4efb\u52a1\n    flushImmediateWork();\n  }\n}\n")),(0,l.kt)("h3",{id:"flushfirstcallback"},"flushFirstCallback"),(0,l.kt)("p",null,"\u6d41\u7a0b\uff1a"),(0,l.kt)("p",null,"1\u3001\u6267\u884c\u7b2c\u4e00\u4e2a\u8282\u70b9\u7684\u56de\u8c03\u51fd\u6570\uff0c\u5e76\u4ece\u94fe\u8868\u4e2d\u5220\u9664\u5f53\u524d\u7684\u7b2c\u4e00\u4e2a\u8282\u70b9\uff0c\u5982\u679c\u56de\u8c03\u51fd\u6570\u8fd4\u56de\u7684\u662f\u4e00\u4e2a\u51fd\u6570\uff0c\u5219\u5229\u7528\u8fd9\u4e2a\u51fd\u6570\u521b\u5efa\u4e00\u4e2a\u65b0\u8282\u70b9",(0,l.kt)("inlineCode",{parentName:"p"},"continuationNode")),(0,l.kt)("p",null,"2\u3001\u5982\u679c\u65b0\u8282\u70b9\u7684\u4f18\u5148\u7ea7\u6700\u9ad8\uff0c\u5219\u6267\u884c",(0,l.kt)("inlineCode",{parentName:"p"},"firstCallbackNode = continuationNode"),"\uff0c\u5e76\u8c03\u7528",(0,l.kt)("inlineCode",{parentName:"p"},"ensureHostCallbackIsScheduled"),"\u3002\u5426\u5219\uff0c\u5230\u7b2c3\u6b65\u3002"),(0,l.kt)("p",null,"3\u3001\u6700\u540e\uff0c\u7531\u4e8e\u65b0\u8282\u70b9\u7684\u5230\u671f\u65f6\u95f4\u4e0e\u539f\u7b2c\u4e00\u4e2a\u8282\u70b9\u7684\u5230\u671f\u65f6\u95f4\u4e00\u6837\uff0c\u6240\u4ee5\u65b0\u8282\u70b9\u5c06\u4f1a\u66ff\u4ee3\u539f\u7b2c\u4e00\u4e2a\u8282\u70b9\u7684\u4f4d\u7f6e\u3002"),(0,l.kt)("p",null,"\u5728\u4e0a\u8ff0\u8fc7\u7a0b\u4e2d\uff0c\u7531\u4e8e\u7b2c2\u6b65\u8bbe\u8ba1\u5230\u5f02\u6b65\u4e8b\u4ef6\uff0c\u6240\u4ee5\u7b2c\u4e09\u6b65\u4f1a\u5728\u7b2c\u4e8c\u6b65\u4e4b\u524d\u6539\u53d8\u4efb\u52a1\u94fe\u8868\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"function flushFirstCallback() {\n  //\u5c06firstCallbackNode\u8d4b\u503c\u7ed9flushedNode\uff0c\u4f5c\u4e3a\u5f53\u524d\u9700\u8981\u88ab\u6267\u884c\u7684\u4efb\u52a1\u8282\u70b9\n  var flushedNode = firstCallbackNode;\n\n  // Remove the node from the list before calling the callback. That way the\n  // list is in a consistent state even if the callback throws.\n  //  \u4ece\u94fe\u8868\u4e2d\u5220\u9664\u7b2c\u4e00\u4e2a\u8282\u70b9firstCallbackNode\uff0c\u539ffirstCallbackNode\u7684\u540e\u4e00\u4e2a\u8282\u70b9\u4f5c\u4e3a\u7b2c\u4e00\u4e2a\u8282\u70b9\n  var next = firstCallbackNode.next;\n  if (firstCallbackNode === next) {\n    // This is the last callback in the list.\n    firstCallbackNode = null;\n    next = null;\n  } else {\n    var lastCallbackNode = firstCallbackNode.previous;\n    firstCallbackNode = lastCallbackNode.next = next;\n    next.previous = lastCallbackNode;\n  }\n  //\u5c06\u5f53\u524d\u9700\u8981\u88ab\u6267\u884c\u7684\u4efb\u52a1\u8282\u70b9\u7684next\u4e0eprevious\u7f6enull\uff0c\u65ad\u5f00\u4e0e\u94fe\u8868\u7684\u94fe\u63a5\n  flushedNode.next = flushedNode.previous = null;\n\n  // Now it's safe to call the callback.\n  var callback = flushedNode.callback;//\u8be5\u4efb\u52a1\u7684\u56de\u8c03\u51fd\u6570\n  var expirationTime = flushedNode.expirationTime;//\u8be5\u4efb\u52a1\u7684\u5230\u671f\u65f6\u95f4\n  var priorityLevel = flushedNode.priorityLevel;//\u8be5\u4efb\u52a1\u7684\u4f18\u5148\u7ea7\n  var previousPriorityLevel = currentPriorityLevel;//\u4fdd\u5b58\u5f53\u524d\u4f18\u5148\u7ea7\n  var previousExpirationTime = currentExpirationTime;//\u4fdd\u5b58\u5f53\u524d\u5230\u671f\u65f6\u95f4\n  currentPriorityLevel = priorityLevel;//\u5229\u7528\u8be5\u4efb\u52a1\u7684\u4f18\u5148\u7ea7\u5237\u65b0\u5f53\u524d\u4f18\u5148\u7ea7\n  currentExpirationTime = expirationTime;//\u5229\u7528\u8be5\u4efb\u52a1\u7684\u5230\u671f\u65f6\u95f4\u5237\u65b0\u5f53\u524d\u5230\u671f\u65f6\u95f4\n  var continuationCallback;\n  try {\n    continuationCallback = callback();//\u6267\u884c\u8be5\u4efb\u52a1\u7684\u56de\u8c03\u51fd\u6570\uff0c\u8fd4\u56de\u503c\u4fdd\u5b58\u5728continuationCallback\n  } finally {\n    //\u6ce8\u610f\u5982\u679ccallback\u662f\u5f02\u6b65\u7684\uff0c\u8fd9\u91ccfinally\u7684\u5b50\u53e5\u4e0d\u4f1a\u7b49callback\u6267\u884c\u5b8c\u5728\u6267\u884c\n    //  try...finally\u662f\u540c\u6b65\u7684\n    //  \u8c03\u7528\u4e86\u56de\u8c03\u51fd\u6570\u4e4b\u540e\u6062\u590d\u539f\u6709\u7684\u5f53\u524d\u4f18\u5148\u7ea7\u4e0e\u5f53\u524d\u5230\u671f\u65f6\u95f4\n    currentPriorityLevel = previousPriorityLevel;\n    currentExpirationTime = previousExpirationTime;\n  }\n\n  // A callback may return a continuation. The continuation should be scheduled\n  // with the same priority and expiration as the just-finished callback.\n  //  \u5982\u679c\u56de\u8c03\u51fd\u6570\u8fd4\u56de\u7684\u662f\u4e00\u4e2a\u51fd\u6570\uff0c\u5219\u518d\u521b\u5efa\u4e00\u4e2a\u4efb\u52a1\u8282\u70b9\n  if (typeof continuationCallback === 'function') {\n    var continuationNode: CallbackNode = {\n      callback: continuationCallback,\n      priorityLevel,\n      expirationTime,\n      next: null,\n      previous: null,\n    };\n\n    // Insert the new callback into the list, sorted by its expiration. This is\n    // almost the same as the code in `scheduleCallback`, except the callback\n    // is inserted into the list *before* callbacks of equal expiration instead\n    // of after.\n    //  \u5c06\u65b0\u751f\u6210\u7684\u8282\u70b9\u4f9d\u7167\u5230\u671f\u65f6\u95f4\u63d2\u5165\u5230\u94fe\u8868\u4e2d\uff0c\u4e0escheduleCallback\u51fd\u6570\u4e2d\u7684\u533a\u522b\u662f\uff0c\n    //  \u5982\u679c\u9047\u5230\u76f8\u540c\u7684\u5230\u671f\u65f6\u95f4\uff0c\u5219\u63d2\u5165\u5230\u5176\u524d\u9762\u800c\u4e0d\u662f\u540e\u9762\n    if (firstCallbackNode === null) {\n      // This is the first callback in the list.\n      //  \u5982\u679c\u6b64\u65f6\u4efb\u52a1\u961f\u5217\u4e3a\u7a7a\uff0c\u5219\u8be5\u65b0\u8282\u70b9\u4e3a\u94fe\u8868\u552f\u4e00\u7684\u8282\u70b9\n      firstCallbackNode = continuationNode.next = continuationNode.previous = continuationNode;\n    } else {\n\n      var nextAfterContinuation = null;\n      var node = firstCallbackNode;\n      do {\n        if (node.expirationTime >= expirationTime) {\n          // This callback expires at or after the continuation. We will insert\n          // the continuation *before* this callback.\n          nextAfterContinuation = node;\n          break;\n        }\n        node = node.next;\n      } while (node !== firstCallbackNode);\n\n      if (nextAfterContinuation === null) {\n        // No equal or lower priority callback was found, which means the new\n        // callback is the lowest priority callback in the list.\n        nextAfterContinuation = firstCallbackNode;\n      } else if (nextAfterContinuation === firstCallbackNode) {\n        // The new callback is the highest priority callback in the list.\n        //  \u5982\u679c\u8fd4\u56de\u7684\u51fd\u6570\u6784\u6210\u7684\u8282\u70b9\u4f18\u5148\u7ea7\u662f\u6700\u9ad8\u7684\uff0c\u90a3\u4e48\u9700\u8981\u5c06\u8be5\u8282\u70b9\u5355\u72ec\u8bbe\u7f6e\u4e3a\u4e00\u4e2a\u4efb\u52a1\u961f\u5217\n          // \u8c03\u7528ensureHostCallbackIsScheduled\u91cd\u65b0\u8bbe\u7f6e\u4efb\u52a1\u6267\u884c\u5668\uff0c\u5e76\u7acb\u5373\u6267\u884c\u4efb\u52a1\u6216\u8005\u7a0d\u540e\u6267\u884c\u4efb\u52a1\n        firstCallbackNode = continuationNode;\n        ensureHostCallbackIsScheduled();\n      }\n\n      var previous = nextAfterContinuation.previous;\n      previous.next = nextAfterContinuation.previous = continuationNode;\n      continuationNode.next = nextAfterContinuation;\n      continuationNode.previous = previous;\n    }\n  }\n}\n")),(0,l.kt)("h3",{id:"flushimmediatework"},"flushImmediateWork"),(0,l.kt)("p",null,"\u6267\u884c\u4efb\u52a1\u961f\u5217\u4e2d\u6240\u6709\u7acb\u5373\u6267\u884c\u4efb\u52a1(\u6700\u9ad8\u4f18\u5148\u7ea7)\u7684\u56de\u8c03\u51fd\u6570\uff0c\u8fd9\u4e9b\u56de\u8c03\u51fd\u6570\u7684\u662f\u4e0d\u80fd\u88ab\u6253\u65ad\u7684\uff0c\u56e0\u4e3a\u5728\u91cd\u65b0\u6267\u884c\u5176\u4ed6\u4efb\u52a1\u961f\u5217\u7684\u65f6\u5019\uff0c\u4f1a\u5148\u5224\u65adisExecutingCallback\u8fd9\u4e2a\u6807\u8bb0\uff0c\u5982\u679c\u4e3atrue\uff0c\u8bf4\u660e\u5728\u6267\u884c\u6700\u9ad8\u4f18\u5148\u7ea7\u7684\u56de\u8c03\uff0c\u76f4\u63a5\u8fd4\u56de\u3002"),(0,l.kt)("p",null,"\u6d41\u7a0b\uff1a"),(0,l.kt)("p",null,"1\u3001\u5982\u679cfirstCallbackNode\u4efb\u52a1\u5177\u5907\u6700\u9ad8\u4f18\u5148\u7ea7\uff0c\u5e76\u4e14currentEventStartTime === -1\uff08\uff1f\uff09\uff0c\u5219\u6807\u8bb0\u5904\u4e8e\u6b63\u5728\u6267\u884c\u6700\u9ad8\u4f18\u5148\u7ea7\u7684\u4efb\u52a1\u7684\u8282\u70b9\u3002"),(0,l.kt)("p",null,"2\u3001\u6267\u884c\u7b2c\u4e00\u4e2a\u8282\u70b9\u7684\u56de\u8c03\u51fd\u6570\uff0c\u76f4\u5230\u7b2c\u4e00\u4e2a\u8282\u70b9\u7684\u4f18\u5148\u7ea7\u4e0d\u662f\u6700\u9ad8\u4f18\u5148\u7ea7\uff08\u7acb\u5373\u6267\u884c\uff09\uff0c\u7531\u4e8e\u94fe\u8868\u662f\u6309\u7167\u5230\u671f\u65f6\u95f4\u6392\u5e8f\uff0c\u800c\u6700\u9ad8\u4f18\u5148\u7ea7\u5bf9\u5e94\u7684\u5230\u671f\u65f6\u95f4\u6700\u5c0f\uff0c\u6240\u4ee5\u90fd\u4f1a\u88ab\u5b89\u6392\u5728\u94fe\u8868\u524d\u9762\u3002\u56e0\u6b64\u8fd9\u91cc\u5c31\u662f\u6267\u884c\u961f\u5217\u4e2d\u6240\u6709\u7684\u7acb\u5373\u6267\u884c\u4efb\u52a1\u7684\u56de\u8c03\u51fd\u6570"),(0,l.kt)("p",null,"3\u3001\u8c03\u7528\u5b8c\u6240\u6709\u7684\u6700\u9ad8\u4f18\u5148\u7ea7\u8282\u70b9\u7684\u56de\u8c03\u51fd\u6570\u4e4b\u540e\uff0c\u5c06isExecutingCallback\u8bbe\u7f6e\u4e3afalse\uff0c\u8868\u793a\u73b0\u5728\u6ca1\u6709\u6267\u884c\u6700\u9ad8\u4f18\u5148\u7ea7\u4efb\u52a1\u3002\u5982\u679c\u8fd8\u6709\u4efb\u52a1\u6ca1\u6267\u884c\u5b8c\uff0c\u90a3\u4e48\u91cd\u65b0\u8bbe\u7f6e\u4efb\u52a1\u6267\u884c\u5668\uff0c\u5426\u5219\u8bbe\u7f6e",(0,l.kt)("inlineCode",{parentName:"p"},"isHostCallbackScheduled = false"),"\u8868\u793a\u961f\u5217\u4e3a\u7a7a\uff0c\u7a7a\u95f2\u65f6\u95f4\u6ca1\u6709\u5b89\u6392\u4efb\u52a1\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"function flushImmediateWork() {\n  if (\n    // Confirm we've exited the outer most event handler\n    //  currentEventStartTime\u8868\u793a\u5f53\u524d\u4e8b\u4ef6\u89e6\u53d1\u7684\u5f00\u59cb\u65f6\u95f4\n    //\u5982\u679cfirstCallbackNode\u4efb\u52a1\u5177\u5907\u6700\u9ad8\u4f18\u5148\u7ea7\uff0c\u5219\u6267\u884c\u56de\u8c03\u51fd\u6570\n    currentEventStartTime === -1 &&\n    firstCallbackNode !== null &&\n    firstCallbackNode.priorityLevel === ImmediatePriority\n  ) {\n    //\u4e00\u4e2a\u9501\uff0c\u7528\u4e8e\u6807\u8bb0\u662f\u5426\u6b63\u5728\u6267\u884c\u6700\u9ad8\u4f18\u5148\u7ea7\u7684\u4efb\u52a1\n    isExecutingCallback = true;\n    try {\n        //\u6267\u884c\u7b2c\u4e00\u4e2a\u8282\u70b9\u7684\u56de\u8c03\u51fd\u6570\uff0c\u76f4\u5230\u7b2c\u4e00\u4e2a\u8282\u70b9\u7684\u4f18\u5148\u7ea7\u4e0d\u662f\u6700\u9ad8\u4f18\u5148\u7ea7\uff08\u7acb\u5373\u6267\u884c\uff09\n      //  \u7531\u4e8e\u94fe\u8868\u662f\u6309\u7167\u5230\u671f\u65f6\u95f4\u6392\u5e8f\uff0c\u800c\u6700\u9ad8\u4f18\u5148\u7ea7\u5bf9\u5e94\u7684\u5230\u671f\u65f6\u95f4\u6700\u5c0f\uff0c\u6240\u4ee5\u90fd\u4f1a\u88ab\u5b89\u6392\u5728\u94fe\u8868\u524d\u9762\n      //  \u56e0\u6b64\u8fd9\u91cc\u5c31\u662f\u6267\u884c\u961f\u5217\u4e2d\u6240\u6709\u7684\u7acb\u5373\u6267\u884c\u4efb\u52a1\u7684\u56de\u8c03\u51fd\u6570\n      do {\n        flushFirstCallback();\n      } while (\n        // Keep flushing until there are no more immediate callbacks\n        firstCallbackNode !== null &&\n        firstCallbackNode.priorityLevel === ImmediatePriority\n      );\n    } finally {\n      //\u8c03\u7528\u5b8c\u6240\u6709\u7684\u6700\u9ad8\u4f18\u5148\u7ea7\u8282\u70b9\u7684\u56de\u8c03\u51fd\u6570\u4e4b\u540e\uff0c\u5c06isExecutingCallback\u8bbe\u7f6e\u4e3afalse\uff0c\u8868\u793a\u73b0\u5728\u6ca1\u6709\u6267\u884c\u6700\u9ad8\u4f18\u5148\u7ea7\u4efb\u52a1\n      isExecutingCallback = false;\n      if (firstCallbackNode !== null) {\n        // There's still work remaining. Request another callback.\n        // \u91cd\u65b0\u8bbe\u7f6e\u4efb\u52a1\u6267\u884c\u5668\n        ensureHostCallbackIsScheduled();\n      } else {\n        //\u961f\u5217\u4e3a\u7a7a\uff0c\u7a7a\u95f2\u65f6\u95f4\u6ca1\u6709\u5b89\u6392\u4efb\u52a1\n        isHostCallbackScheduled = false;\n      }\n    }\n  }\n}\n")),(0,l.kt)("h1",{id:"api"},"API"),(0,l.kt)("p",null,"\u8fd9\u53ea\u8d34unstable_scheduleCallback\u4ee3\u7801\u4ee5\u53ca\u6ce8\u91ca\uff0c\u5177\u4f53\u7684\u6ce8\u91ca\u4e0e\u89e3\u6790\u8bf7\u5173\u6ce8",(0,l.kt)("a",{parentName:"p",href:"https://github.com/BUPTlhuanyu/ReactNote/blob/master/react/packages/scheduler/src/Scheduler.js"},"reactNote"),"\uff0cscheduler\u6d4b\u8bd5\u4ee3\u7801\u5177\u4f53\u53ef\u4ee5\u5173\u6ce8",(0,l.kt)("a",{parentName:"p",href:"https://github.com/BUPTlhuanyu/ReactNote/blob/master/react/runlogic/scheduler.html"},"reactNote")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"unstable_runWithPriority\nunstable_wrapCallback\nunstable_scheduleCallback\nunstable_cancelCallback\nunstable_getCurrentPriorityLevel\nunstable_shouldYield\n")),(0,l.kt)("h3",{id:"unstable_schedulecallback"},"unstable_scheduleCallback"),(0,l.kt)("p",null,"\u4f20\u5165\u53c2\u6570\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"callback\uff0c//\u4efb\u52a1\u7684\u56de\u8c03\u51fd\u6570\ndeprecated_options //\u5305\u542b\u81ea\u5b9a\u4e49\u7684\u5230\u671f\u65f6\u957ftimeout\uff0c\u53ef\u4ee5\u7528\u6765\u6307\u5b9acallback\u6267\u884c\u7684\u5230\u65f6\u95f4\uff0c\n                     \u4e5f\u5c31\u662f\u53ef\u4ee5\u5f71\u54cd\u63d2\u5165\u5230\u5df2\u6709\u7684\u4efb\u52a1\u94fe\u8868\u7684\u4f4d\u7f6e\uff0c\u53ef\u4ee5\u4f7f\u4f20\u5165\u7684callback\u56de\u8c03\u51fd\u6570\u5728\u5f53\u524d\u5e27paint\u4e4b\u524d\u6267\u884c\uff0c\u5373\u7acb\u5373\u6267\u884c\u3002\n")),(0,l.kt)("p",null,"\u529f\u80fd\uff1a\n\u8ba1\u7b97\u5f00\u59cb\u65f6\u95f4\uff0c\u7136\u540e\u6839\u636e\u4f20\u5165\u7684\u53c2\u6570deprecated","_","options.timeout\u8ba1\u7b97\u5230\u671f\u65f6\u95f4 = \u5f00\u59cb\u65f6\u95f4 + \u4f20\u5165\u7684\u53c2\u6570options\u4e2d\u7684timeout\uff0c\u5982\u679cdeprecated","_","options.timeout\u4e0d\u5b58\u5728\uff0c\u6839\u636e\u9ed8\u8ba4\u4f18\u5148\u7ea7\u8ba1\u7b97\u5230\u671f\u65f6\u95f4\u3002\u5c01\u88c5\u6210\u4e00\u4e2a\u8282\u70b9\uff0c\u5982\u4e0b\uff1b"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"  //\u65b0\u8282\u70b9\uff1a\u4fdd\u5b58\u4e86\u4f20\u5165\u7684\u56de\u8c03\u51fd\u6570\uff0c\u4f18\u5148\u7ea7\uff0c\u5230\u671f\u65f6\u95f4\n  var newNode = {\n    callback,\n    priorityLevel: currentPriorityLevel,\n    expirationTime,\n    next: null,//\u94fe\u8868\u540e\u4e00\u4e2a\u8282\u70b9\n    previous: null,//\u94fe\u8868\u524d\u4e00\u4e2a\u8282\u70b9\n  };\n")),(0,l.kt)("p",null,"\u6700\u540e\u6309\u7167\u5230\u671f\u65f6\u95f4\u7684\u5927\u5c0f\uff0c\u4ecefirstNode\u5f00\u59cb\u4ee5\u5c0f\u5230\u5927\u7684\u987a\u5e8f\u63d2\u5165\u5230\u53cc\u5411\u5faa\u73af\u94fe\u8868\u4e2dfirstCallbackNode\u4e2d\uff0c\u8fd4\u56de\u4e00\u4e2a\u65b0\u7684\u94fe\u8868\u3002 "),(0,l.kt)("p",null,"\u6e90\u7801\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"function unstable_scheduleCallback(callback, deprecated_options) {\n    //\u53ea\u6709unstable_wrapCallback\u548cunstable_runWithPriority\u4f1a\u6539\u53d8currentEventStartTime\n    // \u56e0\u6b64\u5728\u521d\u59cb\u72b6\u6001\uff0ccurrentEventStartTime=-1\uff0c\u6240\u4ee5startTime = getCurrentTime()\n    var startTime =\n        currentEventStartTime !== -1 ? currentEventStartTime : getCurrentTime();\n\n    //\u8ba1\u7b97\u5230\u671f\u65f6\u95f4 = \u5f00\u59cb\u65f6\u95f4 + \u4f20\u5165\u7684\u53c2\u6570options\u4e2d\u7684timeout\n    //deprecated_options.timeout\u8868\u793a\u591a\u5c11\u6beb\u79d2\u4e4b\u540e\u8fc7\u671f\n    var expirationTime;\n    if (\n        typeof deprecated_options === 'object' &&\n        deprecated_options !== null &&\n        typeof deprecated_options.timeout === 'number'\n    ) {\n        // FIXME: Remove this branch once we lift expiration times out of React.\n        expirationTime = startTime + deprecated_options.timeout;\n    } else {\n        //\u6839\u636e\u5f53\u524d\u4f18\u5148\u7ea7\u786e\u5b9a\u8fc7\u671f\u65f6\u95f4\n        //   \u521d\u59cb\u72b6\u6001\u4e0b\u4e3acurrentPriorityLevel\u4e3aNormalPriority,\n        switch (currentPriorityLevel) {\n            case ImmediatePriority:\n                expirationTime = startTime + IMMEDIATE_PRIORITY_TIMEOUT;\n                break;\n            case UserBlockingPriority:\n                expirationTime = startTime + USER_BLOCKING_PRIORITY;\n                break;\n            case IdlePriority:\n                expirationTime = startTime + IDLE_PRIORITY;\n                break;\n            case LowPriority:\n                expirationTime = startTime + LOW_PRIORITY_TIMEOUT;\n                break;\n            case NormalPriority:\n            default:\n                expirationTime = startTime + NORMAL_PRIORITY_TIMEOUT;\n        }\n    }\n\n    //\u65b0\u8282\u70b9\uff1a\u4fdd\u5b58\u4e86\u4f20\u5165\u7684\u56de\u8c03\u51fd\u6570\uff0c\u4f18\u5148\u7ea7\uff0c\u5230\u671f\u65f6\u95f4\n    var newNode = {\n        callback,\n        priorityLevel: currentPriorityLevel,\n        expirationTime,\n        next: null,//\u94fe\u8868\u540e\u4e00\u4e2a\u8282\u70b9\n        previous: null,//\u94fe\u8868\u524d\u4e00\u4e2a\u8282\u70b9\n    };\n\n    // Insert the new callback into the list, ordered first by expiration, then\n    // by insertion. So the new callback is inserted any other callback with\n    // equal expiration.\n    // \u5c06\u5f53\u524d\u5305\u542b\u56de\u8c03\u51fd\u6570\u7684\u8282\u70b9\u6309\u7167\u5230\u671f\u65f6\u95f4\u4ecefirstNode\u5f00\u59cb\u4ee5\u5c0f\u5230\u5927\u7684\u987a\u5e8f\u63d2\u5165\u5230\u53cc\u5411\u5faa\u73af\u94fe\u8868\u4e2d\uff0c\n    if (firstCallbackNode === null) {\n        //\u5982\u679c\u4efb\u52a1\u961f\u5217\u4e3a\u7a7a\uff0c\u5219\u5c06\u65b0\u8282\u70b9\u7ec4\u6210\u4e00\u4e2a\u53cc\u5411\u5faa\u73af\u94fe\u8868\uff0c\u5e76\u6267\u884censureHostCallbackIsScheduled\uff0c\u5f00\u59cb\u8c03\u5ea6\n        // This is the first callback in the list.\n        firstCallbackNode = newNode.next = newNode.previous = newNode;\n        ensureHostCallbackIsScheduled();\n    } else {\n        //\u5982\u679c\u4efb\u52a1\u961f\u5217\u4e0d\u4e3a\u7a7a\uff0c\u5c06\u65b0\u8282\u70b9\u63d2\u5165\u5faa\u73af\u94fe\u8868\uff0c\n        var next = null;\n        var node = firstCallbackNode;\n        do {\n            if (node.expirationTime > expirationTime) {\n                // The new callback expires before this one.\n                next = node;\n                break;\n            }\n            node = node.next;\n        } while (node !== firstCallbackNode);\n\n        if (next === null) {\n            //\u5982\u679c\u65b0\u8282\u70b9\u7684\u5230\u671f\u65f6\u95f4\u662f\u6700\u5927\u7684\uff0c\u5219\u5e94\u8be5\u5904\u4e8e\u94fe\u8868\u7684\u672b\u7aef\n            //\u5bf9\u4e8e\u53cc\u5411\u5faa\u73af\u94fe\u8868\u800c\u8a00\uff0c\u65b0\u8282\u70b9\u7684next\u4e3a\u94fe\u8868\u7684\u7b2c\u4e00\u4e2a\u8282\u70b9\u3002\n            // No callback with a later expiration was found, which means the new\n            // callback has the latest expiration in the list.\n            next = firstCallbackNode;\n        } else if (next === firstCallbackNode) {\n            // The new callback has the earliest expiration in the entire list.\n            //  \u5982\u679c\u65b0\u8282\u70b9\u7684\u5230\u671f\u65f6\u95f4\u6700\u5c0f\uff0c\u5219\u65b0\u8282\u70b9\u5c31\u5e94\u8be5\u662f\u94fe\u8868\u7684\u7b2c\u4e00\u4e2a\u8282\u70b9\n            //  \u5728\u63d2\u5165\u4e4b\u524d\uff0c\u5148\u6267\u884censureHostCallbackIsScheduled()\u8fdb\u884c\u8c03\u5ea6\n            //  \u7531\u4e8eensureHostCallbackIsScheduled\u7684\u51fd\u6570\u4f5c\u7528\u57df\u94fe\u4e2d\u6700\u7ec8\u662f\u901a\u8fc7\u56de\u8c03\u51fd\u6570\u6765\u8c03\u7528flushWork\u51fd\u6570\u6765\u6267\u884c\u4efb\u52a1\u94fe\u8868\u4e2d\u7684\u56de\u8c03\u51fd\u6570\u7684\uff0c\n            //  \u5c5e\u4e8e\u5f02\u6b65\u4e8b\u4ef6\uff0c\u56e0\u6b64if\u5916\u90e8\u7684\u4ee3\u7801\u5148\u4e8eensureHostCallbackIsScheduled()\u6267\u884c\n            firstCallbackNode = newNode;\n            ensureHostCallbackIsScheduled();\n        }\n\n        var previous = next.previous;\n        previous.next = next.previous = newNode;\n        newNode.next = next;\n        newNode.previous = previous;\n    }\n\n    return newNode;\n}\n")))}m.isMDXComponent=!0},3696:function(e,n,t){n.Z=t.p+"assets/images/js\u6e32\u67d3\u5e27-d6f57fb5a30e4ee25e6a33ccd8d82ad8.png"},9070:function(e,n,t){n.Z=t.p+"assets/images/scheduler-89f3ab83ca7250ef90c1572e772b9cf1.png"},6415:function(e,n,t){n.Z=t.p+"assets/images/scheduler\u57fa\u672c\u6d41\u7a0b-70d144bd9985feaa4bdf61c5a04d9284.png"}}]);